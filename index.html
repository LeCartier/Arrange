<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Hospital Programming Workbench</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  
  <!-- Room Logic System -->
  <script type="module" src="room-logic/index.js"></script>
  <script type="module" src="room-logic/engine.js"></script>
  <script type="module">
    // Import room logic functions and make them globally available
    import { getChapter, getAllChapters, searchChapters } from './room-logic/index.js';
    import { evaluateChapter, formatForDisplay, exportResults, importResults } from './room-logic/engine.js';
    
    // Import care setting mapping for CBOC vs In-Hospital grouping
    import { 
      CARE_SETTINGS, 
      CARE_SETTING_ICONS, 
      getCareSettingForFA, 
      shouldShowSettingGrouping 
    } from './care-setting-mapping.js';
    
    // Import canonical FA mapping for proper FA numbering
    import {
      CANONICAL_FAS,
      getCanonicalFA,
      hasCanonicalFAs,
      getCanonicalFAList,
      initializeCanonicalFAsFromEquipment
    } from './canonical-fa-mapping.js';
    
    // Make available globally for onclick handlers
    window.RoomLogic = {
      getChapter,
      getAllChapters,
      searchChapters,
      evaluateChapter,
      formatForDisplay,
      exportResults,
      importResults
    };
    
    // Make care setting functions globally available
    window.CareSettings = {
      CARE_SETTINGS,
      CARE_SETTING_ICONS,
      getCareSettingForFA,
      shouldShowSettingGrouping
    };
    
    // Make canonical FA functions globally available
    window.CanonicalFAs = {
      CANONICAL_FAS,
      getCanonicalFA,
      hasCanonicalFAs,
      getCanonicalFAList,
      initializeCanonicalFAsFromEquipment
    };
    
    console.log('Room Logic System loaded');
    console.log('Available chapters:', getAllChapters());
  </script>
  
  <style>
    :root {
      --bg: #060606;
      --bg-card: #111;
      --border: #444;
      --text: #f5f5f5;
      --muted: #aaaaaa;
      --accent: #00b894;
      --pill-inactive: #333;
      --input-bg: #111;
      --input-border: #555;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      padding: 24px;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background-color: var(--bg);
      color: var(--text);
    }

    h1, h2, h3, h4 {
      margin: 0;
    }

    p {
      margin: 0;
    }

    header {
      margin-bottom: 24px;
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 20px;
    }

    header .header-content {
      flex: 1;
    }

    header .header-actions {
      display: flex;
      gap: 12px;
      padding-top: 4px;
      align-items: center;
    }

    /* Revit Status Indicator */
    .revit-status-indicator {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      background: rgba(255,255,255,0.1);
      border-radius: 16px;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 12px;
    }

    .revit-status-indicator:hover {
      background: rgba(255,255,255,0.2);
    }

    .revit-status-indicator .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      transition: background 0.3s;
    }

    .revit-status-indicator .status-dot.disconnected {
      background: #95a5a6;
    }

    .revit-status-indicator .status-dot.connecting {
      background: #f39c12;
      animation: pulse 1s infinite;
    }

    .revit-status-indicator .status-dot.connected {
      background: #27ae60;
    }

    .revit-status-indicator .status-text {
      color: rgba(255,255,255,0.8);
      font-weight: 500;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    header .icon-btn {
      width: 40px;
      height: 40px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    header .icon-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }

    header .icon-btn.portal {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    header .icon-btn.sync {
      background: linear-gradient(135deg, #00b894 0%, #00cec9 100%);
      color: white;
    }

    header .icon-btn.workbench {
      background: linear-gradient(135deg, #ff6b6b 0%, #feca57 100%);
      color: white;
    }

    header .icon-btn.workbench.active {
      background: linear-gradient(135deg, #feca57 0%, #ff6b6b 100%);
      box-shadow: 0 0 20px rgba(254, 202, 87, 0.5);
    }

    header p {
      margin-top: 8px;
      color: var(--muted);
      max-width: 800px;
      font-size: 0.95rem;
    }

    .layout {
      display: grid;
      grid-template-columns: minmax(320px, 400px) minmax(0, 1fr);
      gap: 24px;
      align-items: flex-start;
    }

    .layout.compare-mode {
      grid-template-columns: minmax(320px, 400px) minmax(0, 1fr) minmax(0, 1fr);
    }

    #left-column {
      display: block;
    }

    #right-column {
      display: block;
    }

    #compare-column {
      display: none;
    }

    .layout.compare-mode #compare-column {
      display: block;
    }

    .compare-column {
      background: var(--bg-card);
      border-radius: 12px;
      padding: 20px;
      border: 2px dashed var(--border);
      min-height: 400px;
      transition: border-color 0.2s;
    }

    .compare-column.drag-over {
      border-color: var(--accent);
      background: rgba(0, 184, 148, 0.05);
    }

    .compare-column h3 {
      margin-bottom: 12px;
      color: var(--muted);
      font-size: 1rem;
    }

    .compare-search {
      width: 100%;
      padding: 8px 12px;
      background: var(--input-bg);
      border: 1px solid var(--input-border);
      border-radius: 6px;
      color: var(--text);
      font-size: 0.9rem;
      margin-bottom: 16px;
    }

    .compare-room-display {
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 16px;
    }

    .compare-room-display h4 {
      margin-bottom: 12px;
      color: var(--accent);
    }

    .compare-room-display .detail-row {
      display: flex;
      justify-content: space-between;
      padding: 6px 0;
      border-bottom: 1px solid var(--border);
    }

    .compare-room-display .detail-row:last-child {
      border-bottom: none;
    }

    @media (max-width: 900px) {
      .layout {
        grid-template-columns: 1fr;
      }
      
      .layout.compare-mode {
        grid-template-columns: 1fr;
      }
      
      .layout.compare-mode #left-column {
        order: 1;
      }
      
      .layout.compare-mode #right-column {
        order: 2;
      }
      
      .layout.compare-mode #compare-column {
        order: 3;
      }
    }

    /* Tree View Styles */
    .tree-container {
      background-color: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 16px;
      max-height: calc(100vh - 200px);
      overflow-y: auto;
    }

    .tree-header {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-bottom: 16px;
    }

    .tree-header-top {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .tree-header-title {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .back-to-projects-btn {
      padding: 4px 10px;
      font-size: 0.85rem;
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      color: var(--text);
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .back-to-projects-btn:hover {
      background: var(--bg-hover);
    }

    .mode-toggle {
      display: flex;
      gap: 8px;
    }

    .mode-btn {
      padding: 6px 12px;
      border-radius: 6px;
      border: 1px solid var(--border);
      background-color: var(--pill-inactive);
      color: var(--text);
      font-size: 0.75rem;
      cursor: pointer;
      transition: all 0.15s ease;
    }

    .mode-btn.active {
      background-color: var(--accent);
      border-color: var(--accent);
    }

    .mode-btn:hover {
      transform: translateY(-1px);
    }

    .tree-node {
      margin-left: 0;
    }

    .tree-item {
      position: relative;
      display: flex;
      align-items: center;
      padding: 6px 8px 6px 28px;
      cursor: pointer;
      border-radius: 4px;
      transition: background-color 0.15s ease;
      user-select: none;
    }

    /* Hide spinner arrows on number inputs */
    input[type="number"]::-webkit-inner-spin-button,
    input[type="number"]::-webkit-outer-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }
    
    input[type="number"] {
      -moz-appearance: textfield;
      appearance: textfield;
    }

    .tree-item:hover {
      background-color: rgba(255, 255, 255, 0.05);
    }

    .tree-item.selected {
      background-color: rgba(0, 184, 148, 0.2);
      border-left: 3px solid var(--accent);
    }

    .tree-item.draggable-item {
      user-select: none;
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
    }

    .tree-item.draggable-item:active {
      cursor: grabbing !important;
    }

    .tree-drag-handle {
      position: absolute;
      left: 0;
      top: 0;
      bottom: 0;
      width: 20px;
      cursor: grab;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      transition: opacity 0.2s;
      z-index: 10;
    }

    .tree-drag-handle::before {
      content: '‚ãÆ';
      font-size: 14px;
      color: var(--muted);
    }

    .tree-item:hover .tree-drag-handle {
      opacity: 1;
    }

    .tree-drag-handle:active {
      cursor: grabbing;
    }

    .tree-item {
      position: relative;
      padding-left: 24px;
    }

    .tree-item.drag-over {
      border-top: 2px solid var(--accent);
      background-color: rgba(0, 184, 148, 0.1);
    }

    .tree-item[draggable="true"] {
      -webkit-user-drag: element;
    }

    .tree-toggle {
      width: 16px;
      height: 16px;
      margin-right: 4px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 0.7rem;
      color: var(--muted);
    }

    .tree-toggle.collapsed::before {
      content: '‚ñ∂';
    }

    .tree-toggle.expanded::before {
      content: '‚ñº';
    }

    .tree-toggle.leaf {
      visibility: hidden;
    }

    .tree-icon {
      margin-right: 6px;
      font-size: 0.85rem;
    }

    .tree-label {
      font-size: 0.85rem;
      flex: 1;
    }

    .tree-count {
      font-size: 0.75rem;
      color: var(--muted);
      margin-left: 8px;
    }

    .tree-children {
      margin-left: 20px;
      display: none;
    }

    .tree-children.expanded {
      display: block;
    }

    .detail-panel {
      background-color: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 10px;
    }

    .detail-panel h3 {
      margin: 0 0 8px 0;
      font-size: 1rem;
      color: var(--accent);
    }

    .detail-row {
      display: grid;
      grid-template-columns: 110px 1fr;
      gap: 8px;
      padding: 4px 0;
      border-bottom: 1px solid #222;
      font-size: 0.8rem;
    }

    .detail-row:last-child {
      border-bottom: none;
    }

    .detail-label {
      font-weight: 600;
      min-width: 120px;
      color: var(--muted);
    }

    .detail-value {
      flex: 1;
    }

    .equipment-list {
      max-height: 400px;
      overflow-y: auto;
    }

    .equipment-item {
      padding: 8px;
      margin: 4px 0;
      background-color: rgba(255, 255, 255, 0.02);
      border-radius: 4px;
      font-size: 0.8rem;
      overflow: hidden; /* Prevent horizontal scroll */
    }

    .equipment-item-header {
      display: flex;
      justify-content: space-between;
      gap: 12px;
      font-weight: 600;
      margin-bottom: 4px;
      min-width: 0; /* Allow flex items to shrink below content size */
    }
    
    .equipment-item-header > span:first-child {
      flex: 1;
      min-width: 0; /* Allow text to wrap/truncate */
      overflow: hidden;
    }
    
    .equipment-item-header > span:last-child {
      flex-shrink: 0; /* Don't shrink the quantity/acq info */
      white-space: nowrap;
    }

    .equipment-item-desc {
      color: var(--muted);
      font-size: 0.75rem;
      line-height: 1.4;
      display: block;
      word-wrap: break-word;
      overflow-wrap: break-word;
    }

    .equipment-item-desc.truncated {
      display: -webkit-box;
      -webkit-line-clamp: 2;
      line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .equipment-item-desc.expanded {
      display: block;
      white-space: normal;
    }

    .equipment-desc-toggle {
      color: var(--primary);
      cursor: pointer;
      font-size: 0.75rem;
      margin-left: 4px;
      text-decoration: underline;
      display: inline;
    }

    .equipment-desc-toggle:hover {
      color: var(--primary-hover);
    }

    /* Equipment Detail Panel Styles */
    .equipment-detail-section {
      margin-bottom: 20px;
      padding-bottom: 16px;
      border-bottom: 1px solid var(--border);
    }
    
    .equipment-detail-section:last-child {
      border-bottom: none;
      margin-bottom: 0;
    }
    
    .equipment-detail-section h3 {
      font-size: 0.9rem;
      font-weight: 600;
      color: var(--accent);
      margin: 0 0 12px 0;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .equipment-detail-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
    }
    
    .equipment-detail-row {
      display: flex;
      align-items: flex-start;
      gap: 8px;
    }
    
    .equipment-detail-label {
      font-size: 0.8rem;
      color: var(--muted);
      min-width: 100px;
      flex-shrink: 0;
    }
    
    .equipment-detail-value {
      font-size: 0.85rem;
      color: var(--text);
      word-break: break-word;
    }
    
    .equipment-detail-value.highlight {
      color: var(--accent);
      font-weight: 600;
    }
    
    .equipment-vendor-card {
      background: var(--bg-hover);
      border-radius: 6px;
      padding: 12px;
      margin-bottom: 8px;
    }
    
    .equipment-vendor-card:last-child {
      margin-bottom: 0;
    }
    
    .jsn-clickable {
      cursor: pointer;
      color: var(--primary);
      text-decoration: underline;
      transition: color 0.2s;
    }
    
    .jsn-clickable:hover {
      color: var(--accent);
    }

    /* JSN Lookup Mode Styles */
    .jsn-lookup-container {
      padding: 20px;
      display: flex;
      flex-direction: column;
      height: 100%;
      overflow: hidden;
    }
    
    .jsn-lookup-search {
      display: flex;
      gap: 12px;
      margin-bottom: 12px;
      flex-shrink: 0;
    }
    
    .jsn-lookup-search input {
      flex: 1;
      padding: 12px 16px;
      font-size: 1rem;
      border: 2px solid var(--border);
      border-radius: 8px;
      background: var(--input-bg);
      color: var(--text);
      transition: border-color 0.2s;
    }
    
    .jsn-lookup-search input:focus {
      border-color: var(--accent);
      outline: none;
    }
    
    .jsn-lookup-results {
      display: grid;
      gap: 12px;
    }
    
    .jsn-result-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 16px;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .jsn-result-card:hover {
      border-color: var(--accent);
      box-shadow: 0 2px 8px rgba(0, 184, 148, 0.15);
    }
    
    .jsn-result-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 8px;
    }
    
    .jsn-result-jsn {
      font-weight: 700;
      font-size: 1.1rem;
      color: var(--accent);
    }
    
    .jsn-result-category {
      font-size: 0.75rem;
      padding: 2px 8px;
      border-radius: 4px;
      background: var(--bg-hover);
      color: var(--muted);
    }
    
    .jsn-result-name {
      font-weight: 600;
      margin-bottom: 4px;
    }
    
    .jsn-result-desc {
      font-size: 0.85rem;
      color: var(--muted);
      display: -webkit-box;
      -webkit-line-clamp: 2;
      line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
    
    .jsn-result-specs {
      display: flex;
      gap: 16px;
      margin-top: 8px;
      font-size: 0.8rem;
      color: var(--muted);
    }

    /* JSN Flat List Styles */
    .jsn-lookup-list {
      flex: 1;
      overflow-y: auto;
      border: 1px solid var(--border);
      border-radius: 6px;
      background: var(--bg);
    }
    
    .jsn-list-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px 12px;
      cursor: pointer;
      border-bottom: 1px solid var(--border);
      transition: background 0.15s;
    }
    
    .jsn-list-item:last-child {
      border-bottom: none;
    }
    
    .jsn-list-item:hover {
      background: var(--bg-hover);
    }
    
    .jsn-list-item.selected {
      background: var(--accent);
      color: var(--bg);
    }
    
    .jsn-list-item.selected .jsn-list-jsn {
      color: var(--bg);
    }
    
    .jsn-list-item.selected .jsn-list-name {
      color: var(--bg);
    }
    
    .jsn-list-jsn {
      font-weight: 600;
      font-size: 0.85rem;
      color: var(--primary);
      min-width: 60px;
      flex-shrink: 0;
    }
    
    .jsn-list-name {
      font-size: 0.85rem;
      color: var(--text);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    /* Pagination Styles */
    .jsn-lookup-pagination {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 0;
      margin-top: 8px;
      border-top: 1px solid var(--border);
      flex-shrink: 0;
    }
    
    .jsn-pagination-info {
      font-size: 0.8rem;
      color: var(--muted);
    }
    
    .jsn-pagination-buttons {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .jsn-pagination-buttons button {
      padding: 6px 12px;
      font-size: 0.8rem;
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: 4px;
      color: var(--text);
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .jsn-pagination-buttons button:hover:not(:disabled) {
      background: var(--accent);
      color: var(--bg);
      border-color: var(--accent);
    }
    
    .jsn-pagination-buttons button:disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }
    
    .jsn-pagination-current {
      font-size: 0.8rem;
      color: var(--muted);
      padding: 0 8px;
    }

    /* Logic Portal Styles */
    .logic-card {
      background: var(--bg-card);
      border: 2px solid var(--border);
      border-radius: 8px;
      padding: 20px;
      transition: all 0.2s;
    }

    .logic-card:hover {
      border-color: var(--accent);
      box-shadow: 0 4px 12px rgba(0, 184, 148, 0.2);
    }

    .logic-card-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 15px;
      padding-bottom: 15px;
      border-bottom: 2px solid var(--border);
    }

    .logic-card-title {
      flex: 1;
    }

    .logic-card-code {
      font-weight: bold;
      color: var(--accent);
      font-size: 16px;
      margin-bottom: 5px;
    }

    .logic-card-name {
      color: var(--muted);
      font-size: 14px;
    }

    .logic-fields {
      display: grid;
      gap: 15px;
    }

    .logic-field {
      display: grid;
      grid-template-columns: 150px 1fr;
      gap: 10px;
      align-items: start;
    }

    .logic-field-label {
      font-weight: 600;
      color: var(--text);
      padding-top: 8px;
      font-size: 13px;
    }

    .logic-field-input, .logic-field-textarea {
      padding: 8px 12px;
      border: 2px solid var(--input-border);
      border-radius: 4px;
      font-size: 14px;
      font-family: 'Courier New', monospace;
      background: var(--input-bg);
      color: var(--text);
    }

    .logic-field-input:focus, .logic-field-textarea:focus {
      outline: none;
      border-color: var(--accent);
    }

    .logic-field-textarea {
      min-height: 60px;
      resize: vertical;
    }

    .logic-help-text {
      grid-column: 2;
      font-size: 12px;
      color: var(--muted);
      font-style: italic;
      margin-top: -10px;
    }

    .logic-status {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
    }

    .logic-status.complete {
      background: rgba(0, 184, 148, 0.2);
      color: #00b894;
    }

    .logic-status.partial {
      background: rgba(255, 193, 7, 0.2);
      color: #ffc107;
    }

    .logic-status.empty {
      background: rgba(255, 255, 255, 0.1);
      color: var(--muted);
    }

    .card {
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 16px;
      background-color: var(--bg-card);
      box-shadow: 0 0 12px rgba(0, 0, 0, 0.35);
    }

    .card h2 {
      margin-bottom: 8px;
      font-size: 1.1rem;
    }

    .pill {
      border-radius: 999px;
      padding: 6px 12px;
      margin-right: 8px;
      margin-bottom: 8px;
      border: none;
      cursor: pointer;
      background-color: var(--pill-inactive);
      color: var(--text);
      font-size: 0.75rem;
      transition: background-color 0.15s ease, transform 0.12s ease;
    }

    .pill.active {
      background-color: var(--accent);
    }

    .pill:hover {
      transform: translateY(-1px);
    }

    .pill-group {
      display: flex;
      flex-wrap: wrap;
    }

    .ids-list {
      max-height: 420px;
      overflow-y: auto;
      padding-right: 4px;
    }

    .ids-item {
      margin-bottom: 12px;
      padding-bottom: 12px;
      border-bottom: 1px solid #333;
      font-size: 0.8rem;
    }

    .ids-question {
      font-weight: 600;
      margin-bottom: 4px;
    }

    .ids-input {
      width: 100%;
      padding: 6px;
      border-radius: 4px;
      border: 1px solid var(--input-border);
      background-color: var(--input-bg);
      color: var(--text);
      font-size: 0.8rem;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.8rem;
    }

    th, td {
      padding: 4px 0;
    }

    th {
      text-align: left;
      border-bottom: 1px solid #555;
      padding-bottom: 4px;
      font-weight: 600;
    }

    th.right,
    td.right {
      text-align: right;
    }

    .muted {
      color: var(--muted);
      font-size: 0.9rem;
    }

    code {
      font-family: Menlo, Monaco, Consolas, "Courier New", monospace;
      font-size: 0.8rem;
      background-color: #222;
      padding: 1px 4px;
      border-radius: 3px;
    }

    ul {
      padding-left: 18px;
    }

    li {
      margin-bottom: 4px;
    }

    /* Modal Styles */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.8);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }

    .modal-overlay.active {
      display: flex;
    }

    .modal-content {
      background-color: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 24px;
      max-width: 900px;
      max-height: 80vh;
      overflow-y: auto;
      width: 90%;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      border-bottom: 1px solid var(--border);
      padding-bottom: 12px;
    }

    .modal-close {
      background: none;
      border: none;
      color: var(--text);
      font-size: 1.5rem;
      cursor: pointer;
      padding: 0;
      width: 30px;
      height: 30px;
    }

    .modal-close:hover {
      color: var(--accent);
    }

    .import-options {
      display: flex;
      gap: 12px;
      margin-bottom: 20px;
    }

    .import-option-btn {
      padding: 8px 16px;
      border-radius: 6px;
      border: 1px solid var(--border);
      background-color: var(--pill-inactive);
      color: var(--text);
      cursor: pointer;
      font-size: 0.85rem;
      transition: all 0.15s ease;
    }

    .import-option-btn.active {
      background-color: var(--accent);
      border-color: var(--accent);
    }

    .import-tree {
      max-height: 400px;
      overflow-y: auto;
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 12px;
      background-color: var(--bg);
    }

    .import-tree-item {
      padding: 6px 0;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .import-tree-item input[type="checkbox"] {
      cursor: pointer;
    }

    .import-tree-item label {
      cursor: pointer;
      flex: 1;
    }

    .import-tree-children {
      margin-left: 24px;
    }

    .merge-option {
      margin-top: 16px;
      padding: 12px;
      background-color: var(--bg);
      border: 1px solid var(--border);
      border-radius: 6px;
    }

    .merge-option label {
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      font-size: 0.9rem;
    }

    .btn-primary {
      background-color: var(--accent);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.9rem;
      transition: all 0.15s ease;
    }

    .btn-primary:hover {
      opacity: 0.9;
    }

    .btn-secondary {
      background-color: var(--pill-inactive);
      color: var(--text);
      border: 1px solid var(--border);
      padding: 10px 20px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.9rem;
      transition: all 0.15s ease;
    }

    .btn-secondary:hover {
      background-color: #444;
    }

    .modal-footer {
      margin-top: 20px;
      display: flex;
      justify-content: flex-end;
      gap: 12px;
      padding-top: 12px;
      border-top: 1px solid var(--border);
    }

    .project-name-input {
      width: 100%;
      padding: 8px;
      border-radius: 4px;
      border: 1px solid var(--input-border);
      background-color: var(--input-bg);
      color: var(--text);
      font-size: 0.9rem;
      margin-bottom: 16px;
    }

    .add-to-project-btn {
      margin-top: 12px;
      width: 100%;
      background-color: var(--accent);
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.85rem;
      transition: all 0.15s ease;
    }

    .add-to-project-btn:hover {
      opacity: 0.9;
    }

    .tree-search-box {
      width: 100%;
      padding: 8px 12px;
      background: var(--input-bg);
      border: 1px solid var(--input-border);
      border-radius: 6px;
      color: var(--text);
      font-size: 0.9rem;
      margin-top: 12px;
      margin-bottom: 0;
    }

    .tree-search-box:focus {
      outline: none;
      border-color: var(--accent);
    }

    .tree-item.search-match {
      background-color: rgba(0, 184, 148, 0.1);
    }

    .tree-item.search-highlight {
      background-color: rgba(0, 184, 148, 0.3);
    }

    /* Room Logic Indicators */
    .logic-badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      font-size: 0.7rem;
      padding: 2px 8px;
      border-radius: 12px;
      font-weight: 600;
      margin-left: 8px;
      vertical-align: middle;
    }

    .logic-badge.enabled {
      background: linear-gradient(135deg, #00b894 0%, #00cec9 100%);
      color: white;
      box-shadow: 0 2px 4px rgba(0, 184, 148, 0.3);
    }

    .logic-badge.disabled {
      background: var(--pill-inactive);
      color: var(--muted);
      border: 1px solid var(--border);
    }

    .logic-badge::before {
      content: "";
      width: 6px;
      height: 6px;
      border-radius: 50%;
      display: inline-block;
    }

    .logic-badge.enabled::before {
      background: white;
      box-shadow: 0 0 4px rgba(255, 255, 255, 0.8);
    }

    .logic-badge.disabled::before {
      background: var(--muted);
    }

    .import-tree-item.has-logic {
      border-left: 3px solid #00b894;
      padding-left: 12px;
    }

    .import-tree-item.no-logic {
      opacity: 0.7;
    }

    /* Logic Toggle Switch */
    .logic-toggle-switch {
      position: relative;
      display: inline-block !important;
      width: 24px !important;
      height: 14px !important;
      margin-left: 4px !important;
      margin-right: 4px !important;
      vertical-align: middle;
      flex-shrink: 0;
      min-width: 24px !important;
      max-width: 24px !important;
    }

    .logic-toggle-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .logic-toggle-slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: var(--pill-inactive);
      border: 1px solid var(--border);
      transition: .3s;
      border-radius: 14px;
    }

    .logic-toggle-slider:before {
      position: absolute;
      content: "";
      height: 10px;
      width: 10px;
      left: 2px;
      bottom: 1px;
      background-color: white;
      transition: .3s;
      border-radius: 50%;
    }

    .logic-toggle-switch input:checked + .logic-toggle-slider {
      background: linear-gradient(135deg, #00b894 0%, #00cec9 100%);
      border-color: #00b894;
    }

    .logic-toggle-switch input:checked + .logic-toggle-slider:before {
      transform: translateX(10px);
    }

    .logic-toggle-switch:hover .logic-toggle-slider {
      box-shadow: 0 0 8px rgba(0, 184, 148, 0.4);
    }

    /* Department Input Modal */
    .input-modal {
      background: var(--bg-card);
      padding: 20px;
      border-radius: 8px;
      margin-top: 16px;
      border: 1px solid var(--border);
    }

    .input-field {
      margin-bottom: 16px;
    }

    .input-field label {
      display: block;
      margin-bottom: 6px;
      font-weight: 500;
      color: var(--text);
    }

    .input-field input[type="number"],
    .input-field input[type="text"] {
      width: 100%;
      padding: 10px;
      background: var(--input-bg);
      border: 1px solid var(--input-border);
      border-radius: 6px;
      color: var(--text);
      font-size: 0.95rem;
    }

    .input-field .help-text {
      font-size: 0.85rem;
      color: var(--muted);
      margin-top: 4px;
    }

    .calculation-result {
      background: rgba(0, 184, 148, 0.1);
      border-left: 3px solid var(--accent);
      padding: 12px;
      border-radius: 4px;
      margin-top: 16px;
    }

    .calculation-result h4 {
      color: var(--accent);
      margin-bottom: 8px;
      font-size: 0.9rem;
    }

    .calculation-summary {
      font-size: 0.85rem;
      color: var(--muted);
    }

    /* Workbench Mode */
    #workbench-container {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: #1a1a2e;
      z-index: 9999;
      display: none;
      flex-direction: column;
    }

    #workbench-container.active {
      display: flex;
    }

    #workbench-header {
      background: rgba(26, 26, 46, 0.95);
      border-bottom: 2px solid #64c8ff;
      padding: 16px 24px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    #workbench-header h2 {
      color: #64c8ff;
      font-family: 'Courier New', monospace;
      font-size: 1.5rem;
      margin: 0;
      text-shadow: 0 0 10px rgba(100, 200, 255, 0.5);
    }

    #workbench-controls {
      display: flex;
      gap: 12px;
    }

    .workbench-btn {
      background: rgba(100, 200, 255, 0.2);
      border: 2px solid #64c8ff;
      color: #64c8ff;
      padding: 8px 16px;
      border-radius: 4px;
      cursor: pointer;
      font-family: 'Courier New', monospace;
      font-size: 0.9rem;
      transition: all 0.2s;
    }

    .workbench-btn:hover {
      background: rgba(100, 200, 255, 0.4);
      box-shadow: 0 0 15px rgba(100, 200, 255, 0.5);
    }

    .workbench-btn.danger {
      border-color: #ff6b6b;
      color: #ff6b6b;
      background: rgba(255, 107, 107, 0.2);
    }

    .workbench-btn.danger:hover {
      background: rgba(255, 107, 107, 0.4);
      box-shadow: 0 0 15px rgba(255, 107, 107, 0.5);
    }

    #workbench-canvas-container {
      flex: 1;
      position: relative;
      overflow: hidden;
    }

    #workbench-canvas {
      display: block;
      width: 100%;
      height: 100%;
      image-rendering: pixelated;
    }

    #workbench-legend {
      position: absolute;
      bottom: 20px;
      right: 20px;
      background: rgba(26, 26, 46, 0.95);
      border: 2px solid #64c8ff;
      border-radius: 8px;
      padding: 16px;
      font-family: 'Courier New', monospace;
      color: #64c8ff;
      font-size: 0.85rem;
      max-width: 300px;
    }

    #workbench-legend h4 {
      margin: 0 0 12px 0;
      color: #feca57;
      text-shadow: 0 0 10px rgba(254, 202, 87, 0.5);
    }

    .legend-section {
      margin-bottom: 16px;
    }

    .legend-section:last-child {
      margin-bottom: 0;
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 12px;
      margin: 8px 0;
    }

    .legend-color-box {
      width: 32px;
      height: 32px;
      border: 1px solid #64c8ff;
      border-radius: 4px;
      flex-shrink: 0;
    }

    .legend-pattern-box {
      width: 32px;
      height: 32px;
      border: 1px solid #64c8ff;
      border-radius: 4px;
      flex-shrink: 0;
      background: #fff;
      position: relative;
    }

    .pattern-dots {
      background-image: radial-gradient(circle, #000 2px, transparent 2px);
      background-size: 8px 8px;
    }

    .pattern-diagonal {
      background: repeating-linear-gradient(45deg, transparent, transparent 4px, #000 4px, #000 5px);
    }

    .pattern-crosshatch {
      background: 
        repeating-linear-gradient(45deg, transparent, transparent 4px, rgba(0,0,0,0.5) 4px, rgba(0,0,0,0.5) 5px),
        repeating-linear-gradient(-45deg, transparent, transparent 4px, rgba(0,0,0,0.5) 4px, rgba(0,0,0,0.5) 5px);
    }

    .pattern-horizontal {
      background: repeating-linear-gradient(0deg, transparent, transparent 4px, #000 4px, #000 5px);
    }

    .pattern-vertical {
      background: repeating-linear-gradient(90deg, transparent, transparent 4px, #000 4px, #000 5px);
    }
  </style>
</head>
<body>
  <header>
    <div class="header-content">
      <h1>Hospital Programming Workbench</h1>
      <p>
        A web-based tool for building hospital project programs from equipment guide data.
        Import departments, functional areas, and rooms with equipment to create your project.
      </p>
    </div>
    <div class="header-actions">
      <div id="revit-status" class="revit-status-indicator" title="Revit Connection Status">
        <span class="status-dot disconnected"></span>
        <span class="status-text">Revit</span>
      </div>
      <button class="icon-btn ifc-checker" onclick="openIFCChecker()" title="IFC Model Checker" style="background: linear-gradient(135deg, #6c5ce7 0%, #a29bfe 100%);">üèóÔ∏è</button>
      <button class="icon-btn portal" onclick="openLogicPortal()" title="Logic Portal">‚öôÔ∏è</button>
      <button class="icon-btn sync" onclick="openDataSyncModal()" title="Sync Data">üîÑ</button>
      <button class="icon-btn workbench" id="workbench-toggle" onclick="toggleWorkbench()" title="3D Workbench">üßä</button>
    </div>
  </header>

  <!-- Workbench Mode Overlay -->
  <div id="workbench-container">
    <div id="workbench-header">
      <h2>‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê WORKBENCH v1.0 ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó</h2>
      <div id="workbench-controls">
        <button class="workbench-btn" onclick="workbenchToggleView()" id="view-toggle-btn">üìê 45¬∞/45¬∞ View</button>
        <button class="workbench-btn" onclick="workbenchAutoArrange()">üéØ Auto-Arrange</button>
        <button class="workbench-btn" onclick="workbenchReload()">üîÑ Reload</button>
        <button class="workbench-btn" onclick="workbenchSetBackground('pixel-art')">üé® Pixel Art</button>
        <button class="workbench-btn" onclick="workbenchSetBackground('terminal')">üíª Terminal</button>
        <button class="workbench-btn" onclick="workbenchSetBackground('minimal')">‚ö™ Minimal</button>
        <button class="workbench-btn danger" onclick="toggleWorkbench()">‚úï Close</button>
      </div>
    </div>
    <div id="workbench-canvas-container">
      <canvas id="workbench-canvas" width="1600" height="900"></canvas>
      <div id="workbench-legend">
        <h4>‚ïê‚ïê‚ïê LEGEND ‚ïê‚ïê‚ïê</h4>
        
        <div class="legend-section">
          <strong>Department Colors:</strong>
          <div class="legend-item">
            <div class="legend-color-box" style="background: #FFB3BA;"></div>
            <span>Inpatient</span>
          </div>
          <div class="legend-item">
            <div class="legend-color-box" style="background: #BAFFC9;"></div>
            <span>Clinical</span>
          </div>
          <div class="legend-item">
            <div class="legend-color-box" style="background: #BAE1FF;"></div>
            <span>Support</span>
          </div>
          <div class="legend-item">
            <div class="legend-color-box" style="background: #FFFFBA;"></div>
            <span>Admin</span>
          </div>
        </div>

        <div class="legend-section">
          <strong>Functional Area Patterns:</strong>
          <div class="legend-item">
            <div class="legend-pattern-box pattern-dots"></div>
            <span>Reception</span>
          </div>
          <div class="legend-item">
            <div class="legend-pattern-box pattern-diagonal"></div>
            <span>Patient Area</span>
          </div>
          <div class="legend-item">
            <div class="legend-pattern-box pattern-crosshatch"></div>
            <span>Treatment</span>
          </div>
          <div class="legend-item">
            <div class="legend-pattern-box pattern-horizontal"></div>
            <span>Staff/Admin</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <main class="layout">
    <!-- LEFT COLUMN: Tree Navigation -->
    <section id="left-column">
      <div class="tree-container">
        <div class="tree-header" id="tree-header">
          <div class="tree-header-top">
            <div class="tree-header-title">
              <button class="back-to-projects-btn" id="return-to-projects-btn" onclick="returnToProjectList()" style="display: none;">‚Üê Projects</button>
              <h2 style="font-size: 1.1rem; margin: 0;" id="nav-title">Navigator</h2>
            </div>
          </div>
          <div class="mode-toggle" id="mode-toggle">
            <button class="mode-btn active" data-mode="program" onclick="switchMode('program')">Program Mode</button>
            <button class="mode-btn" data-mode="reference" onclick="switchMode('reference')">Reference Mode</button>
            <button class="mode-btn" data-mode="jsn-lookup" onclick="switchMode('jsn-lookup')">JSN Lookup</button>
            <button class="mode-btn" data-mode="compare" onclick="switchMode('compare')">Compare Mode</button>
          </div>
          <input type="text" id="tree-search-box" class="tree-search-box" placeholder="üîç Search rooms, departments..." oninput="filterTreeDebounced()" style="display: none;" />
        </div>
        <button class="add-to-project-btn" id="add-to-project-btn" onclick="openImportModal()" style="display: none;">+ Add to Project</button>
        <div id="tree-view"></div>
      </div>
    </section>

    <!-- RIGHT COLUMN: Detail View -->
    <section id="right-column">
      <div id="detail-view"></div>
    </section>

    <!-- COMPARE MODE: Second Column -->
    <section id="compare-column">
      <div id="compare-view"></div>
    </section>
  </main>

  <!-- Password Modal -->
  <div id="password-modal" class="modal-overlay">
    <div class="modal-content" style="max-width: 400px;">
      <div class="modal-header">
        <h2>üîê Logic Portal Access</h2>
        <button class="modal-close" onclick="closePasswordModal()">&times;</button>
      </div>
      <div style="padding: 20px;">
        <p style="margin-bottom: 20px; color: var(--muted);">Enter password to access the Room Logic Management Portal</p>
        <input type="password" id="portal-password" placeholder="Enter password" 
               style="width: 100%; padding: 12px; font-size: 16px; border: 2px solid var(--border); border-radius: 6px; background: var(--input-bg); color: var(--text);"
               onkeypress="if(event.key === 'Enter') checkPassword()">
        <div id="password-error" style="color: #e74c3c; margin-top: 10px; display: none;">‚ùå Incorrect password</div>
      </div>
      <div class="modal-footer">
        <button class="btn-secondary" onclick="closePasswordModal()">Cancel</button>
        <button class="btn-primary" onclick="checkPassword()">Enter Portal</button>
      </div>
    </div>
  </div>

  <!-- Logic Portal Modal -->
  <div id="logic-portal-modal" class="modal-overlay">
    <div class="modal-content" style="max-width: 1400px; max-height: 90vh;">
      <div class="modal-header">
        <h2>‚öôÔ∏è Room Logic Management Portal</h2>
        <button class="modal-close" onclick="closeLogicPortal()">&times;</button>
      </div>
      <div style="padding: 20px; overflow-y: auto; max-height: calc(90vh - 160px);">
        <div style="display: flex; gap: 20px; margin-bottom: 20px; align-items: center;">
          <input type="text" id="logic-search-box" placeholder="üîç Search rooms by code or name..."
                 style="flex: 1; padding: 12px; font-size: 14px; border: 2px solid var(--border); border-radius: 6px; background: var(--input-bg); color: var(--text);"
                 oninput="filterLogicRooms()">
          <button onclick="saveAllLogic()" class="btn-primary" style="white-space: nowrap;">üíæ Save All Changes</button>
          <button onclick="exportLogic()" class="btn-secondary" style="white-space: nowrap;">üì• Export</button>
        </div>
        
        <div id="logic-rooms-list" style="display: grid; gap: 15px;">
          <!-- Room logic cards will be inserted here -->
        </div>
      </div>
    </div>
  </div>

  <!-- Import Modal -->
  <div id="import-modal" class="modal-overlay">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Add to Project</h2>
        <button class="modal-close" onclick="closeImportModal()">&times;</button>
      </div>
      <div id="import-modal-body">
        <p class="muted">Expand the tree and check items to add to your project. Departments with <span class="logic-badge enabled" style="display: inline-flex; font-size: 0.7rem;">‚ö° LOGIC</span> have automated room calculation available.</p>
        <div style="margin-bottom: 12px;">
          <input type="text" id="import-search" placeholder="Search departments, functional areas, or rooms..." style="width: 100%; padding: 8px; border: 1px solid var(--border); border-radius: 4px; font-size: 0.95rem;" oninput="filterImportTree()" />
        </div>
        <div id="import-tree-container" class="import-tree"></div>
        <div class="merge-option">
          <label>
            <input type="checkbox" id="merge-on-import" checked />
            <span>Merge with existing items at same level (uncheck to create duplicates)</span>
          </label>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn-secondary" onclick="closeImportModal()">Cancel</button>
        <button class="btn-primary" onclick="confirmImport()">Add Selected</button>
      </div>
    </div>
  </div>

  <!-- Department Logic Modal -->
  <div id="department-logic-modal" class="modal-overlay">
    <div class="modal-content" style="max-width: 700px;">
      <div class="modal-header">
        <h2 id="logic-modal-title">Add Department with Room Logic</h2>
        <button class="modal-close" onclick="closeDepartmentLogicModal()">&times;</button>
      </div>
      <div style="padding: 20px;">
        <div id="logic-modal-content">
          <!-- Dynamic content will be inserted here -->
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn-secondary" onclick="closeDepartmentLogicModal()">Cancel</button>
        <button class="btn-primary" id="calculate-rooms-btn" onclick="calculateAndAddDepartment()" style="display: none;">Calculate & Add to Project</button>
      </div>
    </div>
  </div>

  <!-- Equipment Selection Modal -->
  <div id="equipment-modal" class="modal-overlay">
    <div class="modal-content" style="max-width: 700px;">
      <div class="modal-header">
        <h2>Add Equipment to Room</h2>
        <button class="modal-close" onclick="closeEquipmentModal()">&times;</button>
      </div>
      <div style="padding: 20px;">
        <div style="margin-bottom: 16px;">
          <input type="text" id="equipment-search" placeholder="Search by JSN, name, or description..." style="width: 100%; padding: 8px; border: 1px solid var(--border); border-radius: 4px; font-size: 0.95rem;" oninput="filterEquipmentList()" />
        </div>
        <div id="equipment-list" style="max-height: 400px; overflow-y: auto; border: 1px solid var(--border); border-radius: 4px;">
          <!-- Equipment items will be populated here -->
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn-secondary" onclick="closeEquipmentModal()">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Equipment Detail Popup Modal -->
  <div id="equipment-detail-modal" class="modal-overlay">
    <div class="modal-content" style="max-width: 800px; max-height: 90vh; overflow-y: auto;">
      <div class="modal-header">
        <h2 id="equipment-detail-title">Equipment Details</h2>
        <button class="modal-close" onclick="closeEquipmentDetailModal()">&times;</button>
      </div>
      <div id="equipment-detail-content" style="padding: 20px;">
        <!-- Equipment details will be populated here -->
      </div>
      <div class="modal-footer">
        <button class="btn-secondary" onclick="closeEquipmentDetailModal()">Close</button>
      </div>
    </div>
  </div>

  <!-- Report Generation Modal -->
  <div id="report-modal" class="modal-overlay">
    <div class="modal-content" style="max-width: 500px;">
      <div class="modal-header">
        <h2>üìÑ Generate Project Report</h2>
        <button class="modal-close" onclick="closeReportModal()">&times;</button>
      </div>
      <div style="padding: 20px;">
        <p style="margin-bottom: 16px; color: var(--muted);">Select report format and type:</p>
        
        <!-- Format Selection -->
        <div style="margin-bottom: 16px;">
          <label style="display: block; margin-bottom: 8px; font-weight: 600;">Export Format:</label>
          <div style="display: flex; gap: 8px;">
            <label style="flex: 1; display: flex; align-items: center; padding: 10px; border: 2px solid var(--accent); border-radius: 6px; cursor: pointer; background: var(--bg);" id="format-pdf-label">
              <input type="radio" name="report-format" value="pdf" checked onchange="updateReportFormatUI()" style="margin-right: 8px;">
              <span>üìÑ PDF</span>
            </label>
            <label style="flex: 1; display: flex; align-items: center; padding: 10px; border: 2px solid var(--border); border-radius: 6px; cursor: pointer; background: var(--bg);" id="format-tsv-label">
              <input type="radio" name="report-format" value="tsv" onchange="updateReportFormatUI()" style="margin-right: 8px;">
              <span>üìä TSV</span>
            </label>
          </div>
        </div>
        
        <!-- PDF Report Types -->
        <div id="pdf-report-options" style="margin-bottom: 24px;">
          <label style="display: block; margin-bottom: 12px; cursor: pointer; padding: 12px; border: 2px solid var(--accent); border-radius: 6px; transition: all 0.2s;" onmouseover="this.style.borderColor='var(--accent)'" onmouseout="if(!this.querySelector('input').checked) this.style.borderColor='var(--border)'">
            <input type="radio" name="report-type" value="equipment" checked onchange="document.querySelectorAll('[name=report-type]').forEach(r => r.parentElement.style.borderColor = 'var(--border)'); this.parentElement.style.borderColor = 'var(--accent)';" style="margin-right: 8px;">
            <strong>Equipment Focus</strong>
            <div style="font-size: 0.85rem; color: var(--muted); margin-top: 4px; margin-left: 24px;">Lists all equipment for each room with JSN codes, quantities, and descriptions</div>
          </label>
          
          <label style="display: block; cursor: pointer; padding: 12px; border: 2px solid var(--border); border-radius: 6px; transition: all 0.2s;" onmouseover="this.style.borderColor='var(--accent)'" onmouseout="if(!this.querySelector('input').checked) this.style.borderColor='var(--border)'">
            <input type="radio" name="report-type" value="attributes" onchange="document.querySelectorAll('[name=report-type]').forEach(r => r.parentElement.style.borderColor = 'var(--border)'); this.parentElement.style.borderColor = 'var(--accent)';" style="margin-right: 8px;">
            <strong>Room Attributes Focus</strong>
            <div style="font-size: 0.85rem; color: var(--muted); margin-top: 4px; margin-left: 24px;">Shows detailed room specifications including HVAC, materials, utilities, and environmental requirements</div>
          </label>
        </div>
        
        <!-- TSV Report Types -->
        <div id="tsv-report-options" style="margin-bottom: 24px; display: none;">
          <label style="display: block; margin-bottom: 12px; cursor: pointer; padding: 12px; border: 2px solid var(--accent); border-radius: 6px; transition: all 0.2s;" id="tsv-simple-label">
            <input type="radio" name="tsv-type" value="simple" checked onchange="updateTsvTypeUI()" style="margin-right: 8px;">
            <strong>Simple Equipment List</strong>
            <div style="font-size: 0.85rem; color: var(--muted); margin-top: 4px; margin-left: 24px;">JSN, Name, Quantity, Acquisition Code, Description - organized by Dept/FA/Room</div>
          </label>
          
          <label style="display: block; cursor: pointer; padding: 12px; border: 2px solid var(--border); border-radius: 6px; transition: all 0.2s;" id="tsv-expanded-label">
            <input type="radio" name="tsv-type" value="expanded" onchange="updateTsvTypeUI()" style="margin-right: 8px;">
            <strong>Expanded Equipment List</strong>
            <div style="font-size: 0.85rem; color: var(--muted); margin-top: 4px; margin-left: 24px;">All equipment attributes including cost, dimensions, power requirements, and more</div>
          </label>
        </div>

        <div style="margin-bottom: 16px;" id="pdf-summary-option">
          <label style="display: flex; align-items: center; cursor: pointer;">
            <input type="checkbox" id="include-summary" checked style="margin-right: 8px;">
            <span>Include project summary page</span>
          </label>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn-secondary" onclick="closeReportModal()">Cancel</button>
        <button class="btn-primary" id="generate-report-btn" onclick="generateReport()">üì• Generate PDF</button>
      </div>
    </div>
  </div>

  <!-- Data Sync Modal -->
  <div id="data-sync-modal" class="modal-overlay">
    <div class="modal-content" style="max-width: 600px;">
      <div class="modal-header">
        <h2>üîÑ Sync Data from GitHub</h2>
        <button class="modal-close" onclick="closeDataSyncModal()">&times;</button>
      </div>
      <div style="padding: 20px;">
        <p style="margin-bottom: 20px; color: var(--muted);">Update room and equipment data from the latest source files in your GitHub repository.</p>
        
        <div style="background: var(--bg); border: 1px solid var(--border); border-radius: 6px; padding: 16px; margin-bottom: 20px;">
          <h4 style="margin-bottom: 12px;">Repository Configuration</h4>
          <div style="margin-bottom: 12px;">
            <label style="display: block; margin-bottom: 4px; font-size: 0.9rem;">GitHub Repository (owner/repo)</label>
            <input type="text" id="github-repo" placeholder="LeCartier/Arrange" value="LeCartier/Arrange"
                   style="width: 100%; padding: 8px; background: var(--input-bg); border: 1px solid var(--input-border); color: var(--text); border-radius: 4px;">
          </div>
          <div style="margin-bottom: 12px;">
            <label style="display: block; margin-bottom: 4px; font-size: 0.9rem;">Branch</label>
            <input type="text" id="github-branch" placeholder="main" value="main"
                   style="width: 100%; padding: 8px; background: var(--input-bg); border: 1px solid var(--input-border); color: var(--text); border-radius: 4px;">
          </div>
        </div>

        <div style="background: #1a3a1a; border: 1px solid #2a5a2a; border-radius: 6px; padding: 12px; margin-bottom: 16px;">
          <div style="font-size: 0.85rem; color: #90ee90;">
            <strong>üìã Files to Sync:</strong>
            <ul style="margin: 8px 0 0 20px; line-height: 1.8;">
              <li>src/room_criteria.tsv ‚Üí Updates room specifications</li>
              <li>src/Equipment_Guide_parsed_v2.txt ‚Üí Updates equipment catalog</li>
            </ul>
          </div>
        </div>

        <div id="sync-status" style="min-height: 60px; padding: 12px; background: var(--bg); border: 1px solid var(--border); border-radius: 4px; font-size: 0.85rem; font-family: monospace; overflow-y: auto; max-height: 200px;">
          <div style="color: var(--muted);">Ready to sync...</div>
        </div>

        <div style="margin-top: 16px;">
          <label style="display: flex; align-items: center; cursor: pointer; padding: 8px; background: var(--bg); border-radius: 4px;">
            <input type="checkbox" id="backup-before-sync" checked style="margin-right: 8px;">
            <span style="font-size: 0.9rem;">Create backup of current data before syncing</span>
          </label>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn-secondary" onclick="closeDataSyncModal()">Cancel</button>
        <button class="btn-primary" onclick="syncDataFromGitHub()" style="background: linear-gradient(135deg, #00b894 0%, #00cec9 100%);">üîÑ Sync Now</button>
      </div>
    </div>
  </div>

  <!-- Replace Room Modal -->
  <div id="replace-room-modal" class="modal-overlay">
    <div class="modal-content" style="max-width: 800px; max-height: 90vh;">
      <div class="modal-header">
        <h2>üîÑ Replace Room</h2>
        <button class="modal-close" onclick="closeReplaceRoomModal()">&times;</button>
      </div>
      <div style="padding: 20px; overflow-y: auto; max-height: calc(90vh - 160px);">
        <p style="margin-bottom: 16px; color: var(--muted);">Select a room from the reference library to replace the current room. Choose which properties to import.</p>
        
        <!-- Import Options -->
        <div style="background: var(--bg); border: 1px solid var(--border); border-radius: 8px; padding: 16px; margin-bottom: 20px;">
          <h4 style="margin: 0 0 12px 0;">Import Options</h4>
          <div style="display: flex; flex-direction: column; gap: 12px;">
            <label style="display: flex; align-items: center; cursor: pointer;">
              <input type="checkbox" id="replace-name-sf" checked style="margin-right: 10px; width: 18px; height: 18px;">
              <div>
                <strong>Name & Square Footage</strong>
                <div style="font-size: 0.85rem; color: var(--muted);">Import room name and NSF from selected room</div>
              </div>
            </label>
            <label style="display: flex; align-items: center; cursor: pointer;">
              <input type="checkbox" id="replace-attributes" checked style="margin-right: 10px; width: 18px; height: 18px;">
              <div>
                <strong>Room Attributes</strong>
                <div style="font-size: 0.85rem; color: var(--muted);">Import all finishes, HVAC, medical gases, plumbing, etc.</div>
              </div>
            </label>
            <label style="display: flex; align-items: center; cursor: pointer;">
              <input type="checkbox" id="replace-equipment" checked style="margin-right: 10px; width: 18px; height: 18px;">
              <div>
                <strong>Equipment</strong>
                <div style="font-size: 0.85rem; color: var(--muted);">Replace equipment list with selected room's equipment</div>
              </div>
            </label>
          </div>
        </div>
        
        <!-- Room Search -->
        <div style="margin-bottom: 16px;">
          <input type="text" id="replace-room-search" placeholder="Search rooms by code or name..." 
            style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px; font-size: 1rem; background: var(--input-bg); color: var(--text);" 
            oninput="filterReplaceRoomList()" />
        </div>
        
        <!-- Room List -->
        <div id="replace-room-list" style="max-height: 350px; overflow-y: auto; border: 1px solid var(--border); border-radius: 8px;">
          <!-- Room items will be populated here -->
        </div>
        
        <!-- Selected Room Preview -->
        <div id="replace-room-preview" style="display: none; margin-top: 16px; padding: 16px; background: rgba(0, 184, 148, 0.1); border: 1px solid var(--accent); border-radius: 8px;">
          <h4 style="margin: 0 0 8px 0; color: var(--accent);">Selected Room:</h4>
          <div id="replace-room-preview-content"></div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn-secondary" onclick="closeReplaceRoomModal()">Cancel</button>
        <button class="btn-primary" id="confirm-replace-room-btn" onclick="confirmReplaceRoom()" disabled>Replace Room</button>
      </div>
    </div>
  </div>

  <!-- File Import Modal -->
  <div id="file-import-modal" class="modal-overlay">
    <div class="modal-content" style="max-width: 900px; max-height: 90vh;">
      <div class="modal-header">
        <h2>üì• Import Rooms from File</h2>
        <button class="modal-close" onclick="closeFileImportModal()">&times;</button>
      </div>
      <div style="padding: 20px; overflow-y: auto; max-height: calc(90vh - 160px);">
        <p style="margin-bottom: 16px; color: var(--muted);">Import rooms from an Excel (.xlsx, .xls), CSV, or TSV file. Each row should represent one room.</p>
        
        <!-- File Upload -->
        <div style="background: var(--bg); border: 2px dashed var(--border); border-radius: 8px; padding: 24px; text-align: center; margin-bottom: 20px; cursor: pointer; transition: all 0.2s;" 
             id="file-drop-zone"
             onclick="document.getElementById('import-file-input').click()"
             ondragover="event.preventDefault(); this.style.borderColor='var(--accent)'; this.style.background='rgba(0,184,148,0.1)';"
             ondragleave="this.style.borderColor='var(--border)'; this.style.background='var(--bg)';"
             ondrop="handleFileDrop(event)">
          <div style="font-size: 2rem; margin-bottom: 8px;">üìÅ</div>
          <div style="font-weight: 600; margin-bottom: 4px;">Drop file here or click to browse</div>
          <div style="font-size: 0.85rem; color: var(--muted);">Supports Excel (.xlsx, .xls), CSV, and TSV files</div>
          <input type="file" id="import-file-input" accept=".xlsx,.xls,.csv,.tsv,.txt" style="display: none;" onchange="handleFileSelect(event)">
        </div>
        
        <!-- Column Mapping -->
        <div id="column-mapping-section" style="display: none;">
          <h4 style="margin: 0 0 12px 0;">üìã Column Mapping</h4>
          
          <!-- Header Row Selector -->
          <div style="background: var(--bg); border: 1px solid var(--border); border-radius: 8px; padding: 12px; margin-bottom: 16px;">
            <div style="display: flex; align-items: center; gap: 12px;">
              <label style="font-weight: 600; white-space: nowrap;">Header Row:</label>
              <select id="header-row-select" style="flex: 1; max-width: 200px; padding: 8px; background: var(--input-bg); border: 1px solid var(--input-border); color: var(--text); border-radius: 4px;" onchange="updateHeaderRow()">
                <!-- Options populated dynamically -->
              </select>
              <span style="font-size: 0.85rem; color: var(--muted);">Select the row containing column headers</span>
            </div>
            <div id="header-row-preview" style="margin-top: 8px; font-size: 0.8rem; color: var(--muted); font-family: monospace; white-space: nowrap; overflow-x: auto; padding: 4px 0;"></div>
          </div>
          
          <p style="font-size: 0.85rem; color: var(--muted); margin-bottom: 12px;">Map your file columns to the required fields:</p>
          
          <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-bottom: 20px;">
            <div>
              <label style="display: block; margin-bottom: 4px; font-weight: 600;">Department <span style="color: #e74c3c;">*</span></label>
              <select id="col-department" style="width: 100%; padding: 8px; background: var(--input-bg); border: 1px solid var(--input-border); color: var(--text); border-radius: 4px;">
                <option value="">-- Select Column --</option>
              </select>
            </div>
            <div>
              <label style="display: block; margin-bottom: 4px; font-weight: 600;">Functional Area <span style="color: #e74c3c;">*</span></label>
              <select id="col-functional-area" style="width: 100%; padding: 8px; background: var(--input-bg); border: 1px solid var(--input-border); color: var(--text); border-radius: 4px;">
                <option value="">-- Select Column --</option>
              </select>
            </div>
            <div>
              <label style="display: block; margin-bottom: 4px; font-weight: 600;">Room Name <span style="color: #e74c3c;">*</span></label>
              <select id="col-room-name" style="width: 100%; padding: 8px; background: var(--input-bg); border: 1px solid var(--input-border); color: var(--text); border-radius: 4px;">
                <option value="">-- Select Column --</option>
              </select>
            </div>
            <div>
              <label style="display: block; margin-bottom: 4px; font-weight: 600;">Square Footage (NSF)</label>
              <select id="col-nsf" style="width: 100%; padding: 8px; background: var(--input-bg); border: 1px solid var(--input-border); color: var(--text); border-radius: 4px;">
                <option value="">-- Select Column (optional) --</option>
              </select>
            </div>
            <div>
              <label style="display: block; margin-bottom: 4px; font-weight: 600;">Room Code</label>
              <select id="col-room-code" style="width: 100%; padding: 8px; background: var(--input-bg); border: 1px solid var(--input-border); color: var(--text); border-radius: 4px;">
                <option value="">-- Select Column (optional) --</option>
              </select>
            </div>
            <div>
              <label style="display: block; margin-bottom: 4px; font-weight: 600;">Quantity</label>
              <select id="col-quantity" style="width: 100%; padding: 8px; background: var(--input-bg); border: 1px solid var(--input-border); color: var(--text); border-radius: 4px;">
                <option value="">-- Select Column (optional) --</option>
              </select>
            </div>
            <div>
              <label style="display: block; margin-bottom: 4px; font-weight: 600;">Room Number</label>
              <select id="col-room-number" style="width: 100%; padding: 8px; background: var(--input-bg); border: 1px solid var(--input-border); color: var(--text); border-radius: 4px;">
                <option value="">-- Select Column (optional) --</option>
              </select>
            </div>
          </div>
          
          <!-- Import Options -->
          <div style="background: var(--bg); border: 1px solid var(--border); border-radius: 8px; padding: 16px; margin-bottom: 20px;">
            <h4 style="margin: 0 0 12px 0;">‚öôÔ∏è Import Options</h4>
            <label style="display: flex; align-items: center; cursor: pointer; margin-bottom: 8px;">
              <input type="checkbox" id="import-merge-existing" checked style="margin-right: 10px; width: 18px; height: 18px;">
              <div>
                <strong>Merge with existing project</strong>
                <div style="font-size: 0.85rem; color: var(--muted);">Add rooms to existing departments/functional areas if they match</div>
              </div>
            </label>
            <label style="display: flex; align-items: center; cursor: pointer;">
              <input type="checkbox" id="import-lookup-equipment" checked style="margin-right: 10px; width: 18px; height: 18px;">
              <div>
                <strong>Auto-lookup equipment</strong>
                <div style="font-size: 0.85rem; color: var(--muted);">Try to match room codes and add standard equipment from reference library</div>
              </div>
            </label>
          </div>
          
          <!-- Data Preview -->
          <h4 style="margin: 0 0 12px 0;">üëÅÔ∏è Data Preview (first 10 rows)</h4>
          <div id="import-data-preview" style="max-height: 250px; overflow: auto; border: 1px solid var(--border); border-radius: 8px; font-size: 0.85rem;">
            <!-- Preview table will be rendered here -->
          </div>
          
          <!-- Import Summary -->
          <div id="import-summary" style="margin-top: 16px; padding: 12px; background: rgba(0, 184, 148, 0.1); border: 1px solid var(--accent); border-radius: 8px; display: none;">
            <h4 style="margin: 0 0 8px 0; color: var(--accent);">üìä Import Summary</h4>
            <div id="import-summary-content"></div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn-secondary" onclick="closeFileImportModal()">Cancel</button>
        <button class="btn-primary" id="confirm-file-import-btn" onclick="confirmFileImport()" disabled>Import Rooms</button>
      </div>
    </div>
  </div>

  <script src="equipment-data-part1.js"></script>
  <script src="src/equipment-attributes.js"></script>
  <script src="equipment-data-part2.js"></script>
  <script src="room-sizes.js"></script>
  <script src="src/finish-room-data.js"></script>
  <script>
    // Merge finish-only rooms into ROOM_SIZES for complete coverage
    if (typeof FINISH_ONLY_ROOMS !== 'undefined') {
      ROOM_SIZES.push(...FINISH_ONLY_ROOMS);
      console.log(`Merged finish-only rooms. Total rooms now: ${ROOM_SIZES.length}`);
    }
  </script>
  <script src="workbench.js"></script>
  <script>
    // Build room code to department/FA mapping from equipment guide
    console.log('Building room metadata...');
    
    // Create a map of roomCode -> {department, functionalArea, roomName}
    const roomMetadata = new Map();
    
    // Parse the Equipment_Guide_parsed_v2.txt data to extract room metadata
    // The equipment mappings were generated from that file, so we need to reconstruct the metadata
    // For now, we'll use a simpler approach: create metadata from the existing data
    
    // Enrich ROOM_EQUIPMENT_MAPPINGS with department, functional area, and room names
    if (ROOM_EQUIPMENT_MAPPINGS && ROOM_SIZES && EQUIPMENT_LIST) {
      console.log(`Starting with ${ROOM_EQUIPMENT_MAPPINGS.length} equipment mappings`);
      console.log(`Have ${ROOM_SIZES.length} rooms and ${EQUIPMENT_LIST.length} equipment items`);
      
      // Load room finishes first to get room names, then chapter-fa-mapping, and crosswalk
      Promise.all([
        fetch('src/room_finishes.tsv').then(r => r.text()),
        fetch('chapter-fa-mapping.tsv').then(r => r.text()),
        fetch('src/LegacyRC-Crosswalk.txt').then(r => r.text())
      ])
      .then(([finishText, mappingText, crosswalkText]) => {
        // Build VARF to Legacy code map from crosswalk
        const varfToLegacy = new Map();
        const legacyToVarf = new Map();
        const crosswalkLines = crosswalkText.split('\n');
        for (let i = 1; i < crosswalkLines.length; i++) {
          const line = crosswalkLines[i].trim();
          if (!line || line.startsWith('#')) continue;
          const parts = line.split('\t');
          if (parts.length >= 3) {
            const varf = parts[1]?.trim();
            const legacy = parts[2]?.trim();
            if (varf && legacy && legacy !== 'n/a') {
              varfToLegacy.set(varf, legacy);
              legacyToVarf.set(legacy, varf);
            }
          }
        }
        console.log(`Loaded crosswalk: ${varfToLegacy.size} VARF codes with legacy mappings`);
        
        // Build room code to name map from finish data
        const roomCodeToName = new Map();
        const finishLines = finishText.split('\n');
        for (let i = 1; i < finishLines.length; i++) {
          const line = finishLines[i].trim();
          if (!line) continue;
          const parts = line.split('\t');
          if (parts.length >= 6) {
            const roomCode = parts[4]?.trim();
            const roomName = parts[5]?.trim();
            if (roomCode && roomName && !roomCodeToName.has(roomCode)) {
              roomCodeToName.set(roomCode, roomName);
            }
          }
        }
        
        const mappingLines = mappingText.split('\n');
          
        // Build three lookups:
        // 1. Map<chapter|roomCode, Array<{faNumber, faName}>> - for VARF room code lookup (can be in multiple FAs)
        // 2. Map<chapter|equipFaName, {faNumber, faName}> - for equipment FA name lookup
        // 3. Map<chapter, Map<faName, faNumber>> - for finish FA name fallback
        const roomCodeFaMap = new Map();
        const equipFaNameMap = new Map();
        const chapterFaNumberMap = new Map();
          
          for (let i = 1; i < mappingLines.length; i++) {
            const line = mappingLines[i].trim();
            if (!line) continue;
            
            const parts = line.split('\t');
            if (parts.length < 4) continue;
            
            const chapter = parts[0].trim();
            const faNumber = parts[1].trim();
            const faName = parts[2].trim();
            const varfOrEquipFa = parts[3].trim();
            
            // Check if column 4 is a room code (VARF) or equipment FA name
            // Room codes are short alphanumeric (e.g., SB136, IMS25)
            // Equipment FA names have spaces (e.g., VISITOR AREA, PATIENT AREA)
            if (varfOrEquipFa.includes(' ')) {
              // This is an equipment FA name mapping
              const key = `${chapter}|${varfOrEquipFa}`;
              equipFaNameMap.set(key, { faNumber, faName });
            } else {
              // This is a VARF room code mapping - can appear in multiple FAs
              const key = `${chapter}|${varfOrEquipFa}`;
              if (!roomCodeFaMap.has(key)) {
                roomCodeFaMap.set(key, []);
              }
              roomCodeFaMap.get(key).push({ faNumber, faName });
            }
            
            // Also build finish FA name lookup for fallback
            if (!chapterFaNumberMap.has(chapter)) {
              chapterFaNumberMap.set(chapter, new Map());
            }
            chapterFaNumberMap.get(chapter).set(faName, faNumber);
          }
          
          const totalRoomCodeMappings = Array.from(roomCodeFaMap.values()).reduce((sum, arr) => sum + arr.length, 0);
          console.log(`Loaded FA mappings: ${chapterFaNumberMap.size} chapters, ${roomCodeFaMap.size} unique room codes, ${totalRoomCodeMappings} total room/FA combinations, ${equipFaNameMap.size} equipment FA names`);
          console.log(`Loaded ${roomCodeToName.size} room names from finish data`);
          
          // Store crosswalk maps globally
          window.VARF_TO_LEGACY = varfToLegacy;
          window.LEGACY_TO_VARF = legacyToVarf;
          
          // Now fetch the equipment guide
          return fetch('src/Equipment_Guide_parsed_v2.txt')
            .then(response => response.text())
            .then(text => ({ text, chapterFaNumberMap, roomCodeFaMap, equipFaNameMap, roomCodeToName, varfToLegacy, legacyToVarf }));
        })
        .then(({ text, chapterFaNumberMap, roomCodeFaMap, equipFaNameMap, roomCodeToName, varfToLegacy, legacyToVarf }) => {
          const lines = text.split('\n');
          const deptFaMap = new Map();
          
          // Build a map of chapter number to full department name
          const chapterToDeptName = new Map();
          
          // Build canonical FA order - SEED from TSV first (has complete FA structure including Range Calculation)
          // Then supplement from Equipment Guide for any FAs not in TSV
          const canonicalFAOrder = {};
          
          // Seed canonical FA order from TSV chapterFaNumberMap
          // This ensures FA1 (Range Calculation) etc. appear even if they have no equipment
          chapterFaNumberMap.forEach((faMap, chapter) => {
            if (!canonicalFAOrder[chapter]) {
              canonicalFAOrder[chapter] = {
                departmentName: '',
                faOrder: [],
                faNameToNumber: {}
              };
            }
            // Build ordered array from FA numbers in TSV
            const faEntries = [];
            faMap.forEach((faNumber, faName) => {
              faEntries.push({ faNumber: parseInt(faNumber) || 999, faName, faNumberStr: faNumber });
            });
            // Sort by FA number
            faEntries.sort((a, b) => a.faNumber - b.faNumber);
            // Add to canonical order
            faEntries.forEach(entry => {
              if (!canonicalFAOrder[chapter].faNameToNumber[entry.faName]) {
                canonicalFAOrder[chapter].faOrder.push(entry.faName);
                canonicalFAOrder[chapter].faNameToNumber[entry.faName] = entry.faNumberStr;
              }
            });
          });
          console.log(`Seeded canonical FA order from TSV for ${Object.keys(canonicalFAOrder).length} chapters`);
          
          // Add chapter names for chapters that don't have equipment data
          chapterToDeptName.set('202', '202 (Primary Care)');
          chapterToDeptName.set('224', '224 (Nutrition and Food Service)');
          chapterToDeptName.set('232', '232 (Telecommunications Facilities)');
          chapterToDeptName.set('252', '252 (DELETED - replaced by Imaging Service Chapter 295)');
          chapterToDeptName.set('260', '260 (Mental Health Clinic)');
          chapterToDeptName.set('261', '261 (DELETED - merged into Mental Health Clinic Chapter 260)');
          chapterToDeptName.set('262', '262 (DELETED)');
          chapterToDeptName.set('264', '264 (DELETED)');
          chapterToDeptName.set('265', '265 (Community Based Outpatient Clinic (CBOC) - ARCHIVED)');
          chapterToDeptName.set('272', '272 (DELETED - merged into Mental Health Clinic Chapter 260)');
          chapterToDeptName.set('275', '275 (DELETED - replaced by Imaging Service Chapter 295)');
          chapterToDeptName.set('276', '276 (DELETED - replaced by Imaging Service Chapter 295)');
          chapterToDeptName.set('300', '300 (DELETED - merged into Mental Health Clinic Chapter 260)');
          
          // Skip header line
          // Build map of ALL room instances (not just first occurrence)
          // This allows rooms like SB191 to appear in multiple departments
          const allRoomInstances = [];
          
          for (let i = 1; i < lines.length; i++) {
            const line = lines[i].trim();
            if (!line) continue;
            
            const parts = line.split('\t');
            if (parts.length < 3) continue;
            
            // Clean up department and FA names
            let dept = parts[0] ? parts[0].replace(/"/g, '').trim() : '';
            let fa = parts[1] ? parts[1].replace(/"/g, '').trim() : '';
            const roomNameField = parts[2] ? parts[2].replace(/"/g, '').trim() : '';
            
            // Skip if essential fields are missing
            if (!dept || !fa || !roomNameField) continue;
            
            // Extract chapter number from department field (e.g., "100 (MEDICAL / SURGICAL...)" -> "100")
            const chapterMatch = dept.match(/^(\d+)/);
            const chapterNum = chapterMatch ? chapterMatch[1] : '';
            
            // Store the full department name for this chapter
            if (chapterNum && !chapterToDeptName.has(chapterNum)) {
              chapterToDeptName.set(chapterNum, dept);
            }
            
            // Update department name in canonical FA order if not set
            if (chapterNum && canonicalFAOrder[chapterNum] && !canonicalFAOrder[chapterNum].departmentName) {
              canonicalFAOrder[chapterNum].departmentName = dept;
            }
            
            // Add FA from equipment guide if not already in canonical order (case-insensitive check)
            // TSV provides authoritative FA numbers, equipment guide fills in gaps
            if (chapterNum && fa) {
              if (!canonicalFAOrder[chapterNum]) {
                canonicalFAOrder[chapterNum] = {
                  departmentName: dept,
                  faOrder: [],
                  faNameToNumber: {}
                };
              }
              // Check if this FA (case-insensitive) is already in canonical order
              const faUpper = fa.toUpperCase();
              const existingFA = Object.keys(canonicalFAOrder[chapterNum].faNameToNumber)
                .find(existing => existing.toUpperCase() === faUpper);
              
              if (!existingFA) {
                // This FA from equipment guide isn't in TSV - add it with next available number
                const nextNumber = canonicalFAOrder[chapterNum].faOrder.length + 1;
                canonicalFAOrder[chapterNum].faOrder.push(fa);
                canonicalFAOrder[chapterNum].faNameToNumber[fa] = String(nextNumber);
              } else if (existingFA !== fa) {
                // FA exists with different casing - add uppercase version with same number
                canonicalFAOrder[chapterNum].faNameToNumber[fa] = 
                  canonicalFAOrder[chapterNum].faNameToNumber[existingFA];
              }
            }
            
            // Extract room code from "Order - CODE - Name" format
            const match = roomNameField.match(/- ([A-Z0-9]+) -/);
            if (match) {
              const roomCode = match[1];
              const roomName = roomNameField.split(' - ').slice(2).join(' - ').trim();
              
              // Priority 1: Look up by chapter + room code (most reliable - VARF codes)
              let faNumber = '';
              let mappedFaName = '';
              
              if (chapterNum) {
                const roomKey = `${chapterNum}|${roomCode}`;
                const roomMappings = roomCodeFaMap.get(roomKey);
                if (roomMappings && roomMappings.length > 0) {
                  // Find the mapping that matches the current FA name
                  const matchingMapping = roomMappings.find(m => m.faName === fa);
                  if (matchingMapping) {
                    faNumber = matchingMapping.faNumber;
                    mappedFaName = matchingMapping.faName;
                  } else {
                    // If no exact match, use the first one
                    faNumber = roomMappings[0].faNumber;
                    mappedFaName = roomMappings[0].faName;
                  }
                }
              }
              
              // Priority 2: Look up by chapter + equipment FA name
              if (!faNumber && chapterNum) {
                const equipFaKey = `${chapterNum}|${fa}`;
                const equipFaMapping = equipFaNameMap.get(equipFaKey);
                if (equipFaMapping) {
                  faNumber = equipFaMapping.faNumber;
                  mappedFaName = equipFaMapping.faName;
                }
              }
              
              // Priority 3: Check ROOM_SIZES for FA number (finish data)
              if (!faNumber) {
                const roomAttrs = ROOM_SIZES.find(r => r.id === roomCode);
                faNumber = roomAttrs?.functionalAreaNumber || '';
              }
              
              // Priority 4: Look up by chapter + finish FA name
              if (!faNumber && chapterNum && chapterFaNumberMap.has(chapterNum)) {
                const chapterMap = chapterFaNumberMap.get(chapterNum);
                faNumber = chapterMap.get(fa) || '';
              }
              
              // Use mapped FA name if available, otherwise use equipment FA name
              const finalFaName = mappedFaName || fa;
              
              // Store ALL instances, not just first occurrence
              allRoomInstances.push({
                roomCode: roomCode,
                department: dept,
                departmentChapter: chapterNum,
                functionalArea: finalFaName,
                functionalAreaNumber: faNumber,
                roomName: roomName
              });
              
              // Also keep first occurrence map for backward compatibility
              if (!deptFaMap.has(roomCode)) {
                deptFaMap.set(roomCode, {
                  department: dept,
                  functionalArea: finalFaName,
                  roomName: roomName
                });
              }
            }
          }
          
          console.log(`Built metadata for ${deptFaMap.size} unique room codes`);
          console.log(`Found ${allRoomInstances.length} total room instances (including duplicates across departments)`);
          
          // Add rooms from finish data (chapter-fa-mapping) that don't exist in equipment data
          // This ensures rooms with attributes show in the tree even if they have no equipment yet
          // Key by chapter|roomCode|FA to allow same room in multiple FAs
          const equipmentRoomCodes = new Set(allRoomInstances.map(i => `${i.departmentChapter}|${i.roomCode}|${i.functionalArea}`));
          let addedFromFinish = 0;
          
          console.log(`Equipment room codes Set size: ${equipmentRoomCodes.size}`);
          console.log(`roomCodeFaMap size: ${roomCodeFaMap.size}`);
          
          let ch100FA7Rooms = [];
          roomCodeFaMap.forEach((mappings, key) => {
            const [chapter, roomCode] = key.split('|');
            
            // Each room code can have multiple FA mappings (e.g., SS218 in FA5, FA7, FA8)
            for (const mapping of mappings) {
              const checkKey = `${chapter}|${roomCode}|${mapping.faName}`;
              
              // Debug Chapter 100 FA7
              if (chapter === '100' && mapping.faNumber === '7') {
                ch100FA7Rooms.push(roomCode);
              }
              
              if (!equipmentRoomCodes.has(checkKey)) {
                // Get the proper department name from the chapter
                const deptName = chapterToDeptName.get(chapter) || `${chapter}`;
                
                // This room has finish data but no equipment in this FA
                // Add it as an instance so it appears in the tree
                // Try to get room name from: 1) finish data, 2) ROOM_SIZES, 3) fallback to code
                const roomName = roomCodeToName.get(roomCode) || 
                                ROOM_SIZES.find(r => r.id === roomCode)?.name || 
                                roomCode;
                
                allRoomInstances.push({
                  roomCode: roomCode,
                  department: deptName,
                  departmentChapter: chapter,
                  functionalArea: mapping.faName,
                  functionalAreaNumber: mapping.faNumber,
                  roomName: roomName
                });
                addedFromFinish++;
              }
            }
          });
          
          console.log(`Added ${addedFromFinish} rooms from finish data (have attributes but no equipment)`);
          console.log(`Total instances now: ${allRoomInstances.length}`);
          console.log(`Chapter 100 FA7 rooms: ${ch100FA7Rooms.length}`, ch100FA7Rooms.slice(0, 5));
          
          // Debug: Check if FA7 was added for Chapter 100
          const ch100FA7 = allRoomInstances.filter(i => i.departmentChapter === '100' && i.functionalAreaNumber === '7');
          console.log(`Chapter 100 FA7 rooms: ${ch100FA7.length}`, ch100FA7.map(r => r.roomCode));
          
          // Count how many instances have FA numbers
          const instancesWithFaNumber = allRoomInstances.filter(i => i.functionalAreaNumber).length;
          console.log(`FA Number coverage: ${instancesWithFaNumber} of ${allRoomInstances.length} instances (${Math.round(instancesWithFaNumber/allRoomInstances.length*100)}%)`);
          console.log('Sample metadata:', Array.from(deptFaMap.entries()).slice(0, 3));
          
          // Add rooms from ROOM_SIZES that aren't already in allRoomInstances
          // This ensures all VA rooms appear in reference tree even without equipment/finish data
          const existingRoomCodes = new Set(allRoomInstances.map(i => i.roomCode));
          let addedFromRoomSizes = 0;
          
          // Map room name service suffixes to chapter numbers
          const serviceToChapter = {
            'PMR Svc': { chapter: '270', dept: '270 (PHYSICAL MEDICINE AND REHABILITATION SERVICE (PMR))' },
            'Path Svc': { chapter: '240', dept: '240 (LABORATORY SERVICE)' },
            'Phrm Svc': { chapter: '268', dept: '268 (PHARMACY SERVICE)' },
            'Nurs Svc': { chapter: '254', dept: '254 (NURSING ADMINISTRATIVE FUNCTIONS)' },
            'Surg Svc': { chapter: '286', dept: '286 (SURGICAL AND ENDOVASCULAR SERVICES)' },
            'Img Svc': { chapter: '228', dept: '228 (RADIOLOGY SERVICE)' },
            'Psych Svc': { chapter: '260', dept: '260 (MENTAL HEALTH SERVICE)' },
            'Dent Svc': { chapter: '222', dept: '222 (DENTAL SERVICE)' },
            'Eye Svc': { chapter: '233', dept: '233 (EYE CLINIC)' },
            'Wm Vet Svc': { chapter: '258', dept: '258 (WOMEN VETERANS HEALTH PROGRAM)' },
            'Aud Svc': { chapter: '204', dept: '204 (AUDIOLOGY AND SPEECH PATHOLOGY SERVICE)' },
            'Card Svc': { chapter: '210', dept: '210 (CARDIOLOGY)' },
            'Endo Svc': { chapter: '229', dept: '229 (GI-ENDOSCOPY)' },
            'Neph Svc': { chapter: '316', dept: '316 (DIALYSIS SERVICE)' },
            'Onco Svc': { chapter: '296', dept: '296 (ONCOLOGY / HEMATOLOGY)' },
            'Pulm Svc': { chapter: '212', dept: '212 (PULMONARY FUNCTION SERVICE)' },
            'Derm Svc': { chapter: '224', dept: '224 (DERMATOLOGY SERVICE)' },
            'Neuro Svc': { chapter: '226', dept: '226 (NEUROLOGY SERVICE)' },
            'Urol Svc': { chapter: '298', dept: '298 (UROLOGY SERVICE)' },
            'ED Svc': { chapter: '256', dept: '256 (EMERGENCY DEPARTMENT)' },
            'Educ Svc': { chapter: '248', dept: '248 (MEDICAL MEDIA SERVICE)' },
            'Bldg Sprt': { chapter: '000', dept: 'Building Support' },
            'Stff Sprt': { chapter: '000', dept: 'Staff Support' },
            'CBOC': { chapter: '263', dept: '263 (COMMUNITY BASED OUTPATIENT CLINIC (CBOC))' },
          };
          
          ROOM_SIZES.forEach(room => {
            if (!existingRoomCodes.has(room.id)) {
              // Try to determine chapter from room name service suffix
              let chapterInfo = { chapter: '', dept: 'Uncategorized' };
              for (const [suffix, info] of Object.entries(serviceToChapter)) {
                if (room.name && room.name.includes(suffix)) {
                  chapterInfo = info;
                  break;
                }
              }
              
              allRoomInstances.push({
                roomCode: room.id,
                department: chapterInfo.dept,
                departmentChapter: chapterInfo.chapter,
                functionalArea: 'Other Rooms',
                functionalAreaNumber: '',
                roomName: room.name || room.id
              });
              addedFromRoomSizes++;
            }
          });
          
          console.log(`Added ${addedFromRoomSizes} rooms from ROOM_SIZES (no equipment/finish data)`);
          console.log(`Total room instances: ${allRoomInstances.length}`);
          
          // Store globally for compare mode
          window.ROOM_METADATA = deptFaMap;
          window.ALL_ROOM_INSTANCES = allRoomInstances;
          
          // Store canonical FA order globally - built from Equipment Guide parsing order
          window.CANONICAL_FA_ORDER = canonicalFAOrder;
          console.log(`Built canonical FA order for ${Object.keys(canonicalFAOrder).length} chapters`);
          
          // Log some examples
          if (canonicalFAOrder['100']) {
            console.log('Chapter 100 FAs:', canonicalFAOrder['100'].faOrder.slice(0, 5).map((fa, i) => `${i+1}:${fa}`));
          }
          if (canonicalFAOrder['270']) {
            console.log('Chapter 270 FAs:', canonicalFAOrder['270'].faOrder.slice(0, 5).map((fa, i) => `${i+1}:${fa}`));
          }
          
          // Initialize canonical FAs module from the pre-built CANONICAL_FA_ORDER
          if (window.CanonicalFAs && window.CanonicalFAs.initializeCanonicalFAsFromEquipment) {
            window.CanonicalFAs.initializeCanonicalFAsFromEquipment();
          }
          
          // Build indexed lookup for performance - O(1) instead of O(n) filter
          const roomInstancesByCode = new Map();
          allRoomInstances.forEach(instance => {
            if (!roomInstancesByCode.has(instance.roomCode)) {
              roomInstancesByCode.set(instance.roomCode, []);
            }
            roomInstancesByCode.get(instance.roomCode).push(instance);
          });
          
          console.log(`Starting enrichment of ${ROOM_EQUIPMENT_MAPPINGS.length} base equipment mappings...`);
          
          // First deduplicate the base mappings - same equipment appears multiple times per room
          const uniqueEquipment = new Map();
          ROOM_EQUIPMENT_MAPPINGS.forEach(mapping => {
            const key = `${mapping.roomCode}|${mapping.jsn}`;
            if (!uniqueEquipment.has(key)) {
              uniqueEquipment.set(key, mapping);
            }
          });
          console.log(`Deduplicated base equipment from ${ROOM_EQUIPMENT_MAPPINGS.length} to ${uniqueEquipment.size} unique room+equipment combinations`);
          
          // Simply add metadata to each unique mapping
          // Tree building will use ALL_ROOM_INSTANCES to show rooms in multiple depts
          const enrichedMappings = Array.from(uniqueEquipment.values()).map(mapping => {
            const metadata = deptFaMap.get(mapping.roomCode);
            return {
              ...mapping,
              department: metadata?.department || 'Unknown',
              functionalArea: metadata?.functionalArea || 'Unknown',
              roomName: metadata?.roomName || mapping.roomCode,
              equipmentJsn: mapping.jsn,
              quantity: mapping.qty || 1
            };
          });
          
          console.log(`Enriched ${enrichedMappings.length} mappings with metadata (deduplicated)`);
          
          // Update window property
          window.ROOM_EQUIPMENT_MAPPINGS = enrichedMappings;
          
          // Reset cached dept map so import tree rebuilds with enriched data
          cachedDeptMap = null;
          
          // No deduplication needed since we already deduplicated during enrichment
          // Invalidate cached reference tree since data changed
          cachedReferenceTree = null;
          lastMappingsLength = 0;
          
          // Build ROOM_EQUIPMENT lookup object for easy access by room code
          // Pre-build equipment items lookup for O(1) access
          const equipLookup = new Map();
          EQUIPMENT_LIST.forEach(eq => equipLookup.set(eq.jsn, eq));
          
          window.ROOM_EQUIPMENT = {};
          const roomJSNSeen = {}; // Track JSNs per room to avoid duplicates
          
          enrichedMappings.forEach(mapping => {
            if (!window.ROOM_EQUIPMENT[mapping.roomCode]) {
              window.ROOM_EQUIPMENT[mapping.roomCode] = [];
              roomJSNSeen[mapping.roomCode] = new Set();
            }
            
            // Skip if we've already added this JSN to this room
            if (roomJSNSeen[mapping.roomCode].has(mapping.equipmentJsn)) {
              return;
            }
            roomJSNSeen[mapping.roomCode].add(mapping.equipmentJsn);
            
            const equipItem = equipLookup.get(mapping.equipmentJsn);
            if (equipItem) {
              window.ROOM_EQUIPMENT[mapping.roomCode].push({
                JSN: equipItem.jsn,
                'Equipment Name': equipItem.name,
                'Qty per Room': mapping.quantity || 1,
                'Acq/Ins': mapping.acqIns || equipItem.acqIns || '',
                Description: equipItem.description || ''
              });
            }
          });
          console.log('Built ROOM_EQUIPMENT lookup for', Object.keys(window.ROOM_EQUIPMENT).length, 'room codes (deduplicated by JSN)');
          
          // Now trigger initial render with enriched data
          viewState = 'project-list';
          renderAll();
        })
        .catch(error => {
          console.error('Error loading equipment guide:', error);
          // Fall back to using original data without enrichment
          console.warn('Using original mappings without department/FA metadata');
          window.ROOM_EQUIPMENT_MAPPINGS = ROOM_EQUIPMENT_MAPPINGS;
          viewState = 'project-list';
          renderAll();
        });
    } else {
      // If data isn't available, just render with what we have
      console.warn('Equipment or room data not loaded');
      window.ROOM_EQUIPMENT_MAPPINGS = ROOM_EQUIPMENT_MAPPINGS || [];
      viewState = 'project-list';
      renderAll();
    }
    
    // -----------------------------
    // DATA MODELS & SAMPLE DATA
    // -----------------------------

    // For clarity, using plain JS objects; no TypeScript syntax.
    
    // Helper to get enriched equipment mappings
    function getEquipmentMappings() {
      return window.ROOM_EQUIPMENT_MAPPINGS || ROOM_EQUIPMENT_MAPPINGS || [];
    }

    // PROJECT MANAGEMENT DATA
    // Project structure: departments -> functional areas -> rooms -> equipment
    let USER_PROJECTS = JSON.parse(localStorage.getItem('va-user-projects') || '[]');
    let CURRENT_PROJECT_ID = localStorage.getItem('va-current-project-id') || null;

    // Migrate existing projects to add cost fields
    USER_PROJECTS.forEach(project => {
      // Add cost factors if missing
      if (project.costPerNSF === undefined) project.costPerNSF = 0;
      if (project.costPerGSF === undefined) project.costPerGSF = 0;
      
      // Add cost to equipment if missing
      if (project.departments) {
        project.departments.forEach(dept => {
          if (dept.functionalAreas) {
            dept.functionalAreas.forEach(fa => {
              if (fa.rooms) {
                fa.rooms.forEach(room => {
                  if (room.equipment) {
                    room.equipment.forEach(eq => {
                      if (eq.cost === undefined) eq.cost = 0;
                    });
                  }
                });
              }
            });
          }
        });
      }
    });

    // Initialize default project if none exist
    if (USER_PROJECTS.length === 0) {
      const defaultProject = {
        id: generateId(),
        name: "New Project",
        siteName: "",
        description: "",
        departments: [],
        costPerNSF: 0,
        costPerGSF: 0,
        createdAt: new Date().toISOString(),
        modifiedAt: new Date().toISOString()
      };
      USER_PROJECTS.push(defaultProject);
      CURRENT_PROJECT_ID = defaultProject.id;
      saveProjects();
    } else if (!CURRENT_PROJECT_ID || !USER_PROJECTS.find(p => p.id === CURRENT_PROJECT_ID)) {
      CURRENT_PROJECT_ID = USER_PROJECTS[0].id;
      localStorage.setItem('va-current-project-id', CURRENT_PROJECT_ID);
    }

    function getCurrentProject() {
      return USER_PROJECTS.find(p => p.id === CURRENT_PROJECT_ID) || USER_PROJECTS[0];
    }

    function saveProjects() {
      try {
        const data = JSON.stringify(USER_PROJECTS);
        const sizeKB = (data.length / 1024).toFixed(1);
        
        // Check if data is too large (localStorage typically has 5-10MB limit)
        if (data.length > 5000000) { // 5MB
          console.warn(`Project data is large (${sizeKB} KB). Consider exporting to file.`);
        }
        
        localStorage.setItem('va-user-projects', data);
        getCurrentProject().modifiedAt = new Date().toISOString();
        console.log(`Saved projects (${sizeKB} KB)`);
      } catch (e) {
        if (e.name === 'QuotaExceededError') {
          alert(`Storage quota exceeded!\n\nYour project data is too large to save automatically.\n\nPlease use File > Export Project to save your work to a file instead.\n\nTip: Remove unused equipment or departments to reduce size.`);
          console.error('localStorage quota exceeded. Data size:', (JSON.stringify(USER_PROJECTS).length / 1024).toFixed(1), 'KB');
        } else {
          console.error('Error saving projects:', e);
          alert('Error saving project: ' + e.message);
        }
      }
    }

    function generateId() {
      return 'id-' + Math.random().toString(36).substr(2, 9) + '-' + Date.now();
    }

    const PROJECT = {
      id: "proj-1",
      name: "Sample VA Hospital Project",
      siteName: "Sample VAMC",
      description: "Baseline demo program using PG-18-9 logic."
    };

    const SAMPLE_CHAPTERS = [
      { id: "100", title: "MEDICAL / SURGICAL PATIENT CARE UNIT (MS PCU)", category: "clinical" },
      { id: "102", title: "INTENSIVE CARE PATIENT CARE UNIT (IC PCU)", category: "clinical" },
      { id: "112", title: "MATERNITY CARE (MAT)", category: "clinical" },
      { id: "122", title: "PEDIATRIC PATIENT CARE UNIT (PED PCU)", category: "clinical" },
      { id: "124", title: "NEONATAL INTENSIVE CARE UNIT (NICU)", category: "clinical" },
      { id: "126", title: "PSYCHIATRIC PATIENT CARE UNIT (PSY PCU)", category: "clinical" },
      { id: "130", title: "SPINAL CORD INJURY PATIENT CARE UNIT (SCI PCU)", category: "clinical" },
      { id: "132", title: "BLIND REHABILITATION PATIENT CARE UNIT (BR PCU)", category: "clinical" },
      { id: "202", title: "AMBULATORY CARE / PRIMARY CARE", category: "clinical" },
      { id: "210", title: "SURGERY", category: "clinical" },
      { id: "214", title: "ANESTHESIA", category: "clinical" },
      { id: "218", title: "POST ANESTHESIA CARE UNIT (PACU)", category: "clinical" },
      { id: "224", title: "PAIN MANAGEMENT", category: "clinical" },
      { id: "230", title: "ENDOSCOPY / BRONCHOSCOPY", category: "clinical" },
      { id: "256", title: "EMERGENCY DEPARTMENT (ED)", category: "clinical" },
      { id: "258", title: "URGENT CARE CENTER", category: "clinical" },
      { id: "260", title: "IMAGING", category: "clinical" },
      { id: "262", title: "CARDIOLOGY", category: "clinical" },
      { id: "264", title: "NUCLEAR MEDICINE", category: "clinical" },
      { id: "266", title: "RADIATION ONCOLOGY", category: "clinical" },
      { id: "268", title: "PHARMACY SERVICE", category: "clinical" },
      { id: "270", title: "PATHOLOGY & LABORATORY MEDICINE", category: "clinical" },
      { id: "272", title: "BLOOD BANK", category: "clinical" },
      { id: "280", title: "PROSTHETICS & ORTHOTICS", category: "clinical" },
      { id: "282", title: "PHYSICAL MEDICINE & REHABILITATION", category: "clinical" },
      { id: "284", title: "AUDIOLOGY / SPEECH", category: "clinical" },
      { id: "286", title: "NUTRITION & FOOD SERVICE", category: "support" },
      { id: "290", title: "MENTAL HEALTH / SUBSTANCE ABUSE", category: "clinical" },
      { id: "292", title: "SOCIAL WORK SERVICE", category: "clinical" },
      { id: "294", title: "CHAPLAIN SERVICE", category: "support" },
      { id: "298", title: "EDUCATION / TRAINING", category: "support" },
      { id: "300", title: "ADMINISTRATION", category: "support" },
      { id: "310", title: "MEDICAL RECORDS", category: "support" },
      { id: "330", title: "VOLUNTARY SERVICE", category: "support" },
      { id: "340", title: "ENVIRONMENTAL MANAGEMENT SERVICE", category: "support" },
      { id: "350", title: "STERILE PROCESSING & DISTRIBUTION", category: "support" },
      { id: "360", title: "LINEN SERVICE", category: "support" },
      { id: "370", title: "ENGINEERING / MAINTENANCE", category: "support" },
      { id: "380", title: "POLICE SERVICE", category: "support" },
      { id: "390", title: "TELECOMMUNICATIONS", category: "support" },
      { id: "420", title: "GENERAL STORAGE / RECEIVING", category: "support" }
    ];

    const SAMPLE_IDS = [
      // CHAPTER 100: MEDICAL/SURGICAL PCU
      { id: "CH100_A", chapterId: "100", label: "A", text: "How many Acute Inpatient Medical / Surgical patient beds are projected? (W) (17-267)", type: "W", inputKind: "number", minValue: 17, maxValue: 267, defaultValue: 32 },
      { id: "CH100_B", chapterId: "100", label: "B", text: "Is Behavioral Health Care for Inpatients authorized? (M)", type: "M", inputKind: "boolean", defaultValue: false },
      
      // CHAPTER 102: INTENSIVE CARE PCU
      { id: "CH102_A", chapterId: "102", label: "A", text: "How many ICU beds are projected? (W) (8-45)", type: "W", inputKind: "number", minValue: 8, maxValue: 45, defaultValue: 12 },
      { id: "CH102_B", chapterId: "102", label: "B", text: "Is a Coronary Care Unit authorized? (M)", type: "M", inputKind: "boolean", defaultValue: false },
      { id: "CH102_C", chapterId: "102", label: "C", text: "Is a Cardiac Catheterization Lab authorized? (M)", type: "M", inputKind: "boolean", defaultValue: false },
      
      // CHAPTER 112: MATERNITY CARE
      { id: "CH112_A", chapterId: "112", label: "A", text: "How many annual deliveries are projected? (W)", type: "W", inputKind: "number", defaultValue: 0 },
      { id: "CH112_B", chapterId: "112", label: "B", text: "Is Labor, Delivery, Recovery (LDR) authorized? (M)", type: "M", inputKind: "boolean", defaultValue: false },
      { id: "CH112_C", chapterId: "112", label: "C", text: "Is Labor, Delivery, Recovery, Postpartum (LDRP) authorized? (M)", type: "M", inputKind: "boolean", defaultValue: false },
      
      // CHAPTER 122: PEDIATRIC PCU
      { id: "CH122_A", chapterId: "122", label: "A", text: "How many Pediatric inpatient beds are projected? (W)", type: "W", inputKind: "number", defaultValue: 0 },
      
      // CHAPTER 124: NEONATAL ICU
      { id: "CH124_A", chapterId: "124", label: "A", text: "How many NICU beds are projected? (W)", type: "W", inputKind: "number", defaultValue: 0 },
      { id: "CH124_B", chapterId: "124", label: "B", text: "Is Level II (Intermediate) care authorized? (M)", type: "M", inputKind: "boolean", defaultValue: false },
      { id: "CH124_C", chapterId: "124", label: "C", text: "Is Level III (Intensive) care authorized? (M)", type: "M", inputKind: "boolean", defaultValue: false },
      
      // CHAPTER 126: PSYCHIATRIC PCU
      { id: "CH126_A", chapterId: "126", label: "A", text: "How many Psychiatric inpatient beds are projected? (W) (16-120)", type: "W", inputKind: "number", minValue: 16, maxValue: 120, defaultValue: 0 },
      { id: "CH126_B", chapterId: "126", label: "B", text: "Is Intensive Psychiatric care authorized? (M)", type: "M", inputKind: "boolean", defaultValue: false },
      
      // CHAPTER 130: SPINAL CORD INJURY PCU
      { id: "CH130_A", chapterId: "130", label: "A", text: "How many SCI beds are projected? (W)", type: "W", inputKind: "number", defaultValue: 0 },
      
      // CHAPTER 132: BLIND REHABILITATION PCU
      { id: "CH132_A", chapterId: "132", label: "A", text: "How many Blind Rehabilitation beds are projected? (W)", type: "W", inputKind: "number", defaultValue: 0 },
      
      // CHAPTER 202: AMBULATORY CARE
      { id: "CH202_A", chapterId: "202", label: "A", text: "How many annual Primary Care clinic stops are projected? (W)", type: "W", inputKind: "number", defaultValue: 0 },
      { id: "CH202_B", chapterId: "202", label: "B", text: "How many Primary Care Provider FTE positions are authorized? (S)", type: "S", inputKind: "number", defaultValue: 0 },
      { id: "CH202_C", chapterId: "202", label: "C", text: "How many Specialty Care Provider FTE positions are authorized? (S)", type: "S", inputKind: "number", defaultValue: 0 },
      
      // CHAPTER 210: SURGERY
      { id: "CH210_A", chapterId: "210", label: "A", text: "How many annual surgical operations are projected? (W)", type: "W", inputKind: "number", defaultValue: 0 },
      { id: "CH210_B", chapterId: "210", label: "B", text: "How many Operating Rooms are authorized? (M)", type: "M", inputKind: "number", defaultValue: 0 },
      { id: "CH210_C", chapterId: "210", label: "C", text: "Is Ambulatory Surgery authorized? (M)", type: "M", inputKind: "boolean", defaultValue: false },
      { id: "CH210_D", chapterId: "210", label: "D", text: "Is Cystoscopy authorized? (M)", type: "M", inputKind: "boolean", defaultValue: false },
      
      // CHAPTER 214: ANESTHESIA
      { id: "CH214_A", chapterId: "214", label: "A", text: "How many annual anesthesia procedures are projected? (W)", type: "W", inputKind: "number", defaultValue: 0 },
      { id: "CH214_B", chapterId: "214", label: "B", text: "How many Anesthesiologist FTE positions are authorized? (S)", type: "S", inputKind: "number", defaultValue: 0 },
      
      // CHAPTER 218: PACU
      { id: "CH218_A", chapterId: "218", label: "A", text: "How many PACU beds are projected? (W)", type: "W", inputKind: "number", defaultValue: 0 },
      
      // CHAPTER 224: PAIN MANAGEMENT
      { id: "CH224_A", chapterId: "224", label: "A", text: "How many annual Pain Management clinic stops are projected? (W)", type: "W", inputKind: "number", defaultValue: 0 },
      
      // CHAPTER 230: ENDOSCOPY
      { id: "CH230_A", chapterId: "230", label: "A", text: "How many annual endoscopy procedures are projected? (W)", type: "W", inputKind: "number", defaultValue: 0 },
      { id: "CH230_B", chapterId: "230", label: "B", text: "How many Endoscopy Procedure Rooms are authorized? (M)", type: "M", inputKind: "number", defaultValue: 0 },
      
      // CHAPTER 256: EMERGENCY DEPARTMENT
      { id: "CH256_A", chapterId: "256", label: "A", text: "How many annual ED visits (Stop Code 130) are projected? (W)", type: "W", inputKind: "number", defaultValue: 0 },
      { id: "CH256_B", chapterId: "256", label: "B", text: "How many Emergency Treatment Rooms are authorized? (M)", type: "M", inputKind: "number", defaultValue: 0 },
      { id: "CH256_C", chapterId: "256", label: "C", text: "Is a Trauma Bay authorized? (M)", type: "M", inputKind: "boolean", defaultValue: false },
      
      // CHAPTER 258: URGENT CARE
      { id: "CH258_A", chapterId: "258", label: "A", text: "How many annual Urgent Care visits are projected? (W)", type: "W", inputKind: "number", defaultValue: 0 },
      
      // CHAPTER 260: IMAGING
      { id: "CH260_A", chapterId: "260", label: "A", text: "How many annual Diagnostic Radiology procedures are projected? (W)", type: "W", inputKind: "number", defaultValue: 0 },
      { id: "CH260_B", chapterId: "260", label: "B", text: "How many Radiographic/Fluoroscopic Rooms are authorized? (M)", type: "M", inputKind: "number", defaultValue: 0 },
      { id: "CH260_C", chapterId: "260", label: "C", text: "How many CT Scanners are authorized? (M)", type: "M", inputKind: "number", defaultValue: 0 },
      { id: "CH260_D", chapterId: "260", label: "D", text: "How many MRI units are authorized? (M)", type: "M", inputKind: "number", defaultValue: 0 },
      { id: "CH260_E", chapterId: "260", label: "E", text: "How many Ultrasound Rooms are authorized? (M)", type: "M", inputKind: "number", defaultValue: 0 },
      
      // CHAPTER 262: CARDIOLOGY
      { id: "CH262_A", chapterId: "262", label: "A", text: "How many annual Cardiology clinic stops are projected? (W)", type: "W", inputKind: "number", defaultValue: 0 },
      { id: "CH262_B", chapterId: "262", label: "B", text: "Is Echocardiography authorized? (M)", type: "M", inputKind: "boolean", defaultValue: false },
      { id: "CH262_C", chapterId: "262", label: "C", text: "Is Cardiac Stress Testing authorized? (M)", type: "M", inputKind: "boolean", defaultValue: false },
      
      // CHAPTER 264: NUCLEAR MEDICINE
      { id: "CH264_A", chapterId: "264", label: "A", text: "How many annual Nuclear Medicine procedures are projected? (W)", type: "W", inputKind: "number", defaultValue: 0 },
      { id: "CH264_B", chapterId: "264", label: "B", text: "How many Gamma Cameras are authorized? (M)", type: "M", inputKind: "number", defaultValue: 0 },
      
      // CHAPTER 266: RADIATION ONCOLOGY
      { id: "CH266_A", chapterId: "266", label: "A", text: "How many annual Radiation Oncology treatments are projected? (W)", type: "W", inputKind: "number", defaultValue: 0 },
      { id: "CH266_B", chapterId: "266", label: "B", text: "How many Linear Accelerators are authorized? (M)", type: "M", inputKind: "number", defaultValue: 0 },
      
      // CHAPTER 268: PHARMACY
      { id: "CH268_A", chapterId: "268", label: "A", text: "How many Clinical Pharmacist FTE positions are authorized? (S)", type: "S", inputKind: "number", defaultValue: 0 },
      { id: "CH268_B", chapterId: "268", label: "B", text: "How many annual outpatient prescriptions are projected? (W)", type: "W", inputKind: "number", defaultValue: 0 },
      { id: "CH268_C", chapterId: "268", label: "C", text: "Is IV Admixture authorized? (M)", type: "M", inputKind: "boolean", defaultValue: false },
      { id: "CH268_D", chapterId: "268", label: "D", text: "Is Investigational Drug Service authorized? (M)", type: "M", inputKind: "boolean", defaultValue: false },
      
      // CHAPTER 270: PATHOLOGY & LAB
      { id: "CH270_A", chapterId: "270", label: "A", text: "How many annual Laboratory tests are projected? (W)", type: "W", inputKind: "number", defaultValue: 0 },
      { id: "CH270_B", chapterId: "270", label: "B", text: "How many Pathologist FTE positions are authorized? (S)", type: "S", inputKind: "number", defaultValue: 0 },
      { id: "CH270_C", chapterId: "270", label: "C", text: "Is Anatomical Pathology authorized? (M)", type: "M", inputKind: "boolean", defaultValue: false },
      { id: "CH270_D", chapterId: "270", label: "D", text: "Is Microbiology authorized? (M)", type: "M", inputKind: "boolean", defaultValue: false },
      
      // CHAPTER 272: BLOOD BANK
      { id: "CH272_A", chapterId: "272", label: "A", text: "How many annual blood units are projected? (W)", type: "W", inputKind: "number", defaultValue: 0 },
      { id: "CH272_B", chapterId: "272", label: "B", text: "Is Apheresis authorized? (M)", type: "M", inputKind: "boolean", defaultValue: false },
      
      // CHAPTER 280: PROSTHETICS
      { id: "CH280_A", chapterId: "280", label: "A", text: "How many Prosthetics FTE positions are authorized? (S)", type: "S", inputKind: "number", defaultValue: 0 },
      { id: "CH280_B", chapterId: "280", label: "B", text: "Is Orthotics/Prosthetics Fabrication authorized? (M)", type: "M", inputKind: "boolean", defaultValue: false },
      
      // CHAPTER 282: PHYSICAL MEDICINE & REHAB
      { id: "CH282_A", chapterId: "282", label: "A", text: "How many annual Physical Therapy visits are projected? (W)", type: "W", inputKind: "number", defaultValue: 0 },
      { id: "CH282_B", chapterId: "282", label: "B", text: "How many annual Occupational Therapy visits are projected? (W)", type: "W", inputKind: "number", defaultValue: 0 },
      { id: "CH282_C", chapterId: "282", label: "C", text: "How many Physical Therapist FTE positions are authorized? (S)", type: "S", inputKind: "number", defaultValue: 0 },
      { id: "CH282_D", chapterId: "282", label: "D", text: "How many Occupational Therapist FTE positions are authorized? (S)", type: "S", inputKind: "number", defaultValue: 0 },
      
      // CHAPTER 284: AUDIOLOGY/SPEECH
      { id: "CH284_A", chapterId: "284", label: "A", text: "How many annual Audiology clinic stops are projected? (W)", type: "W", inputKind: "number", defaultValue: 0 },
      { id: "CH284_B", chapterId: "284", label: "B", text: "How many annual Speech Pathology visits are projected? (W)", type: "W", inputKind: "number", defaultValue: 0 },
      { id: "CH284_C", chapterId: "284", label: "C", text: "How many Audiologist FTE positions are authorized? (S)", type: "S", inputKind: "number", defaultValue: 0 },
      
      // CHAPTER 286: NUTRITION & FOOD
      { id: "CH286_A", chapterId: "286", label: "A", text: "How many total meals per day are projected? (W)", type: "W", inputKind: "number", defaultValue: 0 },
      { id: "CH286_B", chapterId: "286", label: "B", text: "How many Dietitian FTE positions are authorized? (S)", type: "S", inputKind: "number", defaultValue: 0 },
      { id: "CH286_C", chapterId: "286", label: "C", text: "Is a Dining Room for patients authorized? (M)", type: "M", inputKind: "boolean", defaultValue: false },
      
      // CHAPTER 290: MENTAL HEALTH
      { id: "CH290_A", chapterId: "290", label: "A", text: "How many annual Mental Health clinic stops are projected? (W)", type: "W", inputKind: "number", defaultValue: 0 },
      { id: "CH290_B", chapterId: "290", label: "B", text: "How many Psychiatrist FTE positions are authorized? (S)", type: "S", inputKind: "number", defaultValue: 0 },
      { id: "CH290_C", chapterId: "290", label: "C", text: "How many Psychologist FTE positions are authorized? (S)", type: "S", inputKind: "number", defaultValue: 0 },
      { id: "CH290_D", chapterId: "290", label: "D", text: "Is Substance Abuse Treatment authorized? (M)", type: "M", inputKind: "boolean", defaultValue: false },
      
      // CHAPTER 292: SOCIAL WORK
      { id: "CH292_A", chapterId: "292", label: "A", text: "How many Social Worker FTE positions are authorized? (S)", type: "S", inputKind: "number", defaultValue: 0 },
      
      // CHAPTER 294: CHAPLAIN
      { id: "CH294_A", chapterId: "294", label: "A", text: "How many Chaplain FTE positions are authorized? (S)", type: "S", inputKind: "number", defaultValue: 0 },
      { id: "CH294_B", chapterId: "294", label: "B", text: "Is a Chapel authorized? (M)", type: "M", inputKind: "boolean", defaultValue: false },
      
      // CHAPTER 298: EDUCATION
      { id: "CH298_A", chapterId: "298", label: "A", text: "How many Educator FTE positions are authorized? (S)", type: "S", inputKind: "number", defaultValue: 0 },
      { id: "CH298_B", chapterId: "298", label: "B", text: "How many total staff requiring training? (W)", type: "W", inputKind: "number", defaultValue: 0 },
      
      // CHAPTER 300: ADMINISTRATION
      { id: "CH300_A", chapterId: "300", label: "A", text: "How many Administrative FTE positions are authorized? (S)", type: "S", inputKind: "number", defaultValue: 0 },
      { id: "CH300_B", chapterId: "300", label: "B", text: "How many total facility FTE positions? (W)", type: "W", inputKind: "number", defaultValue: 0 },
      
      // CHAPTER 310: MEDICAL RECORDS
      { id: "CH310_A", chapterId: "310", label: "A", text: "How many annual patient registrations are projected? (W)", type: "W", inputKind: "number", defaultValue: 0 },
      { id: "CH310_B", chapterId: "310", label: "B", text: "How many Medical Records FTE positions are authorized? (S)", type: "S", inputKind: "number", defaultValue: 0 },
      
      // CHAPTER 330: VOLUNTARY SERVICE
      { id: "CH330_A", chapterId: "330", label: "A", text: "How many Voluntary Service FTE positions are authorized? (S)", type: "S", inputKind: "number", defaultValue: 0 },
      
      // CHAPTER 340: ENVIRONMENTAL MANAGEMENT
      { id: "CH340_A", chapterId: "340", label: "A", text: "How many Environmental Management FTE positions are authorized? (S)", type: "S", inputKind: "number", defaultValue: 0 },
      { id: "CH340_B", chapterId: "340", label: "B", text: "What is the total building gross square feet? (W)", type: "W", inputKind: "number", defaultValue: 0 },
      
      // CHAPTER 350: STERILE PROCESSING
      { id: "CH350_A", chapterId: "350", label: "A", text: "How many annual surgical instrument sets are projected? (W)", type: "W", inputKind: "number", defaultValue: 0 },
      { id: "CH350_B", chapterId: "350", label: "B", text: "How many Sterile Processing FTE positions are authorized? (S)", type: "S", inputKind: "number", defaultValue: 0 },
      
      // CHAPTER 360: LINEN SERVICE
      { id: "CH360_A", chapterId: "360", label: "A", text: "How many pounds of linen per day are projected? (W)", type: "W", inputKind: "number", defaultValue: 0 },
      { id: "CH360_B", chapterId: "360", label: "B", text: "Is on-site laundry authorized? (M)", type: "M", inputKind: "boolean", defaultValue: false },
      
      // CHAPTER 370: ENGINEERING
      { id: "CH370_A", chapterId: "370", label: "A", text: "How many Engineering FTE positions are authorized? (S)", type: "S", inputKind: "number", defaultValue: 0 },
      { id: "CH370_B", chapterId: "370", label: "B", text: "What is the total building gross square feet? (W)", type: "W", inputKind: "number", defaultValue: 0 },
      
      // CHAPTER 380: POLICE SERVICE
      { id: "CH380_A", chapterId: "380", label: "A", text: "How many Police Officer FTE positions are authorized? (S)", type: "S", inputKind: "number", defaultValue: 0 },
      
      // CHAPTER 390: TELECOMMUNICATIONS
      { id: "CH390_A", chapterId: "390", label: "A", text: "How many Telecommunications FTE positions are authorized? (S)", type: "S", inputKind: "number", defaultValue: 0 },
      
      // CHAPTER 420: GENERAL STORAGE
      { id: "CH420_A", chapterId: "420", label: "A", text: "What is the total building gross square feet? (W)", type: "W", inputKind: "number", defaultValue: 0 }
    ];

    const SAMPLE_FUNCTIONAL_AREAS = [
      {
        id: "100-FA1",
        chapterId: "100",
        code: "FA 1",
        name: "Inpatient Unit Patient Area"
      },
      {
        id: "100-FA2",
        chapterId: "100",
        code: "FA 2",
        name: "Support Area"
      },
      {
        id: "268-FA13",
        chapterId: "268",
        code: "FA 13",
        name: "Medication Consultation Services"
      }
    ];

    // SAMPLE_ROOMS now loaded from room-sizes.js as ROOM_SIZES
    const SAMPLE_ROOMS = ROOM_SIZES || [
      // Fallback data if room-sizes.js fails to load
      { id: "IMS21", chapterId: "100", name: "Single Universal Bedroom, MS PCU", nsf: 140 },
      { id: "IMS23", chapterId: "100", name: "Airborne Infection Isolation (AII) Bedroom", nsf: 160 },
      { id: "IMS24", chapterId: "100", name: "Airborne Infection Isolation (AII) Anteroom", nsf: 65 },
      { id: "IMS25", chapterId: "100", name: "Protective Environment Isolation Bedroom", nsf: 160 },
      { id: "IMS26", chapterId: "100", name: "Protective Environment Isolation Anteroom", nsf: 65 },
      { id: "IMS27", chapterId: "100", name: "Bariatric / Physical Disabilities Bedroom", nsf: 200 },
      { id: "NTOIL", chapterId: "100", name: "Patient Toilet", nsf: 60 },
      { id: "NTOI1", chapterId: "100", name: "Patient Toilet, Bariatric", nsf: 80 },
      { id: "NTOI2", chapterId: "100", name: "Patient Toilet, Isolation", nsf: 65 },
      { id: "NSHWR", chapterId: "100", name: "Patient Shower", nsf: 40 },
      { id: "NBATH", chapterId: "100", name: "Patient Bathing Room", nsf: 80 },
      { id: "NWCRM", chapterId: "100", name: "Wheelchair Storage", nsf: 30 },
      { id: "OFA01", chapterId: "100", name: "Office, Nurse Manager", nsf: 120 },
      { id: "OFA02", chapterId: "100", name: "Office, Assistant Nurse Manager", nsf: 100 },
      { id: "OFA03", chapterId: "100", name: "Office, Clinical Nurse Specialist", nsf: 100 },
      { id: "WRML1", chapterId: "100", name: "Workroom, Clinical", nsf: 150 },
      { id: "MEDST", chapterId: "100", name: "Medication Room", nsf: 120 },
      { id: "UTLCL", chapterId: "100", name: "Utility Room, Clean", nsf: 80 },
      { id: "UTLSO", chapterId: "100", name: "Utility Room, Soiled", nsf: 80 },
      { id: "NUTRI", chapterId: "100", name: "Nourishment Station", nsf: 100 },
      { id: "EQPSS", chapterId: "100", name: "Equipment Storage", nsf: 60 },
      { id: "LNST1", chapterId: "100", name: "Linen Storage, Clean", nsf: 60 },
      { id: "JANIT", chapterId: "100", name: "Janitor's Closet", nsf: 40 },
      
      // CHAPTER 102: ICU
      { id: "ICU01", chapterId: "102", name: "ICU Patient Room", nsf: 250 },
      { id: "ICU02", chapterId: "102", name: "ICU Patient Room, Isolation", nsf: 270 },
      { id: "ICUTO", chapterId: "102", name: "ICU Patient Toilet", nsf: 60 },
      { id: "ICUFA", chapterId: "102", name: "ICU Family Consult Room", nsf: 120 },
      { id: "ICUWR", chapterId: "102", name: "ICU Workroom", nsf: 150 },
      { id: "ICUMD", chapterId: "102", name: "ICU Medication Room", nsf: 120 },
      { id: "ICUUC", chapterId: "102", name: "ICU Utility Clean", nsf: 80 },
      { id: "ICUUS", chapterId: "102", name: "ICU Utility Soiled", nsf: 80 },
      { id: "ICUEQ", chapterId: "102", name: "ICU Equipment Storage", nsf: 80 },
      
      // CHAPTER 112: MATERNITY
      { id: "LDR01", chapterId: "112", name: "Labor, Delivery, Recovery Room (LDR)", nsf: 350 },
      { id: "LDRP1", chapterId: "112", name: "Labor, Delivery, Recovery, Postpartum (LDRP)", nsf: 400 },
      { id: "LABOR", chapterId: "112", name: "Labor Room", nsf: 200 },
      { id: "DELIV", chapterId: "112", name: "Delivery Room", nsf: 400 },
      { id: "RECOV", chapterId: "112", name: "Recovery Room", nsf: 140 },
      { id: "NURSY", chapterId: "112", name: "Nursery", nsf: 120 },
      { id: "MATWR", chapterId: "112", name: "Maternity Workroom", nsf: 150 },
      
      // CHAPTER 122: PEDIATRICS
      { id: "PEDBR", chapterId: "122", name: "Pediatric Patient Bedroom", nsf: 140 },
      { id: "PEDPT", chapterId: "122", name: "Pediatric Play Room", nsf: 200 },
      { id: "PEDWR", chapterId: "122", name: "Pediatric Workroom", nsf: 150 },
      
      // CHAPTER 124: NICU
      { id: "NICU1", chapterId: "124", name: "NICU Patient Space, Level II", nsf: 120 },
      { id: "NICU2", chapterId: "124", name: "NICU Patient Space, Level III", nsf: 150 },
      { id: "NICUW", chapterId: "124", name: "NICU Workroom", nsf: 150 },
      
      // CHAPTER 126: PSYCHIATRY
      { id: "PSYBR", chapterId: "126", name: "Psychiatric Patient Bedroom", nsf: 140 },
      { id: "PSYTO", chapterId: "126", name: "Psychiatric Patient Toilet", nsf: 60 },
      { id: "PSYDA", chapterId: "126", name: "Psychiatric Day Room", nsf: 400 },
      { id: "PSYDI", chapterId: "126", name: "Psychiatric Dining Room", nsf: 300 },
      { id: "PSYOC", chapterId: "126", name: "Psychiatric Occupational Therapy", nsf: 400 },
      { id: "PSYEX", chapterId: "126", name: "Psychiatric Exercise Room", nsf: 300 },
      { id: "PSYQU", chapterId: "126", name: "Psychiatric Quiet Room", nsf: 100 },
      { id: "PSYSE", chapterId: "126", name: "Psychiatric Seclusion Room", nsf: 100 },
      
      // CHAPTER 130: SCI
      { id: "SCIBR", chapterId: "130", name: "SCI Patient Bedroom", nsf: 200 },
      { id: "SCITO", chapterId: "130", name: "SCI Patient Toilet", nsf: 80 },
      { id: "SCISH", chapterId: "130", name: "SCI Patient Shower", nsf: 60 },
      { id: "SCITR", chapterId: "130", name: "SCI Therapy Room", nsf: 400 },
      
      // CHAPTER 132: BLIND REHAB
      { id: "BRBR1", chapterId: "132", name: "Blind Rehab Patient Bedroom", nsf: 140 },
      { id: "BRTR1", chapterId: "132", name: "Blind Rehab Training Room", nsf: 300 },
      
      // CHAPTER 202: AMBULATORY CARE
      { id: "EXCL1", chapterId: "202", name: "Exam/Consult Room, Primary Care", nsf: 120 },
      { id: "EXCL2", chapterId: "202", name: "Exam/Consult Room, Specialty", nsf: 120 },
      { id: "PROC1", chapterId: "202", name: "Procedure Room, Minor", nsf: 150 },
      { id: "OFCL1", chapterId: "202", name: "Office, Provider", nsf: 120 },
      { id: "WRMCL", chapterId: "202", name: "Workroom, Clinical", nsf: 120 },
      
      // CHAPTER 210: SURGERY
      { id: "OPROM", chapterId: "210", name: "Operating Room", nsf: 600 },
      { id: "ORCYS", chapterId: "210", name: "Cystoscopy Room", nsf: 400 },
      { id: "SCRUB", chapterId: "210", name: "Scrub/Gown Area", nsf: 80 },
      { id: "SUBST", chapterId: "210", name: "Sub-Sterile Room", nsf: 80 },
      { id: "ANSUP", chapterId: "210", name: "Anesthesia Supply Room", nsf: 150 },
      { id: "ORSTR", chapterId: "210", name: "OR Supply/Storage", nsf: 200 },
      { id: "ORSTC", chapterId: "210", name: "OR Sterile Supply", nsf: 150 },
      
      // CHAPTER 214: ANESTHESIA
      { id: "OFAN1", chapterId: "214", name: "Office, Anesthesiologist", nsf: 120 },
      { id: "ANWRK", chapterId: "214", name: "Anesthesia Workroom", nsf: 150 },
      
      // CHAPTER 218: PACU
      { id: "PACUB", chapterId: "218", name: "PACU Patient Bay", nsf: 120 },
      { id: "PACUW", chapterId: "218", name: "PACU Workstation", nsf: 150 },
      
      // CHAPTER 224: PAIN MANAGEMENT
      { id: "PAINC", chapterId: "224", name: "Pain Management Consult Room", nsf: 120 },
      { id: "PAINP", chapterId: "224", name: "Pain Management Procedure Room", nsf: 150 },
      
      // CHAPTER 230: ENDOSCOPY
      { id: "ENDPR", chapterId: "230", name: "Endoscopy Procedure Room", nsf: 350 },
      { id: "ENDREC", chapterId: "230", name: "Endoscopy Recovery Bay", nsf: 80 },
      { id: "ENDCL", chapterId: "230", name: "Endoscope Cleaning Room", nsf: 120 },
      
      // CHAPTER 256: EMERGENCY
      { id: "EDTRT", chapterId: "256", name: "ED Treatment Room", nsf: 140 },
      { id: "EDTRA", chapterId: "256", name: "ED Trauma Bay", nsf: 400 },
      { id: "EDCAR", chapterId: "256", name: "ED Cardiac Room", nsf: 200 },
      { id: "EDTRI", chapterId: "256", name: "ED Triage Room", nsf: 100 },
      { id: "EDWAI", chapterId: "256", name: "ED Waiting Room", nsf: 300 },
      { id: "EDWRK", chapterId: "256", name: "ED Workroom", nsf: 150 },
      
      // CHAPTER 258: URGENT CARE
      { id: "UCTRT", chapterId: "258", name: "Urgent Care Treatment Room", nsf: 120 },
      { id: "UCWAI", chapterId: "258", name: "Urgent Care Waiting", nsf: 200 },
      
      // CHAPTER 260: IMAGING
      { id: "XRAY1", chapterId: "260", name: "Radiographic/Fluoroscopic Room", nsf: 350 },
      { id: "XRCT1", chapterId: "260", name: "CT Scanner Room", nsf: 500 },
      { id: "XRMRI", chapterId: "260", name: "MRI Room", nsf: 600 },
      { id: "XRUS1", chapterId: "260", name: "Ultrasound Room", nsf: 200 },
      { id: "XRCON", chapterId: "260", name: "Radiologist Control/Reading Room", nsf: 150 },
      { id: "XRCHG", chapterId: "260", name: "Patient Changing Room", nsf: 40 },
      { id: "XRWAI", chapterId: "260", name: "Imaging Waiting Area", nsf: 200 },
      
      // CHAPTER 262: CARDIOLOGY
      { id: "CARDC", chapterId: "262", name: "Cardiology Consult Room", nsf: 120 },
      { id: "CECHO", chapterId: "262", name: "Echocardiography Room", nsf: 200 },
      { id: "CSTRS", chapterId: "262", name: "Cardiac Stress Test Room", nsf: 250 },
      { id: "CCATH", chapterId: "262", name: "Cardiac Catheterization Lab", nsf: 800 },
      
      // CHAPTER 264: NUCLEAR MEDICINE
      { id: "NMGAM", chapterId: "264", name: "Gamma Camera Room", nsf: 350 },
      { id: "NMPTS", chapterId: "264", name: "Nuclear Med Patient Waiting", nsf: 80 },
      { id: "NMHOT", chapterId: "264", name: "Hot Lab", nsf: 120 },
      
      // CHAPTER 266: RADIATION ONCOLOGY
      { id: "ROLAC", chapterId: "266", name: "Linear Accelerator Room", nsf: 600 },
      { id: "ROSIM", chapterId: "266", name: "Simulation Room", nsf: 400 },
      { id: "ROCON", chapterId: "266", name: "Radiation Oncology Consult", nsf: 120 },
      { id: "ROWAI", chapterId: "266", name: "Radiation Oncology Waiting", nsf: 200 },
      
      // CHAPTER 268: PHARMACY
      { id: "PHCON", chapterId: "268", name: "Pharmacy Consult Room", nsf: 100 },
      { id: "PHDIS", chapterId: "268", name: "Outpatient Dispensing", nsf: 300 },
      { id: "PHIVA", chapterId: "268", name: "IV Admixture Room", nsf: 200 },
      { id: "PHINV", chapterId: "268", name: "Investigational Drug Room", nsf: 120 },
      { id: "PHSTO", chapterId: "268", name: "Pharmacy Storage", nsf: 400 },
      { id: "PHOFF", chapterId: "268", name: "Pharmacist Office", nsf: 100 },
      
      // CHAPTER 270: LAB
      { id: "LABCH", chapterId: "270", name: "Chemistry Lab", nsf: 600 },
      { id: "LABHE", chapterId: "270", name: "Hematology Lab", nsf: 400 },
      { id: "LABMI", chapterId: "270", name: "Microbiology Lab", nsf: 500 },
      { id: "LABPA", chapterId: "270", name: "Pathology Lab", nsf: 400 },
      { id: "LABGR", chapterId: "270", name: "Gross Anatomy Room", nsf: 300 },
      { id: "LABPC", chapterId: "270", name: "Phlebotomy Collection", nsf: 80 },
      { id: "LABOF", chapterId: "270", name: "Pathologist Office", nsf: 120 },
      
      // CHAPTER 272: BLOOD BANK
      { id: "BBSTO", chapterId: "272", name: "Blood Bank Storage", nsf: 200 },
      { id: "BBAPH", chapterId: "272", name: "Apheresis Room", nsf: 150 },
      { id: "BBWRK", chapterId: "272", name: "Blood Bank Workroom", nsf: 200 },
      
      // CHAPTER 280: PROSTHETICS
      { id: "PROEX", chapterId: "280", name: "Prosthetics Exam Room", nsf: 120 },
      { id: "PROFB", chapterId: "280", name: "Prosthetics Fabrication", nsf: 500 },
      { id: "PROFF", chapterId: "280", name: "Prosthetist Office", nsf: 100 },
      
      // CHAPTER 282: PM&R
      { id: "PTGYM", chapterId: "282", name: "Physical Therapy Gymnasium", nsf: 800 },
      { id: "PTTRT", chapterId: "282", name: "PT Treatment Cubicle", nsf: 80 },
      { id: "OTTRM", chapterId: "282", name: "Occupational Therapy Room", nsf: 200 },
      { id: "OTADL", chapterId: "282", name: "OT Activities of Daily Living", nsf: 300 },
      { id: "PMOFF", chapterId: "282", name: "Therapist Office", nsf: 100 },
      
      // CHAPTER 284: AUDIOLOGY
      { id: "AUDBO", chapterId: "284", name: "Audiology Booth", nsf: 80 },
      { id: "SPCON", chapterId: "284", name: "Speech Pathology Room", nsf: 120 },
      { id: "AUDOF", chapterId: "284", name: "Audiologist Office", nsf: 100 },
      
      // CHAPTER 286: NUTRITION
      { id: "KITCN", chapterId: "286", name: "Main Kitchen", nsf: 2000 },
      { id: "DININ", chapterId: "286", name: "Dining Room", nsf: 600 },
      { id: "CAFET", chapterId: "286", name: "Cafeteria", nsf: 1200 },
      { id: "NUTOF", chapterId: "286", name: "Dietitian Office", nsf: 100 },
      { id: "NUTCO", chapterId: "286", name: "Nutrition Consult Room", nsf: 100 },
      
      // CHAPTER 290: MENTAL HEALTH
      { id: "MHCON", chapterId: "290", name: "Mental Health Consult Room", nsf: 120 },
      { id: "MHGRP", chapterId: "290", name: "Group Therapy Room", nsf: 300 },
      { id: "MHOFF", chapterId: "290", name: "Psychiatrist/Psychologist Office", nsf: 120 },
      { id: "MHSUB", chapterId: "290", name: "Substance Abuse Treatment Room", nsf: 150 },
      
      // CHAPTER 292: SOCIAL WORK
      { id: "SWCON", chapterId: "292", name: "Social Work Consult Room", nsf: 100 },
      { id: "SWOFF", chapterId: "292", name: "Social Worker Office", nsf: 100 },
      
      // CHAPTER 294: CHAPLAIN
      { id: "CHOFF", chapterId: "294", name: "Chaplain Office", nsf: 100 },
      { id: "CHAPE", chapterId: "294", name: "Chapel", nsf: 800 },
      { id: "CHMED", chapterId: "294", name: "Meditation Room", nsf: 120 },
      
      // CHAPTER 298: EDUCATION
      { id: "EDCLR", chapterId: "298", name: "Classroom", nsf: 600 },
      { id: "EDCON", chapterId: "298", name: "Conference Room", nsf: 400 },
      { id: "EDOFF", chapterId: "298", name: "Educator Office", nsf: 100 },
      { id: "EDLIB", chapterId: "298", name: "Library", nsf: 800 },
      
      // CHAPTER 300: ADMINISTRATION
      { id: "ADDIR", chapterId: "300", name: "Director Office", nsf: 200 },
      { id: "ADOFF", chapterId: "300", name: "Administrative Office", nsf: 100 },
      { id: "ADCON", chapterId: "300", name: "Conference Room", nsf: 300 },
      { id: "ADWRK", chapterId: "300", name: "Workroom/Copy", nsf: 150 },
      
      // CHAPTER 310: MEDICAL RECORDS
      { id: "MRREG", chapterId: "310", name: "Registration/Admitting", nsf: 80 },
      { id: "MRFIL", chapterId: "310", name: "File Room", nsf: 800 },
      { id: "MRWRK", chapterId: "310", name: "Medical Records Work Area", nsf: 200 },
      { id: "MROFF", chapterId: "310", name: "Medical Records Office", nsf: 100 },
      
      // CHAPTER 330: VOLUNTARY SERVICE
      { id: "VSOFF", chapterId: "330", name: "Voluntary Service Office", nsf: 100 },
      { id: "VSWRK", chapterId: "330", name: "Volunteer Work Area", nsf: 200 },
      
      // CHAPTER 340: ENVIRONMENTAL MGMT
      { id: "EMOFF", chapterId: "340", name: "EMS Office", nsf: 100 },
      { id: "EMSTO", chapterId: "340", name: "Housekeeping Storage", nsf: 200 },
      { id: "EMJAN", chapterId: "340", name: "Janitor Closet", nsf: 40 },
      
      // CHAPTER 350: STERILE PROCESSING
      { id: "SPDEC", chapterId: "350", name: "Decontamination Area", nsf: 400 },
      { id: "SPPRE", chapterId: "350", name: "Prep & Pack Area", nsf: 400 },
      { id: "SPSTR", chapterId: "350", name: "Sterilization Room", nsf: 300 },
      { id: "SPSTO", chapterId: "350", name: "Sterile Storage", nsf: 300 },
      
      // CHAPTER 360: LINEN
      { id: "LNCLN", chapterId: "360", name: "Clean Linen Storage", nsf: 400 },
      { id: "LNSOL", chapterId: "360", name: "Soiled Linen Holding", nsf: 200 },
      { id: "LNLAU", chapterId: "360", name: "Laundry Processing", nsf: 800 },
      
      // CHAPTER 370: ENGINEERING
      { id: "ENGOF", chapterId: "370", name: "Engineering Office", nsf: 100 },
      { id: "ENGSH", chapterId: "370", name: "Engineering Shop", nsf: 400 },
      { id: "ENGST", chapterId: "370", name: "Engineering Storage", nsf: 300 },
      
      // CHAPTER 380: POLICE
      { id: "POLOF", chapterId: "380", name: "Police Office", nsf: 100 },
      { id: "POLDI", chapterId: "380", name: "Police Dispatch", nsf: 150 },
      
      // CHAPTER 390: TELECOM
      { id: "TELOF", chapterId: "390", name: "Telecommunications Office", nsf: 100 },
      { id: "TELMDF", chapterId: "390", name: "MDF/IDF Room", nsf: 200 },
      
      // CHAPTER 420: STORAGE
      { id: "STRGE", chapterId: "420", name: "General Storage", nsf: 1000 },
      { id: "RECEI", chapterId: "420", name: "Receiving Dock", nsf: 600 }
    ];

    const SAMPLE_EQUIPMENT = [];  // Will be loaded from Equipment_Guide_parsed_v2.txt

    const SAMPLE_ROOM_EQUIPMENT = [];  // Will be loaded from Equipment_Guide_parsed_v2.txt

    // -----------------------------
    // STATE
    // -----------------------------

    let activeChapters = ["100", "102", "210", "256", "268"];
    let driverValues = [
      { projectId: PROJECT.id, driverId: "CH100_A", value: 32 },
      { projectId: PROJECT.id, driverId: "CH100_B", value: false },
      { projectId: PROJECT.id, driverId: "CH102_A", value: 12 },
      { projectId: PROJECT.id, driverId: "CH102_B", value: false },
      { projectId: PROJECT.id, driverId: "CH102_C", value: false },
      { projectId: PROJECT.id, driverId: "CH210_A", value: 0 },
      { projectId: PROJECT.id, driverId: "CH210_B", value: 4 },
      { projectId: PROJECT.id, driverId: "CH210_C", value: false },
      { projectId: PROJECT.id, driverId: "CH210_D", value: false },
      { projectId: PROJECT.id, driverId: "CH256_A", value: 0 },
      { projectId: PROJECT.id, driverId: "CH256_B", value: 8 },
      { projectId: PROJECT.id, driverId: "CH256_C", value: false },
      { projectId: PROJECT.id, driverId: "CH268_A", value: 3 },
      { projectId: PROJECT.id, driverId: "CH268_B", value: 50000 },
      { projectId: PROJECT.id, driverId: "CH268_C", value: true },
      { projectId: PROJECT.id, driverId: "CH268_D", value: false }
    ];

    let currentMode = 'program';
    let compareLeftRoom = null;
    let compareRightRoom = null; // 'program' or 'reference'
    let selectedNode = null;
    let expandedNodes = new Set(['project']);
    let viewState = 'project-list'; // 'project-list' or 'project-detail'
    let selectedProjectInList = null; // Project selected in list view (not opened)

    let globalIdCounter = 1;
    function makeId() {
      return "id-" + (globalIdCounter++);
    }

    // -----------------------------
    // RULE ENGINE
    // -----------------------------

    function buildProgram(project, driverValues, activeChapterIds) {
      const driverMap = new Map();
      driverValues.forEach(d => driverMap.set(d.driverId, d));

      // Helper function to get driver value
      const getVal = (driverId) => {
        const driver = driverMap.get(driverId);
        if (!driver) return 0;
        if (typeof driver.value === "boolean") return driver.value ? 1 : 0;
        return typeof driver.value === "number" ? driver.value : Number(driver.value || 0);
      };

      const getBool = (driverId) => {
        const driver = driverMap.get(driverId);
        if (!driver) return false;
        return driver.value === true || driver.value === "true";
      };

      const roomRequirements = [];

      // Helper to add room requirement
      const addRoom = (chapterId, roomId, count) => {
        if (count > 0) {
          roomRequirements.push({
            id: makeId(),
            projectId: project.id,
            chapterId: chapterId,
            roomTemplateId: roomId,
            requiredCount: Math.ceil(count)
          });
        }
      };

      // ===== CHAPTER 100: MED/SURG PCU =====
      if (activeChapterIds.includes("100")) {
        const beds = getVal("CH100_A");
        const hasBehavioral = getBool("CH100_B");
        
        if (beds > 0) {
          // Patient Bedrooms - 1 per bed
          addRoom("100", "IMS21", beds);
          
          // Isolation rooms - 1 per 16 beds
          addRoom("100", "IMS23", Math.ceil(beds / 16));
          addRoom("100", "IMS24", Math.ceil(beds / 16)); // Anteroom for isolation
          
          // Bariatric rooms - minimum 1 per 32 beds
          addRoom("100", "IMS27", Math.max(1, Math.ceil(beds / 32)));
        }
      }

      // ===== CHAPTER 102: ICU =====
      if (activeChapterIds.includes("102")) {
        const icuBeds = getVal("CH102_A");
        const hasCCU = getBool("CH102_B");
        const hasCath = getBool("CH102_C");
        
        if (icuBeds > 0) {
          // ICU patient rooms - 1 per bed
          addRoom("102", "ICU01", icuBeds);
          
          // Isolation rooms - minimum 1, or 10% of beds
          addRoom("102", "ICU02", Math.max(1, Math.ceil(icuBeds * 0.1)));
          
          // Patient toilets - 1 per 2 beds
          addRoom("102", "ICUTO", Math.ceil(icuBeds / 2));
          
          // Family consult - 1 per unit (12 beds)
          addRoom("102", "ICUFA", Math.ceil(icuBeds / 12));
          
          // Workroom - 1 per unit
          addRoom("102", "ICUWR", Math.ceil(icuBeds / 12));
          
          // Medication room - 1 per unit
          addRoom("102", "ICUMD", Math.ceil(icuBeds / 12));
          
          // Utility clean - 1 per unit
          addRoom("102", "ICUUC", Math.ceil(icuBeds / 12));
          
          // Utility soiled - 1 per unit
          addRoom("102", "ICUUS", Math.ceil(icuBeds / 12));
          
          // Equipment storage - 1 per unit
          addRoom("102", "ICUEQ", Math.ceil(icuBeds / 12));
          
          // If Cardiac Cath Lab authorized
          if (hasCath) {
            addRoom("102", "CCATH", 1);
          }
        }
      }

      // ===== CHAPTER 112: MATERNITY =====
      if (activeChapterIds.includes("112")) {
        const deliveries = getVal("CH112_A");
        const hasLDR = getBool("CH112_B");
        const hasLDRP = getBool("CH112_C");
        
        if (deliveries > 0) {
          if (hasLDRP) {
            // LDRP rooms - 1 per 300 deliveries
            addRoom("112", "LDRP1", Math.max(1, Math.ceil(deliveries / 300)));
          } else if (hasLDR) {
            // LDR rooms - 1 per 400 deliveries
            addRoom("112", "LDR01", Math.max(1, Math.ceil(deliveries / 400)));
          } else {
            // Traditional Labor & Delivery
            addRoom("112", "LABOR", Math.max(1, Math.ceil(deliveries / 500)));
            addRoom("112", "DELIV", Math.max(1, Math.ceil(deliveries / 600)));
          }
          
          // Recovery rooms
          addRoom("112", "RECOV", Math.max(2, Math.ceil(deliveries / 400)));
          
          // Nursery
          addRoom("112", "NURSY", Math.max(1, Math.ceil(deliveries / 500)));
          
          // Workroom
          addRoom("112", "MATWR", 1);
        }
      }

      // ===== CHAPTER 122: PEDIATRICS =====
      if (activeChapterIds.includes("122")) {
        const pedBeds = getVal("CH122_A");
        
        if (pedBeds > 0) {
          addRoom("122", "PEDBR", pedBeds);
          addRoom("122", "PEDPT", Math.ceil(pedBeds / 16));
          addRoom("122", "PEDWR", Math.ceil(pedBeds / 16));
        }
      }

      // ===== CHAPTER 124: NICU =====
      if (activeChapterIds.includes("124")) {
        const nicuBeds = getVal("CH124_A");
        const hasLevel2 = getBool("CH124_B");
        const hasLevel3 = getBool("CH124_C");
        
        if (nicuBeds > 0) {
          if (hasLevel3) {
            addRoom("124", "NICU2", nicuBeds);
          } else if (hasLevel2) {
            addRoom("124", "NICU1", nicuBeds);
          }
          addRoom("124", "NICUW", Math.ceil(nicuBeds / 12));
        }
      }

      // ===== CHAPTER 126: PSYCHIATRY =====
      if (activeChapterIds.includes("126")) {
        const psyBeds = getVal("CH126_A");
        const hasIntensive = getBool("CH126_B");
        
        if (psyBeds > 0) {
          // Bedrooms - 1 per bed
          addRoom("126", "PSYBR", psyBeds);
          
          // Toilets - 1 per bedroom
          addRoom("126", "PSYTO", psyBeds);
          
          // Day room - 1 per 16 beds
          addRoom("126", "PSYDA", Math.ceil(psyBeds / 16));
          
          // Dining - 1 per 16 beds
          addRoom("126", "PSYDI", Math.ceil(psyBeds / 16));
          
          // OT space - 1 per 16 beds
          addRoom("126", "PSYOC", Math.ceil(psyBeds / 16));
          
          // Exercise room - 1 per 32 beds
          addRoom("126", "PSYEX", Math.ceil(psyBeds / 32));
          
          // Quiet room - 1 per 16 beds
          addRoom("126", "PSYQU", Math.ceil(psyBeds / 16));
          
          // Seclusion room - minimum 2
          addRoom("126", "PSYSE", Math.max(2, Math.ceil(psyBeds / 16)));
        }
      }

      // ===== CHAPTER 130: SCI =====
      if (activeChapterIds.includes("130")) {
        const sciBeds = getVal("CH130_A");
        
        if (sciBeds > 0) {
          addRoom("130", "SCIBR", sciBeds);
          addRoom("130", "SCITO", sciBeds);
          addRoom("130", "SCISH", Math.ceil(sciBeds / 4));
          addRoom("130", "SCITR", Math.ceil(sciBeds / 8));
        }
      }

      // ===== CHAPTER 132: BLIND REHAB =====
      if (activeChapterIds.includes("132")) {
        const brBeds = getVal("CH132_A");
        
        if (brBeds > 0) {
          addRoom("132", "BRBR1", brBeds);
          addRoom("132", "BRTR1", Math.ceil(brBeds / 8));
        }
      }

      // ===== CHAPTER 202: AMBULATORY CARE =====
      if (activeChapterIds.includes("202")) {
        const primaryStops = getVal("CH202_A");
        const primaryFTE = getVal("CH202_B");
        const specialtyFTE = getVal("CH202_C");
        
        // Primary care exam rooms - 1.5 per FTE
        if (primaryFTE > 0) {
          addRoom("202", "EXCL1", Math.ceil(primaryFTE * 1.5));
          addRoom("202", "OFCL1", primaryFTE);
        }
        
        // Specialty exam rooms - 1.5 per FTE
        if (specialtyFTE > 0) {
          addRoom("202", "EXCL2", Math.ceil(specialtyFTE * 1.5));
        }
        
        // Procedure rooms - 1 per 10,000 stops
        if (primaryStops > 0) {
          addRoom("202", "PROC1", Math.max(1, Math.ceil(primaryStops / 10000)));
          addRoom("202", "WRMCL", Math.max(1, Math.ceil((primaryFTE + specialtyFTE) / 5)));
        }
      }

      // ===== CHAPTER 210: SURGERY =====
      if (activeChapterIds.includes("210")) {
        const surgeries = getVal("CH210_A");
        const orRooms = getVal("CH210_B");
        const hasAmb = getBool("CH210_C");
        const hasCysto = getBool("CH210_D");
        
        if (orRooms > 0) {
          addRoom("210", "OPROM", orRooms);
          addRoom("210", "SCRUB", orRooms);
          addRoom("210", "SUBST", orRooms);
          addRoom("210", "ANSUP", Math.max(1, Math.ceil(orRooms / 4)));
          addRoom("210", "ORSTR", Math.max(1, Math.ceil(orRooms / 4)));
          addRoom("210", "ORSTC", Math.max(1, Math.ceil(orRooms / 4)));
          
          if (hasCysto) {
            addRoom("210", "ORCYS", 1);
          }
        }
      }

      // ===== CHAPTER 214: ANESTHESIA =====
      if (activeChapterIds.includes("214")) {
        const anesthFTE = getVal("CH214_B");
        
        if (anesthFTE > 0) {
          addRoom("214", "OFAN1", anesthFTE);
          addRoom("214", "ANWRK", Math.ceil(anesthFTE / 4));
        }
      }

      // ===== CHAPTER 218: PACU =====
      if (activeChapterIds.includes("218")) {
        const pacuBeds = getVal("CH218_A");
        
        if (pacuBeds > 0) {
          addRoom("218", "PACUB", pacuBeds);
          addRoom("218", "PACUW", Math.ceil(pacuBeds / 8));
        }
      }

      // ===== CHAPTER 224: PAIN MANAGEMENT =====
      if (activeChapterIds.includes("224")) {
        const painStops = getVal("CH224_A");
        
        if (painStops > 0) {
          addRoom("224", "PAINC", Math.max(1, Math.ceil(painStops / 2500)));
          addRoom("224", "PAINP", Math.max(1, Math.ceil(painStops / 3000)));
        }
      }

      // ===== CHAPTER 230: ENDOSCOPY =====
      if (activeChapterIds.includes("230")) {
        const endoProc = getVal("CH230_A");
        const endoRooms = getVal("CH230_B");
        
        if (endoRooms > 0) {
          addRoom("230", "ENDPR", endoRooms);
          addRoom("230", "ENDREC", endoRooms * 2);
          addRoom("230", "ENDCL", Math.max(1, Math.ceil(endoRooms / 2)));
        }
      }

      // ===== CHAPTER 256: EMERGENCY DEPARTMENT =====
      if (activeChapterIds.includes("256")) {
        const edVisits = getVal("CH256_A");
        const edRooms = getVal("CH256_B");
        const hasTrauma = getBool("CH256_C");
        
        if (edVisits > 0 || edRooms > 0) {
          const rooms = edRooms > 0 ? edRooms : Math.max(4, Math.ceil(edVisits / 3000));
          
          addRoom("256", "EDTRT", rooms);
          addRoom("256", "EDTRI", Math.max(1, Math.ceil(rooms / 8)));
          addRoom("256", "EDCAR", Math.max(1, Math.ceil(rooms / 10)));
          addRoom("256", "EDWAI", Math.max(1, Math.ceil(rooms / 10)));
          addRoom("256", "EDWRK", Math.max(1, Math.ceil(rooms / 8)));
          
          if (hasTrauma) {
            addRoom("256", "EDTRA", 1);
          }
        }
      }

      // ===== CHAPTER 258: URGENT CARE =====
      if (activeChapterIds.includes("258")) {
        const ucVisits = getVal("CH258_A");
        
        if (ucVisits > 0) {
          addRoom("258", "UCTRT", Math.max(2, Math.ceil(ucVisits / 5000)));
          addRoom("258", "UCWAI", 1);
        }
      }

      // ===== CHAPTER 260: IMAGING =====
      if (activeChapterIds.includes("260")) {
        const xrayRooms = getVal("CH260_B");
        const ctScanners = getVal("CH260_C");
        const mriUnits = getVal("CH260_D");
        const usRooms = getVal("CH260_E");
        
        if (xrayRooms > 0) {
          addRoom("260", "XRAY1", xrayRooms);
          addRoom("260", "XRCON", Math.max(1, Math.ceil(xrayRooms / 3)));
        }
        
        if (ctScanners > 0) {
          addRoom("260", "XRCT1", ctScanners);
        }
        
        if (mriUnits > 0) {
          addRoom("260", "XRMRI", mriUnits);
        }
        
        if (usRooms > 0) {
          addRoom("260", "XRUS1", usRooms);
        }
        
        const totalRooms = xrayRooms + ctScanners + mriUnits + usRooms;
        if (totalRooms > 0) {
          addRoom("260", "XRCHG", Math.max(2, Math.ceil(totalRooms / 2)));
          addRoom("260", "XRWAI", Math.max(1, Math.ceil(totalRooms / 5)));
        }
      }

      // ===== CHAPTER 262: CARDIOLOGY =====
      if (activeChapterIds.includes("262")) {
        const cardStops = getVal("CH262_A");
        const hasEcho = getBool("CH262_B");
        const hasStress = getBool("CH262_C");
        
        if (cardStops > 0) {
          addRoom("262", "CARDC", Math.max(1, Math.ceil(cardStops / 2000)));
          
          if (hasEcho) {
            addRoom("262", "CECHO", Math.max(1, Math.ceil(cardStops / 3000)));
          }
          
          if (hasStress) {
            addRoom("262", "CSTRS", Math.max(1, Math.ceil(cardStops / 2500)));
          }
        }
      }

      // ===== CHAPTER 264: NUCLEAR MEDICINE =====
      if (activeChapterIds.includes("264")) {
        const nmProc = getVal("CH264_A");
        const gammaCams = getVal("CH264_B");
        
        if (gammaCams > 0) {
          addRoom("264", "NMGAM", gammaCams);
          addRoom("264", "NMPTS", gammaCams * 2);
          addRoom("264", "NMHOT", Math.max(1, Math.ceil(gammaCams / 2)));
        }
      }

      // ===== CHAPTER 266: RADIATION ONCOLOGY =====
      if (activeChapterIds.includes("266")) {
        const roTreatments = getVal("CH266_A");
        const linacs = getVal("CH266_B");
        
        if (linacs > 0) {
          addRoom("266", "ROLAC", linacs);
          addRoom("266", "ROSIM", Math.max(1, Math.ceil(linacs / 2)));
          addRoom("266", "ROCON", Math.max(2, linacs));
          addRoom("266", "ROWAI", Math.max(1, Math.ceil(linacs / 2)));
        }
      }

      // ===== CHAPTER 268: PHARMACY =====
      if (activeChapterIds.includes("268")) {
        const pharmFTE = getVal("CH268_A");
        const rxVolume = getVal("CH268_B");
        const hasIV = getBool("CH268_C");
        const hasInv = getBool("CH268_D");
        
        if (pharmFTE > 0) {
          addRoom("268", "PHCON", Math.max(1, Math.ceil(pharmFTE / 2)));
          addRoom("268", "PHOFF", Math.ceil(pharmFTE / 3));
        }
        
        if (rxVolume > 0) {
          addRoom("268", "PHDIS", Math.max(1, Math.ceil(rxVolume / 100000)));
          addRoom("268", "PHSTO", Math.max(1, Math.ceil(rxVolume / 80000)));
        }
        
        if (hasIV) {
          addRoom("268", "PHIVA", 1);
        }
        
        if (hasInv) {
          addRoom("268", "PHINV", 1);
        }
      }

      // ===== CHAPTER 270: PATHOLOGY & LAB =====
      if (activeChapterIds.includes("270")) {
        const labTests = getVal("CH270_A");
        const pathFTE = getVal("CH270_B");
        const hasAnatPath = getBool("CH270_C");
        const hasMicro = getBool("CH270_D");
        
        if (labTests > 0) {
          addRoom("270", "LABCH", Math.max(1, Math.ceil(labTests / 200000)));
          addRoom("270", "LABHE", Math.max(1, Math.ceil(labTests / 250000)));
          addRoom("270", "LABPC", Math.max(2, Math.ceil(labTests / 100000)));
          
          if (hasMicro) {
            addRoom("270", "LABMI", Math.max(1, Math.ceil(labTests / 300000)));
          }
          
          if (hasAnatPath) {
            addRoom("270", "LABPA", 1);
            addRoom("270", "LABGR", 1);
          }
        }
        
        if (pathFTE > 0) {
          addRoom("270", "LABOF", pathFTE);
        }
      }

      // ===== CHAPTER 272: BLOOD BANK =====
      if (activeChapterIds.includes("272")) {
        const bloodUnits = getVal("CH272_A");
        const hasApheresis = getBool("CH272_B");
        
        if (bloodUnits > 0) {
          addRoom("272", "BBSTO", Math.max(1, Math.ceil(bloodUnits / 5000)));
          addRoom("272", "BBWRK", 1);
          
          if (hasApheresis) {
            addRoom("272", "BBAPH", 1);
          }
        }
      }

      // ===== CHAPTER 280: PROSTHETICS =====
      if (activeChapterIds.includes("280")) {
        const prosFTE = getVal("CH280_A");
        const hasFab = getBool("CH280_B");
        
        if (prosFTE > 0) {
          addRoom("280", "PROEX", Math.max(1, Math.ceil(prosFTE * 1.5)));
          addRoom("280", "PROFF", prosFTE);
          
          if (hasFab) {
            addRoom("280", "PROFB", 1);
          }
        }
      }

      // ===== CHAPTER 282: PHYSICAL MEDICINE & REHAB =====
      if (activeChapterIds.includes("282")) {
        const ptVisits = getVal("CH282_A");
        const otVisits = getVal("CH282_B");
        const ptFTE = getVal("CH282_C");
        const otFTE = getVal("CH282_D");
        
        if (ptVisits > 0 || ptFTE > 0) {
          addRoom("282", "PTGYM", Math.max(1, Math.ceil(ptFTE / 8)));
          addRoom("282", "PTTRT", Math.max(2, Math.ceil(ptVisits / 3000)));
        }
        
        if (otVisits > 0 || otFTE > 0) {
          addRoom("282", "OTTRM", Math.max(2, Math.ceil(otVisits / 2500)));
          addRoom("282", "OTADL", Math.max(1, Math.ceil(otFTE / 5)));
        }
        
        if (ptFTE + otFTE > 0) {
          addRoom("282", "PMOFF", ptFTE + otFTE);
        }
      }

      // ===== CHAPTER 284: AUDIOLOGY/SPEECH =====
      if (activeChapterIds.includes("284")) {
        const audioStops = getVal("CH284_A");
        const speechVisits = getVal("CH284_B");
        const audioFTE = getVal("CH284_C");
        
        if (audioStops > 0 || audioFTE > 0) {
          addRoom("284", "AUDBO", Math.max(1, Math.ceil(audioFTE * 1.5)));
          addRoom("284", "AUDOF", audioFTE);
        }
        
        if (speechVisits > 0) {
          addRoom("284", "SPCON", Math.max(1, Math.ceil(speechVisits / 2000)));
        }
      }

      // ===== CHAPTER 286: NUTRITION & FOOD =====
      if (activeChapterIds.includes("286")) {
        const mealsPerDay = getVal("CH286_A");
        const dietFTE = getVal("CH286_B");
        const hasDining = getBool("CH286_C");
        
        if (mealsPerDay > 0) {
          addRoom("286", "KITCN", Math.max(1, Math.ceil(mealsPerDay / 500)));
          
          if (hasDining) {
            addRoom("286", "DININ", Math.max(1, Math.ceil(mealsPerDay / 200)));
          }
          
          addRoom("286", "CAFET", Math.max(1, Math.ceil(mealsPerDay / 300)));
        }
        
        if (dietFTE > 0) {
          addRoom("286", "NUTOF", dietFTE);
          addRoom("286", "NUTCO", Math.max(1, Math.ceil(dietFTE / 2)));
        }
      }

      // ===== CHAPTER 290: MENTAL HEALTH =====
      if (activeChapterIds.includes("290")) {
        const mhStops = getVal("CH290_A");
        const psychFTE = getVal("CH290_B");
        const psycholFTE = getVal("CH290_C");
        const hasSub = getBool("CH290_D");
        
        if (mhStops > 0) {
          addRoom("290", "MHCON", Math.max(2, Math.ceil(mhStops / 2000)));
          addRoom("290", "MHGRP", Math.max(1, Math.ceil(mhStops / 5000)));
          
          if (hasSub) {
            addRoom("290", "MHSUB", Math.max(1, Math.ceil(mhStops / 4000)));
          }
        }
        
        if (psychFTE + psycholFTE > 0) {
          addRoom("290", "MHOFF", psychFTE + psycholFTE);
        }
      }

      // ===== CHAPTER 292: SOCIAL WORK =====
      if (activeChapterIds.includes("292")) {
        const swFTE = getVal("CH292_A");
        
        if (swFTE > 0) {
          addRoom("292", "SWCON", Math.max(1, Math.ceil(swFTE * 1.2)));
          addRoom("292", "SWOFF", swFTE);
        }
      }

      // ===== CHAPTER 294: CHAPLAIN =====
      if (activeChapterIds.includes("294")) {
        const chapFTE = getVal("CH294_A");
        const hasChapel = getBool("CH294_B");
        
        if (chapFTE > 0) {
          addRoom("294", "CHOFF", chapFTE);
        }
        
        if (hasChapel) {
          addRoom("294", "CHAPE", 1);
          addRoom("294", "CHMED", 1);
        }
      }

      // ===== CHAPTER 298: EDUCATION =====
      if (activeChapterIds.includes("298")) {
        const edFTE = getVal("CH298_A");
        const totalStaff = getVal("CH298_B");
        
        if (totalStaff > 0) {
          addRoom("298", "EDCLR", Math.max(1, Math.ceil(totalStaff / 200)));
          addRoom("298", "EDCON", Math.max(1, Math.ceil(totalStaff / 150)));
          addRoom("298", "EDLIB", Math.max(1, Math.ceil(totalStaff / 300)));
        }
        
        if (edFTE > 0) {
          addRoom("298", "EDOFF", edFTE);
        }
      }

      // ===== CHAPTER 300: ADMINISTRATION =====
      if (activeChapterIds.includes("300")) {
        const adminFTE = getVal("CH300_A");
        const totalFTE = getVal("CH300_B");
        
        if (adminFTE > 0) {
          addRoom("300", "ADDIR", Math.max(1, Math.ceil(adminFTE / 50)));
          addRoom("300", "ADOFF", adminFTE);
          addRoom("300", "ADCON", Math.max(1, Math.ceil(adminFTE / 20)));
          addRoom("300", "ADWRK", Math.max(1, Math.ceil(adminFTE / 15)));
        }
      }

      // ===== CHAPTER 310: MEDICAL RECORDS =====
      if (activeChapterIds.includes("310")) {
        const registrations = getVal("CH310_A");
        const mrFTE = getVal("CH310_B");
        
        if (registrations > 0) {
          addRoom("310", "MRREG", Math.max(2, Math.ceil(registrations / 25000)));
          addRoom("310", "MRFIL", Math.max(1, Math.ceil(registrations / 30000)));
          addRoom("310", "MRWRK", Math.max(1, Math.ceil(registrations / 40000)));
        }
        
        if (mrFTE > 0) {
          addRoom("310", "MROFF", Math.max(1, Math.ceil(mrFTE / 3)));
        }
      }

      // ===== CHAPTER 330: VOLUNTARY SERVICE =====
      if (activeChapterIds.includes("330")) {
        const vsFTE = getVal("CH330_A");
        
        if (vsFTE > 0) {
          addRoom("330", "VSOFF", vsFTE);
          addRoom("330", "VSWRK", Math.max(1, Math.ceil(vsFTE / 2)));
        }
      }

      // ===== CHAPTER 340: ENVIRONMENTAL MANAGEMENT =====
      if (activeChapterIds.includes("340")) {
        const emFTE = getVal("CH340_A");
        const buildingGSF = getVal("CH340_B");
        
        if (emFTE > 0) {
          addRoom("340", "EMOFF", Math.max(1, Math.ceil(emFTE / 10)));
          addRoom("340", "EMSTO", Math.max(2, Math.ceil(buildingGSF / 100000)));
          addRoom("340", "EMJAN", Math.max(4, Math.ceil(buildingGSF / 30000)));
        }
      }

      // ===== CHAPTER 350: STERILE PROCESSING =====
      if (activeChapterIds.includes("350")) {
        const instrSets = getVal("CH350_A");
        const spFTE = getVal("CH350_B");
        
        if (instrSets > 0 || spFTE > 0) {
          addRoom("350", "SPDEC", Math.max(1, Math.ceil(instrSets / 5000)));
          addRoom("350", "SPPRE", Math.max(1, Math.ceil(instrSets / 5000)));
          addRoom("350", "SPSTR", Math.max(1, Math.ceil(instrSets / 6000)));
          addRoom("350", "SPSTO", Math.max(1, Math.ceil(instrSets / 4000)));
        }
      }

      // ===== CHAPTER 360: LINEN SERVICE =====
      if (activeChapterIds.includes("360")) {
        const linenLbs = getVal("CH360_A");
        const hasLaundry = getBool("CH360_B");
        
        if (linenLbs > 0) {
          addRoom("360", "LNCLN", Math.max(1, Math.ceil(linenLbs / 1000)));
          addRoom("360", "LNSOL", Math.max(1, Math.ceil(linenLbs / 2000)));
          
          if (hasLaundry) {
            addRoom("360", "LNLAU", Math.max(1, Math.ceil(linenLbs / 800)));
          }
        }
      }

      // ===== CHAPTER 370: ENGINEERING =====
      if (activeChapterIds.includes("370")) {
        const engFTE = getVal("CH370_A");
        const buildingGSF = getVal("CH370_B");
        
        if (engFTE > 0) {
          addRoom("370", "ENGOF", engFTE);
          addRoom("370", "ENGSH", Math.max(1, Math.ceil(engFTE / 8)));
          addRoom("370", "ENGST", Math.max(1, Math.ceil(buildingGSF / 150000)));
        }
      }

      // ===== CHAPTER 380: POLICE SERVICE =====
      if (activeChapterIds.includes("380")) {
        const policeFTE = getVal("CH380_A");
        
        if (policeFTE > 0) {
          addRoom("380", "POLOF", Math.max(1, Math.ceil(policeFTE / 5)));
          addRoom("380", "POLDI", 1);
        }
      }

      // ===== CHAPTER 390: TELECOMMUNICATIONS =====
      if (activeChapterIds.includes("390")) {
        const telFTE = getVal("CH390_A");
        
        if (telFTE > 0) {
          addRoom("390", "TELOF", telFTE);
          addRoom("390", "TELMDF", Math.max(2, Math.ceil(telFTE / 3)));
        }
      }

      // ===== CHAPTER 420: GENERAL STORAGE =====
      if (activeChapterIds.includes("420")) {
        const buildingGSF = getVal("CH420_A");
        
        if (buildingGSF > 0) {
          addRoom("420", "STRGE", Math.max(1, Math.ceil(buildingGSF / 50000)));
          addRoom("420", "RECEI", Math.max(1, Math.ceil(buildingGSF / 100000)));
        }
      }

      // Equipment requirements from room requirements + mappings
      const equipmentRequirements = [];
      for (const rr of roomRequirements) {
        const mappings = ROOM_EQUIPMENT_MAPPINGS.filter(
          re => re.roomCode === rr.roomTemplateId
        );
        for (const mapRow of mappings) {
          equipmentRequirements.push({
            id: makeId(),
            projectId: project.id,
            roomRequirementId: rr.id,
            equipmentJsn: mapRow.jsn,
            requiredQtyPerRoom: mapRow.qty
          });
        }
      }

      return { roomRequirements, equipmentRequirements };
    }

    // -----------------------------
    // TREE VIEW FUNCTIONS
    // -----------------------------

    function switchMode(mode) {
      currentMode = mode;
      document.querySelectorAll('.mode-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.mode === mode);
      });
      
      // Show Add button only in program mode
      const addBtn = document.getElementById('add-to-project-btn');
      if (addBtn) {
        addBtn.style.display = mode === 'program' ? 'block' : 'none';
      }
      
      // Show/hide search box based on mode (not in jsn-lookup - it has its own)
      const searchBox = document.getElementById('tree-search-box');
      if (searchBox) {
        // Show search in reference and compare modes, hide in jsn-lookup
        searchBox.style.display = (mode === 'reference' || mode === 'compare') ? 'block' : 'none';
        searchBox.value = ''; // Clear search when switching modes
      }
      
      const layout = document.querySelector('.layout');
      if (mode === 'compare') {
        layout.classList.add('compare-mode');
      } else {
        layout.classList.remove('compare-mode');
      }
      
      // Update navigator title
      const navTitle = document.getElementById('nav-title');
      if (navTitle) {
        navTitle.textContent = mode === 'jsn-lookup' ? 'Equipment Search' : 'Navigator';
      }
      
      // Handle JSN Lookup mode specially
      if (mode === 'jsn-lookup') {
        renderJsnLookupMode();
        return;
      }
      
      renderAll();
    }

    // Debounce filterTree for better performance during typing
    let filterTreeTimeout = null;
    function filterTreeDebounced() {
      if (filterTreeTimeout) {
        clearTimeout(filterTreeTimeout);
      }
      filterTreeTimeout = setTimeout(filterTree, 150);
    }

    function filterTree() {
      const searchBox = document.getElementById('tree-search-box');
      const searchText = searchBox ? searchBox.value.toLowerCase().trim() : '';
      
      // Clear all search-related classes
      document.querySelectorAll('.tree-item').forEach(item => {
        item.classList.remove('search-match', 'search-highlight');
      });
      
      if (!searchText) {
        // If search is empty, show everything and collapse auto-expanded nodes
        document.querySelectorAll('.tree-item').forEach(item => {
          item.style.display = '';
        });
        renderTree();
        return;
      }
      
      // Find all matching items
      const allItems = document.querySelectorAll('.tree-item');
      const matchingItems = new Set();
      const parentItems = new Set();
      const nodesToExpand = new Set();
      
      allItems.forEach(item => {
        const text = item.textContent.toLowerCase();
        const nodeId = item.dataset.nodeId;
        
        if (text.includes(searchText)) {
          matchingItems.add(item);
          item.classList.add('search-match');
          
          // Find and highlight the exact match within the text
          if (nodeId && nodeId.startsWith('room-')) {
            item.classList.add('search-highlight');
          }
          
          // Add all parent nodes to ensure they're visible
          let parentId = item.dataset.parentId;
          while (parentId) {
            const parentItem = document.querySelector(`[data-node-id="${parentId}"]`);
            if (parentItem) {
              parentItems.add(parentItem);
              matchingItems.add(parentItem);
              
              // Track nodes that should be expanded
              nodesToExpand.add(parentId);
              
              parentId = parentItem.dataset.parentId;
            } else {
              break;
            }
          }
        }
      });
      
      // Expand parent nodes
      nodesToExpand.forEach(nodeId => {
        if (!expandedNodes.has(nodeId)) {
          expandedNodes.add(nodeId);
        }
      });
      
      // Re-render tree to show expanded state, then apply filters
      renderTree();
      
      // Re-apply search highlighting and visibility after render (async for better performance)
      requestAnimationFrame(() => {
        const updatedItems = document.querySelectorAll('.tree-item');
        const updatedMatching = new Set();
        
        updatedItems.forEach(item => {
          const text = item.textContent.toLowerCase();
          const nodeId = item.dataset.nodeId;
          
          if (text.includes(searchText)) {
            updatedMatching.add(item);
            item.classList.add('search-match');
            
            if (nodeId && nodeId.startsWith('room-')) {
              item.classList.add('search-highlight');
            }
            
            // Add parent chain
            let parentId = item.dataset.parentId;
            while (parentId) {
              const parentItem = document.querySelector(`[data-node-id="${parentId}"]`);
              if (parentItem) {
                updatedMatching.add(parentItem);
                parentId = parentItem.dataset.parentId;
              } else {
                break;
              }
            }
          }
        });
        
        // Hide non-matching items
        updatedItems.forEach(item => {
          if (updatedMatching.has(item)) {
            item.style.display = '';
          } else {
            item.style.display = 'none';
          }
        });
      }, 0);
    }    function selectProjectInList(projectId) {
      selectedProjectInList = projectId;
      renderDetail();
    }

    function openProject(projectId) {
      CURRENT_PROJECT_ID = projectId;
      localStorage.setItem('va-current-project-id', projectId);
      viewState = 'project-detail';
      selectedProjectInList = null;
      expandedNodes.clear();
      selectedNode = null;
      renderAll();
    }

    function returnToProjectList() {
      viewState = 'project-list';
      selectedProjectInList = null;
      expandedNodes.clear();
      selectedNode = null;
      renderAll();
    }

    function createNewProject() {
      const newProject = {
        id: generateId(),
        name: `Project ${USER_PROJECTS.length + 1}`,
        siteName: "",
        description: "",
        departments: [],
        createdAt: new Date().toISOString(),
        modifiedAt: new Date().toISOString()
      };
      USER_PROJECTS.push(newProject);
      saveProjects();
      openProject(newProject.id);
    }

    function deleteProject(projectId, event) {
      event.stopPropagation();
      if (USER_PROJECTS.length === 1) {
        alert('Cannot delete the last project');
        return;
      }
      if (!confirm('Are you sure you want to delete this project? This cannot be undone.')) {
        return;
      }
      USER_PROJECTS = USER_PROJECTS.filter(p => p.id !== projectId);
      if (CURRENT_PROJECT_ID === projectId) {
        CURRENT_PROJECT_ID = USER_PROJECTS[0].id;
        localStorage.setItem('va-current-project-id', CURRENT_PROJECT_ID);
      }
      saveProjects();
      renderAll();
    }

    // Export a single project to a JSON file
    function exportProject(projectId, event) {
      if (event) event.stopPropagation();
      
      const project = USER_PROJECTS.find(p => p.id === projectId);
      if (!project) {
        alert('Project not found');
        return;
      }
      
      // Create export data with metadata
      const exportData = {
        version: '1.0',
        exportedAt: new Date().toISOString(),
        type: 'va-arrange-project',
        project: project
      };
      
      const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      
      // Create safe filename from project name
      const safeName = project.name.replace(/[^a-z0-9]/gi, '-').toLowerCase();
      const date = new Date().toISOString().split('T')[0];
      
      const link = document.createElement('a');
      link.href = url;
      link.download = `${safeName}-${date}.arrange.json`;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(url);
      
      console.log(`Exported project "${project.name}" (${(JSON.stringify(exportData).length / 1024).toFixed(1)} KB)`);
    }
    
    // Import a project from a JSON file
    function importProjectFromFile() {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = '.json,.arrange.json';
      
      input.onchange = async (e) => {
        const file = e.target.files[0];
        if (!file) return;
        
        try {
          const text = await file.text();
          const data = JSON.parse(text);
          
          // Validate file format
          if (data.type !== 'va-arrange-project' || !data.project) {
            alert('Invalid file format. Please select a valid Arrange project file (.arrange.json)');
            return;
          }
          
          const importedProject = data.project;
          
          // Check for duplicate project
          const existingProject = USER_PROJECTS.find(p => p.id === importedProject.id);
          
          if (existingProject) {
            const choice = confirm(
              `A project with this ID already exists:\n\n` +
              `Existing: "${existingProject.name}" (modified ${new Date(existingProject.modifiedAt).toLocaleString()})\n` +
              `Importing: "${importedProject.name}" (exported ${new Date(data.exportedAt).toLocaleString()})\n\n` +
              `Click OK to replace the existing project, or Cancel to import as a new project.`
            );
            
            if (choice) {
              // Replace existing
              const index = USER_PROJECTS.findIndex(p => p.id === importedProject.id);
              USER_PROJECTS[index] = importedProject;
              console.log(`Replaced existing project "${importedProject.name}"`);
            } else {
              // Import as new with new ID
              importedProject.id = generateId();
              importedProject.name = importedProject.name + ' (Imported)';
              importedProject.modifiedAt = new Date().toISOString();
              USER_PROJECTS.push(importedProject);
              console.log(`Imported as new project "${importedProject.name}"`);
            }
          } else {
            // No duplicate, just add
            USER_PROJECTS.push(importedProject);
            console.log(`Imported project "${importedProject.name}"`);
          }
          
          saveProjects();
          renderAll();
          
          alert(`Successfully imported project "${importedProject.name}"`);
          
        } catch (err) {
          console.error('Import error:', err);
          alert('Error importing project: ' + err.message);
        }
      };
      
      input.click();
    }

    function buildTreeData() {
      // Reference/Compare mode - always show reference tree regardless of view state
      if (currentMode === 'reference' || currentMode === 'compare') {
        const mappings = window.ROOM_EQUIPMENT_MAPPINGS || [];
        
        // Cache version for forcing tree rebuild when logic changes
        const TREE_VERSION = 3; // Increment to invalidate cache - v3 adds care setting grouping
        
        // Return cached tree if data hasn't changed (and we have data)
        if (cachedReferenceTree && cachedReferenceTree._version === TREE_VERSION && mappings.length > 0 && lastMappingsLength === mappings.length) {
          return cachedReferenceTree;
        }
        
        console.log('Building reference tree from', mappings.length, 'mappings');
        
        const tree = {
          id: 'reference-root',
          type: 'reference-root',
          label: 'Guide',
          icon: 'üìö',
          children: []
        };

        if (mappings.length === 0) {
          console.warn('No equipment mappings available for reference tree');
          return tree;
        }

        const deptMap = new Map();
        
        // Build tree structure efficiently from ALL_ROOM_INSTANCES instead of mappings
        // This is much faster than iterating through millions of mapping entries
        const allInstances = window.ALL_ROOM_INSTANCES || [];
        if (allInstances.length > 0) {
          console.log('Building tree from', allInstances.length, 'room instances (optimized)');
          allInstances.forEach(instance => {
            if (!deptMap.has(instance.department)) {
              deptMap.set(instance.department, {
                name: instance.department,
                chapterNum: instance.departmentChapter || '',
                functionalAreas: new Map(),
                faKeyToDisplayName: new Map() // Maps uppercase key to display name
              });
            }
            
            const dept = deptMap.get(instance.department);
            // Store chapter number if not already set
            if (!dept.chapterNum && instance.departmentChapter) {
              dept.chapterNum = instance.departmentChapter;
            }
            
            // Use uppercase FA name as key for case-insensitive grouping
            const faKey = instance.functionalArea.toUpperCase();
            
            if (!dept.functionalAreas.has(faKey)) {
              dept.functionalAreas.set(faKey, {
                name: instance.functionalArea, // Keep original casing for display
                number: instance.functionalAreaNumber || '',
                rooms: new Map()
              });
              dept.faKeyToDisplayName.set(faKey, instance.functionalArea);
            }
            
            const fa = dept.functionalAreas.get(faKey);
            // Prefer mixed-case name over UPPERCASE for display
            if (instance.functionalArea !== instance.functionalArea.toUpperCase() && 
                fa.name === fa.name.toUpperCase()) {
              fa.name = instance.functionalArea;
              dept.faKeyToDisplayName.set(faKey, instance.functionalArea);
            }
            // Also update FA number if we have one and the existing one is empty
            if (!fa.number && instance.functionalAreaNumber) {
              fa.number = instance.functionalAreaNumber;
            }
            
            if (!fa.rooms.has(instance.roomCode)) {
              fa.rooms.set(instance.roomCode, {
                code: instance.roomCode,
                name: instance.roomName
              });
            }
          });
        } else {
          // Fallback to mappings if ALL_ROOM_INSTANCES not available
          console.log('Building tree from', mappings.length, 'mappings (fallback)');
          mappings.forEach(mapping => {
            if (!deptMap.has(mapping.department)) {
              deptMap.set(mapping.department, {
                name: mapping.department,
                chapterNum: '',
                functionalAreas: new Map(),
                faKeyToDisplayName: new Map()
              });
            }
            
            const dept = deptMap.get(mapping.department);
            // Use uppercase FA name as key for case-insensitive grouping
            const faKey = mapping.functionalArea.toUpperCase();
            
            if (!dept.functionalAreas.has(faKey)) {
              dept.functionalAreas.set(faKey, {
                name: mapping.functionalArea,
                number: mapping.functionalAreaNumber || '',
                rooms: new Map()
              });
              dept.faKeyToDisplayName.set(faKey, mapping.functionalArea);
            }
            
            const fa = dept.functionalAreas.get(faKey);
            // Prefer mixed-case name over UPPERCASE for display
            if (mapping.functionalArea !== mapping.functionalArea.toUpperCase() && 
                fa.name === fa.name.toUpperCase()) {
              fa.name = mapping.functionalArea;
              dept.faKeyToDisplayName.set(faKey, mapping.functionalArea);
            }
            
            if (!fa.rooms.has(mapping.roomCode)) {
              fa.rooms.set(mapping.roomCode, {
                code: mapping.roomCode,
                name: mapping.roomName
              });
            }
          });
        }

        // Get canonical FA functions if available
        const canonicalFAs = window.CanonicalFAs || null;
        
        // Try to initialize canonical FAs if not done yet (in case of timing issues)
        if (canonicalFAs && window.CANONICAL_FA_ORDER && !canonicalFAs.hasCanonicalFAs('100')) {
          canonicalFAs.initializeCanonicalFAsFromEquipment();
        }
        
        // Debug: Log canonical FA order availability
        console.log('CANONICAL_FA_ORDER available:', !!window.CANONICAL_FA_ORDER);
        if (window.CANONICAL_FA_ORDER) {
          const chapters = Object.keys(window.CANONICAL_FA_ORDER);
          console.log('Chapters with canonical FAs:', chapters.length, 'e.g.', chapters.slice(0, 5));
        }
        
        // Build extended FA numbering: canonical FAs get their number, 
        // non-canonical FAs get next available number with letter suffix if needed
        const extendedFANumbers = {}; // chapterNum -> { faName -> displayNumber }
        
        function buildExtendedFANumbers(chapterNum, allFANames) {
          if (!chapterNum) return;
          if (extendedFANumbers[chapterNum]) return; // Already built
          
          extendedFANumbers[chapterNum] = {};
          const chapterOrder = window.CANONICAL_FA_ORDER?.[chapterNum];
          const canonicalFAs = chapterOrder?.faOrder || [];
          // Build case-insensitive canonical set for matching
          const canonicalSetUpper = new Set(canonicalFAs.map(fa => fa.toUpperCase()));
          
          // Also create a map from uppercase to original for proper assignment
          const upperToCanonical = {};
          canonicalFAs.forEach((faName, index) => {
            upperToCanonical[faName.toUpperCase()] = { name: faName, index: index };
          });
          
          // First, assign canonical FAs their numbers (both original and any case variant)
          canonicalFAs.forEach((faName, index) => {
            extendedFANumbers[chapterNum][faName] = String(index + 1);
          });
          
          // Find non-canonical FAs (case-insensitive check)
          const nonCanonicalFAs = allFANames.filter(fa => !canonicalSetUpper.has(fa.toUpperCase()));
          
          // Also assign numbers for canonical FAs that appear with different casing
          allFANames.forEach(fa => {
            const upperFa = fa.toUpperCase();
            if (canonicalSetUpper.has(upperFa) && !extendedFANumbers[chapterNum][fa]) {
              // This FA matches a canonical one (case-insensitive) but is spelled differently
              const canonical = upperToCanonical[upperFa];
              extendedFANumbers[chapterNum][fa] = String(canonical.index + 1);
            }
          });
          
          if (nonCanonicalFAs.length === 0) return;
          
          // Next available number after canonical FAs
          let nextNumber = canonicalFAs.length + 1;
          
          // Track which numbers have letter suffixes
          const letterCounts = {}; // number -> count of letters used
          
          // Sort non-canonical FAs alphabetically for consistent ordering
          nonCanonicalFAs.sort();
          
          nonCanonicalFAs.forEach(faName => {
            // Try to find a related canonical FA by checking if names are similar
            // (e.g., "Physical Therapy - Outpatient" relates to "Physical Therapy")
            let relatedCanonicalIndex = -1;
            const faNameLower = faName.toLowerCase();
            
            // Check for exact prefix match or word overlap
            for (let i = 0; i < canonicalFAs.length; i++) {
              const canonicalName = canonicalFAs[i];
              const canonicalLower = canonicalName.toLowerCase();
              
              // Check if non-canonical starts with canonical name
              if (faNameLower.startsWith(canonicalLower)) {
                relatedCanonicalIndex = i;
                break;
              }
              
              // Check if canonical starts with non-canonical
              if (canonicalLower.startsWith(faNameLower)) {
                relatedCanonicalIndex = i;
                break;
              }
              
              // Check for significant word overlap (at least 2 words match)
              const canonicalWords = canonicalLower.split(/[\s\-\/]+/).filter(w => w.length > 2);
              const faWords = faNameLower.split(/[\s\-\/]+/).filter(w => w.length > 2);
              const matchingWords = canonicalWords.filter(w => faWords.includes(w));
              
              if (matchingWords.length >= 2) {
                relatedCanonicalIndex = i;
                break;
              }
            }
            
            if (relatedCanonicalIndex >= 0) {
              // Assign letter suffix to the related canonical number
              const baseNumber = relatedCanonicalIndex + 1;
              if (!letterCounts[baseNumber]) {
                letterCounts[baseNumber] = 0;
              }
              const letterSuffix = String.fromCharCode(97 + letterCounts[baseNumber]); // a, b, c...
              letterCounts[baseNumber]++;
              extendedFANumbers[chapterNum][faName] = `${baseNumber}${letterSuffix}`;
            } else {
              // No related canonical - assign next available number
              extendedFANumbers[chapterNum][faName] = String(nextNumber);
              nextNumber++;
            }
          });
          
          // Debug log for first chapter
          if (chapterNum === '100' || chapterNum === '270') {
            console.log(`Extended FA numbers for Chapter ${chapterNum}:`, extendedFANumbers[chapterNum]);
          }
        }
        
        // Helper function to get FA number (canonical or extended)
        function getExtendedFANumber(chapterNum, faName, allFANames) {
          if (!chapterNum || !faName) return null;
          
          // Build extended numbers for this chapter if not done yet
          if (!extendedFANumbers[chapterNum]) {
            buildExtendedFANumbers(chapterNum, allFANames);
          }
          
          // Try exact match first
          if (extendedFANumbers[chapterNum]?.[faName]) {
            return extendedFANumbers[chapterNum][faName];
          }
          
          // Try case-insensitive match
          const faNameUpper = faName.toUpperCase();
          for (const [key, value] of Object.entries(extendedFANumbers[chapterNum] || {})) {
            if (key.toUpperCase() === faNameUpper) {
              return value;
            }
          }
          
          return null;
        }
        
        // Helper function to get canonical FA number for a chapter/FA name
        function getCanonicalFANumber(chapterNum, faName) {
          if (!chapterNum || !faName) return null;
          
          // First try the direct lookup from CANONICAL_FA_ORDER (faster)
          const chapterOrder = window.CANONICAL_FA_ORDER?.[chapterNum];
          if (chapterOrder) {
            // Try exact match first
            if (chapterOrder.faNameToNumber[faName]) {
              return chapterOrder.faNameToNumber[faName];
            }
            // Try case-insensitive match (equipment guide uses UPPERCASE, TSV uses Mixed Case)
            const faNameUpper = faName.toUpperCase();
            for (const [canonicalFaName, faNumber] of Object.entries(chapterOrder.faNameToNumber)) {
              if (canonicalFaName.toUpperCase() === faNameUpper) {
                return faNumber;
              }
            }
          }
          
          // Fall back to canonicalFAs module
          if (canonicalFAs) {
            const mapping = canonicalFAs.getCanonicalFA(chapterNum, faName);
            if (mapping && mapping.displayNumber) {
              return mapping.displayNumber;
            }
          }
          return null;
        }
        
        // Helper function to get display label for FA with extended numbering
        function getFADisplayLabel(chapterNum, faName, allFANames) {
          const extendedNumber = getExtendedFANumber(chapterNum, faName, allFANames);
          if (extendedNumber) {
            return `FA${extendedNumber}: ${faName}`;
          }
          // Fallback - shouldn't happen, but just in case
          return faName;
        }
        
        // Debug: Log first few departments and their chapter numbers
        let debugCount = 0;

        Array.from(deptMap.keys()).sort().forEach(deptName => {
          const dept = deptMap.get(deptName);
          const chapterNum = dept.chapterNum || '';
          
          // Debug first 3 departments
          if (debugCount < 3) {
            console.log(`Dept "${deptName}" chapterNum="${chapterNum}"`);
            const faNames = Array.from(dept.functionalAreas.keys()).slice(0, 2);
            faNames.forEach(fa => {
              const canonicalNum = getCanonicalFANumber(chapterNum, fa);
              console.log(`  FA "${fa}" -> canonical: ${canonicalNum}`);
            });
            debugCount++;
          }
          
          const deptNode = {
            id: `dept-ref-${deptName}`,
            type: 'department-reference',
            label: deptName,
            icon: 'üè¢',
            children: []
          };

          // Get all FA keys for this department (uppercase keys for grouping)
          const allFAKeys = Array.from(dept.functionalAreas.keys());
          
          // Get display names for extended numbering
          const allFANames = allFAKeys.map(key => dept.faKeyToDisplayName.get(key) || key);
          
          // Build extended FA numbers for this chapter using display names
          buildExtendedFANumbers(chapterNum, allFANames);
          
          // Sort functional areas by extended FA number (handles 1, 1a, 1b, 2, etc.)
          const sortedFaKeys = allFAKeys.sort((a, b) => {
            // Get display names for looking up FA numbers
            const nameA = dept.faKeyToDisplayName.get(a) || a;
            const nameB = dept.faKeyToDisplayName.get(b) || b;
            // Use extended FA numbers for sorting (case-insensitive lookup)
            const numA = getExtendedFANumber(chapterNum, nameA, allFANames) || '';
            const numB = getExtendedFANumber(chapterNum, nameB, allFANames) || '';
            
            // Parse number and letter parts for proper sorting
            const matchA = numA.match(/^(\d+)([a-z]?)$/);
            const matchB = numB.match(/^(\d+)([a-z]?)$/);
            
            if (matchA && matchB) {
              const intA = parseInt(matchA[1]);
              const intB = parseInt(matchB[1]);
              
              // Sort by number first
              if (intA !== intB) return intA - intB;
              
              // Then by letter suffix (empty string comes before 'a')
              return matchA[2].localeCompare(matchB[2]);
            }
            
            // If only one has a number, it comes first
            if (matchA) return -1;
            if (matchB) return 1;
            
            // Otherwise sort alphabetically by name
            return a.localeCompare(b);
          });

          // Flat FA list - no care setting grouping
          sortedFaKeys.forEach(faKey => {
            const fa = dept.functionalAreas.get(faKey);
            const faDisplayName = dept.faKeyToDisplayName.get(faKey) || faKey;
            const displayLabel = getFADisplayLabel(chapterNum, faDisplayName, allFANames);
            const faNode = {
              id: `fa-ref-${deptName}-${faDisplayName}`,
              type: 'functional-area-reference',
              label: displayLabel,
              icon: 'üìÇ',
              department: deptName,
              functionalArea: faDisplayName,
              children: []
            };

            Array.from(fa.rooms.keys()).sort().forEach(roomCode => {
              const room = fa.rooms.get(roomCode);
              
              // Check if this is a legacy room code (from finish data only, not in room_criteria.tsv)
              const roomData = ROOM_SIZES.find(r => r.id === roomCode);
              const isLegacy = roomData && roomData.source === 'finish_data';
              
              // Check if this VARF code has a legacy code mapping
              const legacyCode = window.VARF_TO_LEGACY?.get(roomCode);
              const varfCode = window.LEGACY_TO_VARF?.get(roomCode);
              
              // Build the label - only show (Legacy) for legacy-only codes in tree
              let label = room.code;
              if (isLegacy) {
                label += ' (Legacy)';
              }
              label += ` - ${room.name}`;
              
              faNode.children.push({
                id: `room-ref-${deptName}-${faDisplayName}-${roomCode}`,
                type: 'room-reference',
                label: label,
                icon: 'üö™',
                department: deptName,
                functionalArea: faDisplayName,
                roomCode: room.code,
                roomName: room.name,
                isLegacy: isLegacy,
                legacyCode: legacyCode,
                varfCode: varfCode
              });
            });

            deptNode.children.push(faNode);
          });

          tree.children.push(deptNode);
        });

        // Cache the tree for next time with version number
        tree._version = 5; // Increment to invalidate cache - case-insensitive FA grouping
        cachedReferenceTree = tree;
        lastMappingsLength = mappings.length;
        console.log('Reference tree cached with', tree.children.length, 'departments');

        return tree;
      }

      // Project list view
      if (viewState === 'project-list') {
        const tree = {
          id: 'project-list',
          type: 'project-list',
          label: 'Projects',
          icon: 'üìã',
          children: []
        };
        return tree;
      }

      // Program mode - Individual project view
      const project = getCurrentProject();
      const tree = {
        id: 'project',
        type: 'project',
        project: project,
        label: project.name,
        icon: 'üè•',
        children: []
      };

      if (currentMode === 'program') {
        // Program mode: show user's project structure (departments > functional areas > rooms > equipment)
        if (!project.departments || project.departments.length === 0) {
          // No departments yet - show empty state
          return tree;
        }

        project.departments.forEach(dept => {
          const deptNode = {
            id: `dept-${dept.id}`,
            type: 'department',
            department: dept,
            label: dept.name,
            icon: 'üè¢',
            children: []
          };

          if (dept.functionalAreas && dept.functionalAreas.length > 0) {
            dept.functionalAreas.forEach(fa => {
              const faNode = {
                id: `fa-${fa.id}`,
                type: 'functional-area',
                functionalArea: fa,
                department: dept,
                label: fa.name,
                icon: 'üìÇ',
                children: []
              };

              if (fa.rooms && fa.rooms.length > 0) {
                fa.rooms.forEach(room => {
                  faNode.children.push({
                    id: `room-${room.id}`,
                    type: 'room',
                    room: room,
                    functionalArea: fa,
                    department: dept,
                    label: `${room.code} - ${room.name}`,
                    icon: 'üö™'
                  });
                });
              }

              deptNode.children.push(faNode);
            });
          }

          tree.children.push(deptNode);
        });
      }

      return tree;
    }

    function renderTreeNode(node, level = 0, parentId = null) {
      const isExpanded = expandedNodes.has(node.id);
      const hasChildren = node.children && node.children.length > 0;
      const isSelected = selectedNode?.id === node.id;
      
      // Escape the node ID for use in onclick handlers
      const escapedNodeId = node.id.replace(/'/g, "\\'").replace(/"/g, '&quot;');
      
      // Make items draggable
      const isDraggableCompare = currentMode === 'compare' && (node.room || node.roomCode);
      const isDraggableProgram = currentMode === 'program' && viewState === 'project-open';
      const isDraggable = isDraggableCompare || isDraggableProgram;
      
      // Build draggable/drop attributes
      let compareAttrs = '';
      if (isDraggableCompare) {
        compareAttrs = `draggable="true" ondragstart="handleRoomDragStart(event, '${escapedNodeId}')"`;
      }
      
      let dropAttrs = '';
      if (isDraggableProgram) {
        dropAttrs = `ondragover="handleTreeDragOver(event)" ondrop="handleTreeDrop(event, '${escapedNodeId}')" ondragleave="handleTreeDragLeave(event)"`;
      }

      let html = `
        <div class="tree-node" data-level="${level}" ${dropAttrs}>
          <div class="tree-item ${isSelected ? 'selected' : ''}" ${compareAttrs} onclick="handleNodeClick('${escapedNodeId}')" data-node-id="${escapedNodeId}" ${parentId ? `data-parent-id="${parentId}"` : ''}>
            ${isDraggableProgram ? `<span class="tree-drag-handle" draggable="true" ondragstart="handleTreeDragStart(event, '${escapedNodeId}')" ondragend="handleTreeDragEnd(event)" title="Drag to reorder"></span>` : ''}
            <span class="tree-toggle ${hasChildren ? (isExpanded ? 'expanded' : 'collapsed') : 'leaf'}" 
                  onclick="event.stopPropagation(); toggleNode('${escapedNodeId}')"></span>
            <span class="tree-icon">${node.icon}</span>
            <span class="tree-label">${node.label}</span>
            ${node.count ? `<span class="tree-count">√ó${node.count}</span>` : ''}
          </div>
      `;

      if (hasChildren) {
        html += `<div class="tree-children ${isExpanded ? 'expanded' : ''}" id="children-${escapedNodeId}">`;
        node.children.forEach(child => {
          html += renderTreeNode(child, level + 1, escapedNodeId);
        });
        html += `</div>`;
      }

      html += `</div>`;
      return html;
    }

    // Drag and Drop for Program Mode Tree
    let draggedNode = null;
    let draggedNodeData = null;
    let isDragging = false;
    let dragStartTime = 0;

    function handleTreeDragStart(event, nodeId) {
      isDragging = true;
      dragStartTime = Date.now();
      draggedNode = event.target.closest('.tree-item');
      if (draggedNode) {
        draggedNode.style.opacity = '0.5';
      }
      event.dataTransfer.effectAllowed = 'move';
      event.dataTransfer.setData('text/plain', nodeId);
      
      // Store the node data for later
      const treeData = buildTreeData();
      draggedNodeData = findNodeById(treeData, nodeId);
      
      // Stop propagation to prevent triggering click
      event.stopPropagation();
    }

    function handleTreeDragOver(event) {
      if (event.preventDefault) {
        event.preventDefault();
      }
      event.dataTransfer.dropEffect = 'move';
      
      // Add visual feedback to the tree-item
      const target = event.target.closest('.tree-node');
      if (target) {
        const item = target.querySelector('.tree-item');
        if (item && item !== draggedNode) {
          item.classList.add('drag-over');
        }
      }
      return false;
    }

    function handleTreeDragLeave(event) {
      const target = event.target.closest('.tree-node');
      if (target) {
        const item = target.querySelector('.tree-item');
        if (item) {
          item.classList.remove('drag-over');
        }
      }
    }

    function handleTreeDrop(event, targetNodeId) {
      if (event.stopPropagation) {
        event.stopPropagation();
      }
      event.preventDefault();
      
      const target = event.target.closest('.tree-node');
      if (target) {
        const item = target.querySelector('.tree-item');
        if (item) {
          item.classList.remove('drag-over');
        }
      }
      
      if (!draggedNodeData || !targetNodeId || draggedNodeData.id === targetNodeId) {
        return false;
      }
      
      const project = getCurrentProject();
      
      // Extract type and ID from node IDs (format: "dept-xxx", "fa-xxx", "room-xxx")
      const draggedType = draggedNodeData.type;
      const targetType = findNodeById(buildTreeData(), targetNodeId)?.type;
      
      if (!draggedType || !targetType || draggedType !== targetType) {
        return false; // Only allow reordering within same type
      }
      
      // Departments can be reordered
      if (draggedType === 'department' && targetType === 'department') {
        const draggedDept = draggedNodeData.department;
        const targetDept = findNodeById(buildTreeData(), targetNodeId)?.department;
        
        const draggedIndex = project.departments.findIndex(d => d.id === draggedDept.id);
        const targetIndex = project.departments.findIndex(d => d.id === targetDept.id);
        
        if (draggedIndex !== -1 && targetIndex !== -1) {
          const [removed] = project.departments.splice(draggedIndex, 1);
          project.departments.splice(targetIndex, 0, removed);
          saveProjects();
          renderAll();
        }
      }
      // FAs can be reordered within same department
      else if (draggedType === 'functional-area' && targetType === 'functional-area') {
        const draggedFA = draggedNodeData.functionalArea;
        const draggedDept = draggedNodeData.department;
        const targetNode = findNodeById(buildTreeData(), targetNodeId);
        const targetFA = targetNode?.functionalArea;
        const targetDept = targetNode?.department;
        
        // Only allow if same department
        if (draggedDept.id === targetDept.id) {
          const dept = project.departments.find(d => d.id === draggedDept.id);
          if (dept) {
            const draggedIndex = dept.functionalAreas.findIndex(f => f.id === draggedFA.id);
            const targetIndex = dept.functionalAreas.findIndex(f => f.id === targetFA.id);
            
            if (draggedIndex !== -1 && targetIndex !== -1) {
              const [removed] = dept.functionalAreas.splice(draggedIndex, 1);
              dept.functionalAreas.splice(targetIndex, 0, removed);
              saveProjects();
              renderAll();
            }
          }
        }
      }
      // Rooms can be reordered within same FA
      else if (draggedType === 'room' && targetType === 'room') {
        const draggedRoom = draggedNodeData.room;
        const draggedFA = draggedNodeData.functionalArea;
        const draggedDept = draggedNodeData.department;
        const targetNode = findNodeById(buildTreeData(), targetNodeId);
        const targetRoom = targetNode?.room;
        const targetFA = targetNode?.functionalArea;
        const targetDept = targetNode?.department;
        
        // Only allow if same FA and department
        if (draggedDept.id === targetDept.id && draggedFA.id === targetFA.id) {
          const dept = project.departments.find(d => d.id === draggedDept.id);
          if (dept) {
            const fa = dept.functionalAreas.find(f => f.id === draggedFA.id);
            if (fa) {
              const draggedIndex = fa.rooms.findIndex(r => r.id === draggedRoom.id);
              const targetIndex = fa.rooms.findIndex(r => r.id === targetRoom.id);
              
              if (draggedIndex !== -1 && targetIndex !== -1) {
                const [removed] = fa.rooms.splice(draggedIndex, 1);
                fa.rooms.splice(targetIndex, 0, removed);
                saveProjects();
                renderAll();
              }
            }
          }
        }
      }
      
      return false;
    }

    function handleTreeDragEnd(event) {
      if (draggedNode) {
        draggedNode.style.opacity = '';
      }
      
      // Remove all visual feedback
      document.querySelectorAll('.tree-item').forEach(item => {
        item.classList.remove('drag-over');
      });
      
      draggedNode = null;
      draggedNodeData = null;
      
      // Clear dragging flag after a short delay to prevent click from firing
      setTimeout(() => {
        isDragging = false;
      }, 100);
    }

    function renderTree() {
      const container = document.getElementById('tree-view');
      const modeToggle = document.getElementById('mode-toggle');
      const addBtn = document.getElementById('add-to-project-btn');
      const returnBtn = document.getElementById('return-to-projects-btn');
      const searchBox = document.getElementById('tree-search-box');

      if (viewState === 'project-list') {
        // Show mode toggle, hide add button and return button in project list view
        if (modeToggle) modeToggle.style.display = 'flex';
        if (addBtn) addBtn.style.display = 'none';
        if (returnBtn) returnBtn.style.display = 'none';
        // Show search box in reference mode even in project list (when tree is shown)
        if (searchBox) searchBox.style.display = currentMode === 'reference' ? 'block' : 'none';
        
        // Render project list in program mode, tree in reference/compare mode
        if (currentMode === 'program') {
          let html = `
            <div style="margin-bottom: 16px; display: flex; gap: 8px;">
              <button class="btn-primary" onclick="createNewProject()" style="flex: 1;">+ New Project</button>
              <button class="btn-secondary" onclick="importProjectFromFile()" title="Import project from file">üì• Import</button>
            </div>
          `;
        
        USER_PROJECTS.forEach(project => {
          const deptCount = project.departments ? project.departments.length : 0;
          let roomCount = 0;
          if (project.departments) {
            project.departments.forEach(dept => {
              if (dept.functionalAreas) {
                dept.functionalAreas.forEach(fa => {
                  if (fa.rooms) roomCount += fa.rooms.length;
                });
              }
            });
          }
          
          const isSelected = selectedProjectInList === project.id;
          
          html += `
            <div class="tree-item" style="padding: 12px; margin-bottom: 8px; background: ${isSelected ? 'var(--input-bg)' : 'var(--bg)'}; border: 1px solid ${isSelected ? 'var(--accent)' : 'var(--border)'}; border-radius: 6px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; gap: 12px;" onclick="selectProjectInList('${project.id}')">
              <div style="flex: 1; min-width: 0;">
                <div style="font-weight: 600; margin-bottom: 4px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">üè• ${project.name}</div>
                <div style="font-size: 0.75rem; color: var(--muted);">${deptCount} departments ‚Ä¢ ${roomCount} rooms</div>
              </div>
              <div style="display: flex; gap: 6px; flex-shrink: 0;">
                <button class="btn-secondary" onclick="openProject('${project.id}'); event.stopPropagation();" style="padding: 6px 10px; font-size: 0.75rem;" title="Open project">üìÇ Open</button>
                <button class="btn-secondary" onclick="exportProject('${project.id}', event)" style="padding: 6px 10px; font-size: 0.75rem;" title="Export project to file">üì§</button>
                <button class="btn-secondary" onclick="deleteProject('${project.id}', event)" style="padding: 6px 10px; font-size: 0.75rem;" title="Delete project">üóëÔ∏è</button>
              </div>
            </div>
          `;
        });
        
        container.innerHTML = html;
        } else {
          // Reference/Compare mode in project list - show reference tree
          console.log('Rendering reference tree in project-list view, mode:', currentMode);
          const treeData = buildTreeData();
          console.log('Tree data:', treeData ? `${treeData.children?.length || 0} children` : 'null');
          const treeHTML = renderTreeNode(treeData);
          console.log('Tree HTML length:', treeHTML?.length || 0);
          container.innerHTML = treeHTML;
        }
      } else {
        // Show mode toggle and conditionally show add/return buttons and search box
        if (modeToggle) modeToggle.style.display = 'flex';
        if (returnBtn) returnBtn.style.display = currentMode === 'compare' ? 'none' : 'block';
        if (addBtn) addBtn.style.display = currentMode === 'program' ? 'block' : 'none';
        if (searchBox) searchBox.style.display = currentMode === 'reference' ? 'block' : 'none';
        
        // Render project tree (program mode) or reference tree (reference/compare mode)
        const treeData = buildTreeData();
        container.innerHTML = renderTreeNode(treeData);
      }
    }

    function toggleNode(nodeId) {
      if (expandedNodes.has(nodeId)) {
        expandedNodes.delete(nodeId);
      } else {
        expandedNodes.add(nodeId);
      }
      // Only re-render tree, not detail (performance optimization)
      renderTree();
    }

    function findNodeById(tree, nodeId) {
      if (tree.id === nodeId) return tree;
      if (tree.children) {
        for (const child of tree.children) {
          const found = findNodeById(child, nodeId);
          if (found) return found;
        }
      }
      return null;
    }

    function handleNodeClick(nodeId) {
      // Ignore clicks during or immediately after drag operations
      if (isDragging || (Date.now() - dragStartTime < 200)) {
        return;
      }
      
      // In compare mode, clicking doesn't select - only drag/drop or search
      if (currentMode === 'compare') {
        return;
      }
      
      const treeData = buildTreeData();
      selectedNode = findNodeById(treeData, nodeId);
      console.log('Node clicked:', nodeId, 'Found:', selectedNode);
      
      // If there's an active search, collapse all and only expand the path to this node
      const searchBox = document.getElementById('tree-search-box');
      const hasActiveSearch = searchBox && searchBox.value.trim() !== '';
      
      if (hasActiveSearch) {
        // Clear expanded nodes
        expandedNodes.clear();
        
        // Expand only the parent path for this node
        const nodeElement = document.querySelector(`[data-node-id="${nodeId.replace(/'/g, "\\'")}"]`);
        if (nodeElement) {
          let parentId = nodeElement.dataset.parentId;
          while (parentId) {
            expandedNodes.add(parentId);
            const parentElement = document.querySelector(`[data-node-id="${parentId}"]`);
            if (parentElement) {
              parentId = parentElement.dataset.parentId;
            } else {
              break;
            }
          }
        }
      }
      
      renderTree();
      renderDetail();
    }

    // -----------------------------
    // DETAIL VIEW FUNCTIONS
    // -----------------------------

    // Helper function to check if two rooms are identical
    function areRoomsIdentical(room1, room2) {
      // Compare basic properties (code, name, and NSF must match)
      if (room1.code !== room2.code || room1.name !== room2.name || room1.nsf !== room2.nsf) {
        return false;
      }
      
      // Compare equipment (same items and quantities)
      const eq1 = room1.equipment || [];
      const eq2 = room2.equipment || [];
      if (eq1.length !== eq2.length) return false;
      
      // Sort and compare equipment by JSN
      const eq1Sorted = [...eq1].sort((a, b) => a.jsn.localeCompare(b.jsn));
      const eq2Sorted = [...eq2].sort((a, b) => a.jsn.localeCompare(b.jsn));
      
      for (let i = 0; i < eq1Sorted.length; i++) {
        if (eq1Sorted[i].jsn !== eq2Sorted[i].jsn || eq1Sorted[i].quantity !== eq2Sorted[i].quantity) {
          return false;
        }
      }
      
      // Compare attributes (excluding 'Room Name' which can have copy suffix)
      const attr1 = room1.attributes || {};
      const attr2 = room2.attributes || {};
      
      const keys1 = Object.keys(attr1).filter(k => k !== 'Room Name').sort();
      const keys2 = Object.keys(attr2).filter(k => k !== 'Room Name').sort();
      
      if (keys1.length !== keys2.length) return false;
      if (keys1.join(',') !== keys2.join(',')) return false;
      
      for (const key of keys1) {
        if (attr1[key] !== attr2[key]) return false;
      }
      
      return true;
    }
    
    // Helper function to group rooms by identity
    function groupRoomsByIdentity(rooms) {
      const groups = [];
      const processed = new Set();
      
      rooms.forEach((room, index) => {
        if (processed.has(index)) return;
        
        const group = {
          room: room,
          roomIds: [room.id],
          quantity: 1
        };
        
        // Find other identical rooms
        for (let i = index + 1; i < rooms.length; i++) {
          if (processed.has(i)) continue;
          if (areRoomsIdentical(room, rooms[i])) {
            group.roomIds.push(rooms[i].id);
            group.quantity++;
            processed.add(i);
          }
        }
        
        processed.add(index);
        groups.push(group);
      });
      
      return groups;
    }

    // Toggle detail section expansion
    function toggleDetailSection(sectionId) {
      const content = document.getElementById(`content-${sectionId}`);
      const toggle = document.getElementById(`toggle-${sectionId}`);
      
      if (content && toggle) {
        if (content.style.display === 'none') {
          content.style.display = 'block';
          toggle.textContent = '‚ñº';
        } else {
          content.style.display = 'none';
          toggle.textContent = '‚ñ∂';
        }
      }
    }

    function renderDetail() {
      const container = document.getElementById('detail-view');
      
      // In compare mode, renderCompareMode handles the detail view
      if (currentMode === 'compare') {
        renderCompareMode();
        return;
      }
      
      if (viewState === 'project-list') {
        // In reference mode, skip project list logic if we have a selected node
        if (currentMode === 'reference' && selectedNode) {
          // Fall through to the selectedNode handling below
        } else if (selectedProjectInList) {
          const project = USER_PROJECTS.find(p => p.id === selectedProjectInList);
          if (project) {
            let totalDepts = project.departments ? project.departments.length : 0;
            let totalFAs = 0;
            let totalRooms = 0;
            let totalEquip = 0;

            if (project.departments) {
              project.departments.forEach(dept => {
                if (dept.functionalAreas) {
                  totalFAs += dept.functionalAreas.length;
                  dept.functionalAreas.forEach(fa => {
                    if (fa.rooms) {
                      totalRooms += fa.rooms.length;
                      fa.rooms.forEach(room => {
                        if (room.equipment) totalEquip += room.equipment.length;
                      });
                    }
                  });
                }
              });
            }

            container.innerHTML = `
              <div class="detail-panel">
                <h3>üìä Project Information</h3>
                <div class="detail-row">
                  <div class="detail-label">Project Name:</div>
                  <div class="detail-value">${project.name}</div>
                </div>
                <div class="detail-row">
                  <div class="detail-label">Created:</div>
                  <div class="detail-value">${new Date(project.createdAt).toLocaleDateString()}</div>
                </div>
                <div class="detail-row">
                  <div class="detail-label">Last Modified:</div>
                  <div class="detail-value">${new Date(project.modifiedAt).toLocaleString()}</div>
                </div>
              </div>
              <div class="detail-panel">
                <h3>üìà Project Statistics</h3>
                <div class="detail-row">
                  <div class="detail-label">Departments:</div>
                  <div class="detail-value">${totalDepts}</div>
                </div>
                <div class="detail-row">
                  <div class="detail-label">Functional Areas:</div>
                  <div class="detail-value">${totalFAs}</div>
                </div>
                <div class="detail-row">
                  <div class="detail-label">Rooms:</div>
                  <div class="detail-value">${totalRooms}</div>
                </div>
                <div class="detail-row">
                  <div class="detail-label">Equipment Items:</div>
                  <div class="detail-value">${totalEquip}</div>
                </div>
              </div>
              <div class="detail-panel">
                <button class="btn-primary" onclick="openProject('${project.id}')" style="width: 100%; margin-bottom: 8px;">üìÇ Open Project</button>
                <button class="btn-primary" onclick="generateReportForProject('${project.id}')" style="width: 100%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">üìÑ Generate Report</button>
              </div>
            `;
            return;
          }
        } else {
          // Only show welcome if not in reference mode with a selection
          if (!(currentMode === 'reference' && selectedNode)) {
            container.innerHTML = `
              <div class="detail-panel">
                <h3>Welcome to Hospital Programming Workbench</h3>
                <p class="muted" style="margin-bottom: 16px;">Manage your hospital programming projects.</p>
                <h4 style="margin-top: 24px; margin-bottom: 12px;">Getting Started</h4>
                <ul class="muted" style="line-height: 1.6;">
                  <li>Click a project to view its details</li>
                  <li>Click <strong>üìÇ Open</strong> to work on a project</li>
                  <li><strong>Program Mode:</strong> Build your project by importing departments, functional areas, and rooms</li>
                  <li><strong>Reference Mode:</strong> Browse all available rooms and equipment from the equipment guide</li>
                  <li>Projects are saved locally in your browser</li>
                </ul>
                
                <h4 style="margin-top: 24px; margin-bottom: 12px;">üì® Did Carter send you a JSON file?</h4>
                <div style="background: var(--bg); border: 1px solid var(--accent); border-radius: 8px; padding: 16px;">
                  <ol class="muted" style="line-height: 1.8; padding-left: 20px; margin: 0;">
                    <li>Click the <strong style="color: var(--accent);">Import Project</strong> button below</li>
                    <li>Select the <strong>.json file</strong> Carter sent you</li>
                    <li>Your project will appear in the list - click <strong>üìÇ Open</strong> to start working!</li>
                  </ol>
                  <div style="margin-top: 12px; font-size: 0.85rem; color: var(--muted);">
                    üí° <em>That's it! The JSON file contains your full project ready to go.</em>
                  </div>
                </div>
                
                <div style="margin-top: 24px; padding: 16px; background: var(--bg); border: 1px solid var(--border); border-radius: 6px;">
                  <h4 style="margin-bottom: 8px;">All Projects</h4>
                  <div style="font-size: 0.9rem; color: var(--muted);">
                    Total Projects: ${USER_PROJECTS.length}
                  </div>
                </div>
              </div>
            `;
            return;
          }
        }
      }
      
      if (!selectedNode) {
        console.log('No selected node');
        container.innerHTML = `
          <div class="detail-panel">
            <h3>Welcome to Hospital Programming Workbench</h3>
            <p class="muted">Select an item from the tree on the left to view details.</p>
            <ul class="muted" style="margin-top: 16px; line-height: 1.6;">
              <li><strong>Program Mode:</strong> Build your project by importing departments, functional areas, and rooms</li>
              <li><strong>Reference Mode:</strong> Browse all available rooms and equipment from the equipment guide</li>
            </ul>
          </div>
        `;
        return;
      }

      console.log('Selected node type:', selectedNode.type, selectedNode);

      let html = '';

      if (selectedNode.type === 'project') {
        html += renderProjectDetail();
      } else if (selectedNode.type === 'department') {
        html += renderDepartmentDetail();
      } else if (selectedNode.type === 'functional-area') {
        html += renderFunctionalAreaDetail();
      } else if (selectedNode.type === 'room') {
        html += renderRoomDetail();
      } else if (selectedNode.type === 'reference-root') {
        html += renderGuideRootDetail();
      } else if (selectedNode.type === 'department-reference') {
        html += renderDepartmentReferenceDetail();
      } else if (selectedNode.type === 'care-setting-reference') {
        html += renderCareSettingReferenceDetail();
      } else if (selectedNode.type === 'functional-area-reference') {
        html += renderFunctionalAreaReferenceDetail();
      } else if (selectedNode.type === 'room-reference') {
        console.log('Calling renderRoomReferenceDetail');
        html += renderRoomReferenceDetail();
      } else if (selectedNode.type === 'chapter') {
        html += renderChapterDetail();
      }

      console.log('Rendering HTML length:', html.length);
      container.innerHTML = html;
    }
    
    function renderCareSettingReferenceDetail() {
      const settingName = selectedNode.careSetting || selectedNode.label;
      const deptName = selectedNode.department;
      const faCount = selectedNode.children ? selectedNode.children.length : 0;
      
      // Count rooms across all FAs in this setting
      let roomCount = 0;
      if (selectedNode.children) {
        selectedNode.children.forEach(fa => {
          if (fa.children) {
            roomCount += fa.children.length;
          }
        });
      }
      
      return `
        <div class="detail-panel">
          <h3>${selectedNode.icon} ${settingName}</h3>
          <div class="detail-row">
            <div class="detail-label">Care Setting:</div>
            <div class="detail-value">${settingName}</div>
          </div>
          <div class="detail-row">
            <div class="detail-label">Department:</div>
            <div class="detail-value">${deptName}</div>
          </div>
          <div class="detail-row">
            <div class="detail-label">Functional Areas:</div>
            <div class="detail-value">${faCount}</div>
          </div>
          <div class="detail-row">
            <div class="detail-label">Total Rooms:</div>
            <div class="detail-value">${roomCount}</div>
          </div>
        </div>
        <div class="detail-panel">
          <p style="margin: 0; color: var(--muted); font-size: 0.85rem;">
            ${settingName === 'CBOC (Community Outpatient)' 
              ? 'Community-Based Outpatient Clinic spaces designed for smaller, distributed care facilities.'
              : settingName === 'In-Hospital'
              ? 'Hospital-based spaces designed for larger medical facilities with expanded services.'
              : 'Spaces that are shared between CBOC and In-Hospital settings.'}
          </p>
        </div>
      `;
    }

    function renderDepartmentDetail() {
      const dept = selectedNode.department;
      const faCount = dept.functionalAreas ? dept.functionalAreas.length : 0;
      let roomCount = 0;
      let equipCount = 0;
      const totalNSF = calculateDeptNSF(dept);
      const allRooms = [];
      const project = getCurrentProject();
      const totalCost = calculateDeptCost(dept, project);

      if (dept.functionalAreas) {
        dept.functionalAreas.forEach(fa => {
          if (fa.rooms) {
            roomCount += fa.rooms.length;
            fa.rooms.forEach(room => {
              if (room.equipment) equipCount += room.equipment.length;
              allRooms.push({ room, fa });
            });
          }
        });
      }

      let html = `
        <div class="detail-panel">
          <h3>üè¢ Department</h3>
          <div class="detail-row">
            <div class="detail-label">Name:</div>
            <div class="detail-value" style="flex: 1;">
              <input type="text" value="${dept.name}" 
                onchange="updateDepartmentName('${dept.id}', this.value)"
                style="width: 100%; padding: 4px 8px; background: var(--input-bg); border: 1px solid var(--input-border); color: var(--text); border-radius: 4px; font-size: 0.95rem;">
            </div>
          </div>
          <div class="detail-row">
            <div class="detail-label">Functional Areas:</div>
            <div class="detail-value">${faCount}</div>
          </div>
          <div class="detail-row">
            <div class="detail-label">Total Rooms:</div>
            <div class="detail-value">${roomCount}</div>
          </div>
          <div class="detail-row">
            <div class="detail-label">Total Equipment:</div>
            <div class="detail-value">${equipCount}</div>
          </div>
          <div class="detail-row">
            <div class="detail-label">Total NSF:</div>
            <div class="detail-value">${totalNSF.toLocaleString()} SF</div>
          </div>
          <div class="detail-row">
            <div class="detail-label">Total Cost:</div>
            <div class="detail-value" style="font-weight: 600; color: var(--accent);">$${totalCost.toLocaleString()}</div>
          </div>
        </div>
        <div class="detail-panel" style="padding: 8px 12px;">
          <button class="btn-secondary" onclick="deleteDepartment('${dept.id}')" style="width: 100%; font-size: 0.85rem; padding: 6px 12px; background: var(--error); color: white; border-color: var(--error);" onmouseover="this.style.opacity='0.8'" onmouseout="this.style.opacity='1'">üóëÔ∏è Delete Department</button>
        </div>
      `;

      if (allRooms.length > 0) {
        const displayRooms = allRooms.slice(0, 100);
        const hasMoreRooms = allRooms.length > 100;
        
        html += `
        <div class="detail-panel">
          <h3>üè¢ Department Structure</h3>
        `;
        
        // Group by functional areas
        dept.functionalAreas.forEach((fa, faIndex) => {
          if (!fa.rooms || fa.rooms.length === 0) return;
          
          const faNSF = calculateFANSF(fa);
          
          html += `
            <div style="margin-bottom: 12px; padding: 10px; background: var(--bg); border-left: 3px solid var(--primary); border-radius: 4px;">
              <div style="display: flex; align-items: center; gap: 8px; cursor: pointer; user-select: none;" onclick="toggleDetailSection('fa-${faIndex}')">
                <span id="toggle-fa-${faIndex}" style="font-size: 0.9rem;">‚ñ∂</span>
                <div style="flex: 1;">
                  <div style="font-weight: 600; font-size: 0.95rem;">üìÇ ${fa.name}</div>
                  <div style="font-size: 0.85rem; color: var(--muted); margin-top: 2px;">${fa.rooms.length} rooms ‚Ä¢ ${faNSF.toLocaleString()} SF</div>
                </div>
              </div>
              <div id="content-fa-${faIndex}" style="display: none; margin-top: 8px; margin-left: 8px;">
          `;
          
          // Show rooms in this FA (grouped by identity)
          const roomGroups = groupRoomsByIdentity(fa.rooms);
          roomGroups.forEach(group => {
            const room = group.room;
            const equipCount = room.equipment ? room.equipment.length : 0;
            html += `
              <div style="padding: 6px 8px; margin-bottom: 4px; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 4px; display: flex; align-items: center; gap: 8px; font-size: 0.85rem;">
                <div style="min-width: 30px; text-align: center;">
                  <input type="number" value="${group.quantity}" min="0" 
                    onchange="updateRoomGroupQuantity('${group.roomIds.join(',')}', this.value, ${group.quantity})"
                    style="width: 45px; padding: 2px 4px; background: var(--input-bg); border: 1px solid var(--input-border); color: var(--text); border-radius: 3px; text-align: center; font-size: 0.85rem;"
                    title="Quantity (0 to delete all, adjust to add/remove copies)">
                </div>
                <div style="flex: 1; min-width: 0;">
                  <strong>${room.code}</strong> - ${room.name}
                </div>
                <div style="white-space: nowrap;">
                  <input type="number" value="${room.nsf || 0}" 
                    onchange="updateRoomGroupNSF('${group.roomIds.join(',')}', this.value)"
                    style="width: 55px; padding: 2px 4px; background: var(--input-bg); border: 1px solid var(--input-border); color: var(--text); border-radius: 3px; text-align: right; font-size: 0.85rem;">
                  <span style="font-size: 0.75rem; margin-left: 2px;">SF</span>
                </div>
                <div style="font-size: 0.75rem; color: var(--muted); white-space: nowrap;">${equipCount} eq</div>
              </div>
            `;
          });
          
          html += `
              </div>
            </div>
          `;
        });
        
        html += `
        </div>
        `;
      }

      return html;
    }

    function renderFunctionalAreaDetail() {
      const fa = selectedNode.functionalArea;
      const dept = selectedNode.department;
      const roomCount = fa.rooms ? fa.rooms.length : 0;
      let equipCount = 0;
      const totalNSF = calculateFANSF(fa);
      const project = getCurrentProject();
      const totalCost = calculateFACost(fa, project);

      if (fa.rooms) {
        fa.rooms.forEach(room => {
          if (room.equipment) equipCount += room.equipment.length;
        });
      }

      let html = `
        <div class="detail-panel">
          <h3>üìÇ Functional Area</h3>
          <div class="detail-row">
            <div class="detail-label">Name:</div>
            <div class="detail-value" style="flex: 1;">
              <input type="text" value="${fa.name}" 
                onchange="updateFunctionalAreaName('${fa.id}', '${dept.id}', this.value)"
                style="width: 100%; padding: 4px 8px; background: var(--input-bg); border: 1px solid var(--input-border); color: var(--text); border-radius: 4px; font-size: 0.95rem;">
            </div>
          </div>
          <div class="detail-row">
            <div class="detail-label">Department:</div>
            <div class="detail-value">${dept.name}</div>
          </div>
          <div class="detail-row">
            <div class="detail-label">Rooms:</div>
            <div class="detail-value">${roomCount}</div>
          </div>
          <div class="detail-row">
            <div class="detail-label">Total Equipment:</div>
            <div class="detail-value">${equipCount}</div>
          </div>
          <div class="detail-row">
            <div class="detail-label">Total NSF:</div>
            <div class="detail-value">${totalNSF.toLocaleString()} SF</div>
          </div>
          <div class="detail-row">
            <div class="detail-label">Total Cost:</div>
            <div class="detail-value" style="font-weight: 600; color: var(--accent);">$${totalCost.toLocaleString()}</div>
          </div>
        </div>
        <div class="detail-panel" style="padding: 8px 12px;">
          <button class="btn-secondary" onclick="deleteFunctionalArea('${fa.id}', '${dept.id}')" style="width: 100%; font-size: 0.85rem; padding: 6px 12px; background: var(--error); color: white; border-color: var(--error);" onmouseover="this.style.opacity='0.8'" onmouseout="this.style.opacity='1'">üóëÔ∏è Delete Functional Area</button>
        </div>
      `;

      if (fa.rooms && fa.rooms.length > 0) {
        const displayRooms = fa.rooms.slice(0, 100);
        const hasMoreRooms = fa.rooms.length > 100;
        
        html += `
        <div class="detail-panel">
          <h3>üö™ Rooms (${fa.rooms.length}${hasMoreRooms ? ' - showing first 100' : ''})</h3>
          <div style="max-height: 400px; overflow-y: auto;">
        `;
        const roomGroups = groupRoomsByIdentity(displayRooms);
        roomGroups.forEach(group => {
          const room = group.room;
          const equipCount = room.equipment ? room.equipment.length : 0;
          html += `
            <div style="padding: 6px 8px; margin-bottom: 4px; background: var(--bg); border: 1px solid var(--border); border-radius: 4px; display: flex; align-items: center; gap: 8px; font-size: 0.85rem;">
              <div style="min-width: 30px; text-align: center;">
                <input type="number" value="${group.quantity}" min="0" 
                  onchange="updateRoomGroupQuantity('${group.roomIds.join(',')}', this.value, ${group.quantity})"
                  style="width: 45px; padding: 2px 4px; background: var(--input-bg); border: 1px solid var(--input-border); color: var(--text); border-radius: 3px; text-align: center; font-size: 0.85rem;"
                  title="Quantity (0 to delete all, adjust to add/remove copies)">
              </div>
              <div style="flex: 1; min-width: 0;">
                <strong>${room.code}</strong> - ${room.name}
              </div>
              <div style="white-space: nowrap;">
                <input type="number" value="${room.nsf || 0}" 
                  onchange="updateRoomGroupNSF('${group.roomIds.join(',')}', this.value)"
                  style="width: 55px; padding: 2px 4px; background: var(--input-bg); border: 1px solid var(--input-border); color: var(--text); border-radius: 3px; text-align: right; font-size: 0.85rem;">
                <span style="font-size: 0.75rem; margin-left: 2px;">SF</span>
              </div>
              <div style="font-size: 0.75rem; color: var(--muted); white-space: nowrap;">${equipCount} eq</div>
            </div>
          `;
        });
        if (hasMoreRooms) {
          html += `
            <div style="padding: 12px; text-align: center; color: var(--muted); font-size: 0.85rem;">
              Showing first 100 of ${fa.rooms.length} rooms. Use tree navigation for specific rooms.
            </div>
          `;
        }
        html += `
          </div>
        </div>
        `;
      }

      return html;
    }

    function renderGuideRootDetail() {
      const allInstances = window.ALL_ROOM_INSTANCES || [];
      
      // Group by department and functional area
      const deptMap = new Map();
      allInstances.forEach(instance => {
        if (!deptMap.has(instance.department)) {
          deptMap.set(instance.department, {
            name: instance.department,
            fas: new Set(),
            rooms: 0,
            nsf: 0
          });
        }
        const dept = deptMap.get(instance.department);
        dept.fas.add(instance.functionalArea);
        dept.rooms++;
        const roomData = getRoomAttributes(instance.roomCode);
        if (roomData && roomData.nsf) {
          dept.nsf += roomData.nsf;
        }
      });
      
      const totalDepts = deptMap.size;
      let totalFAs = 0;
      let totalRooms = 0;
      let totalNSF = 0;
      
      deptMap.forEach(dept => {
        totalFAs += dept.fas.size;
        totalRooms += dept.rooms;
        totalNSF += dept.nsf;
      });
      
      let html = `
        <div class="detail-panel">
          <h3>üìö Equipment Guide</h3>
          <div class="detail-row">
            <div class="detail-label">Departments:</div>
            <div class="detail-value">${totalDepts}</div>
          </div>
          <div class="detail-row">
            <div class="detail-label">Functional Areas:</div>
            <div class="detail-value">${totalFAs}</div>
          </div>
          <div class="detail-row">
            <div class="detail-label">Total Rooms:</div>
            <div class="detail-value">${totalRooms}</div>
          </div>
          <div class="detail-row">
            <div class="detail-label">Total NSF:</div>
            <div class="detail-value">${totalNSF.toLocaleString()} SF</div>
          </div>
        </div>
        <div class="detail-panel">
          <h3>üè¢ Departments</h3>
          <div style="max-height: 500px; overflow-y: auto;">
      `;
      
      // Sort departments and render them with collapsible FAs
      const sortedDepts = Array.from(deptMap.entries()).sort((a, b) => a[0].localeCompare(b[0]));
      sortedDepts.forEach(([deptName, dept], index) => {
        const deptId = `guide-dept-${index}`;
        html += `
          <div style="margin-bottom: 8px; padding: 8px; background: var(--bg); border: 1px solid var(--border); border-radius: 4px;">
            <div style="display: flex; align-items: center; gap: 8px; cursor: pointer; user-select: none;" onclick="toggleDetailSection('${deptId}')">
              <span id="toggle-${deptId}" style="font-size: 0.9rem;">‚ñ∂</span>
              <div style="flex: 1;">
                <div style="font-weight: 600; font-size: 0.95rem;">üè¢ ${deptName}</div>
                <div style="font-size: 0.85rem; color: var(--muted); margin-top: 2px;">
                  ${dept.fas.size} FAs ‚Ä¢ ${dept.rooms} rooms ‚Ä¢ ${dept.nsf.toLocaleString()} SF
                </div>
              </div>
            </div>
            <div id="content-${deptId}" style="display: none; margin-top: 8px; margin-left: 16px; font-size: 0.85rem; color: var(--muted);">
              Click department in tree to view functional areas
            </div>
          </div>
        `;
      });
      
      html += `
          </div>
        </div>
        <div class="detail-panel">
          <p style="color: var(--muted); font-size: 0.9rem;">
            Reference mode - viewing equipment guide data. Switch to Program Mode to work with your project.
          </p>
        </div>
      `;
      
      return html;
    }

    function renderDepartmentReferenceDetail() {
      const deptName = selectedNode.label;

      // Count all room instances and calculate total NSF
      const allInstances = window.ALL_ROOM_INSTANCES || [];
      const deptInstances = allInstances.filter(instance => instance.department === deptName);
      const roomCount = deptInstances.length;
      
      // Group by functional areas
      const faMap = new Map();
      deptInstances.forEach(instance => {
        if (!faMap.has(instance.functionalArea)) {
          faMap.set(instance.functionalArea, {
            name: instance.functionalArea,
            rooms: 0,
            nsf: 0
          });
        }
        const fa = faMap.get(instance.functionalArea);
        fa.rooms++;
        const roomData = getRoomAttributes(instance.roomCode);
        if (roomData && roomData.nsf) {
          fa.nsf += roomData.nsf;
        }
      });
      
      const faCount = faMap.size;
      let totalNSF = 0;
      faMap.forEach(fa => {
        totalNSF += fa.nsf;
      });

      let html = `
        <div class="detail-panel">
          <h3>üè¢ ${deptName}</h3>
          <div class="detail-row">
            <div class="detail-label">Department:</div>
            <div class="detail-value">${deptName}</div>
          </div>
          <div class="detail-row">
            <div class="detail-label">Functional Areas:</div>
            <div class="detail-value">${faCount}</div>
          </div>
          <div class="detail-row">
            <div class="detail-label">Total Rooms:</div>
            <div class="detail-value">${roomCount}</div>
          </div>
          <div class="detail-row">
            <div class="detail-label">Total NSF:</div>
            <div class="detail-value">${totalNSF.toLocaleString()} SF</div>
          </div>
        </div>
        <div class="detail-panel">
          <h3>üìÇ Functional Areas</h3>
          <div style="max-height: 400px; overflow-y: auto;">
      `;
      
      // Sort FAs and render them with collapsible rooms list
      const sortedFAs = Array.from(faMap.entries()).sort((a, b) => a[0].localeCompare(b[0]));
      sortedFAs.forEach(([faName, fa], index) => {
        const faId = `dept-fa-${index}`;
        html += `
          <div style="margin-bottom: 8px; padding: 8px; background: var(--bg); border: 1px solid var(--border); border-radius: 4px;">
            <div style="display: flex; align-items: center; gap: 8px; cursor: pointer; user-select: none;" onclick="toggleDetailSection('${faId}')">
              <span id="toggle-${faId}" style="font-size: 0.9rem;">‚ñ∂</span>
              <div style="flex: 1;">
                <div style="font-weight: 600; font-size: 0.95rem;">üìÇ ${faName}</div>
                <div style="font-size: 0.85rem; color: var(--muted); margin-top: 2px;">
                  ${fa.rooms} rooms ‚Ä¢ ${fa.nsf.toLocaleString()} SF
                </div>
              </div>
            </div>
            <div id="content-${faId}" style="display: none; margin-top: 8px; margin-left: 16px; font-size: 0.85rem; color: var(--muted);">
              Click functional area in tree to view rooms
            </div>
          </div>
        `;
      });
      
      html += `
          </div>
        </div>
        <div class="detail-panel">
          <p style="color: var(--muted); font-size: 0.9rem;">
            Reference mode - viewing equipment guide data. Switch to Program Mode to work with your project.
          </p>
        </div>
      `;
      
      return html;
    }

    function renderFunctionalAreaReferenceDetail() {
      const deptName = selectedNode.department;
      const faName = selectedNode.functionalArea;

      // Count all room instances and calculate total NSF
      const allInstances = window.ALL_ROOM_INSTANCES || [];
      const faInstances = allInstances.filter(instance => 
        instance.department === deptName && instance.functionalArea === faName
      );
      const roomCount = faInstances.length;
      
      // Group rooms by code
      const roomMap = new Map();
      faInstances.forEach(instance => {
        if (!roomMap.has(instance.roomCode)) {
          const roomData = getRoomAttributes(instance.roomCode);
          roomMap.set(instance.roomCode, {
            code: instance.roomCode,
            name: instance.roomName,
            nsf: roomData?.nsf || 0,
            count: 0
          });
        }
        roomMap.get(instance.roomCode).count++;
      });
      
      let totalNSF = 0;
      roomMap.forEach(room => {
        totalNSF += room.nsf * room.count;
      });

      let html = `
        <div class="detail-panel">
          <h3>üìÇ ${faName}</h3>
          <div class="detail-row">
            <div class="detail-label">Department:</div>
            <div class="detail-value">${deptName}</div>
          </div>
          <div class="detail-row">
            <div class="detail-label">Functional Area:</div>
            <div class="detail-value">${faName}</div>
          </div>
          <div class="detail-row">
            <div class="detail-label">Rooms:</div>
            <div class="detail-value">${roomCount}</div>
          </div>
          <div class="detail-row">
            <div class="detail-label">Total NSF:</div>
            <div class="detail-value">${totalNSF.toLocaleString()} SF</div>
          </div>
        </div>
        <div class="detail-panel">
          <h3>üö™ Rooms (${roomMap.size} unique)</h3>
          <div style="max-height: 400px; overflow-y: auto;">
      `;
      
      // Sort rooms by code and display them
      const sortedRooms = Array.from(roomMap.values()).sort((a, b) => a.code.localeCompare(b.code));
      sortedRooms.forEach(room => {
        html += `
          <div style="padding: 6px 8px; margin-bottom: 4px; background: var(--bg); border: 1px solid var(--border); border-radius: 4px; font-size: 0.85rem;">
            <div style="display: flex; align-items: center; gap: 8px;">
              <div style="min-width: 30px; text-align: center; font-weight: 600; color: var(--primary);">
                ${room.count}
              </div>
              <div style="flex: 1; min-width: 0;">
                <strong>${room.code}</strong> - ${room.name}
              </div>
              <div style="white-space: nowrap; color: var(--muted);">
                ${room.nsf.toLocaleString()} SF
              </div>
            </div>
          </div>
        `;
      });
      
      html += `
          </div>
        </div>
        <div class="detail-panel">
          <p style="color: var(--muted); font-size: 0.9rem;">
            Reference mode - viewing equipment guide data. Switch to Program Mode to work with your project.
          </p>
        </div>
      `;
      
      return html;
    }

    function renderProjectDetail() {
      const project = getCurrentProject();
      const totalDepts = project.departments ? project.departments.length : 0;
      let totalFAs = 0;
      let totalRooms = 0;
      let totalEquip = 0;
      const totalNSF = calculateProjectNSF(project);
      const allRooms = [];

      if (project.departments) {
        project.departments.forEach(dept => {
          if (dept.functionalAreas) {
            totalFAs += dept.functionalAreas.length;
            dept.functionalAreas.forEach(fa => {
              if (fa.rooms) {
                totalRooms += fa.rooms.length;
                fa.rooms.forEach(room => {
                  if (room.equipment) {
                    totalEquip += room.equipment.length;
                  }
                  allRooms.push({ room, fa, dept });
                });
              }
            });
          }
        });
      }

      let html = `
        <div class="detail-panel">
          <h3>üìä Project Overview</h3>
          <div class="detail-row">
            <div class="detail-label">Project Name:</div>
            <div class="detail-value">
              <input type="text" 
                     class="project-name-input" 
                     value="${project.name}" 
                     onchange="updateProjectName(this.value)"
                     style="padding: 4px 8px;">
            </div>
          </div>
          <div class="detail-row">
            <div class="detail-label">Departments:</div>
            <div class="detail-value">${totalDepts}</div>
          </div>
          <div class="detail-row">
            <div class="detail-label">Functional Areas:</div>
            <div class="detail-value">${totalFAs}</div>
          </div>
          <div class="detail-row">
            <div class="detail-label">Rooms:</div>
            <div class="detail-value">${totalRooms}</div>
          </div>
          <div class="detail-row">
            <div class="detail-label">Equipment Items:</div>
            <div class="detail-value">${totalEquip}</div>
          </div>
          <div class="detail-row">
            <div class="detail-label">Total NSF:</div>
            <div class="detail-value">${totalNSF.toLocaleString()} SF</div>
          </div>
          <div class="detail-row">
            <div class="detail-label">Last Modified:</div>
            <div class="detail-value">${new Date(project.modifiedAt).toLocaleString()}</div>
          </div>
        </div>
        <div class="detail-panel">
          <h3>üí∞ Cost Settings & Summary</h3>
          <div class="detail-row">
            <div class="detail-label">Cost per NSF:</div>
            <div class="detail-value">
              $<input type="number" 
                     value="${project.costPerNSF || 0}" 
                     min="0"
                     step="10"
                     onchange="updateProjectCostFactor('costPerNSF', this.value)"
                     style="width: 100px; padding: 4px 8px; background: var(--input-bg); border: 1px solid var(--input-border); color: var(--text); border-radius: 4px;">
            </div>
          </div>
          <div class="detail-row">
            <div class="detail-label">Cost per GSF:</div>
            <div class="detail-value">
              $<input type="number" 
                     value="${project.costPerGSF || 0}" 
                     min="0"
                     step="10"
                     onchange="updateProjectCostFactor('costPerGSF', this.value)"
                     style="width: 100px; padding: 4px 8px; background: var(--input-bg); border: 1px solid var(--input-border); color: var(--text); border-radius: 4px;">
            </div>
          </div>
          <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border);">
            <div class="detail-row">
              <div class="detail-label">Equipment Cost:</div>
              <div class="detail-value" style="font-weight: 600; color: var(--accent);">$${calculateProjectCost(project).toLocaleString()}</div>
            </div>
          </div>
          <div style="margin-top: 12px;">
            <button onclick="updateAllEquipmentCostsFromDatabase()" class="btn-secondary" style="width: 100%; display: flex; align-items: center; justify-content: center; gap: 8px; background: #27ae60; border-color: #229954; color: white;" onmouseover="this.style.background='#229954'" onmouseout="this.style.background='#27ae60'" title="Update all equipment costs from the equipment database">
              üí≤ Update All Costs from Database
            </button>
          </div>
          <div style="margin-top: 8px; padding: 8px; background: var(--bg); border-radius: 4px; font-size: 0.85rem; color: var(--muted);">
            Set construction cost per NSF or GSF to calculate total project costs including construction. Use "Update All Costs" to apply database prices to all equipment.
          </div>
        </div>
        <div class="detail-panel">
          <div style="display: flex; gap: 8px; margin-bottom: 8px;">
            <button onclick="openReportModal()" class="btn-primary" style="flex: 1; display: flex; align-items: center; justify-content: center; gap: 8px;">
              üìÑ Generate Report
            </button>
            <button onclick="exportProject('${project.id}')" class="btn-secondary" style="display: flex; align-items: center; justify-content: center; gap: 6px;" title="Export project to file">
              üì§ Export
            </button>
          </div>
          <div style="display: flex; gap: 8px;">
            <button onclick="openFileImportModal()" class="btn-secondary" style="flex: 1; display: flex; align-items: center; justify-content: center; gap: 8px; background: #9b59b6; border-color: #8e44ad; color: white;" onmouseover="this.style.background='#8e44ad'" onmouseout="this.style.background='#9b59b6'" title="Import rooms from Excel, CSV, or TSV file">
              üì• Import from File
            </button>
          </div>
        </div>
        <div class="detail-panel">
          <p style="margin-bottom: 12px; color: var(--muted); font-size: 0.9rem;">
            Click <strong>+ Add to Project</strong> to import departments, functional areas, or rooms from the reference library.
          </p>
        </div>
      `;

      if (allRooms.length > 0) {
        html += `
        <div class="detail-panel">
          <h3>üè• Project Structure</h3>
        `;
        
        // Group by departments
        project.departments.forEach((dept, deptIndex) => {
          if (!dept.functionalAreas || dept.functionalAreas.length === 0) return;
          
          const deptRoomCount = dept.functionalAreas.reduce((sum, fa) => sum + (fa.rooms?.length || 0), 0);
          const deptNSF = calculateDeptNSF(dept);
          
          html += `
            <div style="margin-bottom: 16px; padding: 12px; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 6px;">
              <div style="display: flex; align-items: center; gap: 8px; cursor: pointer; user-select: none;" onclick="toggleDetailSection('dept-${deptIndex}')">
                <span id="toggle-dept-${deptIndex}" style="font-size: 0.9rem;">‚ñ∂</span>
                <div style="flex: 1;">
                  <div style="font-weight: 600; font-size: 1rem;">üè¢ ${dept.name}</div>
                  <div style="font-size: 0.85rem; color: var(--muted); margin-top: 2px;">${deptRoomCount} rooms ‚Ä¢ ${deptNSF.toLocaleString()} SF</div>
                </div>
              </div>
              <div id="content-dept-${deptIndex}" style="display: none; margin-top: 12px;">
          `;
          
          // Group by functional areas within department
          dept.functionalAreas.forEach((fa, faIndex) => {
            if (!fa.rooms || fa.rooms.length === 0) return;
            
            const faNSF = calculateFANSF(fa);
            
            html += `
              <div style="margin-left: 12px; margin-bottom: 12px; padding: 8px; background: var(--bg); border-left: 3px solid var(--primary); border-radius: 4px;">
                <div style="display: flex; align-items: center; gap: 8px; cursor: pointer; user-select: none;" onclick="toggleDetailSection('dept-${deptIndex}-fa-${faIndex}')">
                  <span id="toggle-dept-${deptIndex}-fa-${faIndex}" style="font-size: 0.8rem;">‚ñ∂</span>
                  <div style="flex: 1;">
                    <div style="font-weight: 600; font-size: 0.95rem;">üìÇ ${fa.name}</div>
                    <div style="font-size: 0.85rem; color: var(--muted); margin-top: 2px;">${fa.rooms.length} rooms ‚Ä¢ ${faNSF.toLocaleString()} SF</div>
                  </div>
                </div>
                <div id="content-dept-${deptIndex}-fa-${faIndex}" style="display: none; margin-top: 8px; margin-left: 8px;">
            `;
            
            // Show rooms in this FA (grouped by identity)
            const roomGroups = groupRoomsByIdentity(fa.rooms);
            roomGroups.forEach(group => {
              const room = group.room;
              const equipCount = room.equipment ? room.equipment.length : 0;
              html += `
                <div style="padding: 6px 8px; margin-bottom: 4px; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 4px; display: flex; align-items: center; gap: 8px; font-size: 0.85rem;">
                  <div style="min-width: 30px; text-align: center;">
                    <input type="number" value="${group.quantity}" min="0" 
                      onchange="updateRoomGroupQuantity('${group.roomIds.join(',')}', this.value, ${group.quantity})"
                      style="width: 45px; padding: 2px 4px; background: var(--input-bg); border: 1px solid var(--input-border); color: var(--text); border-radius: 3px; text-align: center; font-size: 0.85rem;"
                      title="Quantity (0 to delete all, adjust to add/remove copies)">
                  </div>
                  <div style="flex: 1; min-width: 0;">
                    <strong>${room.code}</strong> - ${room.name}
                  </div>
                  <div style="white-space: nowrap;">
                    <input type="number" value="${room.nsf || 0}" 
                      onchange="updateRoomGroupNSF('${group.roomIds.join(',')}', this.value)"
                      style="width: 55px; padding: 2px 4px; background: var(--input-bg); border: 1px solid var(--input-border); color: var(--text); border-radius: 3px; text-align: right; font-size: 0.85rem;">
                    <span style="font-size: 0.75rem; margin-left: 2px;">SF</span>
                  </div>
                  <div style="font-size: 0.75rem; color: var(--muted); white-space: nowrap;">${equipCount} eq</div>
                </div>
              `;
            });
            
            html += `
                </div>
              </div>
            `;
          });
          
          html += `
              </div>
            </div>
          `;
        });
        
        html += `
        </div>
        `;
      }

      return html;
    }

    function updateProjectName(newName) {
      const project = getCurrentProject();
      project.name = newName;
      saveProjects();
      renderAll();
    }

    function renderIDSPanel() {
      const activeIds = SAMPLE_IDS.filter(d => activeChapters.includes(d.chapterId));
      
      if (activeIds.length === 0) return '';

      let html = `
        <div class="detail-panel">
          <h3>üìù Input Data Statements (IDS)</h3>
          <p class="muted" style="margin-bottom: 12px; font-size: 0.85rem;">
            Adjust these values to recalculate the program.
          </p>
      `;

      activeIds.forEach(driver => {
        const current = driverValues.find(
          v => v.projectId === PROJECT.id && v.driverId === driver.id
        );
        const val = current ? current.value : (driver.defaultValue ?? "");

        html += `
          <div class="detail-row">
            <div class="detail-label" style="min-width: 200px; font-weight: normal;">
              ${driver.chapterId} ${driver.label}
            </div>
            <div class="detail-value">
        `;

        if (driver.inputKind === "number") {
          html += `
            <input type="number" 
                   value="${val}" 
                   ${driver.minValue != null ? `min="${driver.minValue}"` : ''}
                   ${driver.maxValue != null ? `max="${driver.maxValue}"` : ''}
                   onchange="handleDriverChange('${driver.id}', this.value, 'number')"
                   style="width: 100px; padding: 4px 8px; background: var(--input-bg); border: 1px solid var(--input-border); color: var(--text); border-radius: 4px;">
          `;
        } else if (driver.inputKind === "boolean") {
          html += `
            <select onchange="handleDriverChange('${driver.id}', this.value, 'boolean')"
                    style="padding: 4px 8px; background: var(--input-bg); border: 1px solid var(--input-border); color: var(--text); border-radius: 4px;">
              <option value="false" ${!val ? 'selected' : ''}>No</option>
              <option value="true" ${val ? 'selected' : ''}>Yes</option>
            </select>
          `;
        }

        html += `
            </div>
          </div>
          <div style="font-size: 0.75rem; color: var(--muted); margin: 4px 0 8px 0; padding-left: 200px;">
            ${driver.text}
          </div>
        `;
      });

      html += `</div>`;
      return html;
    }

    function renderChapterDetail() {
      const chapter = SAMPLE_CHAPTERS.find(c => c.id === selectedNode.chapterId);
      const program = buildProgram(PROJECT, driverValues, activeChapters);
      const chapterRooms = program.roomRequirements.filter(rr => rr.chapterId === selectedNode.chapterId);
      const totalRooms = chapterRooms.reduce((sum, rr) => sum + rr.requiredCount, 0);
      const totalNSF = chapterRooms.reduce((sum, rr) => {
        const room = SAMPLE_ROOMS.find(r => r.id === rr.roomTemplateId);
        return sum + (room ? room.nsf * rr.requiredCount : 0);
      }, 0);

      return `
        <div class="detail-panel">
          <h3>üìÅ ${chapter.title}</h3>
          <div class="detail-row">
            <div class="detail-label">Chapter ID:</div>
            <div class="detail-value">${chapter.id}</div>
          </div>
          <div class="detail-row">
            <div class="detail-label">Category:</div>
            <div class="detail-value">${chapter.category}</div>
          </div>
          <div class="detail-row">
            <div class="detail-label">Room Types:</div>
            <div class="detail-value">${chapterRooms.length}</div>
          </div>
          <div class="detail-row">
            <div class="detail-label">Total Rooms:</div>
            <div class="detail-value">${totalRooms}</div>
          </div>
          <div class="detail-row">
            <div class="detail-label">Total NSF:</div>
            <div class="detail-value">${totalNSF.toLocaleString()} SF</div>
          </div>
        </div>
      `;
    }

    // Helper function to get room attributes from ROOM_SIZES
    function getRoomAttributes(roomCode) {
      if (typeof ROOM_SIZES !== 'undefined' && ROOM_SIZES) {
        return ROOM_SIZES.find(r => r.id === roomCode);
      }
      return null;
    }

    // Helper to check if a value has been modified from the original
    function isValueModified(currentValue, originalValue) {
      // If both are null/undefined/empty, not modified
      if ((currentValue === null || currentValue === undefined || currentValue === '') &&
          (originalValue === null || originalValue === undefined || originalValue === '')) {
        return false;
      }
      // If current value exists but original doesn't, it's modified (user added a value)
      if ((currentValue !== null && currentValue !== undefined && currentValue !== '') &&
          (originalValue === null || originalValue === undefined || originalValue === '')) {
        return true;
      }
      // Compare values (convert to string for comparison)
      return String(currentValue) !== String(originalValue);
    }

    // Helper to render editable attribute field with modification indicator
    function renderEditableAttribute(label, value, onChange, originalValue = undefined) {
      const displayValue = value !== null && value !== undefined && value !== '' ? value : '';
      const isModified = originalValue !== undefined && isValueModified(value, originalValue);
      const modifiedIndicator = isModified ? '<span style="color: #e67e22; font-weight: bold; margin-left: 4px;" title="Modified from original">‚óè</span>' : '';
      return `
        <div class="detail-row">
          <div class="detail-label">${label}:${modifiedIndicator}</div>
          <div class="detail-value">
            <input type="text" value="${displayValue}" 
              onchange="${onChange}"
              placeholder="Not specified"
              style="width: 100%; padding: 4px 8px; background: var(--input-bg); border: 1px solid ${isModified ? '#e67e22' : 'var(--input-border)'}; color: var(--text); border-radius: 4px;">
          </div>
        </div>
      `;
    }

    // Helper to render read-only attribute field
    function renderReadOnlyAttribute(label, value) {
      const displayValue = value !== null && value !== undefined && value !== '' ? value : 'Not specified';
      return `
        <div class="detail-row">
          <div class="detail-label">${label}:</div>
          <div class="detail-value">${displayValue}</div>
        </div>
      `;
    }

    function renderRoomDetail() {
      // Handle imported rooms (from reference mode)
      if (selectedNode.room && !selectedNode.roomTemplate) {
        const room = selectedNode.room;
        const equipCount = room.equipment ? room.equipment.length : 0;
        const nsf = room.nsf || 0;
        const project = getCurrentProject();
        const roomCost = calculateRoomCost(room, project);
        const equipmentCost = calculateEquipmentCost(room.equipment);
        
        // Get room attributes from ROOM_SIZES
        const roomAttrs = getRoomAttributes(room.code);

        // Find current dept and FA for this room
        let currentDeptId = null;
        let currentFAId = null;
        let currentDeptName = '';
        let currentFAName = '';
        
        if (project.departments) {
          for (const dept of project.departments) {
            if (dept.functionalAreas) {
              for (const fa of dept.functionalAreas) {
                if (fa.rooms && fa.rooms.some(r => r.id === room.id)) {
                  currentDeptId = dept.id;
                  currentFAId = fa.id;
                  currentDeptName = dept.name;
                  currentFAName = fa.name;
                  break;
                }
              }
            }
            if (currentDeptId) break;
          }
        }

        // Build dept options
        let deptOptions = '';
        if (project.departments) {
          project.departments.forEach(dept => {
            const selected = dept.id === currentDeptId ? 'selected' : '';
            deptOptions += `<option value="${dept.id}" ${selected}>${dept.name}</option>`;
          });
        }

        // Build FA options for current dept
        let faOptions = '';
        const currentDept = project.departments?.find(d => d.id === currentDeptId);
        if (currentDept && currentDept.functionalAreas) {
          currentDept.functionalAreas.forEach(fa => {
            const selected = fa.id === currentFAId ? 'selected' : '';
            faOptions += `<option value="${fa.id}" ${selected}>${fa.name}</option>`;
          });
        }

        let html = `
          <div class="detail-panel">
            <h3>üö™ ${room.code} - ${room.name}</h3>
            <div class="detail-row">
              <div class="detail-label">Department:</div>
              <div class="detail-value">
                <select onchange="updateRoomDepartment('${room.id}', this.value)" 
                  style="width: 100%; padding: 4px 8px; background: var(--input-bg); border: 1px solid var(--input-border); color: var(--text); border-radius: 4px;">
                  ${deptOptions}
                </select>
              </div>
            </div>
            <div class="detail-row">
              <div class="detail-label">Functional Area:</div>
              <div class="detail-value">
                <select id="room-fa-select-${room.id}" onchange="updateRoomFunctionalArea('${room.id}', '${currentDeptId}', this.value)" 
                  style="width: 100%; padding: 4px 8px; background: var(--input-bg); border: 1px solid var(--input-border); color: var(--text); border-radius: 4px;">
                  ${faOptions}
                </select>
              </div>
            </div>
            <div class="detail-row">
              <div class="detail-label">Room Code:</div>
              <div class="detail-value">
                <input type="text" value="${room.code || ''}" 
                  onchange="updateRoomCode('${room.id}', this.value)"
                  placeholder="(optional)"
                  style="width: 100%; padding: 4px 8px; background: var(--input-bg); border: 1px solid var(--input-border); color: var(--text); border-radius: 4px;">
              </div>
            </div>
            <div class="detail-row">
              <div class="detail-label">Room Number:</div>
              <div class="detail-value">
                <input type="text" value="${room.roomNumber || ''}" 
                  onchange="updateRoomNumber('${room.id}', this.value)"
                  placeholder="(optional)"
                  style="width: 100%; padding: 4px 8px; background: var(--input-bg); border: 1px solid var(--input-border); color: var(--text); border-radius: 4px;">
              </div>
            </div>
            <div class="detail-row">
              <div class="detail-label">Room Name:${roomAttrs && isValueModified(room.name, roomAttrs.name) ? '<span style="color: #e67e22; font-weight: bold; margin-left: 4px;" title="Modified from original">‚óè</span>' : ''}</div>
              <div class="detail-value">
                <input type="text" value="${room.name}" 
                  onchange="updateRoomName('${room.id}', this.value)"
                  style="width: 100%; padding: 4px 8px; background: var(--input-bg); border: 1px solid ${roomAttrs && isValueModified(room.name, roomAttrs.name) ? '#e67e22' : 'var(--input-border)'}; color: var(--text); border-radius: 4px;"
                  title="${roomAttrs ? 'Original: ' + roomAttrs.name : ''}">
              </div>
            </div>
            <div class="detail-row">
              <div class="detail-label">NSF:${roomAttrs && isValueModified(nsf, roomAttrs.nsf) ? '<span style="color: #e67e22; font-weight: bold; margin-left: 4px;" title="Modified from original">‚óè</span>' : ''}</div>
              <div class="detail-value">
                <input type="number" value="${nsf}" 
                  onchange="updateRoomNSF('${room.id}', this.value)"
                  style="width: 80px; padding: 4px 8px; background: var(--input-bg); border: 1px solid ${roomAttrs && isValueModified(nsf, roomAttrs.nsf) ? '#e67e22' : 'var(--input-border)'}; color: var(--text); border-radius: 4px;"
                  title="${roomAttrs ? 'Original: ' + roomAttrs.nsf + ' SF' : ''}">
                SF
              </div>
            </div>
            <div class="detail-row">
              <div class="detail-label">Equipment Items:</div>
              <div class="detail-value">${equipCount}</div>
            </div>
            <div class="detail-row">
              <div class="detail-label">Equipment Cost:</div>
              <div class="detail-value" style="font-weight: 600; color: var(--accent);">$${equipmentCost.toLocaleString()}</div>
            </div>
            <div class="detail-row">
              <div class="detail-label">Total Cost:</div>
              <div class="detail-value" style="font-weight: 600; color: var(--accent);">$${roomCost.toLocaleString()}</div>
            </div>
          </div>
          <div class="detail-panel" style="padding: 8px 12px; display: flex; gap: 8px; flex-wrap: wrap;">
            <button class="btn-secondary" onclick="duplicateRoom('${room.id}')" style="flex: 1; font-size: 0.85rem; padding: 6px 12px;">üìã Duplicate Room</button>
            <button class="btn-secondary" onclick="openReplaceRoomModal('${room.id}')" style="flex: 1; font-size: 0.85rem; padding: 6px 12px; background: #3498db; color: white; border-color: #2980b9;" onmouseover="this.style.background='#2980b9'" onmouseout="this.style.background='#3498db'">üîÑ Replace Room</button>
            <button class="btn-secondary" onclick="resetRoomToDefault('${room.id}')" style="flex: 1; font-size: 0.85rem; padding: 6px 12px; background: #f39c12; color: white; border-color: #e67e22;" onmouseover="this.style.background='#e67e22'" onmouseout="this.style.background='#f39c12'">‚Ü©Ô∏è Reset to Default</button>
          </div>
        `;

        // Room Attributes - editable if available from ROOM_SIZES
        if (roomAttrs) {
          // Helper to get attribute value (room.attributes overrides ROOM_SIZES)
          const getAttr = (attrName) => room.attributes?.[attrName] ?? roomAttrs[attrName];
          // Helper to get original value from ROOM_SIZES database
          const getOriginal = (attrName) => roomAttrs[attrName];
          
          // Consolidated Attributes Panel with ALL available attributes in multi-column layout
          html += `
            <div class="detail-panel">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                <h3 style="margin: 0;">üìã Room Attributes</h3>
                <span style="font-size: 0.8rem; color: var(--muted);">
                  <span style="color: #e67e22; font-weight: bold;">‚óè</span> Modified from database
                </span>
              </div>
              <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 16px;">
                
                <!-- Column 1: Materials & Finishes -->
                <div>
                  <h4 style="margin: 0 0 8px 0; font-size: 0.9rem; color: var(--muted);">üèóÔ∏è Materials & Finishes</h4>
                  ${renderEditableAttribute('Ceiling Material', getAttr('ceilingMaterial'), `updateRoomAttribute('${room.id}', 'ceilingMaterial', this.value)`, getOriginal('ceilingMaterial'))}
                  ${renderEditableAttribute('Ceiling Alt', getAttr('ceilingMaterialAlternate'), `updateRoomAttribute('${room.id}', 'ceilingMaterialAlternate', this.value)`, getOriginal('ceilingMaterialAlternate'))}
                  ${renderEditableAttribute('Ceiling Finish', getAttr('ceilingFinish'), `updateRoomAttribute('${room.id}', 'ceilingFinish', this.value)`, getOriginal('ceilingFinish'))}
                  ${renderEditableAttribute('Ceiling Spec', getAttr('finishCeiling'), `updateRoomAttribute('${room.id}', 'finishCeiling', this.value)`, getOriginal('finishCeiling'))}
                  
                  <div style="height: 8px;"></div>
                  ${renderEditableAttribute('Wall Material', getAttr('wallMaterial'), `updateRoomAttribute('${room.id}', 'wallMaterial', this.value)`, getOriginal('wallMaterial'))}
                  ${renderEditableAttribute('Wall Alt', getAttr('wallMaterialAlternate'), `updateRoomAttribute('${room.id}', 'wallMaterialAlternate', this.value)`, getOriginal('wallMaterialAlternate'))}
                  ${renderEditableAttribute('Wall Finish', getAttr('wallFinish'), `updateRoomAttribute('${room.id}', 'wallFinish', this.value)`, getOriginal('wallFinish'))}
                  ${renderEditableAttribute('Wall Spec', getAttr('finishWall'), `updateRoomAttribute('${room.id}', 'finishWall', this.value)`, getOriginal('finishWall'))}
                  ${renderEditableAttribute('Wainscot Spec', getAttr('finishWain'), `updateRoomAttribute('${room.id}', 'finishWain', this.value)`, getOriginal('finishWain'))}
                  
                  <div style="height: 8px;"></div>
                  ${renderEditableAttribute('Floor Material', getAttr('floorMaterial'), `updateRoomAttribute('${room.id}', 'floorMaterial', this.value)`, getOriginal('floorMaterial'))}
                  ${renderEditableAttribute('Floor Alt', getAttr('floorMaterialAlternate'), `updateRoomAttribute('${room.id}', 'floorMaterialAlternate', this.value)`, getOriginal('floorMaterialAlternate'))}
                  ${renderEditableAttribute('Floor Spec', getAttr('finishFloor'), `updateRoomAttribute('${room.id}', 'finishFloor', this.value)`, getOriginal('finishFloor'))}
                  ${renderEditableAttribute('Floor Base', getAttr('floorBaseMaterial'), `updateRoomAttribute('${room.id}', 'floorBaseMaterial', this.value)`, getOriginal('floorBaseMaterial'))}
                  ${renderEditableAttribute('Base Spec', getAttr('finishBase'), `updateRoomAttribute('${room.id}', 'finishBase', this.value)`, getOriginal('finishBase'))}
                </div>
                
                <!-- Column 2: Door & Environmental -->
                <div>
                  <h4 style="margin: 0 0 8px 0; font-size: 0.9rem; color: var(--muted);">üö™ Door</h4>
                  ${renderEditableAttribute('Door Material', getAttr('doorMaterial'), `updateRoomAttribute('${room.id}', 'doorMaterial', this.value)`, getOriginal('doorMaterial'))}
                  ${renderEditableAttribute('Door Spec', getAttr('finishDoor'), `updateRoomAttribute('${room.id}', 'finishDoor', this.value)`, getOriginal('finishDoor'))}
                  ${renderEditableAttribute('Door Height', getAttr('doorHeight'), `updateRoomAttribute('${room.id}', 'doorHeight', this.value)`, getOriginal('doorHeight'))}
                  ${renderEditableAttribute('Door Width', getAttr('doorWidth'), `updateRoomAttribute('${room.id}', 'doorWidth', this.value)`, getOriginal('doorWidth'))}
                  ${renderEditableAttribute('Door Type', getAttr('doorType'), `updateRoomAttribute('${room.id}', 'doorType', this.value)`, getOriginal('doorType'))}
                  ${renderEditableAttribute('Door Rating', getAttr('doorRating'), `updateRoomAttribute('${room.id}', 'doorRating', this.value)`, getOriginal('doorRating'))}
                  ${renderEditableAttribute('Hardware Spec', getAttr('finishHardware'), `updateRoomAttribute('${room.id}', 'finishHardware', this.value)`, getOriginal('finishHardware'))}
                  
                  <h4 style="margin: 12px 0 8px 0; font-size: 0.9rem; color: var(--muted);">üí° Lighting & Acoustics</h4>
                  ${renderEditableAttribute('Lighting Level', getAttr('lightingLevel'), `updateRoomAttribute('${room.id}', 'lightingLevel', this.value)`, getOriginal('lightingLevel'))}
                  ${renderEditableAttribute('Acoustical Criteria', getAttr('acousticalCriteria'), `updateRoomAttribute('${room.id}', 'acousticalCriteria', this.value)`, getOriginal('acousticalCriteria'))}
                  ${renderEditableAttribute('Max Noise (NC)', getAttr('maxNoiseLevelNc'), `updateRoomAttribute('${room.id}', 'maxNoiseLevelNc', this.value)`, getOriginal('maxNoiseLevelNc'))}
                  ${renderEditableAttribute('Floor Live Load', getAttr('floorLiveLoad'), `updateRoomAttribute('${room.id}', 'floorLiveLoad', this.value)`, getOriginal('floorLiveLoad'))}
                </div>
                
                <!-- Column 3: HVAC -->
                <div>
                  <h4 style="margin: 0 0 8px 0; font-size: 0.9rem; color: var(--muted);">‚ùÑÔ∏è HVAC</h4>
                  ${renderEditableAttribute('Min Total ACH', getAttr('minTotalAch'), `updateRoomAttribute('${room.id}', 'minTotalAch', this.value)`, getOriginal('minTotalAch'))}
                  ${renderEditableAttribute('Min OA ACH', getAttr('minOaAch'), `updateRoomAttribute('${room.id}', 'minOaAch', this.value)`, getOriginal('minOaAch'))}
                  ${renderEditableAttribute('Unoccupied ACH', getAttr('unoccupiedAch'), `updateRoomAttribute('${room.id}', 'unoccupiedAch', this.value)`, getOriginal('unoccupiedAch'))}
                  ${renderEditableAttribute('Air Balance', getAttr('roomAirBalance'), `updateRoomAttribute('${room.id}', 'roomAirBalance', this.value)`, getOriginal('roomAirBalance'))}
                  ${renderEditableAttribute('HEPA Filtration', getAttr('airHasHepaFiltration'), `updateRoomAttribute('${room.id}', 'airHasHepaFiltration', this.value)`, getOriginal('airHasHepaFiltration'))}
                  ${renderEditableAttribute('100% Exhaust', getAttr('exhaustIs100Outside'), `updateRoomAttribute('${room.id}', 'exhaustIs100Outside', this.value)`, getOriginal('exhaustIs100Outside'))}
                  ${renderEditableAttribute('Temp Cooling (¬∞C)', getAttr('indoorTempCoolingC'), `updateRoomAttribute('${room.id}', 'indoorTempCoolingC', this.value)`, getOriginal('indoorTempCoolingC'))}
                  ${renderEditableAttribute('Temp Heating (¬∞C)', getAttr('indoorTempHeatingC'), `updateRoomAttribute('${room.id}', 'indoorTempHeatingC', this.value)`, getOriginal('indoorTempHeatingC'))}
                  ${renderEditableAttribute('RH Max (%)', getAttr('indoorRelativeHumidityRhMax'), `updateRoomAttribute('${room.id}', 'indoorRelativeHumidityRhMax', this.value)`, getOriginal('indoorRelativeHumidityRhMax'))}
                  ${renderEditableAttribute('RH Min (%)', getAttr('indoorRelativeHumidityRhMin'), `updateRoomAttribute('${room.id}', 'indoorRelativeHumidityRhMin', this.value)`, getOriginal('indoorRelativeHumidityRhMin'))}
                </div>
                
                <!-- Column 4: Medical Gases & Plumbing -->
                <div>
                  <h4 style="margin: 0 0 8px 0; font-size: 0.9rem; color: var(--muted);">üîß Medical Gases</h4>
                  ${renderEditableAttribute('Medical Air', getAttr('medAir'), `updateRoomAttribute('${room.id}', 'medAir', this.value)`, getOriginal('medAir'))}
                  ${renderEditableAttribute('Medical Vacuum', getAttr('medVac'), `updateRoomAttribute('${room.id}', 'medVac', this.value)`, getOriginal('medVac'))}
                  ${renderEditableAttribute('Oxygen', getAttr('oxygen'), `updateRoomAttribute('${room.id}', 'oxygen', this.value)`, getOriginal('oxygen'))}
                  ${renderEditableAttribute('Nitrogen', getAttr('nitrogen'), `updateRoomAttribute('${room.id}', 'nitrogen', this.value)`, getOriginal('nitrogen'))}
                  ${renderEditableAttribute('Nitrous Oxide', getAttr('nitrousOxide'), `updateRoomAttribute('${room.id}', 'nitrousOxide', this.value)`, getOriginal('nitrousOxide'))}
                  ${renderEditableAttribute('WAGD', getAttr('wagd'), `updateRoomAttribute('${room.id}', 'wagd', this.value)`, getOriginal('wagd'))}
                  ${renderEditableAttribute('CO2', getAttr('co2'), `updateRoomAttribute('${room.id}', 'co2', this.value)`, getOriginal('co2'))}
                  ${renderEditableAttribute('Inst Air', getAttr('instAir'), `updateRoomAttribute('${room.id}', 'instAir', this.value)`, getOriginal('instAir'))}
                  ${renderEditableAttribute('Lab Air', getAttr('labAir'), `updateRoomAttribute('${room.id}', 'labAir', this.value)`, getOriginal('labAir'))}
                  ${renderEditableAttribute('Lab Vacuum', getAttr('labVac'), `updateRoomAttribute('${room.id}', 'labVac', this.value)`, getOriginal('labVac'))}
                  ${renderEditableAttribute('Dental Air', getAttr('dentalAir'), `updateRoomAttribute('${room.id}', 'dentalAir', this.value)`, getOriginal('dentalAir'))}
                  ${renderEditableAttribute('Dental Vacuum', getAttr('dentalVac'), `updateRoomAttribute('${room.id}', 'dentalVac', this.value)`, getOriginal('dentalVac'))}
                  ${renderEditableAttribute('Oral Evac', getAttr('oralEvac'), `updateRoomAttribute('${room.id}', 'oralEvac', this.value)`, getOriginal('oralEvac'))}
                  
                  <h4 style="margin: 12px 0 8px 0; font-size: 0.9rem; color: var(--muted);">üíß Plumbing</h4>
                  ${renderEditableAttribute('Cold Water', getAttr('domesticColdWater'), `updateRoomAttribute('${room.id}', 'domesticColdWater', this.value)`, getOriginal('domesticColdWater'))}
                  ${renderEditableAttribute('Hot Water', getAttr('domesticHotWater'), `updateRoomAttribute('${room.id}', 'domesticHotWater', this.value)`, getOriginal('domesticHotWater'))}
                  ${renderEditableAttribute('Floor Drain', getAttr('floorDrain'), `updateRoomAttribute('${room.id}', 'floorDrain', this.value)`, getOriginal('floorDrain'))}
                  ${renderEditableAttribute('Natural Gas', getAttr('naturalGas'), `updateRoomAttribute('${room.id}', 'naturalGas', this.value)`, getOriginal('naturalGas'))}
                  ${renderEditableAttribute('Lab Natural Gas', getAttr('labNaturalGas'), `updateRoomAttribute('${room.id}', 'labNaturalGas', this.value)`, getOriginal('labNaturalGas'))}
                </div>
              </div>
            </div>
          `;
        }

        if (room.equipment && room.equipment.length > 0) {
          html += `
            <div class="detail-panel">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                <div style="display: flex; align-items: center; gap: 12px;">
                  <h3 style="margin: 0;">üîß Equipment (${room.equipment.length} items)</h3>
                  <span style="font-size: 0.75rem; color: var(--muted);">
                    <span style="color: #e67e22; font-weight: bold;">‚óè</span> = cost override
                  </span>
                </div>
                <button class="btn-secondary" onclick="addEquipmentToRoom('${room.id}')" style="padding: 6px 12px; font-size: 0.85rem;">‚ûï Add Equipment</button>
              </div>
              <div class="equipment-list">
          `;

          room.equipment.forEach(eq => {
            const unitCost = getEquipmentUnitCost(eq.jsn, eq.cost);
            const eqCost = unitCost * (eq.quantity || 1);
            const hasDefaultPrice = !eq.cost && unitCost > 0;
            // Check if cost is overridden from database price
            const dbPrice = typeof getEquipmentPrice === 'function' ? getEquipmentPrice(eq.jsn) : 
                           (typeof EQUIPMENT_ATTRIBUTES !== 'undefined' && EQUIPMENT_ATTRIBUTES[eq.jsn] ? EQUIPMENT_ATTRIBUTES[eq.jsn].meanPrice : null);
            const costIsModified = eq.cost && dbPrice && eq.cost !== dbPrice;
            const costModifiedIndicator = costIsModified ? '<span style="color: #e67e22; font-weight: bold; margin-left: 2px;" title="Cost modified from database">‚óè</span>' : '';
            html += `
              <div class="equipment-item">
                <div class="equipment-item-header">
                  <span><span class="jsn-clickable" onclick="event.stopPropagation(); showEquipmentDetail('${eq.jsn}')" title="Click for equipment details">${eq.jsn}</span> - ${eq.name} - <span class="equipment-item-desc${eq.description && eq.description.length > 100 ? ' truncated' : ''}">${eq.description || ''}</span>${eq.description && eq.description.length > 100 ? ' <span class="equipment-desc-toggle" onclick="toggleEquipmentDesc(this)">more</span>' : ''}</span>
                  <span style="display: flex; align-items: center; gap: 8px;">
                    <span>Qty:</span>
                    <input type="number" value="${eq.quantity}" min="1"
                      onchange="updateEquipmentQuantity('${room.id}', '${eq.id}', this.value)"
                      style="width: 60px; padding: 2px 6px; background: var(--input-bg); border: 1px solid var(--input-border); color: var(--text); border-radius: 4px;">
                    <span>| $${costModifiedIndicator}</span>
                    <input type="number" value="${eq.cost || ''}" min="0" step="100"
                      onchange="updateEquipmentCost('${room.id}', '${eq.id}', this.value)"
                      placeholder="${hasDefaultPrice ? unitCost : '0'}"
                      style="width: 80px; padding: 2px 6px; background: var(--input-bg); border: 1px solid ${costIsModified ? '#e67e22' : 'var(--input-border)'}; color: ${hasDefaultPrice ? 'var(--muted)' : 'var(--text)'}; border-radius: 4px;"
                      title="${hasDefaultPrice ? 'Using database price ($' + unitCost + '). Enter value to override.' : (costIsModified ? 'Modified from database price ($' + dbPrice + ')' : 'Unit cost')}">
                    <span>= $${eqCost.toLocaleString()}</span>
                    <span>| ${eq.acqIns}</span>
                    <button onclick="removeEquipment('${room.id}', '${eq.id}')" 
                      style="padding: 2px 8px; background: var(--error); color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.75rem;"
                      title="Remove equipment">üóëÔ∏è</button>
                  </span>
                </div>
              </div>
            `;
          });

          html += `
              </div>
            </div>
          `;
        } else {
          // Show Add Equipment button even when no equipment exists
          html += `
            <div class="detail-panel">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                <h3 style="margin: 0;">üîß Equipment (0 items)</h3>
                <button class="btn-secondary" onclick="addEquipmentToRoom('${room.id}')" style="padding: 6px 12px; font-size: 0.85rem;">‚ûï Add Equipment</button>
              </div>
              <p style="color: var(--muted); font-size: 0.9rem;">No equipment in this room yet.</p>
            </div>
          `;
        }

        return html;
      }

      // Handle program mode rooms (rule-based)
      const room = selectedNode.roomTemplate;
      const rr = selectedNode.roomRequirement;
      const program = buildProgram(PROJECT, driverValues, activeChapters);
      
      // Get equipment for this room
      const roomEquipment = program.equipmentRequirements.filter(
        er => er.roomRequirementId === rr.id
      );

      // Get room attributes from ROOM_SIZES
      const roomAttrs = getRoomAttributes(room.id);

      let html = `
        <div class="detail-panel">
          <h3>üö™ ${room.id} - ${room.name}</h3>
          <div class="detail-row">
            <div class="detail-label">Room Code:</div>
            <div class="detail-value">${room.id}</div>
          </div>
          <div class="detail-row">
            <div class="detail-label">Quantity:</div>
            <div class="detail-value">${rr.requiredCount}</div>
          </div>
          <div class="detail-row">
            <div class="detail-label">NSF per Room:</div>
            <div class="detail-value">${room.nsf} SF</div>
          </div>
          <div class="detail-row">
            <div class="detail-label">Total NSF:</div>
            <div class="detail-value">${(room.nsf * rr.requiredCount).toLocaleString()} SF</div>
          </div>
          ${roomAttrs && roomAttrs.functionalAreaName ? `
          <div class="detail-row" style="margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border);">
            <div class="detail-label">Functional Area:</div>
            <div class="detail-value">FA${roomAttrs.functionalAreaNumber}: ${roomAttrs.functionalAreaName}</div>
          </div>
          ` : ''}
        </div>
      `;

      // Room Attributes - show in read-only mode for program mode rooms
      if (roomAttrs) {
        html += `
          <div class="detail-panel">
            <h3>üìã Room Attributes</h3>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 16px;">
              
              <!-- Column 1: Materials & Finishes -->
              <div>
                <h4 style="margin: 0 0 8px 0; font-size: 0.9rem; color: var(--muted);">üèóÔ∏è Materials & Finishes</h4>
                ${renderReadOnlyAttribute('Ceiling Material', roomAttrs.ceilingMaterial)}
                ${renderReadOnlyAttribute('Ceiling Alt', roomAttrs.ceilingMaterialAlternate)}
                ${renderReadOnlyAttribute('Ceiling Finish', roomAttrs.ceilingFinish)}
                ${renderReadOnlyAttribute('Ceiling Spec', roomAttrs.finishCeiling)}
                
                <div style="height: 8px;"></div>
                ${renderReadOnlyAttribute('Wall Material', roomAttrs.wallMaterial)}
                ${renderReadOnlyAttribute('Wall Alt', roomAttrs.wallMaterialAlternate)}
                ${renderReadOnlyAttribute('Wall Finish', roomAttrs.wallFinish)}
                ${renderReadOnlyAttribute('Wall Spec', roomAttrs.finishWall)}
                ${renderReadOnlyAttribute('Wainscot Spec', roomAttrs.finishWain)}
                
                <div style="height: 8px;"></div>
                ${renderReadOnlyAttribute('Floor Material', roomAttrs.floorMaterial)}
                ${renderReadOnlyAttribute('Floor Alt', roomAttrs.floorMaterialAlternate)}
                ${renderReadOnlyAttribute('Floor Spec', roomAttrs.finishFloor)}
                ${renderReadOnlyAttribute('Floor Base', roomAttrs.floorBaseMaterial)}
                ${renderReadOnlyAttribute('Base Spec', roomAttrs.finishBase)}
              </div>
              
              <!-- Column 2: Door & Environmental -->
              <div>
                <h4 style="margin: 0 0 8px 0; font-size: 0.9rem; color: var(--muted);">üö™ Door</h4>
                ${renderReadOnlyAttribute('Door Material', roomAttrs.doorMaterial)}
                ${renderReadOnlyAttribute('Door Spec', roomAttrs.finishDoor)}
                ${renderReadOnlyAttribute('Door Height', roomAttrs.doorHeight)}
                ${renderReadOnlyAttribute('Door Width', roomAttrs.doorWidth)}
                ${renderReadOnlyAttribute('Door Type', roomAttrs.doorType)}
                ${renderReadOnlyAttribute('Door Rating', roomAttrs.doorRating)}
                ${renderReadOnlyAttribute('Hardware Spec', roomAttrs.finishHardware)}
                
                <h4 style="margin: 12px 0 8px 0; font-size: 0.9rem; color: var(--muted);">üí° Lighting & Acoustics</h4>
                ${renderReadOnlyAttribute('Lighting Level', roomAttrs.lightingLevel)}
                ${renderReadOnlyAttribute('Acoustical Criteria', roomAttrs.acousticalCriteria)}
                ${renderReadOnlyAttribute('Max Noise (NC)', roomAttrs.maxNoiseLevelNc)}
                ${renderReadOnlyAttribute('Floor Live Load', roomAttrs.floorLiveLoad)}
              </div>
              
              <!-- Column 3: HVAC -->
              <div>
                <h4 style="margin: 0 0 8px 0; font-size: 0.9rem; color: var(--muted);">‚ùÑÔ∏è HVAC</h4>
                ${renderReadOnlyAttribute('Min Total ACH', roomAttrs.minTotalAch)}
                ${renderReadOnlyAttribute('Min OA ACH', roomAttrs.minOaAch)}
                ${renderReadOnlyAttribute('Room Air', roomAttrs.roomAir)}
                ${renderReadOnlyAttribute('Room Air Balance', roomAttrs.roomAirBalance)}
                ${renderReadOnlyAttribute('Unoccupied ACH', roomAttrs.unoccupiedAch)}
                ${renderReadOnlyAttribute('HEPA Filtration', roomAttrs.airHasHepaFiltration)}
                ${renderReadOnlyAttribute('100% Outside Exhaust', roomAttrs["exhaustIs100%Outside"])}
                ${renderReadOnlyAttribute('Temp Cooling (C)', roomAttrs.indoorTempCoolingC)}
                ${renderReadOnlyAttribute('Temp Heating (C)', roomAttrs.indoorTempHeatingC)}
                ${renderReadOnlyAttribute('RH Max (%)', roomAttrs["indoorRelativeHumidity%rhMax"])}
                ${renderReadOnlyAttribute('RH Min (%)', roomAttrs["indoorRelativeHumidity%rhMin"])}
              </div>
            </div>
          </div>
        `;
      }

      html += `
        <div class="detail-panel">
          <p style="color: var(--muted); font-size: 0.9rem;">
            üí° Program Mode - rooms are generated by rules. Import to Project Mode to customize.
          </p>
        </div>
      `;

      if (roomEquipment.length > 0) {
        html += `
          <div class="detail-panel">
            <h3>üîß Equipment (${roomEquipment.length} items)</h3>
            <div class="equipment-list">
        `;

        const equipmentMap = new Map();
        EQUIPMENT_LIST.forEach(e => equipmentMap.set(e.jsn, e));

        roomEquipment.forEach(er => {
          const eq = equipmentMap.get(er.equipmentJsn);
          if (eq) {
            html += `
              <div class="equipment-item">
                <div class="equipment-item-header">
                  <span><span class="jsn-clickable" onclick="event.stopPropagation(); showEquipmentDetail('${eq.jsn}')" title="Click for equipment details">${eq.jsn}</span> - ${eq.name} - <span class="equipment-item-desc${eq.description && eq.description.length > 100 ? ' truncated' : ''}">${eq.description || ''}</span>${eq.description && eq.description.length > 100 ? '<span class="equipment-desc-toggle" onclick="toggleEquipmentDesc(this)">more</span>' : ''}</span>
                  <span>Qty: ${er.requiredQtyPerRoom} | ${eq.acqIns}</span>
                </div>
              </div>
            `;
          }
        });

        html += `
            </div>
          </div>
        `;
      }

      return html;
    }

    function renderRoomReferenceDetail() {
      // Get room info from selected node
      const roomCode = selectedNode.roomCode;
      const roomName = selectedNode.roomName;
      const department = selectedNode.department;
      const functionalArea = selectedNode.functionalArea;
      
      console.log('Rendering room reference:', roomCode, roomName, department, functionalArea);
      console.log('ROOM_SIZES available:', typeof ROOM_SIZES !== 'undefined', ROOM_SIZES ? ROOM_SIZES.length : 0);
      console.log('ROOM_EQUIPMENT_MAPPINGS available:', typeof ROOM_EQUIPMENT_MAPPINGS !== 'undefined', ROOM_EQUIPMENT_MAPPINGS ? ROOM_EQUIPMENT_MAPPINGS.length : 0);
      
      // Defensive check for ROOM_SIZES
      if (typeof ROOM_SIZES === 'undefined') {
        return `
          <div class="detail-panel">
            <h3>‚ö†Ô∏è Data Loading Error</h3>
            <p style="color: var(--muted);">Room size data not loaded. Please refresh the page.</p>
          </div>
        `;
      }
      
      // Get room attributes from ROOM_SIZES
      const roomData = getRoomAttributes(roomCode);
      console.log('Found roomData:', roomData ? 'Yes' : 'No', roomData ? roomData.id : 'null');
      
      // Get all equipment for this room code (don't filter by dept/FA since equipment is same across instances)
      const allMappings = getEquipmentMappings();
      console.log('Total equipment mappings available:', allMappings.length);
      const roomEquipment = allMappings.filter(re => re.roomCode === roomCode);
      console.log('Found equipment mappings for', roomCode, ':', roomEquipment.length);
      if (roomEquipment.length > 0) {
        console.log('Sample equipment mapping:', roomEquipment[0]);
        console.log('First 5 JSNs:', roomEquipment.slice(0, 5).map(re => re.jsn));
      }

      let html = `
        <div class="detail-panel">
          <h3>üö™ ${roomCode}${roomData?.source === 'finish_data' ? ' (Legacy)' : ''} - ${roomName}</h3>
          ${renderReadOnlyAttribute('Room Code', roomCode + (roomData?.source === 'finish_data' ? ' (Legacy)' : '') + (window.VARF_TO_LEGACY?.get(roomCode) ? ` [Legacy: ${window.VARF_TO_LEGACY.get(roomCode)}]` : '') + (window.LEGACY_TO_VARF?.get(roomCode) ? ` [VARF: ${window.LEGACY_TO_VARF.get(roomCode)}]` : ''))}
          ${renderReadOnlyAttribute('Department', department)}
          ${renderReadOnlyAttribute('Functional Area', functionalArea)}
          ${renderReadOnlyAttribute('NSF', roomData?.nsf ? roomData.nsf + ' SF' : 'Not specified')}
          ${renderReadOnlyAttribute('Equipment Items', roomEquipment.length)}
        </div>
        <div class="detail-panel">
          <p style="color: var(--muted); font-size: 0.9rem; margin-bottom: 12px;">
            üìö Reference mode - read-only view. Switch to Program Mode and import this room to edit.
          </p>
        </div>
      `;

      // Room Attributes - show in compact multi-column layout with ALL available attributes
      if (roomData) {
        html += `
          <div class="detail-panel">
            <h3>üìã Attributes</h3>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; font-size: 0.75rem;">
              
              <!-- Column 1: Materials & Finishes -->
              <div>
                <h4 style="margin: 0 0 4px 0; font-size: 0.75rem; color: var(--muted); font-weight: 600;">üèóÔ∏è Materials & Finishes</h4>
                ${renderReadOnlyAttribute('Ceiling Mat', roomData.ceilingMaterial)}
                ${renderReadOnlyAttribute('Ceiling Alt', roomData.ceilingMaterialAlternate)}
                ${renderReadOnlyAttribute('Ceiling Finish', roomData.ceilingFinish)}
                ${renderReadOnlyAttribute('Ceiling Cat', roomData.ceilingCategory)}
                ${renderReadOnlyAttribute('Wall Mat', roomData.wallMaterial)}
                ${renderReadOnlyAttribute('Wall Alt', roomData.wallMaterialAlternate)}
                ${renderReadOnlyAttribute('Wall Finish', roomData.wallFinish)}
                ${renderReadOnlyAttribute('Wall Finish Alt', roomData.wallFinishAlternate)}
                ${renderReadOnlyAttribute('Floor Mat', roomData.floorMaterial)}
                ${renderReadOnlyAttribute('Floor Alt', roomData.floorMaterialAlternate)}
                ${renderReadOnlyAttribute('Floor Base', roomData.floorBaseMaterial)}
                ${renderReadOnlyAttribute('Floor Base Alt', roomData.floorBaseMaterialAlternate)}
                ${renderReadOnlyAttribute('Wain', roomData.wain)}
              </div>
              
              <!-- Column 2: Door & Environmental -->
              <div>
                <h4 style="margin: 0 0 4px 0; font-size: 0.75rem; color: var(--muted); font-weight: 600;">üö™ Door</h4>
                ${renderReadOnlyAttribute('Door Mat', roomData.doorMaterial)}
                ${renderReadOnlyAttribute('Door Height', roomData.doorHeight)}
                ${renderReadOnlyAttribute('Door Width', roomData.doorWidth)}
                ${renderReadOnlyAttribute('Door Function', roomData.doorFunction)}
                ${renderReadOnlyAttribute('Door Hardware', roomData.doorHardware)}
                ${renderReadOnlyAttribute('Door Type', roomData.doorType)}
                ${renderReadOnlyAttribute('Door Rating', roomData.doorRating)}
                ${renderReadOnlyAttribute('Door Notes', roomData.doorNotes)}
                
                <h4 style="margin: 8px 0 4px 0; font-size: 0.75rem; color: var(--muted); font-weight: 600;">üí° Light/Sound</h4>
                ${renderReadOnlyAttribute('Lighting Lvl', roomData.lightingLevel)}
                ${renderReadOnlyAttribute('Acoustical', roomData.acousticalCriteria)}
                ${renderReadOnlyAttribute('Max NC', roomData.maxNoiseLevelNc)}
                ${renderReadOnlyAttribute('Floor Load', roomData.floorLiveLoad)}
              </div>
              
              <!-- Column 3: HVAC -->
              <div>
                <h4 style="margin: 0 0 4px 0; font-size: 0.75rem; color: var(--muted); font-weight: 600;">‚ùÑÔ∏è HVAC</h4>
                ${renderReadOnlyAttribute('Total ACH', roomData.minTotalAch)}
                ${renderReadOnlyAttribute('OA ACH', roomData.minOaAch)}
                ${renderReadOnlyAttribute('Unocc ACH', roomData.unoccupiedAch)}
                ${renderReadOnlyAttribute('Air Balance', roomData.roomAirBalance)}
                ${renderReadOnlyAttribute('Room Air', roomData.roomAir)}
                ${renderReadOnlyAttribute('HEPA Filter', roomData.airHasHepaFiltration)}
                ${renderReadOnlyAttribute('100% Exhaust', roomData.exhaustIs100Outside)}
                ${renderReadOnlyAttribute('Cool Temp', roomData.indoorTempCoolingC ? roomData.indoorTempCoolingC + '¬∞C' : null)}
                ${renderReadOnlyAttribute('Heat Temp', roomData.indoorTempHeatingC ? roomData.indoorTempHeatingC + '¬∞C' : null)}
                ${renderReadOnlyAttribute('RH Max', roomData.indoorRelativeHumidityRhMax ? roomData.indoorRelativeHumidityRhMax + '%' : null)}
                ${renderReadOnlyAttribute('RH Min', roomData.indoorRelativeHumidityRhMin ? roomData.indoorRelativeHumidityRhMin + '%' : null)}
                ${renderReadOnlyAttribute('Temp Ctrl', roomData.individualRoomControlTemp)}
                ${renderReadOnlyAttribute('Flow Ctrl', roomData.individualRoomControlFlow)}
              </div>
              
              <!-- Column 4: Medical Gases & Services -->
              <div>
                <h4 style="margin: 0 0 4px 0; font-size: 0.75rem; color: var(--muted); font-weight: 600;">üîß Medical Gases</h4>
                ${renderReadOnlyAttribute('Med Air', roomData.medAir)}
                ${renderReadOnlyAttribute('Med Vac', roomData.medVac)}
                ${renderReadOnlyAttribute('O‚ÇÇ', roomData.oxygen)}
                ${renderReadOnlyAttribute('N‚ÇÇ', roomData.nitrogen)}
                ${renderReadOnlyAttribute('N‚ÇÇO', roomData.nitrousOxide)}
                ${renderReadOnlyAttribute('WAGD', roomData.wagd)}
                ${renderReadOnlyAttribute('CO‚ÇÇ', roomData.co2)}
                ${renderReadOnlyAttribute('Inst Air', roomData.instAir)}
                ${renderReadOnlyAttribute('Lab Air', roomData.labAir)}
                ${renderReadOnlyAttribute('Lab Vac', roomData.labVac)}
                ${renderReadOnlyAttribute('Lab Gas', roomData.labNaturalGas)}
                ${renderReadOnlyAttribute('Dental Air', roomData.dentalAir)}
                ${renderReadOnlyAttribute('Dental Vac', roomData.dentalVac)}
                ${renderReadOnlyAttribute('Oral Evac', roomData.oralEvac)}
                
                <h4 style="margin: 8px 0 4px 0; font-size: 0.75rem; color: var(--muted); font-weight: 600;">üíß Plumbing</h4>
                ${renderReadOnlyAttribute('Cold Water', roomData.domesticColdWater)}
                ${renderReadOnlyAttribute('Hot Water', roomData.domesticHotWater)}
                ${renderReadOnlyAttribute('Floor Drain', roomData.floorDrain)}
                ${renderReadOnlyAttribute('Nat Gas', roomData.naturalGas)}
              </div>
            </div>
          </div>
        `;
      }

      // Equipment List
      if (roomEquipment.length > 0) {
        html += `
          <div class="detail-panel">
            <h3>üîß Equipment (${roomEquipment.length} items)</h3>
            <div class="equipment-list">
        `;

        const equipmentMap = new Map();
        EQUIPMENT_LIST.forEach(e => equipmentMap.set(e.jsn, e));

        roomEquipment.forEach(re => {
          const eq = equipmentMap.get(re.jsn);
          if (eq) {
            html += `
              <div class="equipment-item">
                <div class="equipment-item-header">
                  <span><span class="jsn-clickable" onclick="event.stopPropagation(); showEquipmentDetail('${eq.jsn}')" title="Click for equipment details">${eq.jsn}</span> - ${eq.name} - <span class="equipment-item-desc${eq.description && eq.description.length > 100 ? ' truncated' : ''}">${eq.description || ''}</span>${eq.description && eq.description.length > 100 ? '<span class="equipment-desc-toggle" onclick="toggleEquipmentDesc(this)">more</span>' : ''}</span>
                  <span>Qty: ${re.quantity} | ${eq.acqIns}</span>
                </div>
              </div>
            `;
          }
        });

        html += `
            </div>
          </div>
        `;
      }

      return html;
    }

    function handleDriverChange(driverId, value, type) {
      const existingIndex = driverValues.findIndex(
        d => d.projectId === PROJECT.id && d.driverId === driverId
      );

      let finalValue = value;
      if (type === "number") {
        finalValue = value === "" ? "" : Number(value);
      } else if (type === "boolean") {
        finalValue = value === "true";
      }

      const newEntry = {
        projectId: PROJECT.id,
        driverId: driverId,
        value: finalValue
      };

      if (existingIndex === -1) {
        driverValues = driverValues.concat(newEntry);
      } else {
        const copy = driverValues.slice();
        copy[existingIndex] = newEntry;
        driverValues = copy;
      }

      renderAll();
    }

    // -----------------------------
    // RENDER FUNCTIONS
    // -----------------------------

    // Debounce utility to prevent excessive re-renders
    function debounce(func, wait) {
      let timeout;
      return function executedFunction(...args) {
        const later = () => {
          clearTimeout(timeout);
          func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
      };
    }

    function renderAll() {
      renderTree();
      renderDetail();
      
      // Render compare mode panels if in compare mode
      if (currentMode === 'compare') {
        renderCompareMode();
      }
    }

    function renderCompareMode() {
      const detailView = document.getElementById('detail-view');
      const compareView = document.getElementById('compare-view');
      
      console.log('renderCompareMode called');
      console.log('compareLeftRoom:', compareLeftRoom);
      console.log('compareRightRoom:', compareRightRoom);
      
      // Left column in detail-view
      let leftHtml = `
        <div class="compare-column" id="compare-left-col" ondrop="handleCompareDrop(event, 'left')" ondragover="handleCompareDragOver(event)" ondragleave="handleCompareDragLeave(event)">
          <h3>Room Comparison - Left Side</h3>
          <input type="text" class="compare-search" id="compare-left-search" placeholder="Search room code or name..." oninput="searchCompareRoom('left')">
          <div id="compare-left-results"></div>
          <div id="compare-left-display">
      `;
      
      if (compareLeftRoom) {
        console.log('Rendering left room:', compareLeftRoom.room.code);
        leftHtml += renderRoomComparison(compareLeftRoom);
      } else {
        leftHtml += `<p style="color: var(--muted); text-align: center; padding: 40px 0;">Drag a room here or search to compare</p>`;
      }
      
      leftHtml += `
          </div>
        </div>
      `;
      
      detailView.innerHTML = leftHtml;
      
      // Right column in compare-view
      let rightHtml = `
        <div class="compare-column" id="compare-right-col" ondrop="handleCompareDrop(event, 'right')" ondragover="handleCompareDragOver(event)" ondragleave="handleCompareDragLeave(event)">
          <h3>Room Comparison - Right Side</h3>
          <input type="text" class="compare-search" id="compare-right-search" placeholder="Search room code or name..." oninput="searchCompareRoom('right')">
          <div id="compare-right-results"></div>
          <div id="compare-right-display">
      `;
      
      if (compareRightRoom) {
        console.log('Rendering right room:', compareRightRoom.room.code);
        rightHtml += renderRoomComparison(compareRightRoom);
      } else {
        rightHtml += `<p style="color: var(--muted); text-align: center; padding: 40px 0;">Drag a room here or search to compare</p>`;
      }
      
      rightHtml += `
          </div>
        </div>
      `;
      
      console.log('Setting compareView innerHTML');
      compareView.innerHTML = rightHtml;
    }

    function renderRoomComparison(roomData) {
      const { room, fa, dept } = roomData;
      const equipCount = room.equipment ? room.equipment.length : 0;
      const totalNSF = room.nsf || 0;
      
      let html = `
        <div class="compare-room-display">
          <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 16px;">
            <h4>${room.code} - ${room.name}</h4>
            <button onclick="clearCompareRoom('${roomData.side}')" style="background: var(--pill-inactive); border: none; color: var(--text); padding: 4px 8px; border-radius: 4px; cursor: pointer;">‚úï</button>
          </div>
          <div class="detail-row">
            <div class="detail-label">Department:</div>
            <div class="detail-value">${dept.name}</div>
          </div>
          <div class="detail-row">
            <div class="detail-label">Functional Area:</div>
            <div class="detail-value">${fa.name}</div>
          </div>
          <div class="detail-row">
            <div class="detail-label">NSF:</div>
            <div class="detail-value">${totalNSF.toLocaleString()} SF</div>
          </div>
          <div class="detail-row">
            <div class="detail-label">Equipment Items:</div>
            <div class="detail-value">${equipCount}</div>
          </div>
      `;
      
      // Attributes
      if (room.attributes && Object.keys(room.attributes).length > 0) {
        html += `<h4 style="margin-top: 20px; margin-bottom: 12px; font-size: 0.95rem;">Attributes</h4>`;
        Object.entries(room.attributes).forEach(([key, value]) => {
          html += `
            <div class="detail-row">
              <div class="detail-label">${key}:</div>
              <div class="detail-value">${value}</div>
            </div>
          `;
        });
      }
      
      // Equipment
      if (room.equipment && room.equipment.length > 0) {
        html += `<h4 style="margin-top: 20px; margin-bottom: 12px; font-size: 0.95rem;">Equipment (${room.equipment.length})</h4>`;
        room.equipment.forEach(eq => {
          const hasLongDesc = eq.description && eq.description.length > 100;
          html += `
            <div style="padding: 8px; margin-bottom: 8px; background: var(--bg-secondary); border-radius: 4px;">
              <div style="font-weight: 600; margin-bottom: 4px;"><span class="jsn-clickable" onclick="event.stopPropagation(); showEquipmentDetail('${eq.jsn}')" title="Click for equipment details">${eq.jsn}</span> - ${eq.name} - <span class="equipment-item-desc${hasLongDesc ? ' truncated' : ''}" style="font-size: 0.8rem; color: var(--muted);">${eq.description || ''}</span>${hasLongDesc ? '<span class="equipment-desc-toggle" onclick="toggleEquipmentDesc(this)">more</span>' : ''}</div>
              <div style="font-size: 0.85rem; color: var(--muted);">Qty: ${eq.quantity} | ${eq.acqIns}</div>
            </div>
          `;
        });
      }
      
      html += `
        </div>
      `;
      
      return html;
    }

    function handleRoomDragStart(event, nodeId) {
      // Store the room code for the drop event (use reference data in compare mode)
      const treeData = buildTreeData();
      const node = findNodeById(treeData, nodeId);
      if (node) {
        // In compare mode, use roomCode; in program mode, use room.id
        if (currentMode === 'compare' && node.roomCode) {
          event.dataTransfer.setData('text/plain', node.roomCode);
        } else if (node.room) {
          event.dataTransfer.setData('text/plain', node.room.id);
        }
        event.dataTransfer.effectAllowed = 'copy';
      }
    }

    function handleCompareDragOver(event) {
      event.preventDefault();
      event.currentTarget.classList.add('drag-over');
    }

    function handleCompareDragLeave(event) {
      event.currentTarget.classList.remove('drag-over');
    }

    function handleCompareDrop(event, side) {
      event.preventDefault();
      event.currentTarget.classList.remove('drag-over');
      
      // Get room code from drag event
      const roomCode = event.dataTransfer.getData('text/plain');
      if (!roomCode) return;
      
      console.log('Drop received for room code:', roomCode);
      
      // Get metadata for this room code
      const metadata = window.ROOM_METADATA ? window.ROOM_METADATA.get(roomCode) : null;
      if (!metadata) {
        console.error('No metadata found for room code:', roomCode);
        return;
      }
      
      console.log('Found metadata:', metadata);
      
      const roomSize = ROOM_SIZES.find(r => r.id === roomCode);
      if (!roomSize) {
        console.error('No room size found for room code:', roomCode);
        return;
      }
      
      // Build room object from reference data
      const room = {
        code: roomCode,
        name: roomSize.name || metadata.roomName || roomCode,
        nsf: roomSize.nsf || 0,
        attributes: {},
        equipment: []
      };
      
      // Add attributes from ROOM_SIZES (all properties except id, name, nsf)
      Object.keys(roomSize).forEach(key => {
        if (key !== 'id' && key !== 'name' && key !== 'nsf' && roomSize[key] !== null) {
          room.attributes[key] = roomSize[key];
        }
      });
      
      // Add equipment (deduplicate by JSN)
      const equipForRoom = ROOM_EQUIPMENT_MAPPINGS.filter(m => m.roomCode === roomCode);
      const seenJSNs = new Set();
      equipForRoom.forEach(eq => {
        // Skip if we've already added this JSN
        if (seenJSNs.has(eq.jsn)) return;
        seenJSNs.add(eq.jsn);
        
        const equipDetail = EQUIPMENT_LIST.find(e => e.jsn === eq.jsn);
        if (equipDetail) {
          room.equipment.push({
            jsn: eq.jsn,
            name: equipDetail.name,
            quantity: eq.qty || eq.quantity || 1,
            acqIns: equipDetail.acqIns,
            description: equipDetail.description
          });
        }
      });
      
      const dept = { name: metadata.department };
      const fa = { name: metadata.functionalArea };
      
      console.log('Built room data:', { room, fa, dept });
      
      if (side === 'left') {
        compareLeftRoom = { room, fa, dept, side: 'left' };
      } else if (side === 'right') {
        compareRightRoom = { room, fa, dept, side: 'right' };
      }
      
      console.log('Rendering compare mode after drop');
      renderCompareMode();
    }

    function clearCompareRoom(side) {
      if (side === 'left') {
        compareLeftRoom = null;
      } else if (side === 'right') {
        compareRightRoom = null;
      }
      renderCompareMode();
    }

    function searchCompareRoom(side) {
      const searchInput = document.getElementById(`compare-${side}-search`);
      const resultsDiv = document.getElementById(`compare-${side}-results`);
      const query = searchInput.value.toLowerCase().trim();
      
      if (!query) {
        resultsDiv.innerHTML = '';
        return;
      }
      
      const matches = [];
      const seenRooms = new Set();
      
      // Search reference data
      ROOM_EQUIPMENT_MAPPINGS.forEach(mapping => {
        if (seenRooms.has(mapping.roomCode)) return;
        
        const roomSize = ROOM_SIZES[mapping.roomCode];
        if (!roomSize) return;
        
        const roomName = roomSize['Room Name'] || mapping.roomCode;
        
        if (mapping.roomCode.toLowerCase().includes(query) || roomName.toLowerCase().includes(query)) {
          seenRooms.add(mapping.roomCode);
          matches.push({
            roomCode: mapping.roomCode,
            roomName: roomName,
            deptName: mapping.department,
            faName: mapping.functionalArea
          });
        }
      });
      
      let html = '';
      if (matches.length > 0) {
        html = '<div style="background: var(--bg); border: 1px solid var(--border); border-radius: 4px; margin-bottom: 12px; max-height: 200px; overflow-y: auto;">';
        matches.forEach(match => {
          html += `
            <div onclick="selectCompareRoom('${match.roomCode}', '${side}')" style="padding: 8px; cursor: pointer; border-bottom: 1px solid var(--border); transition: background 0.2s;" onmouseover="this.style.background='var(--bg-secondary)'" onmouseout="this.style.background='transparent'">
              <div style="font-weight: 600;">${match.roomCode} - ${match.roomName}</div>
              <div style="font-size: 0.85rem; color: var(--muted);">${match.deptName} ‚Üí ${match.faName}</div>
            </div>
          `;
        });
        html += '</div>';
      } else {
        html = '<p style="color: var(--muted); font-size: 0.85rem; margin-bottom: 12px;">No matching rooms found</p>';
      }
      
      resultsDiv.innerHTML = html;
    }

    function selectCompareRoom(roomCode, side) {
      // Get metadata for this room code
      const metadata = window.ROOM_METADATA ? window.ROOM_METADATA.get(roomCode) : null;
      if (!metadata) return;
      
      const roomSize = ROOM_SIZES.find(r => r.id === roomCode);
      if (!roomSize) return;
      
      // Build room object from reference data
      const room = {
        code: roomCode,
        name: roomSize.name || metadata.roomName || roomCode,
        nsf: roomSize.nsf || 0,
        attributes: {},
        equipment: []
      };
      
      // Add attributes from ROOM_SIZES (all properties except id, name, nsf)
      Object.keys(roomSize).forEach(key => {
        if (key !== 'id' && key !== 'name' && key !== 'nsf' && roomSize[key] !== null) {
          room.attributes[key] = roomSize[key];
        }
      });
      
      // Add equipment (deduplicate by JSN)
      const equipForRoom = ROOM_EQUIPMENT_MAPPINGS.filter(m => m.roomCode === roomCode);
      const seenJSNs = new Set();
      equipForRoom.forEach(eq => {
        // Skip if we've already added this JSN
        if (seenJSNs.has(eq.jsn)) return;
        seenJSNs.add(eq.jsn);
        
        const equipDetail = EQUIPMENT_LIST.find(e => e.jsn === eq.jsn);
        if (equipDetail) {
          room.equipment.push({
            jsn: eq.jsn,
            name: equipDetail.name,
            quantity: eq.qty || eq.quantity || 1,
            acqIns: equipDetail.acqIns,
            description: equipDetail.description
          });
        }
      });
      
      const dept = { name: metadata.department };
      const fa = { name: metadata.functionalArea };
      
      if (side === 'left') {
        compareLeftRoom = { room, fa, dept, side: 'left' };
      } else if (side === 'right') {
        compareRightRoom = { room, fa, dept, side: 'right' };
      }
      
      // Clear search
      document.getElementById(`compare-${side}-search`).value = '';
      document.getElementById(`compare-${side}-results`).innerHTML = '';
      renderCompareMode();
    }

    // Debounced version for input handlers
    const debouncedRenderAll = debounce(renderAll, 150);

    // -----------------------------
    // EVENT HANDLERS
    // -----------------------------

    // -----------------------------
    // IMPORT MODAL FUNCTIONS
    // -----------------------------

    let selectedImportItems = new Set();
    let expandedImportNodes = new Set();

    // Cache the department/FA structure to avoid rebuilding on every render
    let cachedDeptMap = null;
    function getDeptMap() {
      if (!cachedDeptMap) {
        cachedDeptMap = new Map();
        const mappings = window.ROOM_EQUIPMENT_MAPPINGS || [];
        mappings.forEach(mapping => {
          if (!cachedDeptMap.has(mapping.department)) {
            cachedDeptMap.set(mapping.department, new Map());
          }
          const faMap = cachedDeptMap.get(mapping.department);
          if (!faMap.has(mapping.functionalArea)) {
            faMap.set(mapping.functionalArea, new Set());
          }
          faMap.get(mapping.functionalArea).add(mapping.roomCode);
        });
      }
      return cachedDeptMap;
    }

    function openImportModal() {
      document.getElementById('import-modal').classList.add('active');
      document.getElementById('import-search').value = '';
      renderImportTree();
      setTimeout(() => document.getElementById('import-search').focus(), 100);
    }

    function closeImportModal() {
      document.getElementById('import-modal').classList.remove('active');
      selectedImportItems.clear();
    }

    // Room Logic Functions
    let currentLogicDepartment = null;
    let currentLogicInputs = {};
    let departmentLogicToggles = new Map(); // Track which departments have logic enabled

    function checkDepartmentHasLogic(departmentName) {
      if (!window.RoomLogic) return false;
      
      // Map department names to chapter IDs
      // Department names come from Equipment_Guide_parsed_v2.txt format: "100 (NAME)"
      // Extract chapter ID from department name (first 3 digits)
      const match = departmentName.match(/^(\d{3})/);
      if (!match) return false;
      
      const chapterId = match[1];
      const chapter = window.RoomLogic.getChapter(chapterId);
      return chapter !== null;
    }

    function getDepartmentChapterId(departmentName) {
      // Extract chapter ID from department name (first 3 digits)
      // Department names are in format: "XXX (DEPARTMENT NAME)"
      const match = departmentName.match(/^(\d{3})/);
      return match ? match[1] : null;
    }

    function showAvailableLogicDepartments() {
      if (!window.RoomLogic) {
        alert('Room logic system not loaded!');
        return;
      }
      
      const chapters = window.RoomLogic.getAllChapters();
      
      let html = `
        <div style="margin-bottom: 16px;">
          <h3 style="margin-bottom: 12px;">Departments with Automated Logic</h3>
          <p class="muted" style="margin-bottom: 16px;">These departments have automated room calculation based on your inputs.</p>
        </div>
      `;
      
      chapters.forEach(chapter => {
        html += `
          <div style="background: var(--bg-card); border: 1px solid var(--border); border-radius: 8px; padding: 16px; margin-bottom: 12px; cursor: pointer; transition: all 0.2s;" 
               onmouseover="this.style.borderColor='var(--accent)'" 
               onmouseout="this.style.borderColor='var(--border)'"
               onclick="openDepartmentLogicWorkflowById('${chapter.id}')">
            <div style="display: flex; align-items: center; gap: 12px;">
              <span class="logic-badge enabled">‚ö° LOGIC</span>
              <div style="flex: 1;">
                <h4 style="margin-bottom: 4px;">Chapter ${chapter.id}: ${chapter.name}</h4>
                <p class="muted" style="font-size: 0.85rem;">${chapter.description}</p>
                ${chapter.status ? `<p style="font-size: 0.8rem; margin-top: 6px; color: #856404; background: #fff3cd; padding: 6px 10px; border-radius: 4px; display: inline-block;">${chapter.status}</p>` : ''}
                <p class="muted" style="font-size: 0.75rem; margin-top: 4px;">${chapter.inputCount} inputs required ‚Ä¢ ${chapter.functionalAreaCount} functional areas</p>
              </div>
              <button class="btn-primary" style="padding: 6px 12px; font-size: 0.85rem;">Configure ‚Üí</button>
            </div>
          </div>
        `;
      });
      
      document.getElementById('logic-modal-content').innerHTML = html;
      document.getElementById('logic-modal-title').textContent = 'Add Department with Room Logic';
      document.getElementById('calculate-rooms-btn').style.display = 'none';
      document.getElementById('department-logic-modal').classList.add('active');
      closeImportModal();
    }

    function toggleDepartmentLogic(departmentName, enabled) {
      departmentLogicToggles.set(departmentName, enabled);
      renderImportTree(); // Re-render to update badge
    }

    function openDepartmentLogicWorkflow(departmentName) {
      const chapterId = getDepartmentChapterId(departmentName);
      if (chapterId) {
        openDepartmentLogicWorkflowById(chapterId);
      }
    }

    function openDepartmentLogicWorkflowById(chapterId) {
      if (!window.RoomLogic) {
        alert('Room logic system not loaded!');
        return;
      }
      
      const chapter = window.RoomLogic.getChapter(chapterId);
      if (!chapter) {
        alert(`Chapter ${chapterId} not found!`);
        return;
      }
      
      currentLogicDepartment = chapter;
      currentLogicInputs = {};
      
      // Initialize default values
      chapter.inputs.forEach(input => {
        currentLogicInputs[input.id] = input.defaultValue || (input.min || 0);
      });
      
      let html = `
        <div style="margin-bottom: 20px;">
          <h3 style="margin-bottom: 8px;">Chapter ${chapter.chapter}: ${chapter.name}</h3>
          <p class="muted">${chapter.description}</p>
          ${chapter.status ? `<div style="margin-top: 12px; padding: 12px; background: #fff3cd; border-left: 4px solid #ffc107; border-radius: 4px; font-size: 0.9rem;">${chapter.status}</div>` : ''}
        </div>
        
        <div class="input-modal">
          <h4 style="margin-bottom: 16px; color: var(--accent);">Project Inputs</h4>
      `;
      
      chapter.inputs.forEach(input => {
        html += `
          <div class="input-field">
            <label for="input-${input.id}">${input.label}</label>
            <input type="${input.type}" 
                   id="input-${input.id}" 
                   ${input.min !== undefined ? `min="${input.min}"` : ''}
                   ${input.max !== undefined ? `max="${input.max}"` : ''}
                   value="${currentLogicInputs[input.id]}"
                   onchange="updateLogicInput('${input.id}', this.value)"
                   style="width: 100%;">
            ${input.helpText ? `<div class="help-text">${input.helpText}</div>` : ''}
          </div>
        `;
      });
      
      html += `
        </div>
        
        <div id="preview-results" style="margin-top: 20px; display: none;">
          <div class="calculation-result">
            <h4>üìä Calculation Preview</h4>
            <div id="preview-content" class="calculation-summary"></div>
          </div>
        </div>
      `;
      
      document.getElementById('logic-modal-content').innerHTML = html;
      document.getElementById('logic-modal-title').textContent = `Add ${chapter.name}`;
      document.getElementById('calculate-rooms-btn').style.display = 'block';
      document.getElementById('department-logic-modal').classList.add('active');
      closeImportModal();
      
      // Show initial preview
      updateCalculationPreview();
    }

    function updateLogicInput(inputId, value) {
      currentLogicInputs[inputId] = parseFloat(value) || 0;
      updateCalculationPreview();
    }

    function updateCalculationPreview() {
      if (!currentLogicDepartment) return;
      
      // Validate inputs against min/max
      let validationError = null;
      for (const input of currentLogicDepartment.inputs) {
        const value = currentLogicInputs[input.id];
        if (input.min !== undefined && value < input.min) {
          validationError = `${input.label}: Value must be at least ${input.min} (you entered ${value})`;
          break;
        }
        if (input.max !== undefined && value > input.max) {
          validationError = `${input.label}: Value must be at most ${input.max} (you entered ${value})`;
          break;
        }
      }
      
      if (validationError) {
        document.getElementById('preview-content').innerHTML = 
          `<p style="color: #ff6b6b;"><strong>‚ö†Ô∏è Validation Error:</strong> ${validationError}</p>`;
        document.getElementById('preview-results').style.display = 'block';
        document.getElementById('calculate-rooms-btn').disabled = true;
        return;
      }
      
      try {
        const results = window.RoomLogic.evaluateChapter(currentLogicDepartment, currentLogicInputs);
        
        let html = '';
        
        if (results.totalRooms === 0) {
          html = `<p style="color: #ff6b6b;"><strong>‚ö†Ô∏è No rooms calculated:</strong> Your input values may be outside the valid range or don't match any calculation rules.</p>`;
          document.getElementById('calculate-rooms-btn').disabled = true;
        } else {
          html = `
            <p><strong>Total Rooms:</strong> ${results.totalRooms}</p>
            <p><strong>Total NSF:</strong> ${results.totalNSF.toLocaleString()} sq ft</p>
            <p><strong>Functional Areas:</strong> ${results.functionalAreas.length}</p>
          `;
          document.getElementById('calculate-rooms-btn').disabled = false;
        }
        
        if (results.errors.length > 0) {
          html += `<p style="color: #ff6b6b; margin-top: 8px;"><strong>‚ö†Ô∏è Errors:</strong> ${results.errors[0].message}</p>`;
          document.getElementById('calculate-rooms-btn').disabled = true;
        }
        
        document.getElementById('preview-content').innerHTML = html;
        document.getElementById('preview-results').style.display = 'block';
      } catch (error) {
        console.error('Preview error:', error);
        document.getElementById('preview-content').innerHTML = 
          `<p style="color: #ff6b6b;"><strong>‚ö†Ô∏è Calculation Error:</strong> ${error.message}</p>`;
        document.getElementById('preview-results').style.display = 'block';
        document.getElementById('calculate-rooms-btn').disabled = true;
      }
    }

    function calculateAndAddDepartment() {
      if (!currentLogicDepartment) return;
      
      try {
        const results = window.RoomLogic.evaluateChapter(currentLogicDepartment, currentLogicInputs);
        
        if (results.errors.length > 0) {
          alert(`Calculation errors:\n${results.errors.map(e => e.message).join('\n')}`);
          return;
        }
        
        // Helper function to get equipment for a room code
        function getEquipmentForRoomCode(roomCode) {
          const equipment = [];
          
          // Try multiple sources for equipment data
          const mappings = window.ROOM_EQUIPMENT_MAPPINGS || 
                          (typeof ROOM_EQUIPMENT_MAPPINGS !== 'undefined' ? ROOM_EQUIPMENT_MAPPINGS : []);
          const equipList = window.EQUIPMENT_LIST || 
                           (typeof EQUIPMENT_LIST !== 'undefined' ? EQUIPMENT_LIST : []);
          
          if (mappings.length === 0 || equipList.length === 0) {
            console.warn('Equipment data not loaded:', { 
              mappingsCount: mappings.length, 
              equipListCount: equipList.length,
              roomCode 
            });
            return [];
          }
          
          const equipForRoom = mappings.filter(m => m.roomCode === roomCode);
          console.log(`Found ${equipForRoom.length} equipment items for room ${roomCode}`);
          
          equipForRoom.forEach(eq => {
            const equipDetail = equipList.find(e => e.jsn === eq.jsn || e.jsn === eq.equipmentJsn);
            if (equipDetail) {
              equipment.push({
                jsn: eq.jsn || eq.equipmentJsn,
                name: equipDetail.name,
                quantity: eq.qty || eq.quantity || 1,
                acqIns: equipDetail.acqIns || eq.acqIns,
                description: equipDetail.description
              });
            } else {
              console.warn(`Equipment detail not found for JSN: ${eq.jsn || eq.equipmentJsn}`);
            }
          });
          
          return equipment;
        }
        
        // Convert results to department structure
        const project = getCurrentProject();
        const newDept = {
          id: generateId(),
          name: currentLogicDepartment.name,
          chapterId: currentLogicDepartment.chapter,
          logicInputs: {...currentLogicInputs},
          functionalAreas: results.functionalAreas.map(fa => ({
            id: generateId(),
            name: fa.name,
            description: fa.description,
            rooms: fa.rooms.filter(r => r.type !== 'calculation').map(room => ({
              id: generateId(),
              code: room.code,
              name: room.name,
              quantity: room.quantity,
              nsf: room.nsfPerRoom,
              totalNSF: room.totalNSF,
              notes: room.notes || '',
              equipment: getEquipmentForRoomCode(room.code),
              logicGenerated: true
            }))
          }))
        };
        
        project.departments.push(newDept);
        saveProjects();
        renderAll();
        closeDepartmentLogicModal();
        
        alert(`‚úÖ Added ${currentLogicDepartment.name}\n\n${results.totalRooms} rooms ‚Ä¢ ${results.totalNSF.toLocaleString()} NSF`);
      } catch (error) {
        console.error('Calculation error:', error);
        alert('Error calculating rooms: ' + error.message);
      }
    }

    function closeDepartmentLogicModal() {
      document.getElementById('department-logic-modal').classList.remove('active');
      currentLogicDepartment = null;
      currentLogicInputs = {};
    }

    function filterImportTree() {
      const searchTerm = document.getElementById('import-search').value.toLowerCase();
      
      if (searchTerm) {
        // Auto-expand all nodes when searching to show matches
        const deptMap = getDeptMap();
        deptMap.forEach((faMap, dept) => {
          const deptMatches = dept.toLowerCase().includes(searchTerm);
          
          faMap.forEach((rooms, fa) => {
            const faMatches = fa.toLowerCase().includes(searchTerm);
            
            rooms.forEach(roomCode => {
              const enrichedMappings = window.ROOM_EQUIPMENT_MAPPINGS || ROOM_EQUIPMENT_MAPPINGS;
              const roomMapping = enrichedMappings.find(
                m => m.department === dept && m.functionalArea === fa && m.roomCode === roomCode
              );
              const roomName = roomMapping ? roomMapping.roomName : roomCode;
              const roomMatches = roomCode.toLowerCase().includes(searchTerm) || 
                                  (roomName && roomName.toLowerCase().includes(searchTerm));
              
              // Expand parent nodes if any child matches
              if (deptMatches || faMatches || roomMatches) {
                expandedImportNodes.add(dept);
                expandedImportNodes.add(`${dept}::${fa}`);
              }
            });
          });
        });
      }
      
      renderImportTree();
    }

    function toggleImportNode(nodeId) {
      if (expandedImportNodes.has(nodeId)) {
        expandedImportNodes.delete(nodeId);
      } else {
        expandedImportNodes.add(nodeId);
      }
      renderImportTree();
    }

    function renderImportTree() {
      const container = document.getElementById('import-tree-container');
      let html = '';

      // Use cached department map
      const deptMap = getDeptMap();
      
      // Get search term
      const searchTerm = document.getElementById('import-search')?.value.toLowerCase() || '';

      // Helper function to check if department should be shown
      function shouldShowDept(dept, faMap) {
        if (!searchTerm) return true;
        if (dept.toLowerCase().includes(searchTerm)) return true;
        
        // Check if any FA or room matches
        for (const [fa, rooms] of faMap.entries()) {
          if (fa.toLowerCase().includes(searchTerm)) return true;
          
          for (const roomCode of rooms) {
            const enrichedMappings = window.ROOM_EQUIPMENT_MAPPINGS || ROOM_EQUIPMENT_MAPPINGS;
            const roomMapping = enrichedMappings.find(
              m => m.department === dept && m.functionalArea === fa && m.roomCode === roomCode
            );
            const roomName = roomMapping ? roomMapping.roomName : roomCode;
            if (roomCode.toLowerCase().includes(searchTerm) || 
                (roomName && roomName.toLowerCase().includes(searchTerm))) {
              return true;
            }
          }
        }
        return false;
      }
      
      // Helper function to check if FA should be shown
      function shouldShowFA(dept, fa, rooms) {
        if (!searchTerm) return true;
        if (fa.toLowerCase().includes(searchTerm)) return true;
        
        for (const roomCode of rooms) {
          const enrichedMappings = window.ROOM_EQUIPMENT_MAPPINGS || ROOM_EQUIPMENT_MAPPINGS;
          const roomMapping = enrichedMappings.find(
            m => m.department === dept && m.functionalArea === fa && m.roomCode === roomCode
          );
          const roomName = roomMapping ? roomMapping.roomName : roomCode;
          if (roomCode.toLowerCase().includes(searchTerm) || 
              (roomName && roomName.toLowerCase().includes(searchTerm))) {
            return true;
          }
        }
        return false;
      }
      
      // Helper function to check if room should be shown
      function shouldShowRoom(dept, fa, roomCode) {
        if (!searchTerm) return true;
        const enrichedMappings = window.ROOM_EQUIPMENT_MAPPINGS || ROOM_EQUIPMENT_MAPPINGS;
        const roomMapping = enrichedMappings.find(
          m => m.department === dept && m.functionalArea === fa && m.roomCode === roomCode
        );
        const roomName = roomMapping ? roomMapping.roomName : roomCode;
        return roomCode.toLowerCase().includes(searchTerm) || 
               (roomName && roomName.toLowerCase().includes(searchTerm));
      }

      // Render unified tree with checkboxes at all levels
      Array.from(deptMap.keys()).sort().forEach(dept => {
        const faMap = deptMap.get(dept);
        
        // Skip if doesn't match search
        if (!shouldShowDept(dept, faMap)) return;
        
        const faCount = faMap.size;
        let totalRooms = 0;
        deptMap.get(dept).forEach(rooms => totalRooms += rooms.size);
        const deptId = `dept-${dept.replace(/[^a-zA-Z0-9]/g, '_')}`;
        const isDeptExpanded = expandedImportNodes.has(deptId);
        
        // Calculate department checkbox state
        const deptState = getCheckboxState(dept, deptMap);
        
        // Check if department has room logic available
        const hasLogic = checkDepartmentHasLogic(dept);
        const logicEnabled = departmentLogicToggles.get(dept) || false;
        const logicBadge = hasLogic 
          ? `<span class="logic-badge ${logicEnabled ? 'enabled' : 'disabled'}">${logicEnabled ? '‚ö° LOGIC' : 'MANUAL'}</span>` 
          : '<span class="logic-badge disabled">MANUAL</span>';
        
        html += `
          <div style="margin-bottom: 8px;">
            <div class="import-tree-item ${hasLogic ? 'has-logic' : 'no-logic'}">
              <span onclick="toggleImportNode('${deptId}')" style="cursor: pointer; margin-right: 4px;">${isDeptExpanded ? '‚ñº' : '‚ñ∂'}</span>
              <input type="checkbox" id="import-${dept}" value="${dept}" 
                ${deptState.checked ? 'checked' : ''}
                ${deptState.indeterminate ? 'data-indeterminate="true"' : ''}
                onchange="toggleImportItem('${dept}', this.checked)">
              <label for="import-${dept}" style="font-weight: 600;">${dept}</label>
              ${logicBadge}
              ${hasLogic ? `<label class="logic-toggle-switch" onclick="event.stopPropagation();">
                <input type="checkbox" ${logicEnabled ? 'checked' : ''} 
                  onchange="toggleDepartmentLogic('${dept.replace(/'/g, "\\'")}', this.checked)">
                <span class="logic-toggle-slider"></span>
              </label>` : ''}
              <span style="font-size: 0.75rem; color: var(--muted); margin-left: 8px;">(${faCount} FAs, ${totalRooms} rooms)</span>
            </div>
            ${isDeptExpanded ? `
              <div style="margin-left: 24px; margin-top: 4px;">
                ${Array.from(deptMap.get(dept).keys()).sort().filter(fa => {
                  return shouldShowFA(dept, fa, deptMap.get(dept).get(fa));
                }).map(fa => {
                  const roomCount = deptMap.get(dept).get(fa).size;
                  const faItemKey = `${dept}::${fa}`;
                  const faId = `fa-${dept.replace(/[^a-zA-Z0-9]/g, '_')}-${fa.replace(/[^a-zA-Z0-9]/g, '_')}`;
                  const isFaExpanded = expandedImportNodes.has(faId);
                  
                  // Calculate FA checkbox state
                  const faState = getFACheckboxState(dept, fa, deptMap);
                  
                  return `
                    <div style="margin-bottom: 4px;">
                      <div class="import-tree-item">
                        <span onclick="toggleImportNode('${faId}')" style="cursor: pointer; margin-right: 4px;">${isFaExpanded ? '‚ñº' : '‚ñ∂'}</span>
                        <input type="checkbox" id="import-${faItemKey.replace(/[^a-zA-Z0-9]/g, '_')}" 
                          value="${faItemKey}" 
                          ${faState.checked ? 'checked' : ''}
                          ${faState.indeterminate ? 'data-indeterminate="true"' : ''}
                          onchange="toggleImportItem('${faItemKey}', this.checked)">
                        <label for="import-${faItemKey.replace(/[^a-zA-Z0-9]/g, '_')}">${fa}</label>
                        <span style="font-size: 0.75rem; color: var(--muted); margin-left: 8px;">(${roomCount} rooms)</span>
                      </div>
                      ${isFaExpanded ? `
                        <div style="margin-left: 24px; margin-top: 2px;">
                          ${Array.from(deptMap.get(dept).get(fa)).sort().filter(roomCode => {
                            return shouldShowRoom(dept, fa, roomCode);
                          }).map(roomCode => {
                            const mappings = window.ROOM_EQUIPMENT_MAPPINGS || [];
                            const roomMapping = mappings.find(m => 
                              m.department === dept && 
                              m.functionalArea === fa && 
                              m.roomCode === roomCode
                            );
                            const roomName = roomMapping ? roomMapping.roomName : roomCode;
                            const roomItemKey = `${dept}::${fa}::${roomCode}`;
                            
                            return `
                              <div class="import-tree-item" style="padding-left: 16px;">
                                <input type="checkbox" id="import-${roomItemKey.replace(/[^a-zA-Z0-9]/g, '_')}" 
                                  value="${roomItemKey}" 
                                  ${selectedImportItems.has(roomItemKey) ? 'checked' : ''}
                                  onchange="toggleImportItem('${roomItemKey}', this.checked)">
                                <label for="import-${roomItemKey.replace(/[^a-zA-Z0-9]/g, '_')}" style="font-size: 0.85rem;">${roomCode} - ${roomName}</label>
                              </div>
                            `;
                          }).join('')}
                        </div>
                      ` : ''}
                    </div>
                  `;
                }).join('')}
              </div>
            ` : ''}
          </div>
        `;
      });

      container.innerHTML = html || `<p class="muted" style="text-align: center; padding: 40px;">${searchTerm ? 'No matching items found' : 'No items available'}</p>`;
      
      // Set indeterminate states after rendering
      document.querySelectorAll('input[data-indeterminate="true"]').forEach(checkbox => {
        checkbox.indeterminate = true;
      });
    }
    
    function getCheckboxState(dept, deptMap) {
      // Check if department itself is selected
      if (selectedImportItems.has(dept)) {
        return { checked: true, indeterminate: false };
      }
      
      // Count selected FAs and rooms under this department
      let totalFAs = 0;
      let selectedFAs = 0;
      let hasSelectedRooms = false;
      
      deptMap.get(dept).forEach((rooms, fa) => {
        totalFAs++;
        const faKey = `${dept}::${fa}`;
        if (selectedImportItems.has(faKey)) {
          selectedFAs++;
        } else {
          // Check if any individual rooms are selected
          rooms.forEach(roomCode => {
            if (selectedImportItems.has(`${dept}::${fa}::${roomCode}`)) {
              hasSelectedRooms = true;
            }
          });
        }
      });
      
      if (selectedFAs === totalFAs) {
        return { checked: true, indeterminate: false };
      } else if (selectedFAs > 0 || hasSelectedRooms) {
        return { checked: false, indeterminate: true };
      }
      return { checked: false, indeterminate: false };
    }
    
    function getFACheckboxState(dept, fa, deptMap) {
      const faKey = `${dept}::${fa}`;
      
      // Check if FA itself is selected
      if (selectedImportItems.has(faKey)) {
        return { checked: true, indeterminate: false };
      }
      
      // Count selected rooms under this FA
      const rooms = deptMap.get(dept).get(fa);
      let selectedRooms = 0;
      
      rooms.forEach(roomCode => {
        if (selectedImportItems.has(`${dept}::${fa}::${roomCode}`)) {
          selectedRooms++;
        }
      });
      
      if (selectedRooms === rooms.size) {
        return { checked: true, indeterminate: false };
      } else if (selectedRooms > 0) {
        return { checked: false, indeterminate: true };
      }
      return { checked: false, indeterminate: false };
    }

    function toggleImportNode(nodeId) {
      if (expandedImportNodes.has(nodeId)) {
        expandedImportNodes.delete(nodeId);
      } else {
        expandedImportNodes.add(nodeId);
      }
      renderImportTree();
    }

    function toggleImportItem(itemKey, checked) {
      const parts = itemKey.split('::');
      const deptMap = getDeptMap();
      
      if (parts.length === 1) {
        // Department level
        const dept = itemKey;
        if (checked) {
          selectedImportItems.add(dept);
          // Add all FAs and rooms under this department
          deptMap.get(dept).forEach((rooms, fa) => {
            selectedImportItems.add(`${dept}::${fa}`);
            rooms.forEach(roomCode => {
              selectedImportItems.add(`${dept}::${fa}::${roomCode}`);
            });
          });
        } else {
          selectedImportItems.delete(dept);
          // Remove all FAs and rooms under this department
          deptMap.get(dept).forEach((rooms, fa) => {
            selectedImportItems.delete(`${dept}::${fa}`);
            rooms.forEach(roomCode => {
              selectedImportItems.delete(`${dept}::${fa}::${roomCode}`);
            });
          });
        }
      } else if (parts.length === 2) {
        // Functional Area level
        const [dept, fa] = parts;
        if (checked) {
          selectedImportItems.add(itemKey);
          // Add all rooms under this FA
          deptMap.get(dept).get(fa).forEach(roomCode => {
            selectedImportItems.add(`${dept}::${fa}::${roomCode}`);
          });
          // Check if all FAs in this dept are now selected
          let allFAsSelected = true;
          deptMap.get(dept).forEach((rooms, faName) => {
            if (!selectedImportItems.has(`${dept}::${faName}`)) {
              allFAsSelected = false;
            }
          });
          if (allFAsSelected) {
            selectedImportItems.add(dept);
          }
        } else {
          selectedImportItems.delete(itemKey);
          selectedImportItems.delete(dept); // Uncheck parent dept
          // Remove all rooms under this FA
          deptMap.get(dept).get(fa).forEach(roomCode => {
            selectedImportItems.delete(`${dept}::${fa}::${roomCode}`);
          });
        }
      } else if (parts.length === 3) {
        // Room level
        const [dept, fa, roomCode] = parts;
        if (checked) {
          selectedImportItems.add(itemKey);
          // Check if all rooms in this FA are now selected
          const rooms = deptMap.get(dept).get(fa);
          let allRoomsSelected = true;
          rooms.forEach(rc => {
            if (!selectedImportItems.has(`${dept}::${fa}::${rc}`)) {
              allRoomsSelected = false;
            }
          });
          if (allRoomsSelected) {
            selectedImportItems.add(`${dept}::${fa}`);
            // Check if all FAs in dept are now selected
            let allFAsSelected = true;
            deptMap.get(dept).forEach((rooms, faName) => {
              if (!selectedImportItems.has(`${dept}::${faName}`)) {
                allFAsSelected = false;
              }
            });
            if (allFAsSelected) {
              selectedImportItems.add(dept);
            }
          }
        } else {
          selectedImportItems.delete(itemKey);
          selectedImportItems.delete(`${dept}::${fa}`); // Uncheck parent FA
          selectedImportItems.delete(dept); // Uncheck parent dept
        }
      }
      
      renderImportTree();
    }

    function confirmImport() {
      if (selectedImportItems.size === 0) {
        alert('Please select at least one item to import');
        return;
      }

      // Collect departments with logic enabled from selected items
      const logicDepartments = [];
      const manualDepartments = [];
      
      selectedImportItems.forEach(itemKey => {
        const parts = itemKey.split('::');
        if (parts.length === 1) {
          const deptName = itemKey;
          if (departmentLogicToggles.get(deptName)) {
            logicDepartments.push(deptName);
          } else {
            manualDepartments.push({ type: 'department', data: itemKey });
          }
        } else if (!departmentLogicToggles.get(parts[0])) {
          // Only add if parent department doesn't have logic enabled
          if (parts.length === 2) {
            manualDepartments.push({ type: 'fa', data: itemKey });
          } else if (parts.length === 3) {
            manualDepartments.push({ type: 'room', data: itemKey });
          }
        }
      });

      // If there are logic departments, collect all inputs first
      if (logicDepartments.length > 0) {
        showCombinedLogicInputDialog(logicDepartments, manualDepartments);
      } else {
        // No logic departments, proceed with normal import
        executeImport([], manualDepartments);
      }
    }

    function showCombinedLogicInputDialog(logicDepartments, manualDepartments) {
      if (!window.RoomLogic) {
        alert('Room logic system not loaded!');
        return;
      }

      // Collect all inputs from all logic departments
      const allInputs = [];
      const chapterMap = new Map();
      
      logicDepartments.forEach(deptName => {
        const chapterId = getDepartmentChapterId(deptName);
        if (chapterId) {
          const chapter = window.RoomLogic.getChapter(chapterId);
          if (chapter) {
            chapterMap.set(deptName, chapter);
            chapter.inputs.forEach(input => {
              allInputs.push({
                deptName,
                chapterId,
                chapterName: chapter.name,
                input
              });
            });
          }
        }
      });

      if (allInputs.length === 0) {
        alert('No logic inputs found for selected departments');
        return;
      }

      // Build combined input dialog
      let html = `
        <div style="margin-bottom: 20px;">
          <h3 style="margin-bottom: 8px;">Room Logic Inputs</h3>
          <p class="muted">Provide inputs for ${logicDepartments.length} department(s) with logic enabled:</p>
        </div>
      `;

      // Group inputs by department
      logicDepartments.forEach(deptName => {
        const chapter = chapterMap.get(deptName);
        if (!chapter) return;

        html += `
          <div class="input-modal" style="margin-bottom: 20px; padding: 16px; background: rgba(255,255,255,0.03); border-radius: 8px;">
            <h4 style="margin-bottom: 12px; color: var(--accent);">‚ö° ${chapter.name}</h4>
        `;

        chapter.inputs.forEach(input => {
          const inputId = `logic-input-${deptName}-${input.id}`.replace(/[^a-zA-Z0-9-]/g, '_');
          const defaultValue = input.defaultValue || input.min || 0;
          
          html += `
            <div class="input-field" style="margin-bottom: 12px;">
              <label for="${inputId}">${input.label}</label>
              <input type="${input.type}" 
                     id="${inputId}" 
                     ${input.min !== undefined ? `min="${input.min}"` : ''}
                     ${input.max !== undefined ? `max="${input.max}"` : ''}
                     value="${defaultValue}"
                     data-dept="${deptName}"
                     data-input-id="${input.id}"
                     style="width: 100%;">
              ${input.helpText ? `<div class="help-text">${input.helpText}</div>` : ''}
            </div>
          `;
        });

        html += `</div>`;
      });

      document.getElementById('logic-modal-content').innerHTML = html;
      document.getElementById('logic-modal-title').textContent = 'Configure Logic Departments';
      document.getElementById('calculate-rooms-btn').style.display = 'block';
      document.getElementById('calculate-rooms-btn').textContent = 'Calculate & Add to Project';
      document.getElementById('calculate-rooms-btn').onclick = () => {
        executeCombinedLogicImport(chapterMap, manualDepartments);
      };
      document.getElementById('department-logic-modal').classList.add('active');
    }

    function executeCombinedLogicImport(chapterMap, manualDepartments) {
      const project = getCurrentProject();
      const mergeMode = document.getElementById('merge-on-import').checked;
      const logicResults = [];

      // Collect inputs and calculate for each logic department
      chapterMap.forEach((chapter, deptName) => {
        const inputs = {};
        
        // Gather input values for this department
        chapter.inputs.forEach(input => {
          const inputId = `logic-input-${deptName}-${input.id}`.replace(/[^a-zA-Z0-9-]/g, '_');
          const element = document.getElementById(inputId);
          if (element) {
            inputs[input.id] = parseFloat(element.value) || 0;
          }
        });

        // Validate inputs
        for (const input of chapter.inputs) {
          const value = inputs[input.id];
          if (input.min !== undefined && value < input.min) {
            alert(`${chapter.name} - ${input.label}: Value must be at least ${input.min} (you entered ${value})`);
            return;
          }
          if (input.max !== undefined && value > input.max) {
            alert(`${chapter.name} - ${input.label}: Value must be at most ${input.max} (you entered ${value})`);
            return;
          }
        }

        try {
          const results = window.RoomLogic.evaluateChapter(chapter, inputs);
          
          if (results.errors.length > 0) {
            alert(`${chapter.name} calculation errors:\n${results.errors.map(e => e.message).join('\n')}`);
            return;
          }

          logicResults.push({
            deptName,
            chapter,
            inputs,
            results
          });
        } catch (error) {
          console.error(`Error calculating ${deptName}:`, error);
          alert(`Error calculating ${chapter.name}: ${error.message}`);
          return;
        }
      });

      // Add all logic departments to project
      logicResults.forEach(({ deptName, chapter, inputs, results }) => {
        const newDept = {
          id: generateId(),
          name: chapter.name,
          chapterId: chapter.chapter,
          logicInputs: {...inputs},
          functionalAreas: results.functionalAreas
            .map(fa => ({
              id: generateId(),
              name: fa.name,
              description: fa.description,
              rooms: fa.rooms.filter(r => r.type !== 'calculation').map(room => ({
                id: generateId(),
                code: room.code,
                name: room.name,
                quantity: room.quantity,
                nsf: room.nsfPerRoom,
                totalNSF: room.totalNSF,
                notes: room.notes || '',
                equipment: [],
                logicGenerated: true
              }))
            }))
            .filter(fa => fa.rooms.length > 0) // Exclude FAs with only calculation rooms
        };
        project.departments.push(newDept);
      });

      // Execute manual imports
      executeImport([], manualDepartments);

      saveProjects();
      closeDepartmentLogicModal();
      closeImportModal();
      renderAll();

      const totalLogicRooms = logicResults.reduce((sum, r) => sum + r.results.totalRooms, 0);
      const totalLogicNSF = logicResults.reduce((sum, r) => sum + r.results.totalNSF, 0);
      
      alert(`‚úÖ Import Complete\n\nLogic Departments: ${logicResults.length}\nRooms: ${totalLogicRooms}\nNSF: ${totalLogicNSF.toLocaleString()}\n\nManual Items: ${manualDepartments.length}`);
    }

    function executeImport(logicDepartments, manualDepartments) {
      const mergeMode = document.getElementById('merge-on-import').checked;
      const project = getCurrentProject();

      manualDepartments.forEach(item => {
        if (item.type === 'department') {
          importDepartment(project, item.data, mergeMode);
        } else if (item.type === 'fa') {
          const [dept, fa] = item.data.split('::');
          importFunctionalArea(project, dept, fa, mergeMode);
        } else if (item.type === 'room') {
          const [dept, fa, roomCode] = item.data.split('::');
          importRoom(project, dept, fa, roomCode, mergeMode);
        }
      });

      saveProjects();
      closeImportModal();
      renderAll();
    }

    function importDepartment(project, deptName, mergeMode) {
      let dept = project.departments.find(d => d.name === deptName);
      
      if (!dept || !mergeMode) {
        dept = {
          id: generateId(),
          name: deptName,
          functionalAreas: []
        };
        project.departments.push(dept);
      }

      // Use ALL_ROOM_INSTANCES to find functional areas and rooms for this department
      const faMap = new Map();
      const allInstances = window.ALL_ROOM_INSTANCES || [];
      allInstances.forEach(instance => {
        if (instance.department === deptName) {
          if (!faMap.has(instance.functionalArea)) {
            faMap.set(instance.functionalArea, new Set());
          }
          faMap.get(instance.functionalArea).add(instance.roomCode);
        }
      });

      faMap.forEach((rooms, faName) => {
        let fa = dept.functionalAreas.find(f => f.name === faName);
        if (!fa || !mergeMode) {
          fa = {
            id: generateId(),
            name: faName,
            rooms: []
          };
          dept.functionalAreas.push(fa);
        }

        // Import all rooms in this functional area
        rooms.forEach(roomCode => {
          importRoomToFA(fa, deptName, faName, roomCode, mergeMode);
        });
      });
    }

    function importFunctionalArea(project, deptName, faName, mergeMode) {
      let dept = project.departments.find(d => d.name === deptName);
      
      if (!dept) {
        dept = {
          id: generateId(),
          name: deptName,
          functionalAreas: []
        };
        project.departments.push(dept);
      }

      let fa = dept.functionalAreas.find(f => f.name === faName);
      if (!fa || !mergeMode) {
        fa = {
          id: generateId(),
          name: faName,
          rooms: []
        };
        dept.functionalAreas.push(fa);
      }

      // Use ALL_ROOM_INSTANCES to find rooms for this dept/FA combination
      const rooms = new Set();
      const allInstances = window.ALL_ROOM_INSTANCES || [];
      allInstances.forEach(instance => {
        if (instance.department === deptName && instance.functionalArea === faName) {
          rooms.add(instance.roomCode);
        }
      });

      rooms.forEach(roomCode => {
        importRoomToFA(fa, deptName, faName, roomCode, mergeMode);
      });
    }

    function importRoom(project, deptName, faName, roomCode, mergeMode) {
      let dept = project.departments.find(d => d.name === deptName);
      
      if (!dept) {
        dept = {
          id: generateId(),
          name: deptName,
          functionalAreas: []
        };
        project.departments.push(dept);
      }

      let fa = dept.functionalAreas.find(f => f.name === faName);
      if (!fa) {
        fa = {
          id: generateId(),
          name: faName,
          rooms: []
        };
        dept.functionalAreas.push(fa);
      }

      importRoomToFA(fa, deptName, faName, roomCode, mergeMode);
    }

    function importRoomToFA(fa, deptName, faName, roomCode, mergeMode) {
      let room = fa.rooms.find(r => r.code === roomCode);
      
      if (!room || !mergeMode) {
        // Look up room name and NSF from ROOM_SIZES
        const roomTemplate = ROOM_SIZES.find(r => r['Room Code'] === roomCode);
        const nsf = roomTemplate ? roomTemplate['NSF'] : 100; // Default 100 NSF if not found
        const roomName = roomTemplate ? roomTemplate['Room Name'] : roomCode;

        room = {
          id: generateId(),
          code: roomCode,
          name: roomName,
          nsf: nsf,
          equipment: []
        };
        fa.rooms.push(room);
      }

      // Import equipment for this room using ROOM_EQUIPMENT lookup (already deduplicated)
      const baseEquipment = window.ROOM_EQUIPMENT ? window.ROOM_EQUIPMENT[roomCode] : [];
      if (baseEquipment && baseEquipment.length > 0) {
        baseEquipment.forEach(eq => {
          const equipExists = room.equipment.some(e => e.jsn === eq.JSN);
          if (!equipExists || !mergeMode) {
            room.equipment.push({
              id: generateId(),
              jsn: eq.JSN,
              name: eq['Equipment Name'],
              quantity: eq['Qty per Room'] || 1,
              acqIns: eq['Acq/Ins'] || '',
              description: eq.Description || ''
            });
          }
        });
      }
    }

    // -----------------------------
    // REPORT GENERATION FUNCTIONS
    // -----------------------------

    function openReportModal() {
      document.getElementById('report-modal').classList.add('active');
      updateReportFormatUI(); // Ensure UI is in sync
    }

    function closeReportModal() {
      document.getElementById('report-modal').classList.remove('active');
    }
    
    function updateReportFormatUI() {
      const format = document.querySelector('input[name="report-format"]:checked').value;
      const pdfOptions = document.getElementById('pdf-report-options');
      const tsvOptions = document.getElementById('tsv-report-options');
      const summaryOption = document.getElementById('pdf-summary-option');
      const generateBtn = document.getElementById('generate-report-btn');
      const pdfLabel = document.getElementById('format-pdf-label');
      const tsvLabel = document.getElementById('format-tsv-label');
      
      if (format === 'pdf') {
        pdfOptions.style.display = 'block';
        tsvOptions.style.display = 'none';
        summaryOption.style.display = 'block';
        generateBtn.textContent = 'üì• Generate PDF';
        generateBtn.onclick = generatePDFReport;
        pdfLabel.style.borderColor = 'var(--accent)';
        tsvLabel.style.borderColor = 'var(--border)';
      } else {
        pdfOptions.style.display = 'none';
        tsvOptions.style.display = 'block';
        summaryOption.style.display = 'none';
        generateBtn.textContent = 'üì• Generate TSV';
        generateBtn.onclick = generateTSVReport;
        pdfLabel.style.borderColor = 'var(--border)';
        tsvLabel.style.borderColor = 'var(--accent)';
      }
    }
    
    function updateTsvTypeUI() {
      const type = document.querySelector('input[name="tsv-type"]:checked').value;
      const simpleLabel = document.getElementById('tsv-simple-label');
      const expandedLabel = document.getElementById('tsv-expanded-label');
      
      simpleLabel.style.borderColor = type === 'simple' ? 'var(--accent)' : 'var(--border)';
      expandedLabel.style.borderColor = type === 'expanded' ? 'var(--accent)' : 'var(--border)';
    }
    
    function generateReport() {
      const format = document.querySelector('input[name="report-format"]:checked').value;
      if (format === 'pdf') {
        generatePDFReport();
      } else {
        generateTSVReport();
      }
    }
    
    function generateTSVReport() {
      const tsvType = document.querySelector('input[name="tsv-type"]:checked').value;
      const project = getCurrentProject();
      
      if (!project) {
        alert('No project selected');
        return;
      }
      
      const rows = [];
      let faCounter = 0; // Track FA numbers within each department
      
      // Row 1: Project name
      rows.push([project.name]);
      rows.push([]); // Spacer row
      
      if (project.departments) {
        project.departments.forEach((dept, deptIdx) => {
          // Department row
          rows.push([dept.name]);
          rows.push([]); // Spacer row
          
          faCounter = 0; // Reset FA counter for each department
          
          if (dept.functionalAreas) {
            dept.functionalAreas.forEach((fa, faIdx) => {
              faCounter++;
              
              // Functional Area row (number - name)
              rows.push([`${faCounter} - ${fa.name}`]);
              rows.push([]); // Spacer row
              
              if (fa.rooms) {
                fa.rooms.forEach((room, roomIdx) => {
                  // Room header row (roomNumber - name - code)
                  if (tsvType === 'simple') {
                    // Simple: Room row then equipment rows with 5 columns
                    const roomTitle = room.roomNumber 
                      ? `${room.roomNumber} - ${room.name} - ${room.code}`
                      : `${room.name} - ${room.code}`;
                    rows.push([roomTitle]);
                    // Column headers under each room
                    rows.push(['JSN', 'Name', 'Qty', 'Acquisition', 'Description']);
                  } else {
                    // Expanded: Room row includes room details
                    const roomData = ROOM_SIZES.find(r => r.roomCode === room.code || r.id === room.code);
                    const roomTitle = room.roomNumber 
                      ? `${room.roomNumber} - ${room.name} - ${room.code}`
                      : `${room.name} - ${room.code}`;
                    rows.push([
                      roomTitle,
                      `NSF: ${room.nsf || roomData?.nsf || 0}`
                    ]);
                    // Column headers under each room - include extended attributes
                    rows.push([
                      'JSN', 'Name', 'Qty', 'Acquisition', 'Description', 'Unit Cost',
                      'Width (in)', 'Depth (in)', 'Height (in)', 'Weight (lbs)',
                      'Volts', 'Amps', 'Watts', 'Phase', 'BTU/Hour'
                    ]);
                  }
                  
                  // Equipment rows
                  if (room.equipment && room.equipment.length > 0) {
                    room.equipment.forEach(equip => {
                      if (tsvType === 'simple') {
                        // Simple: JSN, Name, Qty, Acquisition, Description
                        rows.push([
                          equip.jsn || '',
                          equip.name || '',
                          equip.quantity || 1,
                          equip.acquisitionCode || equip.acqIns || '',
                          equip.description || ''
                        ]);
                      } else {
                        // Expanded: Look up full equipment attributes from EQUIPMENT_ATTRIBUTES
                        const attrs = (typeof EQUIPMENT_ATTRIBUTES !== 'undefined' && equip.jsn) 
                          ? EQUIPMENT_ATTRIBUTES[equip.jsn] 
                          : null;
                        
                        // Get power info
                        const power = attrs?.power || {};
                        // Get dimensions
                        const dims = attrs?.dimensions || {};
                        // Get hertz/BTU info
                        const hertz = attrs?.hertz || {};
                        
                        rows.push([
                          equip.jsn || '',
                          equip.name || '',
                          equip.quantity || 1,
                          equip.acquisitionCode || equip.acqIns || '',
                          equip.description || '',
                          attrs?.meanPrice || '',
                          dims.width || '',
                          dims.depth || '',
                          dims.height || '',
                          dims.weight || '',
                          power.volts || '',
                          power.amps || '',
                          power.watts || '',
                          power.phase || '',
                          hertz.btuPerHour || ''
                        ]);
                      }
                    });
                  }
                  
                  rows.push([]); // Spacer row after each room
                });
              }
            });
          }
        });
      }
      
      // Convert to TSV string
      const tsvContent = rows.map(row => 
        row.map(cell => {
          // Escape tabs and newlines in cell content
          const str = String(cell ?? '');
          if (str.includes('\t') || str.includes('\n') || str.includes('"')) {
            return '"' + str.replace(/"/g, '""') + '"';
          }
          return str;
        }).join('\t')
      ).join('\n');
      
      // Download the file
      const blob = new Blob([tsvContent], { type: 'text/tab-separated-values' });
      const url = URL.createObjectURL(blob);
      
      const safeName = project.name.replace(/[^a-z0-9]/gi, '-').toLowerCase();
      const date = new Date().toISOString().split('T')[0];
      const typeSuffix = tsvType === 'simple' ? 'equipment' : 'equipment-expanded';
      
      const link = document.createElement('a');
      link.href = url;
      link.download = `${safeName}-${typeSuffix}-${date}.tsv`;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(url);
      
      console.log(`Generated TSV report: ${rows.length} rows`);
      closeReportModal();
    }

    function generateReportForProject(projectId) {
      // Temporarily set this project as the context for report generation
      const originalProject = currentProjectId;
      currentProjectId = projectId;
      openReportModal();
      // Reset after modal opens
      setTimeout(() => {
        currentProjectId = originalProject;
      }, 100);
    }

    function generatePDFReport() {
      const reportType = document.querySelector('input[name="report-type"]:checked').value;
      const includeSummary = document.getElementById('include-summary').checked;
      const project = getCurrentProject();
      
      if (!project) {
        alert('No project selected');
        return;
      }

      // Initialize jsPDF - portrait for room sheets
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF('portrait', 'mm', 'letter');
      
      const pageHeight = 265;
      const pageWidth = 215;
      const marginLeft = 12;
      const marginRight = pageWidth - 12;
      const contentWidth = marginRight - marginLeft;
      const roomSpacing = 8;

      // Colors
      const primaryColor = [41, 128, 185];
      const secondaryColor = [52, 73, 94];
      const accentColor = [46, 204, 113];
      const lightGray = [248, 248, 248];
      const borderColor = [220, 220, 220];

      let yPos = 15;
      let currentDeptFA = '';

      // Helper: Calculate room height based on content
      function calculateRoomHeight(room, reportType) {
        let height = 32; // Header + basic info
        
        if (reportType === 'attributes' || reportType === 'both') {
          height += 45; // Finishes, HVAC, Med Gas rows
        }
        
        if (reportType === 'equipment' || reportType === 'both') {
          const equipCount = room.equipment?.length || 0;
          height += 8 + Math.min(equipCount * 4.5, 50); // Equipment section, capped
        }
        
        return height;
      }

      // Helper: Check if we need a new page
      function checkPageBreak(spaceNeeded) {
        if (yPos + spaceNeeded > pageHeight) {
          doc.addPage();
          yPos = 15;
          return true;
        }
        return false;
      }

      // Helper: Draw department/FA header
      function drawDeptFAHeader(dept, fa) {
        const key = `${dept.name}|${fa.name}`;
        if (key !== currentDeptFA) {
          checkPageBreak(12);
          currentDeptFA = key;
          
          doc.setFillColor(...primaryColor);
          doc.rect(marginLeft, yPos, contentWidth, 8, 'F');
          
          doc.setFontSize(9);
          doc.setFont(undefined, 'bold');
          doc.setTextColor(255, 255, 255);
          doc.text(`${dept.name}  ‚Ä∫  ${fa.name}`, marginLeft + 3, yPos + 5.5);
          
          yPos += 11;
        }
      }

      // Helper: Draw compact room card
      function drawRoomCard(room, dept, fa, reportType) {
        const roomData = ROOM_SIZES.find(r => (r.id || r.roomCode) === room.code) || {};
        const attrs = room.attributes || {};
        
        const cardStartY = yPos;
        
        // Room header bar
        doc.setFillColor(245, 248, 250);
        doc.setDrawColor(...borderColor);
        doc.roundedRect(marginLeft, yPos, contentWidth, 10, 1, 1, 'FD');
        
        // Room code badge
        doc.setFillColor(...primaryColor);
        doc.roundedRect(marginLeft + 2, yPos + 2, 28, 6, 1, 1, 'F');
        doc.setFontSize(7);
        doc.setFont(undefined, 'bold');
        doc.setTextColor(255, 255, 255);
        doc.text(room.code || 'CUSTOM', marginLeft + 16, yPos + 6, { align: 'center' });
        
        // Room name with room number if present
        doc.setFontSize(9);
        doc.setTextColor(0, 0, 0);
        const roomDisplayName = room.roomNumber 
          ? `${room.roomNumber} - ${room.name}`
          : room.name;
        doc.text(roomDisplayName, marginLeft + 33, yPos + 6);
        
        // NSF
        doc.setFontSize(8);
        doc.setFont(undefined, 'bold');
        doc.setTextColor(...primaryColor);
        doc.text(`${room.nsf || 0} NSF`, marginRight - 3, yPos + 6, { align: 'right' });
        
        yPos += 12;
        
        // Content area
        const contentStartY = yPos;
        let leftColX = marginLeft + 3;
        let rightColX = marginLeft + contentWidth/2 + 5;
        
        if (reportType === 'attributes' || reportType === 'both') {
          // === COMPACT ATTRIBUTES LAYOUT ===
          doc.setFontSize(6.5);
          
          // Row 1: Finishes
          doc.setFont(undefined, 'bold');
          doc.setTextColor(...secondaryColor);
          doc.text('FINISHES', leftColX, yPos);
          doc.setFont(undefined, 'normal');
          doc.setTextColor(0, 0, 0);
          
          const floor = roomData.floorMaterial || roomData.finishFloor || attrs.floorMaterial || '-';
          const wall = roomData.wallMaterial || roomData.finishWall || attrs.wallMaterial || '-';
          const ceiling = roomData.ceilingMaterial || roomData.finishCeiling || attrs.ceilingMaterial || '-';
          
          yPos += 4;
          doc.text(`Floor: ${floor.substring(0, 20)}`, leftColX, yPos);
          doc.text(`Wall: ${wall.substring(0, 20)}`, leftColX + 45, yPos);
          doc.text(`Ceiling: ${ceiling.substring(0, 20)}`, leftColX + 90, yPos);
          
          yPos += 6;
          
          // Row 2: HVAC
          doc.setFont(undefined, 'bold');
          doc.setTextColor(...secondaryColor);
          doc.text('HVAC', leftColX, yPos);
          doc.setFont(undefined, 'normal');
          doc.setTextColor(0, 0, 0);
          
          const ach = roomData.airChangesPerHour || roomData.ach || attrs.airChangesPerHour || '-';
          const temp = roomData.indoorTemperatureF || roomData.temperature || attrs.temperature || '-';
          const rhMin = roomData.indoorRelativeHumidityRhMin || '';
          const rhMax = roomData.indoorRelativeHumidityRhMax || '';
          const humidity = rhMin || rhMax ? `${rhMin}${rhMin && rhMax ? '-' : ''}${rhMax}%` : '-';
          const pressure = roomData.pressureRelationship || roomData.pressure || attrs.pressure || '-';
          
          yPos += 4;
          doc.text(`ACH: ${ach}`, leftColX, yPos);
          doc.text(`Temp: ${temp}${temp !== '-' ? '¬∞F' : ''}`, leftColX + 25, yPos);
          doc.text(`RH: ${humidity}`, leftColX + 55, yPos);
          doc.text(`Pressure: ${pressure}`, leftColX + 85, yPos);
          
          yPos += 6;
          
          // Row 3: Medical Gases
          doc.setFont(undefined, 'bold');
          doc.setTextColor(...secondaryColor);
          doc.text('MED GAS', leftColX, yPos);
          doc.setFont(undefined, 'normal');
          doc.setTextColor(0, 0, 0);
          
          const o2 = roomData.oxygenOutlets || roomData.oxygen || attrs.oxygen || '-';
          const medAir = roomData.medicalAirOutlets || roomData.medicalAir || attrs.medicalAir || '-';
          const vac = roomData.medicalVacuumOutlets || roomData.vacuum || attrs.vacuum || '-';
          const n2o = roomData.nitrousOxideOutlets || roomData.nitrousOxide || attrs.nitrousOxide || '-';
          
          yPos += 4;
          doc.text(`O‚ÇÇ: ${o2}`, leftColX, yPos);
          doc.text(`Air: ${medAir}`, leftColX + 20, yPos);
          doc.text(`Vac: ${vac}`, leftColX + 40, yPos);
          doc.text(`N‚ÇÇO: ${n2o}`, leftColX + 60, yPos);
          
          // Electrical on right side
          const lighting = roomData.lightingLevel || roomData.lighting || attrs.lighting || '-';
          const emergency = roomData.emergencyPower || attrs.emergencyPower || '-';
          doc.text(`Lighting: ${lighting} fc`, leftColX + 90, yPos);
          doc.text(`Emerg: ${emergency}`, leftColX + 130, yPos);
          
          yPos += 5;
        }
        
        if (reportType === 'equipment' || reportType === 'both') {
          // === COMPACT EQUIPMENT LIST ===
          const equipList = room.equipment || [];
          
          if (equipList.length > 0) {
            doc.setFontSize(6.5);
            doc.setFont(undefined, 'bold');
            doc.setTextColor(...secondaryColor);
            doc.text(`EQUIPMENT (${equipList.length})`, leftColX, yPos);
            yPos += 3;
            
            // Equipment table header
            doc.setFillColor(...secondaryColor);
            doc.rect(marginLeft + 2, yPos, contentWidth - 4, 4, 'F');
            doc.setFontSize(5.5);
            doc.setTextColor(255, 255, 255);
            doc.text('JSN', leftColX, yPos + 2.8);
            doc.text('Equipment Name', leftColX + 22, yPos + 2.8);
            doc.text('Qty', leftColX + 100, yPos + 2.8);
            doc.text('Acq/Ins', leftColX + 115, yPos + 2.8);
            doc.text('Cost', leftColX + 145, yPos + 2.8);
            yPos += 4.5;
            
            doc.setFont(undefined, 'normal');
            doc.setTextColor(0, 0, 0);
            
            // Show up to 8 equipment items per room card
            const maxEquip = 8;
            equipList.slice(0, maxEquip).forEach((eq, idx) => {
              if (idx % 2 === 0) {
                doc.setFillColor(...lightGray);
                doc.rect(marginLeft + 2, yPos - 1, contentWidth - 4, 4, 'F');
              }
              
              doc.setFontSize(6);
              doc.text(eq.jsn || '-', leftColX, yPos + 2);
              doc.text((eq.name || '').substring(0, 40), leftColX + 22, yPos + 2);
              doc.text(String(eq.quantity || 1), leftColX + 103, yPos + 2);
              doc.text((eq.acqIns || '-').substring(0, 8), leftColX + 115, yPos + 2);
              const cost = eq.cost || 0;
              doc.text(cost > 0 ? '$' + cost.toLocaleString() : '-', leftColX + 145, yPos + 2);
              yPos += 4;
            });
            
            if (equipList.length > maxEquip) {
              doc.setFontSize(5.5);
              doc.setTextColor(100, 100, 100);
              doc.text(`... +${equipList.length - maxEquip} more items`, leftColX + 22, yPos + 1);
              yPos += 3;
            }
            
            // Room equipment total
            const roomTotal = equipList.reduce((sum, eq) => sum + (eq.cost || 0) * (eq.quantity || 1), 0);
            if (roomTotal > 0) {
              doc.setFontSize(6);
              doc.setFont(undefined, 'bold');
              doc.setTextColor(...accentColor);
              doc.text(`Room Total: $${roomTotal.toLocaleString()}`, marginRight - 5, yPos + 1, { align: 'right' });
              yPos += 3;
            }
          } else {
            doc.setFontSize(6);
            doc.setTextColor(150, 150, 150);
            doc.text('No equipment specified', leftColX, yPos + 2);
            yPos += 5;
          }
        }
        
        // Draw border around entire room card
        const cardHeight = yPos - cardStartY + 2;
        doc.setDrawColor(...borderColor);
        doc.setLineWidth(0.3);
        doc.roundedRect(marginLeft, cardStartY, contentWidth, cardHeight, 1, 1, 'S');
        
        yPos += roomSpacing;
      }

      // Collect all rooms
      const allRooms = [];
      if (project.departments) {
        project.departments.forEach(dept => {
          if (dept.functionalAreas) {
            dept.functionalAreas.forEach(fa => {
              if (fa.rooms) {
                fa.rooms.forEach(room => {
                  allRooms.push({ room, dept, fa });
                });
              }
            });
          }
        });
      }

      if (allRooms.length === 0) {
        alert('No rooms to export');
        return;
      }

      // Calculate totals
      let totalEquip = 0, totalCost = 0;
      const totalNSF = calculateProjectNSF(project);
      allRooms.forEach(({ room }) => {
        if (room.equipment) {
          totalEquip += room.equipment.length;
          room.equipment.forEach(eq => {
            totalCost += (eq.cost || 0) * (eq.quantity || 1);
          });
        }
      });

      // Summary/Cover Page (if selected)
      if (includeSummary) {
        // Header
        doc.setFillColor(...primaryColor);
        doc.rect(0, 0, pageWidth, 40, 'F');
        
        doc.setFontSize(20);
        doc.setFont(undefined, 'bold');
        doc.setTextColor(255, 255, 255);
        doc.text(project.name, pageWidth / 2, 18, { align: 'center' });
        
        doc.setFontSize(11);
        doc.setFont(undefined, 'normal');
        doc.text(reportType === 'equipment' ? 'Equipment Report' : reportType === 'attributes' ? 'Room Attributes Report' : 'Complete Room Report', pageWidth / 2, 28, { align: 'center' });
        
        doc.setFontSize(8);
        doc.text(`Generated: ${new Date().toLocaleDateString()}`, pageWidth / 2, 36, { align: 'center' });
        
        yPos = 55;
        
        // Summary grid
        const boxWidth = 58;
        const boxHeight = 20;
        const summaryData = [
          { label: 'Departments', value: project.departments?.length || 0, color: primaryColor },
          { label: 'Functional Areas', value: project.departments?.reduce((s, d) => s + (d.functionalAreas?.length || 0), 0) || 0, color: secondaryColor },
          { label: 'Total Rooms', value: allRooms.length, color: accentColor },
          { label: 'Total NSF', value: totalNSF.toLocaleString(), color: primaryColor },
          { label: 'Equipment Items', value: totalEquip, color: secondaryColor },
          { label: 'Est. Cost', value: '$' + totalCost.toLocaleString(), color: accentColor }
        ];
        
        summaryData.forEach((item, i) => {
          const col = i % 3;
          const row = Math.floor(i / 3);
          const x = marginLeft + (col * (boxWidth + 5));
          const y = yPos + (row * (boxHeight + 5));
          
          doc.setFillColor(250, 250, 250);
          doc.setDrawColor(...item.color);
          doc.setLineWidth(0.8);
          doc.roundedRect(x, y, boxWidth, boxHeight, 2, 2, 'FD');
          
          doc.setFontSize(14);
          doc.setFont(undefined, 'bold');
          doc.setTextColor(...item.color);
          doc.text(String(item.value), x + boxWidth/2, y + 10, { align: 'center' });
          
          doc.setFontSize(7);
          doc.setFont(undefined, 'normal');
          doc.setTextColor(100, 100, 100);
          doc.text(item.label, x + boxWidth/2, y + 16, { align: 'center' });
        });
        
        yPos += 60;
        
        // Quick room listing by department
        doc.setFontSize(10);
        doc.setFont(undefined, 'bold');
        doc.setTextColor(...secondaryColor);
        doc.text('Room Index', marginLeft, yPos);
        yPos += 6;
        
        doc.setFontSize(7);
        doc.setFont(undefined, 'normal');
        
        let currentDept = '';
        allRooms.forEach(({ room, dept, fa }, idx) => {
          if (yPos > pageHeight - 10) {
            doc.addPage();
            yPos = 15;
          }
          
          if (dept.name !== currentDept) {
            currentDept = dept.name;
            yPos += 2;
            doc.setFont(undefined, 'bold');
            doc.setTextColor(...primaryColor);
            doc.text(dept.name, marginLeft, yPos);
            yPos += 4;
            doc.setFont(undefined, 'normal');
          }
          
          doc.setTextColor(60, 60, 60);
          const roomIndexName = room.roomNumber 
            ? `${room.code || 'CUSTOM'} - ${room.roomNumber} - ${room.name.substring(0, 40)}`
            : `${room.code || 'CUSTOM'} - ${room.name.substring(0, 50)}`;
          doc.text(roomIndexName, marginLeft + 5, yPos);
          doc.setTextColor(150, 150, 150);
          doc.text(`${room.nsf || 0} NSF`, marginRight, yPos, { align: 'right' });
          yPos += 3.5;
        });
        
        doc.addPage();
        yPos = 15;
        currentDeptFA = '';
      }

      // Generate room cards - multiple per page
      allRooms.forEach(({ room, dept, fa }, roomIdx) => {
        const roomHeight = calculateRoomHeight(room, reportType);
        
        // Check if we need dept/FA header
        const needsHeader = `${dept.name}|${fa.name}` !== currentDeptFA;
        const totalNeeded = roomHeight + (needsHeader ? 12 : 0);
        
        // Check if room fits on current page
        if (yPos + totalNeeded > pageHeight) {
          doc.addPage();
          yPos = 15;
          currentDeptFA = ''; // Reset so header shows on new page
        }
        
        drawDeptFAHeader(dept, fa);
        drawRoomCard(room, dept, fa, reportType);
      });

      // Add page footers
      const totalPages = doc.internal.getNumberOfPages();
      for (let i = 1; i <= totalPages; i++) {
        doc.setPage(i);
        doc.setFontSize(7);
        doc.setTextColor(150, 150, 150);
        doc.text(`${project.name}`, marginLeft, 273);
        doc.text(`Page ${i} of ${totalPages}`, pageWidth / 2, 273, { align: 'center' });
        doc.text(new Date().toLocaleDateString(), marginRight, 273, { align: 'right' });
      }

      // Save the PDF
      const fileName = `${project.name.replace(/[^a-z0-9]/gi, '_')}_${reportType}_${new Date().toISOString().split('T')[0]}.pdf`;
      doc.save(fileName);
      
      closeReportModal();
    }

    // -----------------------------
    // ROOM MANAGEMENT FUNCTIONS
    // -----------------------------

    function updateRoomGroupQuantity(roomIdsStr, newQuantity, currentQuantity) {
      const qty = parseInt(newQuantity);
      const currentQty = parseInt(currentQuantity);
      
      if (isNaN(qty) || qty < 0) {
        alert('Please enter a valid quantity (0 or greater)');
        renderAll();
        return;
      }

      const roomIds = roomIdsStr.split(',');
      const project = getCurrentProject();
      if (!project.departments) return;

      // Find the first room to use as template
      let templateRoom = null;
      let targetFA = null;
      
      for (const dept of project.departments) {
        if (!dept.functionalAreas) continue;
        for (const fa of dept.functionalAreas) {
          if (!fa.rooms) continue;
          const room = fa.rooms.find(r => r.id === roomIds[0]);
          if (room) {
            templateRoom = room;
            targetFA = fa;
            break;
          }
        }
        if (templateRoom) break;
      }

      if (!templateRoom || !targetFA) return;

      if (qty === 0) {
        // Delete all rooms in the group
        if (confirm(`Delete all ${currentQty} "${templateRoom.name}" room(s)?`)) {
          roomIds.forEach(roomId => {
            const roomIndex = targetFA.rooms.findIndex(r => r.id === roomId);
            if (roomIndex !== -1) {
              targetFA.rooms.splice(roomIndex, 1);
              if (selectedNode && selectedNode.room && selectedNode.room.id === roomId) {
                selectedNode = null;
              }
            }
          });
          saveProjects();
          renderAll();
        } else {
          renderAll();
        }
        return;
      }

      const difference = qty - currentQty;
      
      if (difference > 0) {
        // Add more copies
        for (let i = 0; i < difference; i++) {
          const newName = templateRoom.name;
          const newRoom = {
            id: generateId(),
            code: templateRoom.code,
            name: newName,
            nsf: templateRoom.nsf,
            attributes: templateRoom.attributes ? { ...templateRoom.attributes } : undefined,
            equipment: templateRoom.equipment ? templateRoom.equipment.map(eq => ({
              id: generateId(),
              jsn: eq.jsn,
              name: eq.name,
              quantity: eq.quantity,
              acqIns: eq.acqIns,
              description: eq.description
            })) : []
          };
          targetFA.rooms.push(newRoom);
        }
        saveProjects();
        renderAll();
      } else if (difference < 0) {
        // Remove some copies (keep the first ones, remove the last)
        const toRemove = Math.abs(difference);
        const toRemoveIds = roomIds.slice(-toRemove);
        
        toRemoveIds.forEach(roomId => {
          const roomIndex = targetFA.rooms.findIndex(r => r.id === roomId);
          if (roomIndex !== -1) {
            targetFA.rooms.splice(roomIndex, 1);
            if (selectedNode && selectedNode.room && selectedNode.room.id === roomId) {
              selectedNode = null;
            }
          }
        });
        saveProjects();
        renderAll();
      }
      // If difference === 0, no change needed
    }

    function updateRoomGroupNSF(roomIdsStr, newNSF) {
      const nsf = parseInt(newNSF);
      if (isNaN(nsf) || nsf < 0) {
        alert('Please enter a valid NSF value');
        renderAll();
        return;
      }

      const roomIds = roomIdsStr.split(',');
      const project = getCurrentProject();
      if (!project.departments) return;

      // Update NSF for all rooms in the group
      for (const dept of project.departments) {
        if (!dept.functionalAreas) continue;
        for (const fa of dept.functionalAreas) {
          if (!fa.rooms) continue;
          roomIds.forEach(roomId => {
            const room = fa.rooms.find(r => r.id === roomId);
            if (room) {
              room.nsf = nsf;
            }
          });
        }
      }

      saveProjects();
      renderAll();
    }

    function toggleEquipmentDesc(element) {
      const descDiv = element.previousElementSibling;
      const isExpanded = descDiv.classList.contains('expanded');
      
      if (isExpanded) {
        descDiv.classList.remove('expanded');
        descDiv.classList.add('truncated');
        element.textContent = 'more';
      } else {
        descDiv.classList.add('expanded');
        descDiv.classList.remove('truncated');
        element.textContent = 'less';
      }
    }

    function updateRoomQuantity(roomId, newQuantity) {
      const qty = parseInt(newQuantity);
      if (isNaN(qty) || qty < 0) {
        alert('Please enter a valid quantity (0 or greater)');
        renderAll();
        return;
      }

      const project = getCurrentProject();
      if (!project.departments) return;

      // Find the room
      for (const dept of project.departments) {
        if (!dept.functionalAreas) continue;
        for (const fa of dept.functionalAreas) {
          if (!fa.rooms) continue;
          const roomIndex = fa.rooms.findIndex(r => r.id === roomId);
          if (roomIndex !== -1) {
            const room = fa.rooms[roomIndex];
            
            if (qty === 0) {
              // Delete the room
              if (confirm(`Delete "${room.name}"?`)) {
                fa.rooms.splice(roomIndex, 1);
                if (selectedNode && selectedNode.room && selectedNode.room.id === roomId) {
                  selectedNode = null;
                }
                saveProjects();
                renderAll();
              } else {
                renderAll(); // Reset the input
              }
              return;
            } else if (qty > 1) {
              // Duplicate the room (qty - 1) times
              const duplicateCount = qty - 1;
              for (let i = 0; i < duplicateCount; i++) {
                const newName = room.name + ' (Copy)';
                const newRoom = {
                  id: generateId(),
                  code: room.code,
                  name: newName,
                  nsf: room.nsf,
                  attributes: room.attributes ? {
                    ...room.attributes,
                    'Room Name': newName
                  } : { 'Room Name': newName },
                  equipment: room.equipment.map(eq => ({
                    id: generateId(),
                    jsn: eq.jsn,
                    name: eq.name,
                    quantity: eq.quantity,
                    acqIns: eq.acqIns,
                    description: eq.description
                  }))
                };
                fa.rooms.push(newRoom);
              }
              saveProjects();
              renderAll();
              return;
            }
            // qty === 1: do nothing, it's the current state
            return;
          }
        }
      }
    }

    function updateRoomNSF(roomId, newNSF) {
      const project = getCurrentProject();
      if (!project.departments) return;

      for (const dept of project.departments) {
        if (!dept.functionalAreas) continue;
        for (const fa of dept.functionalAreas) {
          if (!fa.rooms) continue;
          const room = fa.rooms.find(r => r.id === roomId);
          if (room) {
            room.nsf = parseFloat(newNSF) || 0;
            saveProjects();
            renderAll();
            return;
          }
        }
      }
    }

    function updateRoomName(roomId, newName) {
      const project = getCurrentProject();
      if (!project.departments) return;

      newName = newName.trim();
      if (!newName) {
        alert('Room name cannot be empty');
        renderAll();
        return;
      }

      for (const dept of project.departments) {
        if (!dept.functionalAreas) continue;
        for (const fa of dept.functionalAreas) {
          if (!fa.rooms) continue;
          const room = fa.rooms.find(r => r.id === roomId);
          if (room) {
            room.name = newName;
            saveProjects();
            renderAll();
            return;
          }
        }
      }
    }

    function updateRoomCode(roomId, newCode) {
      const project = getCurrentProject();
      if (!project.departments) return;

      for (const dept of project.departments) {
        if (!dept.functionalAreas) continue;
        for (const fa of dept.functionalAreas) {
          if (!fa.rooms) continue;
          const room = fa.rooms.find(r => r.id === roomId);
          if (room) {
            room.code = newCode.trim();
            saveProjects();
            renderAll();
            return;
          }
        }
      }
    }

    function updateRoomNumber(roomId, newNumber) {
      const project = getCurrentProject();
      if (!project.departments) return;

      for (const dept of project.departments) {
        if (!dept.functionalAreas) continue;
        for (const fa of dept.functionalAreas) {
          if (!fa.rooms) continue;
          const room = fa.rooms.find(r => r.id === roomId);
          if (room) {
            room.roomNumber = newNumber.trim();
            saveProjects();
            renderAll();
            return;
          }
        }
      }
    }

    function updateRoomDepartment(roomId, newDeptId) {
      const project = getCurrentProject();
      if (!project.departments) return;

      // Find the room and its current location
      let roomToMove = null;
      let sourceFa = null;
      let sourceDept = null;

      for (const dept of project.departments) {
        if (!dept.functionalAreas) continue;
        for (const fa of dept.functionalAreas) {
          if (!fa.rooms) continue;
          const roomIndex = fa.rooms.findIndex(r => r.id === roomId);
          if (roomIndex !== -1) {
            roomToMove = fa.rooms[roomIndex];
            sourceFa = fa;
            sourceDept = dept;
            break;
          }
        }
        if (roomToMove) break;
      }

      if (!roomToMove) return;

      // Find target department
      const targetDept = project.departments.find(d => d.id === newDeptId);
      if (!targetDept) return;

      // If same department, no change needed
      if (sourceDept.id === targetDept.id) return;

      // Find or create a functional area with same name in target department
      if (!targetDept.functionalAreas) targetDept.functionalAreas = [];
      let targetFa = targetDept.functionalAreas.find(f => f.name === sourceFa.name);
      
      if (!targetFa) {
        // Create new FA with same name in target department
        targetFa = {
          id: generateId(),
          name: sourceFa.name,
          rooms: []
        };
        targetDept.functionalAreas.push(targetFa);
      }

      // Remove room from source FA
      const roomIndex = sourceFa.rooms.findIndex(r => r.id === roomId);
      if (roomIndex !== -1) {
        sourceFa.rooms.splice(roomIndex, 1);
      }

      // Add room to target FA
      if (!targetFa.rooms) targetFa.rooms = [];
      targetFa.rooms.push(roomToMove);

      // Clean up empty source FA
      if (sourceFa.rooms.length === 0) {
        const faIndex = sourceDept.functionalAreas.findIndex(f => f.id === sourceFa.id);
        if (faIndex !== -1) {
          sourceDept.functionalAreas.splice(faIndex, 1);
        }
      }

      saveProjects();
      renderAll();
    }

    function updateRoomFunctionalArea(roomId, currentDeptId, newFaId) {
      const project = getCurrentProject();
      if (!project.departments) return;

      // Find current department
      const dept = project.departments.find(d => d.id === currentDeptId);
      if (!dept || !dept.functionalAreas) return;

      // Find the room and its current FA
      let roomToMove = null;
      let sourceFa = null;

      for (const fa of dept.functionalAreas) {
        if (!fa.rooms) continue;
        const roomIndex = fa.rooms.findIndex(r => r.id === roomId);
        if (roomIndex !== -1) {
          roomToMove = fa.rooms[roomIndex];
          sourceFa = fa;
          break;
        }
      }

      if (!roomToMove) return;

      // Find target FA
      const targetFa = dept.functionalAreas.find(f => f.id === newFaId);
      if (!targetFa) return;

      // If same FA, no change needed
      if (sourceFa.id === targetFa.id) return;

      // Remove room from source FA
      const roomIndex = sourceFa.rooms.findIndex(r => r.id === roomId);
      if (roomIndex !== -1) {
        sourceFa.rooms.splice(roomIndex, 1);
      }

      // Add room to target FA
      if (!targetFa.rooms) targetFa.rooms = [];
      targetFa.rooms.push(roomToMove);

      // Clean up empty source FA
      if (sourceFa.rooms.length === 0) {
        const faIndex = dept.functionalAreas.findIndex(f => f.id === sourceFa.id);
        if (faIndex !== -1) {
          dept.functionalAreas.splice(faIndex, 1);
        }
      }

      saveProjects();
      renderAll();
    }

    function updateDepartmentName(deptId, newName) {
      const project = getCurrentProject();
      if (!project.departments) return;

      newName = newName.trim();
      if (!newName) {
        alert('Department name cannot be empty');
        renderAll();
        return;
      }

      const dept = project.departments.find(d => d.id === deptId);
      if (dept) {
        dept.name = newName;
        saveProjects();
        renderAll();
      }
    }

    function updateFunctionalAreaName(faId, deptId, newName) {
      const project = getCurrentProject();
      if (!project.departments) return;

      newName = newName.trim();
      if (!newName) {
        alert('Functional Area name cannot be empty');
        renderAll();
        return;
      }

      const dept = project.departments.find(d => d.id === deptId);
      if (!dept || !dept.functionalAreas) return;

      const fa = dept.functionalAreas.find(f => f.id === faId);
      if (fa) {
        fa.name = newName;
        saveProjects();
        renderAll();
      }
    }

    function updateRoomAttribute(roomId, attributeName, newValue) {
      const project = getCurrentProject();
      if (!project.departments) return;

      for (const dept of project.departments) {
        if (!dept.functionalAreas) continue;
        for (const fa of dept.functionalAreas) {
          if (!fa.rooms) continue;
          const room = fa.rooms.find(r => r.id === roomId);
          if (room) {
            // Initialize attributes object if it doesn't exist
            if (!room.attributes) {
              room.attributes = {};
            }
            // Store the attribute value
            room.attributes[attributeName] = newValue;
            saveProjects();
            renderAll();
            return;
          }
        }
      }
    }

    function resetRoomToDefault(roomId) {
      if (!confirm('Reset this room to default attributes and equipment? This will remove any customizations you\'ve made.')) return;
      
      const project = getCurrentProject();
      if (!project.departments) return;

      for (const dept of project.departments) {
        if (!dept.functionalAreas) continue;
        for (const fa of dept.functionalAreas) {
          if (!fa.rooms) continue;
          const room = fa.rooms.find(r => r.id === roomId);
          if (room) {
            // Find the base room in ROOM_SIZES
            const baseRoom = ROOM_SIZES.find(r => r['Room Code'] === room.code);
            if (!baseRoom) {
              alert('Cannot find base room data for code: ' + room.code);
              return;
            }

            // Reset attributes to default (clear customizations)
            delete room.attributes;
            
            // Reset equipment to base room equipment
            const baseEquipment = ROOM_EQUIPMENT[room.code] || [];
            room.equipment = baseEquipment.map(eq => ({
              id: generateId(),
              jsn: eq.JSN,
              name: eq['Equipment Name'],
              quantity: eq['Qty per Room'] || 1,
              acqIns: eq['Acq/Ins'],
              description: eq.Description
            }));
            
            saveProjects();
            renderAll();
            return;
          }
        }
      }
    }

    function resetRoomToDefault(roomId) {
      if (!confirm('Reset this room to default attributes and equipment? This will remove any customizations you\'ve made.')) return;
      
      const project = getCurrentProject();
      if (!project.departments) return;

      for (const dept of project.departments) {
        if (!dept.functionalAreas) continue;
        for (const fa of dept.functionalAreas) {
          if (!fa.rooms) continue;
          const room = fa.rooms.find(r => r.id === roomId);
          if (room) {
            // Find the base room in ROOM_SIZES
            const baseRoom = ROOM_SIZES.find(r => r['Room Code'] === room.code);
            if (!baseRoom) {
              alert('Cannot find base room data for code: ' + room.code);
              return;
            }

            // Reset attributes to default (clear customizations)
            delete room.attributes;
            
            // Reset equipment to base room equipment
            const baseEquipment = ROOM_EQUIPMENT[room.code] || [];
            room.equipment = baseEquipment.map(eq => ({
              id: generateId(),
              jsn: eq.JSN,
              name: eq['Equipment Name'],
              quantity: eq['Qty per Room'] || 1,
              acqIns: eq['Acq/Ins'],
              description: eq.Description
            }));
            
            saveProjects();
            renderAll();
            return;
          }
        }
      }
    }

    function duplicateRoom(roomId) {
      const project = getCurrentProject();
      if (!project.departments) return;

      for (const dept of project.departments) {
        if (!dept.functionalAreas) continue;
        for (const fa of dept.functionalAreas) {
          if (!fa.rooms) continue;
          const room = fa.rooms.find(r => r.id === roomId);
          if (room) {
            const newName = room.name + ' (Copy)';
            const newRoom = {
              id: generateId(),
              code: room.code,
              name: newName,
              nsf: room.nsf,
              attributes: room.attributes ? {
                ...room.attributes,
                'Room Name': newName  // Update Room Name attribute to match new name
              } : { 'Room Name': newName },
              equipment: room.equipment.map(eq => ({
                id: generateId(),
                jsn: eq.jsn,
                name: eq.name,
                quantity: eq.quantity,
                acqIns: eq.acqIns,
                description: eq.description
              }))
            };
            fa.rooms.push(newRoom);
            saveProjects();
            renderAll();
            return;
          }
        }
      }
    }

    // ---------------------------------
    // REPLACE ROOM FUNCTIONALITY
    // ---------------------------------
    let replaceRoomTargetId = null;
    let selectedReplaceRoomCode = null;

    function openReplaceRoomModal(roomId) {
      replaceRoomTargetId = roomId;
      selectedReplaceRoomCode = null;
      
      // Reset UI state
      document.getElementById('replace-room-search').value = '';
      document.getElementById('replace-name-sf').checked = true;
      document.getElementById('replace-attributes').checked = true;
      document.getElementById('replace-equipment').checked = true;
      document.getElementById('replace-room-preview').style.display = 'none';
      document.getElementById('confirm-replace-room-btn').disabled = true;
      
      // Populate room list
      populateReplaceRoomList();
      
      // Show modal
      document.getElementById('replace-room-modal').classList.add('active');
    }

    function closeReplaceRoomModal() {
      document.getElementById('replace-room-modal').classList.remove('active');
      replaceRoomTargetId = null;
      selectedReplaceRoomCode = null;
    }

    function populateReplaceRoomList(searchTerm = '') {
      const container = document.getElementById('replace-room-list');
      const searchLower = searchTerm.toLowerCase().trim();
      
      // Get unique rooms from ROOM_SIZES
      const rooms = ROOM_SIZES.filter(r => {
        if (!searchLower) return true;
        const code = (r.id || r['Room Code'] || '').toLowerCase();
        const name = (r.name || r['Room Name'] || '').toLowerCase();
        return code.includes(searchLower) || name.includes(searchLower);
      });

      // Sort by room code
      rooms.sort((a, b) => {
        const codeA = a.id || a['Room Code'] || '';
        const codeB = b.id || b['Room Code'] || '';
        return codeA.localeCompare(codeB);
      });

      // Limit to first 100 for performance
      const displayRooms = rooms.slice(0, 100);
      
      let html = '';
      
      if (displayRooms.length === 0) {
        html = `<div style="padding: 20px; text-align: center; color: var(--muted);">No rooms found matching "${searchTerm}"</div>`;
      } else {
        displayRooms.forEach(room => {
          const code = room.id || room['Room Code'] || '';
          const name = room.name || room['Room Name'] || '';
          const nsf = room.nsf || room['NSF'] || 0;
          const equipCount = (ROOM_EQUIPMENT && ROOM_EQUIPMENT[code]) ? ROOM_EQUIPMENT[code].length : 0;
          const isSelected = selectedReplaceRoomCode === code;
          
          html += `
            <div class="replace-room-item ${isSelected ? 'selected' : ''}" 
                 onclick="selectReplaceRoom('${code}')"
                 style="padding: 12px 16px; border-bottom: 1px solid var(--border); cursor: pointer; transition: background 0.2s; ${isSelected ? 'background: rgba(0, 184, 148, 0.15);' : ''}"
                 onmouseover="if(!this.classList.contains('selected')) this.style.background='rgba(255,255,255,0.05)'"
                 onmouseout="if(!this.classList.contains('selected')) this.style.background=''">
              <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                <div>
                  <div style="font-weight: 600; margin-bottom: 4px;">${code}</div>
                  <div style="font-size: 0.9rem; color: var(--muted);">${name}</div>
                </div>
                <div style="text-align: right; font-size: 0.85rem;">
                  <div style="color: var(--accent);">${nsf} SF</div>
                  <div style="color: var(--muted);">${equipCount} equipment</div>
                </div>
              </div>
            </div>
          `;
        });
        
        if (rooms.length > 100) {
          html += `<div style="padding: 12px; text-align: center; color: var(--muted); font-size: 0.85rem;">Showing 100 of ${rooms.length} results. Refine your search to see more.</div>`;
        }
      }
      
      container.innerHTML = html;
    }

    function filterReplaceRoomList() {
      const searchTerm = document.getElementById('replace-room-search').value;
      populateReplaceRoomList(searchTerm);
    }

    function selectReplaceRoom(roomCode) {
      selectedReplaceRoomCode = roomCode;
      
      // Update list UI to show selection
      const searchTerm = document.getElementById('replace-room-search').value;
      populateReplaceRoomList(searchTerm);
      
      // Show preview
      const roomData = ROOM_SIZES.find(r => (r.id || r['Room Code']) === roomCode);
      const equipCount = (ROOM_EQUIPMENT && ROOM_EQUIPMENT[roomCode]) ? ROOM_EQUIPMENT[roomCode].length : 0;
      
      if (roomData) {
        const code = roomData.id || roomData['Room Code'] || '';
        const name = roomData.name || roomData['Room Name'] || '';
        const nsf = roomData.nsf || roomData['NSF'] || 0;
        
        document.getElementById('replace-room-preview-content').innerHTML = `
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px;">
            <div><strong>Room Code:</strong> ${code}</div>
            <div><strong>Room Name:</strong> ${name}</div>
            <div><strong>NSF:</strong> ${nsf} SF</div>
            <div><strong>Equipment:</strong> ${equipCount} items</div>
          </div>
        `;
        document.getElementById('replace-room-preview').style.display = 'block';
        document.getElementById('confirm-replace-room-btn').disabled = false;
      }
    }

    function confirmReplaceRoom() {
      if (!replaceRoomTargetId || !selectedReplaceRoomCode) {
        alert('Please select a room to use as the replacement source.');
        return;
      }

      const importNameSf = document.getElementById('replace-name-sf').checked;
      const importAttributes = document.getElementById('replace-attributes').checked;
      const importEquipment = document.getElementById('replace-equipment').checked;

      if (!importNameSf && !importAttributes && !importEquipment) {
        alert('Please select at least one import option.');
        return;
      }

      // Find the target room in the project
      const project = getCurrentProject();
      if (!project.departments) return;

      let targetRoom = null;
      let foundFA = null;

      for (const dept of project.departments) {
        if (!dept.functionalAreas) continue;
        for (const fa of dept.functionalAreas) {
          if (!fa.rooms) continue;
          const room = fa.rooms.find(r => r.id === replaceRoomTargetId);
          if (room) {
            targetRoom = room;
            foundFA = fa;
            break;
          }
        }
        if (targetRoom) break;
      }

      if (!targetRoom) {
        alert('Target room not found in project.');
        return;
      }

      // Get source room data
      const sourceRoomData = ROOM_SIZES.find(r => (r.id || r['Room Code']) === selectedReplaceRoomCode);
      if (!sourceRoomData) {
        alert('Source room data not found.');
        return;
      }

      // Build confirmation message
      let changesList = [];
      if (importNameSf) {
        changesList.push('- Name: ' + (sourceRoomData.name || sourceRoomData['Room Name'] || selectedReplaceRoomCode));
        changesList.push('- NSF: ' + (sourceRoomData.nsf || sourceRoomData['NSF'] || 0) + ' SF');
      }
      if (importAttributes) {
        changesList.push('- All room attributes (finishes, HVAC, medical gases, etc.)');
      }
      if (importEquipment) {
        const equipCount = (ROOM_EQUIPMENT && ROOM_EQUIPMENT[selectedReplaceRoomCode]) ? ROOM_EQUIPMENT[selectedReplaceRoomCode].length : 0;
        changesList.push('- Equipment: ' + equipCount + ' items');
      }

      const confirmMsg = `Replace room "${targetRoom.code} - ${targetRoom.name}" with data from "${selectedReplaceRoomCode}"?\n\nThe following will be imported:\n${changesList.join('\n')}\n\nThis action cannot be undone.`;
      
      if (!confirm(confirmMsg)) return;

      // Apply the replacement
      if (importNameSf) {
        targetRoom.code = selectedReplaceRoomCode;
        targetRoom.name = sourceRoomData.name || sourceRoomData['Room Name'] || selectedReplaceRoomCode;
        targetRoom.nsf = sourceRoomData.nsf || sourceRoomData['NSF'] || 0;
      }

      if (importAttributes) {
        // Copy all room attributes from source, excluding id, name, nsf
        targetRoom.attributes = {};
        const excludeKeys = ['id', 'name', 'nsf', 'Room Code', 'Room Name', 'NSF'];
        for (const [key, value] of Object.entries(sourceRoomData)) {
          if (!excludeKeys.includes(key) && value !== null && value !== undefined && value !== '') {
            targetRoom.attributes[key] = value;
          }
        }
      }

      if (importEquipment) {
        // Replace equipment with source room's equipment
        const sourceEquipment = ROOM_EQUIPMENT && ROOM_EQUIPMENT[selectedReplaceRoomCode] || [];
        targetRoom.equipment = sourceEquipment.map(eq => {
          const jsn = eq.JSN;
          // Get cost from EQUIPMENT_ATTRIBUTES database if available
          const attrs = typeof EQUIPMENT_ATTRIBUTES !== 'undefined' && EQUIPMENT_ATTRIBUTES[jsn];
          const cost = attrs?.meanPrice || 0;
          
          return {
            id: generateId(),
            jsn: jsn,
            name: eq['Equipment Name'],
            quantity: eq['Qty per Room'] || 1,
            acqIns: eq['Acq/Ins'] || '',
            description: eq.Description || '',
            cost: cost
          };
        });
      }

      // Save and refresh
      saveProjects();
      closeReplaceRoomModal();
      renderAll();

      // Show success message
      alert(`‚úÖ Room replaced successfully!\n\nNew room: ${targetRoom.code} - ${targetRoom.name}`);
    }

    // ---------------------------------
    // FILE IMPORT FUNCTIONALITY
    // ---------------------------------
    let importFileData = null;
    let importFileColumns = [];
    let importFileAllRows = null; // Store all raw rows
    let importHeaderRowIndex = 0; // Which row contains headers

    function openFileImportModal() {
      // Reset state
      importFileData = null;
      importFileColumns = [];
      importFileAllRows = null;
      importHeaderRowIndex = 0;
      document.getElementById('import-file-input').value = '';
      document.getElementById('column-mapping-section').style.display = 'none';
      document.getElementById('import-summary').style.display = 'none';
      document.getElementById('confirm-file-import-btn').disabled = true;
      document.getElementById('file-drop-zone').style.borderColor = 'var(--border)';
      document.getElementById('file-drop-zone').style.background = 'var(--bg)';
      
      // Show modal
      document.getElementById('file-import-modal').classList.add('active');
    }

    function closeFileImportModal() {
      document.getElementById('file-import-modal').classList.remove('active');
      importFileData = null;
      importFileColumns = [];
      importFileAllRows = null;
      importHeaderRowIndex = 0;
    }

    function handleFileDrop(event) {
      event.preventDefault();
      document.getElementById('file-drop-zone').style.borderColor = 'var(--border)';
      document.getElementById('file-drop-zone').style.background = 'var(--bg)';
      
      const files = event.dataTransfer.files;
      if (files.length > 0) {
        processImportFile(files[0]);
      }
    }

    function handleFileSelect(event) {
      const files = event.target.files;
      if (files.length > 0) {
        processImportFile(files[0]);
      }
    }

    function processImportFile(file) {
      const fileName = file.name.toLowerCase();
      const reader = new FileReader();
      
      if (fileName.endsWith('.xlsx') || fileName.endsWith('.xls')) {
        // Excel file
        reader.onload = function(e) {
          try {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { type: 'array' });
            const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
            const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });
            parseImportData(jsonData);
          } catch (error) {
            alert('Error reading Excel file: ' + error.message);
            console.error('Excel parse error:', error);
          }
        };
        reader.readAsArrayBuffer(file);
      } else if (fileName.endsWith('.csv')) {
        // CSV file
        reader.onload = function(e) {
          try {
            const text = e.target.result;
            const rows = parseCSV(text, ',');
            parseImportData(rows);
          } catch (error) {
            alert('Error reading CSV file: ' + error.message);
            console.error('CSV parse error:', error);
          }
        };
        reader.readAsText(file);
      } else if (fileName.endsWith('.tsv') || fileName.endsWith('.txt')) {
        // TSV file
        reader.onload = function(e) {
          try {
            const text = e.target.result;
            const rows = parseCSV(text, '\t');
            parseImportData(rows);
          } catch (error) {
            alert('Error reading TSV file: ' + error.message);
            console.error('TSV parse error:', error);
          }
        };
        reader.readAsText(file);
      } else {
        alert('Unsupported file type. Please use Excel (.xlsx, .xls), CSV, or TSV files.');
      }
    }

    function parseCSV(text, delimiter) {
      const rows = [];
      const lines = text.split(/\r?\n/);
      
      for (const line of lines) {
        if (line.trim() === '') continue;
        
        // Simple CSV parsing (handles basic cases, not complex quoted values)
        const values = [];
        let current = '';
        let inQuotes = false;
        
        for (let i = 0; i < line.length; i++) {
          const char = line[i];
          
          if (char === '"' && (i === 0 || line[i-1] !== '\\')) {
            inQuotes = !inQuotes;
          } else if (char === delimiter && !inQuotes) {
            values.push(current.trim().replace(/^"|"$/g, ''));
            current = '';
          } else {
            current += char;
          }
        }
        values.push(current.trim().replace(/^"|"$/g, ''));
        rows.push(values);
      }
      
      return rows;
    }

    function parseImportData(rows) {
      if (!rows || rows.length < 2) {
        alert('File must contain at least a header row and one data row.');
        return;
      }

      // Store all rows for later use
      importFileAllRows = rows;
      
      // Try to auto-detect header row (look for row with most text-like values)
      importHeaderRowIndex = autoDetectHeaderRow(rows);
      
      // Populate header row selector
      populateHeaderRowSelector(rows);
      
      // Apply the detected header row
      applyHeaderRowSelection();
      
      // Show column mapping section
      document.getElementById('column-mapping-section').style.display = 'block';
    }
    
    function autoDetectHeaderRow(rows) {
      // Look at first 10 rows and find the one most likely to be headers
      // Headers typically have text values and match common column names
      const headerKeywords = ['department', 'dept', 'functional', 'room', 'name', 'code', 'nsf', 'sf', 'area', 'qty', 'quantity'];
      let bestRowIndex = 0;
      let bestScore = 0;
      
      const checkRows = Math.min(rows.length, 10);
      for (let i = 0; i < checkRows; i++) {
        const row = rows[i];
        if (!row || row.length === 0) continue;
        
        let score = 0;
        let hasText = 0;
        
        for (const cell of row) {
          const cellStr = String(cell || '').toLowerCase().trim();
          if (cellStr && isNaN(parseFloat(cellStr))) {
            hasText++;
            // Check if it matches common header keywords
            for (const keyword of headerKeywords) {
              if (cellStr.includes(keyword)) {
                score += 10;
                break;
              }
            }
          }
        }
        
        // Prefer rows with more text values and keyword matches
        score += hasText;
        
        if (score > bestScore) {
          bestScore = score;
          bestRowIndex = i;
        }
      }
      
      return bestRowIndex;
    }
    
    function populateHeaderRowSelector(rows) {
      const select = document.getElementById('header-row-select');
      select.innerHTML = '';
      
      // Show first 10 rows as options
      const maxRows = Math.min(rows.length, 10);
      for (let i = 0; i < maxRows; i++) {
        const row = rows[i];
        const preview = row.slice(0, 4).map(c => String(c || '').substring(0, 15)).join(' | ');
        const option = document.createElement('option');
        option.value = i;
        option.textContent = `Row ${i + 1}: ${preview}${row.length > 4 ? '...' : ''}`;
        if (i === importHeaderRowIndex) option.selected = true;
        select.appendChild(option);
      }
      
      // Show preview of selected header row
      updateHeaderRowPreview();
    }
    
    function updateHeaderRowPreview() {
      const preview = document.getElementById('header-row-preview');
      if (importFileAllRows && importFileAllRows[importHeaderRowIndex]) {
        const row = importFileAllRows[importHeaderRowIndex];
        preview.textContent = 'Columns: ' + row.map((c, i) => `[${i+1}] ${String(c || '').substring(0, 20)}`).join('  ');
      } else {
        preview.textContent = '';
      }
    }
    
    function updateHeaderRow() {
      const select = document.getElementById('header-row-select');
      importHeaderRowIndex = parseInt(select.value) || 0;
      updateHeaderRowPreview();
      applyHeaderRowSelection();
    }
    
    function applyHeaderRowSelection() {
      if (!importFileAllRows) return;
      
      // Use selected row as headers
      const headerRow = importFileAllRows[importHeaderRowIndex];
      importFileColumns = headerRow.map((col, idx) => ({
        index: idx,
        name: String(col || `Column ${idx + 1}`).trim()
      }));

      // Data is everything after the header row
      importFileData = importFileAllRows.slice(importHeaderRowIndex + 1).filter(row => 
        row.some(cell => cell !== null && cell !== undefined && String(cell).trim() !== '')
      );

      if (importFileData.length === 0) {
        alert('No data rows found after the header row.');
        return;
      }

      // Update column mapping dropdowns
      populateColumnMappingDropdowns();
      
      // Auto-detect column mappings
      autoDetectColumnMappings();
      
      // Render preview
      renderImportPreview();
      
      // Update summary
      updateImportSummary();
    }

    function populateColumnMappingDropdowns() {
      const dropdowns = ['col-department', 'col-functional-area', 'col-room-name', 'col-nsf', 'col-room-code', 'col-quantity', 'col-room-number'];
      
      dropdowns.forEach(id => {
        const select = document.getElementById(id);
        const isOptional = id === 'col-nsf' || id === 'col-room-code' || id === 'col-quantity' || id === 'col-room-number';
        
        select.innerHTML = isOptional 
          ? '<option value="">-- Select Column (optional) --</option>'
          : '<option value="">-- Select Column --</option>';
        
        importFileColumns.forEach(col => {
          const option = document.createElement('option');
          option.value = col.index;
          option.textContent = col.name;
          select.appendChild(option);
        });
        
        // Add change listener
        select.onchange = function() {
          renderImportPreview();
          updateImportSummary();
        };
      });
    }

    function autoDetectColumnMappings() {
      const mappings = {
        'col-department': ['department', 'dept', 'department name'],
        'col-functional-area': ['functional area', 'functional_area', 'fa', 'area', 'function'],
        'col-room-name': ['room name', 'room_name', 'name', 'room', 'space name', 'space'],
        'col-nsf': ['nsf', 'sf', 'square footage', 'sqft', 'square feet', 'area', 'size'],
        'col-room-code': ['room code', 'room_code', 'code', 'room id', 'id'],
        'col-quantity': ['quantity', 'qty', 'count', 'num'],
        'col-room-number': ['room number', 'room_number', 'room no', 'room #', 'number', 'no', 'rm number', 'rm no', 'rm#']
      };

      for (const [selectId, keywords] of Object.entries(mappings)) {
        const select = document.getElementById(selectId);
        
        for (const col of importFileColumns) {
          const colNameLower = col.name.toLowerCase();
          
          for (const keyword of keywords) {
            if (colNameLower === keyword || colNameLower.includes(keyword)) {
              select.value = col.index;
              break;
            }
          }
          
          if (select.value !== '') break;
        }
      }
    }

    function renderImportPreview() {
      const container = document.getElementById('import-data-preview');
      
      if (!importFileData || importFileData.length === 0) {
        container.innerHTML = '<div style="padding: 20px; text-align: center; color: var(--muted);">No data to preview</div>';
        return;
      }

      // Get column mappings
      const deptCol = document.getElementById('col-department').value;
      const faCol = document.getElementById('col-functional-area').value;
      const roomNameCol = document.getElementById('col-room-name').value;
      const nsfCol = document.getElementById('col-nsf').value;
      const roomCodeCol = document.getElementById('col-room-code').value;
      const qtyCol = document.getElementById('col-quantity').value;
      const roomNumberCol = document.getElementById('col-room-number').value;

      // Build preview table
      let html = '<table style="width: 100%; border-collapse: collapse;">';
      
      // Header row
      html += '<thead><tr style="background: var(--bg-secondary); position: sticky; top: 0;">';
      html += '<th style="padding: 8px; border: 1px solid var(--border); text-align: left;">Department</th>';
      html += '<th style="padding: 8px; border: 1px solid var(--border); text-align: left;">Functional Area</th>';
      html += '<th style="padding: 8px; border: 1px solid var(--border); text-align: left;">Room Name</th>';
      html += '<th style="padding: 8px; border: 1px solid var(--border); text-align: left;">Room #</th>';
      html += '<th style="padding: 8px; border: 1px solid var(--border); text-align: left;">NSF</th>';
      html += '<th style="padding: 8px; border: 1px solid var(--border); text-align: left;">Code</th>';
      html += '<th style="padding: 8px; border: 1px solid var(--border); text-align: left;">Qty</th>';
      html += '</tr></thead>';
      
      // Data rows (first 10)
      html += '<tbody>';
      const previewRows = importFileData.slice(0, 10);
      
      previewRows.forEach((row, idx) => {
        const deptRaw = deptCol !== '' ? (row[parseInt(deptCol)] || '') : '';
        const faRaw = faCol !== '' ? (row[parseInt(faCol)] || '') : '';
        const roomName = roomNameCol !== '' ? (row[parseInt(roomNameCol)] || '') : '';
        const nsf = nsfCol !== '' ? (row[parseInt(nsfCol)] || '') : '';
        const roomCode = roomCodeCol !== '' ? (row[parseInt(roomCodeCol)] || '') : '';
        const qty = qtyCol !== '' ? (row[parseInt(qtyCol)] || '1') : '1';
        const roomNumber = roomNumberCol !== '' ? (row[parseInt(roomNumberCol)] || '') : '';
        
        // Treat blank dept/FA as valid (will use "Blank" as name)
        const dept = String(deptRaw).trim() || '<span style="color: #f39c12;">(Blank)</span>';
        const fa = String(faRaw).trim() || '<span style="color: #f39c12;">(Blank)</span>';
        const isValid = roomName; // Only room name is truly required
        const rowStyle = isValid ? '' : 'background: rgba(231, 76, 60, 0.1);';
        
        html += `<tr style="${rowStyle}">`;
        html += `<td style="padding: 6px 8px; border: 1px solid var(--border);">${dept}</td>`;
        html += `<td style="padding: 6px 8px; border: 1px solid var(--border);">${fa}</td>`;
        html += `<td style="padding: 6px 8px; border: 1px solid var(--border);">${roomName || '<span style="color: #e74c3c;">Missing</span>'}</td>`;
        html += `<td style="padding: 6px 8px; border: 1px solid var(--border);">${roomNumber}</td>`;
        html += `<td style="padding: 6px 8px; border: 1px solid var(--border);">${nsf}</td>`;
        html += `<td style="padding: 6px 8px; border: 1px solid var(--border);">${roomCode}</td>`;
        html += `<td style="padding: 6px 8px; border: 1px solid var(--border);">${qty}</td>`;
        html += '</tr>';
      });
      
      if (importFileData.length > 10) {
        html += `<tr><td colspan="7" style="padding: 8px; text-align: center; color: var(--muted); border: 1px solid var(--border);">... and ${importFileData.length - 10} more rows</td></tr>`;
      }
      
      html += '</tbody></table>';
      container.innerHTML = html;
    }

    function updateImportSummary() {
      const deptCol = document.getElementById('col-department').value;
      const faCol = document.getElementById('col-functional-area').value;
      const roomNameCol = document.getElementById('col-room-name').value;
      
      // Check required fields
      if (deptCol === '' || faCol === '' || roomNameCol === '') {
        document.getElementById('import-summary').style.display = 'none';
        document.getElementById('confirm-file-import-btn').disabled = true;
        return;
      }

      // Count valid rows
      let validRows = 0;
      let invalidRows = 0;
      const departments = new Set();
      const functionalAreas = new Set();
      
      importFileData.forEach(row => {
        const deptRaw = row[parseInt(deptCol)];
        const faRaw = row[parseInt(faCol)];
        const roomName = row[parseInt(roomNameCol)];
        
        // Only room name is required - blank dept/FA will become "Blank"
        if (roomName && String(roomName).trim()) {
          validRows++;
          const deptName = String(deptRaw || '').trim() || 'Blank';
          const faName = String(faRaw || '').trim() || 'Blank';
          departments.add(deptName);
          functionalAreas.add(`${deptName}::${faName}`);
        } else {
          invalidRows++;
        }
      });

      // Show summary
      document.getElementById('import-summary').style.display = 'block';
      document.getElementById('import-summary-content').innerHTML = `
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 12px;">
          <div><strong>Total Rows:</strong> ${importFileData.length}</div>
          <div><strong>Valid Rooms:</strong> ${validRows}</div>
          <div><strong>Invalid Rows:</strong> ${invalidRows}</div>
          <div><strong>Departments:</strong> ${departments.size}</div>
          <div><strong>Functional Areas:</strong> ${functionalAreas.size}</div>
        </div>
        ${invalidRows > 0 ? '<div style="margin-top: 8px; color: #e67e22; font-size: 0.85rem;">‚ö†Ô∏è Rows without room names will be skipped.</div>' : ''}
      `;

      // Enable import button if we have valid data
      document.getElementById('confirm-file-import-btn').disabled = validRows === 0;
    }

    function confirmFileImport() {
      const deptCol = parseInt(document.getElementById('col-department').value);
      const faCol = parseInt(document.getElementById('col-functional-area').value);
      const roomNameCol = parseInt(document.getElementById('col-room-name').value);
      const nsfCol = document.getElementById('col-nsf').value;
      const roomCodeCol = document.getElementById('col-room-code').value;
      const qtyCol = document.getElementById('col-quantity').value;
      const roomNumberCol = document.getElementById('col-room-number').value;
      
      const mergeExisting = document.getElementById('import-merge-existing').checked;
      const lookupEquipment = document.getElementById('import-lookup-equipment').checked;

      const project = getCurrentProject();
      if (!project) {
        alert('No project selected.');
        return;
      }

      // Initialize departments array if needed
      if (!project.departments) {
        project.departments = [];
      }

      let importedRooms = 0;
      let skippedRows = 0;
      let equipmentMatches = 0;

      // Process each row
      importFileData.forEach(row => {
        const deptName = String(row[deptCol] || '').trim() || 'Blank';
        const faName = String(row[faCol] || '').trim() || 'Blank';
        const roomName = String(row[roomNameCol] || '').trim();
        
        // Skip rows without room name (only required field)
        if (!roomName) {
          skippedRows++;
          return;
        }

        const nsf = nsfCol !== '' ? parseFloat(row[parseInt(nsfCol)]) || 0 : 0;
        let roomCode = roomCodeCol !== '' ? String(row[parseInt(roomCodeCol)] || '').trim() : '';
        const quantity = qtyCol !== '' ? parseInt(row[parseInt(qtyCol)]) || 1 : 1;
        const roomNumber = roomNumberCol !== '' ? String(row[parseInt(roomNumberCol)] || '').trim() : '';

        // Try to find or create department
        let dept = project.departments.find(d => d.name.toLowerCase() === deptName.toLowerCase());
        if (!dept) {
          dept = {
            id: generateId(),
            name: deptName,
            functionalAreas: []
          };
          project.departments.push(dept);
        }

        // Try to find or create functional area
        if (!dept.functionalAreas) dept.functionalAreas = [];
        let fa = dept.functionalAreas.find(f => f.name.toLowerCase() === faName.toLowerCase());
        if (!fa) {
          fa = {
            id: generateId(),
            name: faName,
            rooms: []
          };
          dept.functionalAreas.push(fa);
        }

        // Try to lookup room code if not provided
        if (!roomCode && lookupEquipment) {
          // Try to find a matching room in ROOM_SIZES by name
          const matchingRoom = ROOM_SIZES.find(r => {
            const rName = (r.name || r['Room Name'] || '').toLowerCase();
            return rName === roomName.toLowerCase() || rName.includes(roomName.toLowerCase());
          });
          if (matchingRoom) {
            roomCode = matchingRoom.id || matchingRoom['Room Code'] || '';
          }
        }

        // Create room(s) based on quantity
        if (!fa.rooms) fa.rooms = [];
        
        for (let i = 0; i < quantity; i++) {
          const newRoom = {
            id: generateId(),
            code: roomCode || `CUSTOM-${generateId().substring(0, 6)}`,
            name: roomName,
            roomNumber: roomNumber || '',
            nsf: nsf,
            equipment: [],
            attributes: {}
          };

          // Try to lookup room attributes from ROOM_SIZES if room code is available
          if (lookupEquipment && roomCode && typeof ROOM_SIZES !== 'undefined') {
            const roomData = ROOM_SIZES.find(r => (r.id || r['Room Code']) === roomCode);
            if (roomData) {
              // Copy all room attributes (finishes, HVAC, medical gases, etc.)
              const excludeKeys = ['id', 'name', 'nsf', 'Room Code', 'Room Name', 'NSF'];
              for (const [key, value] of Object.entries(roomData)) {
                if (!excludeKeys.includes(key) && value !== null && value !== undefined && value !== '') {
                  newRoom.attributes[key] = value;
                }
              }
            }
          }

          // Try to lookup equipment if room code is available
          if (lookupEquipment && roomCode && ROOM_EQUIPMENT && ROOM_EQUIPMENT[roomCode]) {
            newRoom.equipment = ROOM_EQUIPMENT[roomCode].map(eq => {
              const jsn = eq.JSN;
              // Get cost from EQUIPMENT_ATTRIBUTES database if available
              const attrs = typeof EQUIPMENT_ATTRIBUTES !== 'undefined' && EQUIPMENT_ATTRIBUTES[jsn];
              const cost = attrs?.meanPrice || 0;
              
              return {
                id: generateId(),
                jsn: jsn,
                name: eq['Equipment Name'],
                quantity: eq['Qty per Room'] || 1,
                acqIns: eq['Acq/Ins'] || '',
                description: eq.Description || '',
                cost: cost
              };
            });
            if (newRoom.equipment.length > 0) {
              equipmentMatches++;
            }
          }

          // Check for duplicates if merge mode
          if (mergeExisting) {
            const existingRoom = fa.rooms.find(r => 
              r.name.toLowerCase() === roomName.toLowerCase() && 
              r.nsf === nsf
            );
            if (existingRoom) {
              // Skip duplicate
              continue;
            }
          }

          fa.rooms.push(newRoom);
          importedRooms++;
        }
      });

      // Save and refresh
      saveProjects();
      closeFileImportModal();
      renderAll();

      // Show success message
      alert(`‚úÖ Import Complete!\n\n` +
            `Rooms Imported: ${importedRooms}\n` +
            `Rows Skipped: ${skippedRows}\n` +
            `Equipment Matches: ${equipmentMatches}\n\n` +
            `Departments: ${project.departments.length}\n` +
            `Functional Areas: ${project.departments.reduce((sum, d) => sum + (d.functionalAreas?.length || 0), 0)}`);
    }

    function deleteDepartment(deptId) {
      const project = getCurrentProject();
      const dept = project.departments?.find(d => d.id === deptId);
      
      if (!dept) return;
      
      const faCount = dept.functionalAreas?.length || 0;
      let roomCount = 0;
      dept.functionalAreas?.forEach(fa => {
        roomCount += fa.rooms?.length || 0;
      });
      
      const confirmMsg = `Are you sure you want to delete "${dept.name}"?\n\nThis will delete:\n- ${faCount} functional area(s)\n- ${roomCount} room(s)\n\nThis action cannot be undone.`;
      
      if (!confirm(confirmMsg)) return;
      
      if (!project.departments) return;
      
      const deptIndex = project.departments.findIndex(d => d.id === deptId);
      if (deptIndex !== -1) {
        project.departments.splice(deptIndex, 1);
        saveProjects();
        // Clear selection if the deleted department was selected
        if (selectedNode && selectedNode.department && selectedNode.department.id === deptId) {
          selectedNode = null;
        }
        renderAll();
      }
    }

    function deleteFunctionalArea(faId, deptId) {
      const project = getCurrentProject();
      const dept = project.departments?.find(d => d.id === deptId);
      const fa = dept?.functionalAreas?.find(f => f.id === faId);
      
      if (!fa) return;
      
      const roomCount = fa.rooms?.length || 0;
      const confirmMsg = `Are you sure you want to delete "${fa.name}"?\n\nThis will delete ${roomCount} room(s).\n\nThis action cannot be undone.`;
      
      if (!confirm(confirmMsg)) return;
      
      if (!dept || !dept.functionalAreas) return;
      
      const faIndex = dept.functionalAreas.findIndex(f => f.id === faId);
      if (faIndex !== -1) {
        dept.functionalAreas.splice(faIndex, 1);
        saveProjects();
        // Clear selection if the deleted functional area was selected
        if (selectedNode && selectedNode.functionalArea && selectedNode.functionalArea.id === faId) {
          selectedNode = null;
        }
        renderAll();
      }
    }

    function deleteRoom(roomId) {
      if (!confirm('Are you sure you want to delete this room?')) return;
      
      const project = getCurrentProject();
      if (!project.departments) return;

      for (const dept of project.departments) {
        if (!dept.functionalAreas) continue;
        for (const fa of dept.functionalAreas) {
          if (!fa.rooms) continue;
          const roomIndex = fa.rooms.findIndex(r => r.id === roomId);
          if (roomIndex !== -1) {
            fa.rooms.splice(roomIndex, 1);
            saveProjects();
            // Clear selection if the deleted room was selected
            if (selectedNode && selectedNode.room && selectedNode.room.id === roomId) {
              selectedNode = null;
            }
            renderAll();
            return;
          }
        }
      }
    }

    function updateEquipmentQuantity(roomId, equipmentId, newQuantity) {
      const project = getCurrentProject();
      if (!project.departments) return;

      const qty = parseInt(newQuantity);
      if (isNaN(qty) || qty < 1) {
        alert('Please enter a valid quantity (minimum 1)');
        renderAll();
        return;
      }

      for (const dept of project.departments) {
        if (!dept.functionalAreas) continue;
        for (const fa of dept.functionalAreas) {
          if (!fa.rooms) continue;
          const room = fa.rooms.find(r => r.id === roomId);
          if (room && room.equipment) {
            const equipment = room.equipment.find(e => e.id === equipmentId);
            if (equipment) {
              equipment.quantity = qty;
              saveProjects();
              renderAll();
              return;
            }
          }
        }
      }
    }

    function removeEquipment(roomId, equipmentId) {
      const project = getCurrentProject();
      if (!project.departments) return;

      for (const dept of project.departments) {
        if (!dept.functionalAreas) continue;
        for (const fa of dept.functionalAreas) {
          if (!fa.rooms) continue;
          const room = fa.rooms.find(r => r.id === roomId);
          if (room && room.equipment) {
            room.equipment = room.equipment.filter(e => e.id !== equipmentId);
            saveProjects();
            renderAll();
            return;
          }
        }
      }
    }

    function updateEquipmentCost(roomId, equipmentId, newCost) {
      const project = getCurrentProject();
      if (!project.departments) return;

      const cost = parseFloat(newCost);
      if (isNaN(cost) || cost < 0) {
        alert('Please enter a valid cost (minimum 0)');
        renderAll();
        return;
      }

      for (const dept of project.departments) {
        if (!dept.functionalAreas) continue;
        for (const fa of dept.functionalAreas) {
          if (!fa.rooms) continue;
          const room = fa.rooms.find(r => r.id === roomId);
          if (room && room.equipment) {
            const equipment = room.equipment.find(e => e.id === equipmentId);
            if (equipment) {
              equipment.cost = cost;
              saveProjects();
              renderAll();
              return;
            }
          }
        }
      }
    }

    function updateProjectCostFactor(factorType, newValue) {
      const project = getCurrentProject();
      const value = parseFloat(newValue);
      
      if (isNaN(value) || value < 0) {
        alert('Please enter a valid cost factor (minimum 0)');
        renderAll();
        return;
      }

      if (factorType === 'costPerNSF') {
        project.costPerNSF = value;
        // Clear GSF when NSF is set
        if (value > 0) project.costPerGSF = 0;
      } else if (factorType === 'costPerGSF') {
        project.costPerGSF = value;
        // Clear NSF when GSF is set
        if (value > 0) project.costPerNSF = 0;
      }

      saveProjects();
      renderAll();
    }

    let currentRoomIdForEquipment = null;

    function addEquipmentToRoom(roomId) {
      currentRoomIdForEquipment = roomId;
      renderEquipmentList();
      document.getElementById('equipment-modal').classList.add('active');
      document.getElementById('equipment-search').value = '';
      document.getElementById('equipment-search').focus();
    }

    function closeEquipmentModal() {
      document.getElementById('equipment-modal').classList.remove('active');
      currentRoomIdForEquipment = null;
    }

    // -----------------------------
    // EQUIPMENT DETAIL POPUP
    // -----------------------------

    function showEquipmentDetail(jsn) {
      const equipItem = EQUIPMENT_LIST.find(e => e.jsn === jsn);
      if (!equipItem) {
        console.warn('Equipment not found:', jsn);
        return;
      }
      
      // Get extended attributes if available
      const attrs = (typeof EQUIPMENT_ATTRIBUTES !== 'undefined') ? EQUIPMENT_ATTRIBUTES[jsn] : null;
      
      // Update modal title
      document.getElementById('equipment-detail-title').textContent = `${jsn} - ${equipItem.name}`;
      
      // Build content
      let html = '';
      
      // Basic Info Section
      html += `<div class="equipment-detail-section">
        <h3>üìã Basic Information</h3>
        <div class="equipment-detail-grid">
          <div class="equipment-detail-row">
            <span class="equipment-detail-label">JSN:</span>
            <span class="equipment-detail-value highlight">${jsn}</span>
          </div>
          <div class="equipment-detail-row">
            <span class="equipment-detail-label">Category:</span>
            <span class="equipment-detail-value">${equipItem.acqIns || 'N/A'}</span>
          </div>
          <div class="equipment-detail-row" style="grid-column: 1 / -1;">
            <span class="equipment-detail-label">Name:</span>
            <span class="equipment-detail-value">${equipItem.name}</span>
          </div>
        </div>
        ${equipItem.description ? `<div style="margin-top: 12px;">
          <div class="equipment-detail-label" style="margin-bottom: 4px;">Description:</div>
          <div class="equipment-detail-value">${equipItem.description}</div>
        </div>` : ''}
      </div>`;
      
      if (attrs) {
        // Pricing Section
        if (attrs.meanPrice || attrs.unitIssue) {
          html += `<div class="equipment-detail-section">
            <h3>üí∞ Pricing</h3>
            <div class="equipment-detail-grid">
              ${attrs.meanPrice ? `<div class="equipment-detail-row">
                <span class="equipment-detail-label">Mean Price:</span>
                <span class="equipment-detail-value highlight">$${attrs.meanPrice.toLocaleString()}</span>
              </div>` : ''}
              ${attrs.priceDate ? `<div class="equipment-detail-row">
                <span class="equipment-detail-label">Price Date:</span>
                <span class="equipment-detail-value">${attrs.priceDate}</span>
              </div>` : ''}
              ${attrs.unitIssue ? `<div class="equipment-detail-row">
                <span class="equipment-detail-label">Unit Issue:</span>
                <span class="equipment-detail-value">${attrs.unitIssue}</span>
              </div>` : ''}
            </div>
          </div>`;
        }
        
        // Dimensions Section
        if (attrs.dimensions && (attrs.dimensions.width || attrs.dimensions.height || attrs.dimensions.depth || attrs.dimensions.weight)) {
          const d = attrs.dimensions;
          html += `<div class="equipment-detail-section">
            <h3>üìê Dimensions</h3>
            <div class="equipment-detail-grid">
              ${d.width ? `<div class="equipment-detail-row">
                <span class="equipment-detail-label">Width:</span>
                <span class="equipment-detail-value">${d.width}" (${d.widthMetric || 0} cm)</span>
              </div>` : ''}
              ${d.height ? `<div class="equipment-detail-row">
                <span class="equipment-detail-label">Height:</span>
                <span class="equipment-detail-value">${d.height}" (${d.heightMetric || 0} cm)</span>
              </div>` : ''}
              ${d.depth ? `<div class="equipment-detail-row">
                <span class="equipment-detail-label">Depth:</span>
                <span class="equipment-detail-value">${d.depth}" (${d.depthMetric || 0} cm)</span>
              </div>` : ''}
              ${d.weight ? `<div class="equipment-detail-row">
                <span class="equipment-detail-label">Weight:</span>
                <span class="equipment-detail-value">${d.weight} lbs (${d.weightMetric || 0} kg)</span>
              </div>` : ''}
            </div>
          </div>`;
        }
        
        // Power Requirements Section
        if (attrs.power && (attrs.power.amps || attrs.power.volts || attrs.power.watts)) {
          const p = attrs.power;
          html += `<div class="equipment-detail-section">
            <h3>‚ö° Power Requirements</h3>
            <div class="equipment-detail-grid">
              ${p.volts ? `<div class="equipment-detail-row">
                <span class="equipment-detail-label">Voltage:</span>
                <span class="equipment-detail-value">${p.volts}V</span>
              </div>` : ''}
              ${p.amps ? `<div class="equipment-detail-row">
                <span class="equipment-detail-label">Amperage:</span>
                <span class="equipment-detail-value">${p.amps}A</span>
              </div>` : ''}
              ${p.watts ? `<div class="equipment-detail-row">
                <span class="equipment-detail-label">Wattage:</span>
                <span class="equipment-detail-value">${p.watts}W</span>
              </div>` : ''}
              ${p.phase ? `<div class="equipment-detail-row">
                <span class="equipment-detail-label">Phase:</span>
                <span class="equipment-detail-value">${p.phase}-phase</span>
              </div>` : ''}
            </div>
          </div>`;
        }
        
        // Frequency/BTU Section
        if (attrs.hertz && (attrs.hertz.frequency !== '0' || attrs.hertz.btuPerHour)) {
          const h = attrs.hertz;
          html += `<div class="equipment-detail-section">
            <h3>üå°Ô∏è Thermal/Frequency</h3>
            <div class="equipment-detail-grid">
              ${h.frequency && h.frequency !== '0' ? `<div class="equipment-detail-row">
                <span class="equipment-detail-label">Frequency:</span>
                <span class="equipment-detail-value">${h.frequency} Hz</span>
              </div>` : ''}
              ${h.btuPerHour ? `<div class="equipment-detail-row">
                <span class="equipment-detail-label">BTU/Hour:</span>
                <span class="equipment-detail-value">${h.btuPerHour.toLocaleString()}</span>
              </div>` : ''}
              <div class="equipment-detail-row">
                <span class="equipment-detail-label">Dependent:</span>
                <span class="equipment-detail-value">${h.dependent ? 'Yes' : 'No'}</span>
              </div>
              <div class="equipment-detail-row">
                <span class="equipment-detail-label">Switchable:</span>
                <span class="equipment-detail-value">${h.switchable ? 'Yes' : 'No'}</span>
              </div>
            </div>
          </div>`;
        }
        
        // Category Codes Section
        if (attrs.category || attrs.fundingSource) {
          html += `<div class="equipment-detail-section">
            <h3>üè∑Ô∏è Category & Funding</h3>
            <div class="equipment-detail-grid">`;
          if (attrs.category) {
            if (attrs.category.va) html += `<div class="equipment-detail-row">
              <span class="equipment-detail-label">VA Category:</span>
              <span class="equipment-detail-value">${attrs.category.va}</span>
            </div>`;
            if (attrs.category.mhs) html += `<div class="equipment-detail-row">
              <span class="equipment-detail-label">MHS Category:</span>
              <span class="equipment-detail-value">${attrs.category.mhs}</span>
            </div>`;
          }
          if (attrs.fundingSource) {
            if (attrs.fundingSource.va) html += `<div class="equipment-detail-row">
              <span class="equipment-detail-label">VA Funding:</span>
              <span class="equipment-detail-value">${attrs.fundingSource.va}</span>
            </div>`;
            if (attrs.fundingSource.mhs) html += `<div class="equipment-detail-row">
              <span class="equipment-detail-label">MHS Funding:</span>
              <span class="equipment-detail-value">${attrs.fundingSource.mhs}</span>
            </div>`;
          }
          html += `</div></div>`;
        }
        
        // Utilities Section
        if (attrs.utilities && attrs.utilities.length > 0) {
          html += `<div class="equipment-detail-section">
            <h3>üîß Utilities Required</h3>
            <div class="equipment-detail-value">${attrs.utilities.join(', ')}</div>
          </div>`;
        }
        
        // Vendors Section
        if (attrs.vendors && attrs.vendors.length > 0) {
          html += `<div class="equipment-detail-section">
            <h3>üè≠ Vendor References</h3>`;
          attrs.vendors.forEach((vendor, idx) => {
            html += `<div class="equipment-vendor-card">
              <div style="font-weight: 600; margin-bottom: 6px;">Vendor ${idx + 1}</div>
              <div class="equipment-detail-grid">
                ${vendor.cageId ? `<div class="equipment-detail-row">
                  <span class="equipment-detail-label">CAGE ID:</span>
                  <span class="equipment-detail-value">${vendor.cageId}</span>
                </div>` : ''}
                ${vendor.model ? `<div class="equipment-detail-row">
                  <span class="equipment-detail-label">Model:</span>
                  <span class="equipment-detail-value">${vendor.model}</span>
                </div>` : ''}
                ${vendor.cutsheet ? `<div class="equipment-detail-row">
                  <span class="equipment-detail-label">Cutsheet:</span>
                  <span class="equipment-detail-value">${vendor.cutsheet}</span>
                </div>` : ''}
                ${vendor.price ? `<div class="equipment-detail-row">
                  <span class="equipment-detail-label">Price:</span>
                  <span class="equipment-detail-value">$${vendor.price.toLocaleString()}</span>
                </div>` : ''}
              </div>
            </div>`;
          });
          html += `</div>`;
        }
        
        // Criteria Sheet Section
        if (attrs.criteriaSheet) {
          html += `<div class="equipment-detail-section">
            <h3>üìÑ Criteria Sheet</h3>
            <div class="equipment-detail-grid">
              ${attrs.criteriaSheet.id ? `<div class="equipment-detail-row">
                <span class="equipment-detail-label">Sheet ID:</span>
                <span class="equipment-detail-value">${attrs.criteriaSheet.id}</span>
              </div>` : ''}
              ${attrs.criteriaSheet.filename ? `<div class="equipment-detail-row">
                <span class="equipment-detail-label">Filename:</span>
                <span class="equipment-detail-value">${attrs.criteriaSheet.filename}</span>
              </div>` : ''}
            </div>
          </div>`;
        }
        
        // Review Info Section
        if (attrs.dateApproved || attrs.lastModifiedDate || attrs.yearReview) {
          html += `<div class="equipment-detail-section">
            <h3>üìÖ Review Information</h3>
            <div class="equipment-detail-grid">
              ${attrs.dateApproved ? `<div class="equipment-detail-row">
                <span class="equipment-detail-label">Date Approved:</span>
                <span class="equipment-detail-value">${attrs.dateApproved}</span>
              </div>` : ''}
              ${attrs.lastModifiedDate ? `<div class="equipment-detail-row">
                <span class="equipment-detail-label">Last Modified:</span>
                <span class="equipment-detail-value">${attrs.lastModifiedDate}</span>
              </div>` : ''}
              ${attrs.yearReview ? `<div class="equipment-detail-row">
                <span class="equipment-detail-label">Year Review:</span>
                <span class="equipment-detail-value">${attrs.yearReview}</span>
              </div>` : ''}
              ${attrs.frequencyReview ? `<div class="equipment-detail-row">
                <span class="equipment-detail-label">Review Frequency:</span>
                <span class="equipment-detail-value">Every ${attrs.frequencyReview} years</span>
              </div>` : ''}
            </div>
          </div>`;
        }
        
        // NSN Section
        if (attrs.nsn) {
          html += `<div class="equipment-detail-section">
            <h3>üî¢ National Stock Number</h3>
            <div class="equipment-detail-value highlight">${attrs.nsn}</div>
          </div>`;
        }
      } else {
        html += `<div class="equipment-detail-section">
          <div style="color: var(--muted); font-style: italic;">
            Extended attributes not available for this equipment item.
          </div>
        </div>`;
      }
      
      document.getElementById('equipment-detail-content').innerHTML = html;
      document.getElementById('equipment-detail-modal').classList.add('active');
    }
    
    function closeEquipmentDetailModal() {
      document.getElementById('equipment-detail-modal').classList.remove('active');
    }

    // -----------------------------
    // JSN LOOKUP MODE
    // -----------------------------
    
    let jsnLookupCurrentPage = 0;
    const JSN_ITEMS_PER_PAGE = 100;
    let jsnLookupFilteredList = [];
    let jsnLookupSelectedJsn = null;

    function renderJsnLookupMode() {
      const treeView = document.getElementById('tree-view');
      const detailView = document.getElementById('detail-view');
      
      // Sort equipment alphabetically by JSN
      jsnLookupFilteredList = [...EQUIPMENT_LIST].sort((a, b) => a.jsn.localeCompare(b.jsn));
      jsnLookupCurrentPage = 0;
      jsnLookupSelectedJsn = null;
      
      // Tree panel with search and flat list
      treeView.innerHTML = `
        <div class="jsn-lookup-container">
          <div style="margin-bottom: 12px;">
            <h3 style="margin: 0 0 4px 0;">üîç JSN Equipment Lookup</h3>
            <p style="color: var(--muted); font-size: 0.8rem; margin: 0;">
              ${EQUIPMENT_LIST.length.toLocaleString()} equipment items
            </p>
          </div>
          <div class="jsn-lookup-search">
            <input type="text" id="jsn-lookup-search" placeholder="Filter by JSN or name..." 
                   oninput="filterJsnList()" />
          </div>
          <div id="jsn-lookup-list" class="jsn-lookup-list">
            <!-- Items will be rendered here -->
          </div>
          <div id="jsn-lookup-pagination" class="jsn-lookup-pagination">
            <!-- Pagination will be rendered here -->
          </div>
        </div>
      `;
      
      // Render initial list
      renderJsnList();
      
      // Detail panel shows welcome
      renderJsnWelcomePanel();
      
      // Focus the search input
      setTimeout(() => {
        const input = document.getElementById('jsn-lookup-search');
        if (input) input.focus();
      }, 100);
    }
    
    function renderJsnWelcomePanel() {
      const detailView = document.getElementById('detail-view');
      detailView.innerHTML = `
        <div class="detail-panel">
          <div class="detail-header">
            <h2>JSN Equipment Lookup</h2>
          </div>
          <div style="padding: 20px; color: var(--muted);">
            <p>Select an equipment item from the list to view detailed specifications.</p>
            <p style="margin-top: 12px;"><strong>Available Data:</strong></p>
            <ul style="margin-top: 8px; padding-left: 20px;">
              <li>Basic information (JSN, name, description, category)</li>
              <li>Pricing and unit of issue</li>
              <li>Physical dimensions (width, height, depth, weight)</li>
              <li>Power requirements (voltage, amperage, wattage, phase)</li>
              <li>Thermal data (BTU/hour, frequency)</li>
              <li>Category and funding codes (VA, MHS)</li>
              <li>Vendor references (CAGE IDs, models, cutsheets)</li>
              <li>Criteria sheet references</li>
              <li>Review dates and NSN</li>
            </ul>
          </div>
        </div>
      `;
    }
    
    function renderJsnList() {
      const container = document.getElementById('jsn-lookup-list');
      const paginationContainer = document.getElementById('jsn-lookup-pagination');
      
      const totalItems = jsnLookupFilteredList.length;
      const totalPages = Math.ceil(totalItems / JSN_ITEMS_PER_PAGE);
      const startIdx = jsnLookupCurrentPage * JSN_ITEMS_PER_PAGE;
      const endIdx = Math.min(startIdx + JSN_ITEMS_PER_PAGE, totalItems);
      const pageItems = jsnLookupFilteredList.slice(startIdx, endIdx);
      
      if (totalItems === 0) {
        container.innerHTML = `<div style="padding: 40px; text-align: center; color: var(--muted);">No equipment found</div>`;
        paginationContainer.innerHTML = '';
        return;
      }
      
      // Render items
      let html = '';
      pageItems.forEach(eq => {
        const isSelected = eq.jsn === jsnLookupSelectedJsn;
        html += `
          <div class="jsn-list-item${isSelected ? ' selected' : ''}" data-jsn="${eq.jsn}" onclick="selectJsnItem('${eq.jsn}')">
            <span class="jsn-list-jsn">${eq.jsn}</span>
            <span class="jsn-list-name">${eq.name}</span>
          </div>
        `;
      });
      container.innerHTML = html;
      
      // Render pagination
      if (totalPages > 1) {
        let pagHtml = `<div class="jsn-pagination-info">Showing ${startIdx + 1}-${endIdx} of ${totalItems}</div>`;
        pagHtml += `<div class="jsn-pagination-buttons">`;
        pagHtml += `<button onclick="jsnPagePrev()" ${jsnLookupCurrentPage === 0 ? 'disabled' : ''}>‚Üê Prev</button>`;
        pagHtml += `<span class="jsn-pagination-current">Page ${jsnLookupCurrentPage + 1} of ${totalPages}</span>`;
        pagHtml += `<button onclick="jsnPageNext()" ${jsnLookupCurrentPage >= totalPages - 1 ? 'disabled' : ''}>Next ‚Üí</button>`;
        pagHtml += `</div>`;
        paginationContainer.innerHTML = pagHtml;
      } else {
        paginationContainer.innerHTML = `<div class="jsn-pagination-info">${totalItems} items</div>`;
      }
    }
    
    function filterJsnList() {
      const searchInput = document.getElementById('jsn-lookup-search');
      const searchTerm = searchInput.value.toLowerCase().trim();
      
      // Sort equipment alphabetically by JSN
      const sortedEquipment = [...EQUIPMENT_LIST].sort((a, b) => a.jsn.localeCompare(b.jsn));
      
      if (!searchTerm) {
        jsnLookupFilteredList = sortedEquipment;
      } else {
        jsnLookupFilteredList = sortedEquipment.filter(eq => 
          eq.jsn.toLowerCase().includes(searchTerm) ||
          eq.name.toLowerCase().includes(searchTerm)
        );
      }
      
      jsnLookupCurrentPage = 0;
      renderJsnList();
    }
    
    function jsnPagePrev() {
      if (jsnLookupCurrentPage > 0) {
        jsnLookupCurrentPage--;
        renderJsnList();
      }
    }
    
    function jsnPageNext() {
      const totalPages = Math.ceil(jsnLookupFilteredList.length / JSN_ITEMS_PER_PAGE);
      if (jsnLookupCurrentPage < totalPages - 1) {
        jsnLookupCurrentPage++;
        renderJsnList();
      }
    }
    
    function selectJsnItem(jsn) {
      jsnLookupSelectedJsn = jsn;
      
      // Update selection highlight in list
      document.querySelectorAll('.jsn-list-item').forEach(item => {
        item.classList.toggle('selected', item.dataset.jsn === jsn);
      });
      
      // Show equipment detail in right panel
      showJsnDetailPanel(jsn);
    }
    
    function showJsnDetailPanel(jsn) {
      const equipItem = EQUIPMENT_LIST.find(e => e.jsn === jsn);
      if (!equipItem) return;
      
      const detailView = document.getElementById('detail-view');
      const attrs = (typeof EQUIPMENT_ATTRIBUTES !== 'undefined') ? EQUIPMENT_ATTRIBUTES[jsn] : null;
      
      let html = `
        <div class="detail-panel">
          <div class="detail-header">
            <h2>${jsn} - ${equipItem.name}</h2>
          </div>
          <div style="padding: 20px; overflow-y: auto;">
      `;
      
      // Basic Info Section
      html += `<div class="equipment-detail-section">
        <h3>üìã Basic Information</h3>
        <div class="equipment-detail-grid">
          <div class="equipment-detail-row">
            <span class="equipment-detail-label">JSN:</span>
            <span class="equipment-detail-value highlight">${jsn}</span>
          </div>
          <div class="equipment-detail-row">
            <span class="equipment-detail-label">Category:</span>
            <span class="equipment-detail-value">${equipItem.acqIns || 'N/A'}</span>
          </div>
          <div class="equipment-detail-row" style="grid-column: 1 / -1;">
            <span class="equipment-detail-label">Name:</span>
            <span class="equipment-detail-value">${equipItem.name}</span>
          </div>
        </div>
        ${equipItem.description ? `<div style="margin-top: 12px;">
          <div class="equipment-detail-label" style="margin-bottom: 4px;">Description:</div>
          <div class="equipment-detail-value">${equipItem.description}</div>
        </div>` : ''}
      </div>`;
      
      if (attrs) {
        // Pricing Section
        if (attrs.meanPrice || attrs.unitIssue) {
          html += `<div class="equipment-detail-section">
            <h3>üí∞ Pricing</h3>
            <div class="equipment-detail-grid">
              ${attrs.meanPrice ? `<div class="equipment-detail-row">
                <span class="equipment-detail-label">Mean Price:</span>
                <span class="equipment-detail-value highlight">$${attrs.meanPrice.toLocaleString()}</span>
              </div>` : ''}
              ${attrs.priceDate ? `<div class="equipment-detail-row">
                <span class="equipment-detail-label">Price Date:</span>
                <span class="equipment-detail-value">${attrs.priceDate}</span>
              </div>` : ''}
              ${attrs.unitIssue ? `<div class="equipment-detail-row">
                <span class="equipment-detail-label">Unit Issue:</span>
                <span class="equipment-detail-value">${attrs.unitIssue}</span>
              </div>` : ''}
            </div>
          </div>`;
        }
        
        // Dimensions Section
        if (attrs.dimensions && (attrs.dimensions.width || attrs.dimensions.height || attrs.dimensions.depth || attrs.dimensions.weight)) {
          const d = attrs.dimensions;
          html += `<div class="equipment-detail-section">
            <h3>üìê Dimensions</h3>
            <div class="equipment-detail-grid">
              ${d.width ? `<div class="equipment-detail-row">
                <span class="equipment-detail-label">Width:</span>
                <span class="equipment-detail-value">${d.width}" (${d.widthMetric || 0} cm)</span>
              </div>` : ''}
              ${d.height ? `<div class="equipment-detail-row">
                <span class="equipment-detail-label">Height:</span>
                <span class="equipment-detail-value">${d.height}" (${d.heightMetric || 0} cm)</span>
              </div>` : ''}
              ${d.depth ? `<div class="equipment-detail-row">
                <span class="equipment-detail-label">Depth:</span>
                <span class="equipment-detail-value">${d.depth}" (${d.depthMetric || 0} cm)</span>
              </div>` : ''}
              ${d.weight ? `<div class="equipment-detail-row">
                <span class="equipment-detail-label">Weight:</span>
                <span class="equipment-detail-value">${d.weight} lbs (${d.weightMetric || 0} kg)</span>
              </div>` : ''}
            </div>
          </div>`;
        }
        
        // Power Requirements Section
        if (attrs.power && (attrs.power.amps || attrs.power.volts || attrs.power.watts)) {
          const p = attrs.power;
          html += `<div class="equipment-detail-section">
            <h3>‚ö° Power Requirements</h3>
            <div class="equipment-detail-grid">
              ${p.volts ? `<div class="equipment-detail-row">
                <span class="equipment-detail-label">Voltage:</span>
                <span class="equipment-detail-value">${p.volts}V</span>
              </div>` : ''}
              ${p.amps ? `<div class="equipment-detail-row">
                <span class="equipment-detail-label">Amperage:</span>
                <span class="equipment-detail-value">${p.amps}A</span>
              </div>` : ''}
              ${p.watts ? `<div class="equipment-detail-row">
                <span class="equipment-detail-label">Wattage:</span>
                <span class="equipment-detail-value">${p.watts}W</span>
              </div>` : ''}
              ${p.phase ? `<div class="equipment-detail-row">
                <span class="equipment-detail-label">Phase:</span>
                <span class="equipment-detail-value">${p.phase}-phase</span>
              </div>` : ''}
            </div>
          </div>`;
        }
        
        // Frequency/BTU Section
        if (attrs.hertz && (attrs.hertz.frequency !== '0' || attrs.hertz.btuPerHour)) {
          const h = attrs.hertz;
          html += `<div class="equipment-detail-section">
            <h3>üå°Ô∏è Thermal/Frequency</h3>
            <div class="equipment-detail-grid">
              ${h.frequency && h.frequency !== '0' ? `<div class="equipment-detail-row">
                <span class="equipment-detail-label">Frequency:</span>
                <span class="equipment-detail-value">${h.frequency} Hz</span>
              </div>` : ''}
              ${h.btuPerHour ? `<div class="equipment-detail-row">
                <span class="equipment-detail-label">BTU/Hour:</span>
                <span class="equipment-detail-value">${h.btuPerHour.toLocaleString()}</span>
              </div>` : ''}
              <div class="equipment-detail-row">
                <span class="equipment-detail-label">Dependent:</span>
                <span class="equipment-detail-value">${h.dependent ? 'Yes' : 'No'}</span>
              </div>
              <div class="equipment-detail-row">
                <span class="equipment-detail-label">Switchable:</span>
                <span class="equipment-detail-value">${h.switchable ? 'Yes' : 'No'}</span>
              </div>
            </div>
          </div>`;
        }
        
        // Category Codes Section
        if (attrs.category || attrs.fundingSource) {
          html += `<div class="equipment-detail-section">
            <h3>üè∑Ô∏è Category & Funding</h3>
            <div class="equipment-detail-grid">`;
          if (attrs.category) {
            if (attrs.category.va) html += `<div class="equipment-detail-row">
              <span class="equipment-detail-label">VA Category:</span>
              <span class="equipment-detail-value">${attrs.category.va}</span>
            </div>`;
            if (attrs.category.mhs) html += `<div class="equipment-detail-row">
              <span class="equipment-detail-label">MHS Category:</span>
              <span class="equipment-detail-value">${attrs.category.mhs}</span>
            </div>`;
          }
          if (attrs.fundingSource) {
            if (attrs.fundingSource.va) html += `<div class="equipment-detail-row">
              <span class="equipment-detail-label">VA Funding:</span>
              <span class="equipment-detail-value">${attrs.fundingSource.va}</span>
            </div>`;
            if (attrs.fundingSource.mhs) html += `<div class="equipment-detail-row">
              <span class="equipment-detail-label">MHS Funding:</span>
              <span class="equipment-detail-value">${attrs.fundingSource.mhs}</span>
            </div>`;
          }
          html += `</div></div>`;
        }
        
        // Utilities Section
        if (attrs.utilities && attrs.utilities.length > 0) {
          html += `<div class="equipment-detail-section">
            <h3>üîß Utilities Required</h3>
            <div class="equipment-detail-value">${attrs.utilities.join(', ')}</div>
          </div>`;
        }
        
        // Vendors Section
        if (attrs.vendors && attrs.vendors.length > 0) {
          html += `<div class="equipment-detail-section">
            <h3>üè≠ Vendor References</h3>`;
          attrs.vendors.forEach((vendor, idx) => {
            html += `<div class="equipment-vendor-card">
              <div style="font-weight: 600; margin-bottom: 6px;">Vendor ${idx + 1}</div>
              <div class="equipment-detail-grid">
                ${vendor.cageId ? `<div class="equipment-detail-row">
                  <span class="equipment-detail-label">CAGE ID:</span>
                  <span class="equipment-detail-value">${vendor.cageId}</span>
                </div>` : ''}
                ${vendor.model ? `<div class="equipment-detail-row">
                  <span class="equipment-detail-label">Model:</span>
                  <span class="equipment-detail-value">${vendor.model}</span>
                </div>` : ''}
                ${vendor.cutsheet ? `<div class="equipment-detail-row">
                  <span class="equipment-detail-label">Cutsheet:</span>
                  <span class="equipment-detail-value">${vendor.cutsheet}</span>
                </div>` : ''}
                ${vendor.price ? `<div class="equipment-detail-row">
                  <span class="equipment-detail-label">Price:</span>
                  <span class="equipment-detail-value">$${vendor.price.toLocaleString()}</span>
                </div>` : ''}
              </div>
            </div>`;
          });
          html += `</div>`;
        }
        
        // Criteria Sheet Section
        if (attrs.criteriaSheet) {
          html += `<div class="equipment-detail-section">
            <h3>üìÑ Criteria Sheet</h3>
            <div class="equipment-detail-grid">
              ${attrs.criteriaSheet.id ? `<div class="equipment-detail-row">
                <span class="equipment-detail-label">Sheet ID:</span>
                <span class="equipment-detail-value">${attrs.criteriaSheet.id}</span>
              </div>` : ''}
              ${attrs.criteriaSheet.filename ? `<div class="equipment-detail-row">
                <span class="equipment-detail-label">Filename:</span>
                <span class="equipment-detail-value">${attrs.criteriaSheet.filename}</span>
              </div>` : ''}
            </div>
          </div>`;
        }
        
        // Review Info Section
        if (attrs.dateApproved || attrs.lastModifiedDate || attrs.yearReview) {
          html += `<div class="equipment-detail-section">
            <h3>üìÖ Review Information</h3>
            <div class="equipment-detail-grid">
              ${attrs.dateApproved ? `<div class="equipment-detail-row">
                <span class="equipment-detail-label">Date Approved:</span>
                <span class="equipment-detail-value">${attrs.dateApproved}</span>
              </div>` : ''}
              ${attrs.lastModifiedDate ? `<div class="equipment-detail-row">
                <span class="equipment-detail-label">Last Modified:</span>
                <span class="equipment-detail-value">${attrs.lastModifiedDate}</span>
              </div>` : ''}
              ${attrs.yearReview ? `<div class="equipment-detail-row">
                <span class="equipment-detail-label">Year Review:</span>
                <span class="equipment-detail-value">${attrs.yearReview}</span>
              </div>` : ''}
              ${attrs.frequencyReview ? `<div class="equipment-detail-row">
                <span class="equipment-detail-label">Review Frequency:</span>
                <span class="equipment-detail-value">Every ${attrs.frequencyReview} years</span>
              </div>` : ''}
            </div>
          </div>`;
        }
        
        // NSN Section
        if (attrs.nsn) {
          html += `<div class="equipment-detail-section">
            <h3>üî¢ National Stock Number</h3>
            <div class="equipment-detail-value highlight">${attrs.nsn}</div>
          </div>`;
        }
      } else {
        html += `<div class="equipment-detail-section">
          <div style="color: var(--muted); font-style: italic;">
            Extended attributes not available for this equipment item.
          </div>
        </div>`;
      }
      
      html += `</div></div>`;
      detailView.innerHTML = html;
    }

    function renderEquipmentList(searchTerm = '') {
      const container = document.getElementById('equipment-list');
      const lowerSearch = searchTerm.toLowerCase();
      
      let filteredEquipment = EQUIPMENT_LIST;
      if (searchTerm) {
        filteredEquipment = EQUIPMENT_LIST.filter(eq => 
          eq.jsn.toLowerCase().includes(lowerSearch) ||
          eq.name.toLowerCase().includes(lowerSearch) ||
          (eq.description && eq.description.toLowerCase().includes(lowerSearch))
        );
      }

      if (filteredEquipment.length === 0) {
        container.innerHTML = '<div style="padding: 40px; text-align: center; color: var(--muted);">No equipment found</div>';
        return;
      }

      let html = '<div style="display: flex; flex-direction: column;">';
      filteredEquipment.forEach(eq => {
        html += `
          <div style="padding: 12px 16px; border-bottom: 1px solid var(--border); cursor: pointer; transition: background 0.2s;" 
               onmouseover="this.style.background='var(--bg-hover)'" 
               onmouseout="this.style.background='transparent'"
               onclick="selectEquipment('${eq.jsn}')">
            <div style="font-weight: 600; margin-bottom: 4px;"><span class="jsn-clickable" onclick="event.stopPropagation(); showEquipmentDetail('${eq.jsn}')" title="Click for equipment details">${eq.jsn}</span> - ${eq.name}</div>
            ${eq.acqIns ? `<div style="font-size: 0.85rem; color: var(--muted); margin-bottom: 2px;">Category: ${eq.acqIns}</div>` : ''}
            ${eq.description ? `<div style="font-size: 0.85rem; color: var(--muted);">${eq.description}</div>` : ''}
          </div>
        `;
      });
      html += '</div>';
      
      container.innerHTML = html;
    }

    function filterEquipmentList() {
      const searchTerm = document.getElementById('equipment-search').value;
      renderEquipmentList(searchTerm);
    }

    function selectEquipment(jsn) {
      const equipItem = EQUIPMENT_LIST.find(e => e.jsn === jsn);
      if (!equipItem) {
        alert('Equipment not found.');
        return;
      }

      const quantity = prompt('Enter quantity:', '1');
      if (!quantity) return;

      const project = getCurrentProject();
      if (!project.departments) return;

      for (const dept of project.departments) {
        if (!dept.functionalAreas) continue;
        for (const fa of dept.functionalAreas) {
          if (!fa.rooms) continue;
          const room = fa.rooms.find(r => r.id === currentRoomIdForEquipment);
          if (room) {
            if (!room.equipment) room.equipment = [];
            room.equipment.push({
              id: generateId(),
              jsn: equipItem.jsn,
              name: equipItem.name,
              quantity: parseInt(quantity) || 1,
              acqIns: equipItem.acqIns,
              description: equipItem.description,
              cost: 0
            });
            saveProjects();
            closeEquipmentModal();
            renderAll();
            return;
          }
        }
      }
    }

    function calculateTotalNSF(rooms) {
      if (!rooms) return 0;
      return rooms.reduce((sum, room) => sum + (room.nsf || 0), 0);
    }

    function calculateFANSF(fa) {
      return calculateTotalNSF(fa.rooms);
    }

    function calculateDeptNSF(dept) {
      if (!dept.functionalAreas) return 0;
      return dept.functionalAreas.reduce((sum, fa) => sum + calculateFANSF(fa), 0);
    }

    function calculateProjectNSF(project) {
      if (!project.departments) return 0;
      return project.departments.reduce((sum, dept) => sum + calculateDeptNSF(dept), 0);
    }

    // COST CALCULATION FUNCTIONS
    function calculateEquipmentCost(equipment) {
      if (!equipment) return 0;
      return equipment.reduce((sum, eq) => {
        // Use global getEquipmentPrice if available, otherwise check local attributes
        let unitCost = 0;
        if (typeof getEquipmentPrice === 'function') {
          unitCost = getEquipmentPrice(eq.jsn, eq.cost);
        } else {
          // Fallback: check for per-item cost override, then database price
          unitCost = eq.cost || 0;
          if (!unitCost && eq.jsn && typeof EQUIPMENT_ATTRIBUTES !== 'undefined') {
            const attrs = EQUIPMENT_ATTRIBUTES[eq.jsn];
            if (attrs && attrs.meanPrice) {
              unitCost = attrs.meanPrice;
            }
          }
        }
        
        return sum + (unitCost * (eq.quantity || 1));
      }, 0);
    }

    function getEquipmentUnitCost(jsn, overrideCost) {
      // Use global getEquipmentPrice if available
      if (typeof getEquipmentPrice === 'function') {
        return getEquipmentPrice(jsn, overrideCost);
      }
      
      // Fallback implementation
      if (overrideCost && overrideCost > 0) return overrideCost;
      
      if (jsn && typeof EQUIPMENT_ATTRIBUTES !== 'undefined') {
        const attrs = EQUIPMENT_ATTRIBUTES[jsn];
        if (attrs && attrs.meanPrice) {
          return attrs.meanPrice;
        }
      }
      
      return 0;
    }

    function calculateRoomCost(room, project) {
      let cost = 0;
      // Equipment cost
      if (room.equipment) {
        cost += calculateEquipmentCost(room.equipment);
      }
      // Construction cost (NSF * costPerNSF or GSF * costPerGSF)
      const nsf = room.nsf || 0;
      const costPerNSF = project?.costPerNSF || 0;
      const costPerGSF = project?.costPerGSF || 0;
      if (costPerNSF > 0) {
        cost += nsf * costPerNSF;
      } else if (costPerGSF > 0 && nsf > 0) {
        // Assuming a default 1.35 grossing factor if using GSF
        const gsf = nsf * 1.35;
        cost += gsf * costPerGSF;
      }
      return cost;
    }

    function calculateFACost(fa, project) {
      if (!fa.rooms) return 0;
      return fa.rooms.reduce((sum, room) => sum + calculateRoomCost(room, project), 0);
    }

    function calculateDeptCost(dept, project) {
      if (!dept.functionalAreas) return 0;
      return dept.functionalAreas.reduce((sum, fa) => sum + calculateFACost(fa, project), 0);
    }

    function calculateProjectCost(project) {
      if (!project.departments) return 0;
      return project.departments.reduce((sum, dept) => sum + calculateDeptCost(dept, project), 0);
    }

    function updateAllEquipmentCostsFromDatabase() {
      const project = getCurrentProject();
      if (!project.departments) {
        alert('No departments in project');
        return;
      }

      if (typeof EQUIPMENT_ATTRIBUTES === 'undefined') {
        alert('Equipment database not loaded. Cannot update costs.');
        return;
      }

      let updatedCount = 0;
      let notFoundCount = 0;
      let alreadySetCount = 0;
      const notFoundJSNs = new Set();

      // Iterate through all equipment in the project
      project.departments.forEach(dept => {
        if (!dept.functionalAreas) return;
        dept.functionalAreas.forEach(fa => {
          if (!fa.rooms) return;
          fa.rooms.forEach(room => {
            if (!room.equipment) return;
            room.equipment.forEach(eq => {
              if (!eq.jsn) return;

              const attrs = EQUIPMENT_ATTRIBUTES[eq.jsn];
              if (attrs && attrs.meanPrice) {
                // Update the cost from database
                eq.cost = attrs.meanPrice;
                updatedCount++;
              } else {
                notFoundCount++;
                notFoundJSNs.add(eq.jsn);
              }
            });
          });
        });
      });

      saveProjects();
      renderAll();

      // Show summary
      let message = `Equipment costs updated!\n\n`;
      message += `‚úÖ Updated: ${updatedCount} items\n`;
      if (notFoundCount > 0) {
        message += `‚ö†Ô∏è No price found: ${notFoundCount} items\n`;
        if (notFoundJSNs.size <= 10) {
          message += `   JSNs: ${Array.from(notFoundJSNs).join(', ')}\n`;
        } else {
          message += `   (${notFoundJSNs.size} unique JSNs without pricing)\n`;
        }
      }

      alert(message);
    }

    // -----------------------------
    // LOGIC PORTAL
    // -----------------------------

    let roomLogicData = {};
    let workbench = null;

    function toggleWorkbench() {
      const container = document.getElementById('workbench-container');
      const button = document.getElementById('workbench-toggle');
      
      if (container.classList.contains('active')) {
        // Close workbench
        container.classList.remove('active');
        button.classList.remove('active');
      } else {
        // Open workbench
        container.classList.add('active');
        button.classList.add('active');
        
        // Initialize or refresh workbench
        if (!workbench) {
          workbench = new IsometricWorkbench('workbench-canvas');
        }
        
        // Load current project data
        workbenchReload();
      }
    }

    function workbenchReload() {
      if (!workbench) return;
      
      // Get current project departments from the tree
      const departments = [];
      const project = getCurrentProject();
      
      Object.keys(project.departments || {}).forEach(deptName => {
        const dept = project.departments[deptName];
        const rooms = [];
        
        Object.keys(dept.functionalAreas || {}).forEach(faName => {
          const fa = dept.functionalAreas[faName];
          (fa.rooms || []).forEach(room => {
            const qty = room.quantity || 1;
            // Create one room entry per quantity so each gets a cube
            for (let i = 0; i < qty; i++) {
              rooms.push({
                room_code: room.roomCode,
                room_name: room.roomName + (qty > 1 ? ` #${i + 1}` : ''),
                functional_area: faName,
                nsf: room.nsf || 100,
                quantity: 1
              });
            }
          });
        });
        
        departments.push({
          name: deptName,
          rooms: rooms
        });
      });
      
      workbench.loadFromProject(departments);
    }

    function workbenchAutoArrange() {
      if (!workbench) return;
      workbench.autoArrange();
    }
    
    function workbenchSetBackground(style) {
      if (!workbench) return;
      workbench.setBackgroundStyle(style);
    }

    function workbenchToggleView() {
      if (!workbench) return;
      workbench.toggleViewMode();
      
      // Update button text
      const btn = document.getElementById('view-toggle-btn');
      if (workbench.viewMode === 'elevation') {
        btn.textContent = 'üìê 45¬∞/45¬∞ View';
      } else {
        btn.textContent = 'üìê Top-Down View';
      }
    }

    function openLogicPortal() {
      document.getElementById('password-modal').classList.add('active');
      document.getElementById('portal-password').value = '';
      document.getElementById('password-error').style.display = 'none';
      setTimeout(() => document.getElementById('portal-password').focus(), 100);
    }

    function closePasswordModal() {
      document.getElementById('password-modal').classList.remove('active');
    }

    function checkPassword() {
      const password = document.getElementById('portal-password').value;
      if (password === 'CARTER') {
        closePasswordModal();
        showLogicPortal();
      } else {
        document.getElementById('password-error').style.display = 'block';
        document.getElementById('portal-password').select();
      }
    }

    function showLogicPortal() {
      loadRoomLogic();
      renderLogicRoomsList();
      document.getElementById('logic-portal-modal').classList.add('active');
    }

    function closeLogicPortal() {
      document.getElementById('logic-portal-modal').classList.remove('active');
    }

    // -----------------------------
    // DATA SYNC FUNCTIONS
    // -----------------------------

    function openDataSyncModal() {
      document.getElementById('data-sync-modal').classList.add('active');
      // Load saved config
      const savedRepo = localStorage.getItem('github-repo') || 'LeCartier/Arrange';
      const savedBranch = localStorage.getItem('github-branch') || 'main';
      document.getElementById('github-repo').value = savedRepo;
      document.getElementById('github-branch').value = savedBranch;
      
      // Reset status
      document.getElementById('sync-status').innerHTML = '<div style="color: var(--muted);">Ready to sync...</div>';
    }

    function closeDataSyncModal() {
      document.getElementById('data-sync-modal').classList.remove('active');
    }

    function logSync(message, type = 'info') {
      const statusDiv = document.getElementById('sync-status');
      const color = type === 'error' ? '#ff6b6b' : type === 'success' ? '#51cf66' : type === 'warning' ? '#ffd93d' : 'var(--text)';
      const timestamp = new Date().toLocaleTimeString();
      statusDiv.innerHTML += `<div style="color: ${color}; margin-bottom: 4px;">[${timestamp}] ${message}</div>`;
      statusDiv.scrollTop = statusDiv.scrollHeight;
    }

    async function syncDataFromGitHub() {
      const repo = document.getElementById('github-repo').value.trim();
      const branch = document.getElementById('github-branch').value.trim();
      const createBackup = document.getElementById('backup-before-sync').checked;

      if (!repo) {
        alert('Please enter a GitHub repository');
        return;
      }

      // Save config
      localStorage.setItem('github-repo', repo);
      localStorage.setItem('github-branch', branch);

      // Clear status
      document.getElementById('sync-status').innerHTML = '';
      logSync('Starting data sync...', 'info');

      try {
        // Create backup if requested
        if (createBackup) {
          logSync('Creating backup of current data...', 'info');
          const backup = {
            timestamp: new Date().toISOString(),
            ROOM_SIZES: typeof ROOM_SIZES !== 'undefined' ? ROOM_SIZES : [],
            EQUIPMENT_LIST: typeof EQUIPMENT_LIST !== 'undefined' ? EQUIPMENT_LIST : [],
            ROOM_EQUIPMENT_MAPPINGS: typeof ROOM_EQUIPMENT_MAPPINGS !== 'undefined' ? ROOM_EQUIPMENT_MAPPINGS : []
          };
          localStorage.setItem('data-backup-' + Date.now(), JSON.stringify(backup));
          logSync('Backup created successfully', 'success');
        }

        // Fetch room criteria TSV
        logSync('Fetching room_criteria.tsv...', 'info');
        const roomCriteriaUrl = `https://raw.githubusercontent.com/${repo}/${branch}/src/room_criteria.tsv`;
        const roomResponse = await fetch(roomCriteriaUrl);
        
        if (!roomResponse.ok) {
          throw new Error(`Failed to fetch room_criteria.tsv: ${roomResponse.status}`);
        }
        
        const roomData = await roomResponse.text();
        logSync(`Downloaded room_criteria.tsv (${(roomData.length / 1024).toFixed(1)} KB)`, 'success');

        // Fetch equipment guide
        logSync('Fetching Equipment_Guide_parsed_v2.txt...', 'info');
        const equipUrl = `https://raw.githubusercontent.com/${repo}/${branch}/src/Equipment_Guide_parsed_v2.txt`;
        const equipResponse = await fetch(equipUrl);
        
        if (!equipResponse.ok) {
          throw new Error(`Failed to fetch Equipment_Guide_parsed_v2.txt: ${equipResponse.status}`);
        }
        
        const equipData = await equipResponse.text();
        logSync(`Downloaded Equipment_Guide_parsed_v2.txt (${(equipData.length / 1024).toFixed(1)} KB)`, 'success');

        // Parse TSV data
        logSync('Parsing room criteria data...', 'info');
        const newRoomSizes = parseTSVData(roomData);
        logSync(`Parsed ${newRoomSizes.length} rooms`, 'success');

        // Parse equipment data
        logSync('Parsing equipment data...', 'info');
        const { equipmentList, mappings } = parseEquipmentData(equipData);
        logSync(`Parsed ${equipmentList.length} equipment items and ${mappings.length} mappings`, 'success');

        // Update global variables
        if (newRoomSizes.length > 0) {
          window.ROOM_SIZES = newRoomSizes;
          logSync('Updated ROOM_SIZES', 'success');
        }
        
        if (equipmentList.length > 0) {
          window.EQUIPMENT_LIST = equipmentList;
          logSync('Updated EQUIPMENT_LIST', 'success');
        }
        
        if (mappings.length > 0) {
          window.ROOM_EQUIPMENT_MAPPINGS = mappings;
          logSync('Updated ROOM_EQUIPMENT_MAPPINGS', 'success');
        }

        // Store update timestamp
        localStorage.setItem('last-data-sync', new Date().toISOString());

        logSync('‚úì Data sync completed successfully!', 'success');
        logSync('Refreshing UI...', 'info');
        
        // Refresh the UI
        renderAll();
        
        setTimeout(() => {
          alert('Data sync completed! The application has been updated with the latest data.');
          closeDataSyncModal();
        }, 1000);

      } catch (error) {
        logSync(`‚úó Error: ${error.message}`, 'error');
        console.error('Sync error:', error);
      }
    }

    function parseTSVData(tsvText) {
      const lines = tsvText.trim().split('\n');
      if (lines.length < 2) return [];

      const headers = lines[0].split('\t');
      const rooms = [];

      for (let i = 1; i < lines.length; i++) {
        const values = lines[i].split('\t');
        const room = {};
        
        headers.forEach((header, index) => {
          let value = values[index] || '';
          
          // Remove surrounding quotes if present (common in TSV/CSV for fields with commas)
          if (value.startsWith('"') && value.endsWith('"')) {
            value = value.slice(1, -1);
          }
          
          // Convert to appropriate type
          if (value === '') {
            room[header] = null;
          } else if (!isNaN(value) && value !== '') {
            room[header] = parseFloat(value);
          } else {
            room[header] = value;
          }
        });

        if (room.roomCode) {
          rooms.push(room);
        }
      }

      return rooms;
    }

    function parseEquipmentData(equipText) {
      // This is a simplified parser - adjust based on your actual file format
      const lines = equipText.trim().split('\n');
      const equipmentList = [];
      const mappings = [];
      
      let currentSection = null;
      
      for (const line of lines) {
        if (line.startsWith('EQUIPMENT:')) {
          currentSection = 'equipment';
          continue;
        } else if (line.startsWith('MAPPINGS:')) {
          currentSection = 'mappings';
          continue;
        }

        if (currentSection === 'equipment' && line.trim()) {
          const parts = line.split('|');
          if (parts.length >= 3) {
            equipmentList.push({
              jsn: parts[0].trim(),
              name: parts[1].trim(),
              description: parts[2].trim()
            });
          }
        } else if (currentSection === 'mappings' && line.trim()) {
          const parts = line.split('|');
          if (parts.length >= 5) {
            mappings.push({
              roomCode: parts[0].trim(),
              department: parts[1].trim(),
              functionalArea: parts[2].trim(),
              equipmentJsn: parts[3].trim(),
              quantity: parseInt(parts[4]) || 1
            });
          }
        }
      }

      return { equipmentList, mappings };
    }

    function loadRoomLogic() {
      // Load existing logic from localStorage
      const saved = localStorage.getItem('roomLogicData');
      if (saved) {
        try {
          roomLogicData = JSON.parse(saved);
        } catch (e) {
          roomLogicData = {};
        }
      }

      // Initialize with all rooms from ROOM_SIZES
      if (typeof ROOM_SIZES !== 'undefined') {
        ROOM_SIZES.forEach(room => {
          if (!roomLogicData[room.id]) {
            roomLogicData[room.id] = {
              code: room.id,
              name: room.name,
              minQty: '',
              maxQty: '',
              qtyFormula: '',
              nsfFormula: room.nsf ? String(room.nsf) : '',
              variables: '',
              notes: ''
            };
          } else {
            // Update name if it changed
            roomLogicData[room.id].name = room.name;
            // Update NSF if not set
            if (!roomLogicData[room.id].nsfFormula && room.nsf) {
              roomLogicData[room.id].nsfFormula = String(room.nsf);
            }
          }
        });
      }
    }

    let currentLogicPage = 0;
    const LOGIC_PAGE_SIZE = 50; // Show 50 rooms at a time

    function renderLogicRoomsList(append = false) {
      const container = document.getElementById('logic-rooms-list');
      const searchTerm = (document.getElementById('logic-search-box')?.value || '').toLowerCase();
      
      const allRooms = Object.values(roomLogicData)
        .filter(room => {
          if (!searchTerm) return true;
          return room.code.toLowerCase().includes(searchTerm) ||
                 room.name.toLowerCase().includes(searchTerm);
        })
        .sort((a, b) => a.code.localeCompare(b.code));

      // Reset page on new search
      if (!append) {
        currentLogicPage = 0;
      }

      const start = currentLogicPage * LOGIC_PAGE_SIZE;
      const end = start + LOGIC_PAGE_SIZE;
      const rooms = allRooms.slice(start, end);
      const hasMore = end < allRooms.length;

      const html = rooms.map(room => {
        const hasLogic = room.qtyFormula || room.minQty || room.maxQty || room.notes;
        const status = hasLogic ? 
          (room.qtyFormula && room.minQty && room.maxQty ? 'complete' : 'partial') : 'empty';
        const statusText = status === 'complete' ? 'Complete' : 
                          status === 'partial' ? 'Partial' : 'No Logic';
        
        const escapedCode = escapeHtml(room.code).replace(/'/g, '&#39;');
        const displayCode = escapeHtml(room.code);
        const displayName = escapeHtml(room.name);
        const displayMinQty = escapeHtml(room.minQty || '');
        const displayMaxQty = escapeHtml(room.maxQty || '');
        const displayQtyFormula = escapeHtml(room.qtyFormula || '');
        const displayNsfFormula = escapeHtml(room.nsfFormula || '');
        const displayVariables = escapeHtml(room.variables || '');
        const displayNotes = escapeHtml(room.notes || '');

        return `
          <div class="logic-card">
            <div class="logic-card-header">
              <div class="logic-card-title">
                <div class="logic-card-code">${displayCode}</div>
                <div class="logic-card-name">${displayName}</div>
              </div>
              <span class="logic-status ${status}">${statusText}</span>
            </div>
            
            <div class="logic-fields">
              <div class="logic-field">
                <label class="logic-field-label">Minimum Qty:</label>
                <input type="text" class="logic-field-input" 
                       value="${displayMinQty}" 
                       data-room-code="${escapedCode}"
                       onchange="updateRoomLogic(this.dataset.roomCode, 'minQty', this.value)"
                       placeholder="e.g., 1 or 0">
              </div>
              
              <div class="logic-field">
                <label class="logic-field-label">Maximum Qty:</label>
                <input type="text" class="logic-field-input" 
                       value="${displayMaxQty}" 
                       data-room-code="${escapedCode}"
                       onchange="updateRoomLogic(this.dataset.roomCode, 'maxQty', this.value)"
                       placeholder="e.g., 20 or unlimited">
              </div>
              
              <div class="logic-field">
                <label class="logic-field-label">Quantity Formula:</label>
                <textarea class="logic-field-textarea" 
                          data-room-code="${escapedCode}"
                          onchange="updateRoomLogic(this.dataset.roomCode, 'qtyFormula', this.value)"
                          placeholder="e.g., annualVisits / 2000 or 1 per 10 beds">${displayQtyFormula}</textarea>
              </div>
              <div class="logic-help-text">Enter calculation formula or text description</div>
              
              <div class="logic-field">
                <label class="logic-field-label">NSF per Room:</label>
                <input type="text" class="logic-field-input" 
                       value="${displayNsfFormula}" 
                       data-room-code="${escapedCode}"
                       onchange="updateRoomLogic(this.dataset.roomCode, 'nsfFormula', this.value)"
                       placeholder="e.g., 120 or varies">
              </div>
              
              <div class="logic-field">
                <label class="logic-field-label">Variables Used:</label>
                <input type="text" class="logic-field-input" 
                       value="${displayVariables}" 
                       data-room-code="${escapedCode}"
                       onchange="updateRoomLogic(this.dataset.roomCode, 'variables', this.value)"
                       placeholder="e.g., numBeds, annualVisits">
              </div>
              <div class="logic-help-text">Comma-separated list of project variables</div>
              
              <div class="logic-field">
                <label class="logic-field-label">Notes:</label>
                <textarea class="logic-field-textarea" 
                          data-room-code="${escapedCode}"
                          onchange="updateRoomLogic(this.dataset.roomCode, 'notes', this.value)"
                          placeholder="Section 4 & 5 notes from PDF...">${displayNotes}</textarea>
              </div>
              <div class="logic-help-text">Reference to PDF sections or calculation notes</div>
            </div>
          </div>
        `;
      }).join('');
    }

    function updateRoomLogic(code, field, value) {
      if (!roomLogicData[code]) {
        roomLogicData[code] = { code };
      }
      roomLogicData[code][field] = value;
    }

    const filterLogicRooms = debounce(() => {
      renderLogicRoomsList();
    }, 300);

    function saveAllLogic() {
      try {
        localStorage.setItem('roomLogicData', JSON.stringify(roomLogicData));
        alert('‚úÖ Room logic saved successfully to browser storage!');
      } catch (e) {
        alert('‚ùå Error saving logic: ' + e.message);
      }
    }

    function exportLogic() {
      try {
        const dataStr = JSON.stringify(roomLogicData, null, 2);
        const dataBlob = new Blob([dataStr], { type: 'application/json' });
        const url = URL.createObjectURL(dataBlob);
        const link = document.createElement('a');
        link.href = url;
        link.download = `room-logic-${new Date().toISOString().split('T')[0]}.json`;
        link.click();
        URL.revokeObjectURL(url);
        alert('‚úÖ Room logic exported successfully!');
      } catch (e) {
        alert('‚ùå Error exporting logic: ' + e.message);
      }
    }

    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Close modals when clicking outside
    window.addEventListener('click', (e) => {
      if (e.target.id === 'password-modal') closePasswordModal();
      if (e.target.id === 'logic-portal-modal') closeLogicPortal();
      if (e.target.id === 'import-modal') closeImportModal();
      if (e.target.id === 'equipment-modal') closeEquipmentModal();
      if (e.target.id === 'ifc-checker-modal') closeIFCChecker();
    });

    // -----------------------------
    // IFC CHECKER INTEGRATION
    // -----------------------------
    
    let ifcCheckerInstance = null;
    
    function openIFCChecker() {
      let modal = document.getElementById('ifc-checker-modal');
      if (!modal) {
        modal = document.createElement('div');
        modal.id = 'ifc-checker-modal';
        modal.className = 'modal';
        modal.innerHTML = `
          <div class="modal-content" style="max-width: 1200px; width: 95%; max-height: 90vh; overflow: auto;">
            <div class="modal-header">
              <h2>üèóÔ∏è IFC Model Checker</h2>
              <span class="close-btn" onclick="closeIFCChecker()">&times;</span>
            </div>
            <div id="ifc-checker-container"></div>
          </div>
        `;
        document.body.appendChild(modal);
      }
      modal.style.display = 'flex';
      
      // Initialize IFC Checker if not already done
      if (!ifcCheckerInstance) {
        initializeIFCChecker();
      }
    }
    
    function closeIFCChecker() {
      const modal = document.getElementById('ifc-checker-modal');
      if (modal) {
        modal.style.display = 'none';
      }
    }
    
    async function initializeIFCChecker() {
      try {
        // Dynamically import the IFC Checker UI
        const { IFCCheckerApp } = await import('./ifc-checker/ifc-checker-ui.js');
        ifcCheckerInstance = new IFCCheckerApp('ifc-checker-container');
        
        // Make workbench data available for the checker
        if (typeof workbenchResults !== 'undefined') {
          window.workbenchResults = workbenchResults;
        }
        
        // Make equipment data available
        if (typeof EQUIPMENT_LIST !== 'undefined') {
          window.EQUIPMENT_LIST = EQUIPMENT_LIST;
        }
        
        console.log('IFC Checker initialized successfully');
      } catch (error) {
        console.error('Error initializing IFC Checker:', error);
        document.getElementById('ifc-checker-container').innerHTML = `
          <div style="padding: 40px; text-align: center;">
            <h3>‚ö†Ô∏è IFC Checker Loading Error</h3>
            <p style="color: var(--muted);">Could not load the IFC Checker module.</p>
            <p style="color: var(--muted); font-size: 0.85rem;">Error: ${error.message}</p>
            <p style="color: var(--muted); font-size: 0.85rem; margin-top: 20px;">
              Note: The IFC Checker requires a web server to load modules properly.<br>
              Try running: <code>npx serve</code> or <code>python -m http.server</code>
            </p>
          </div>
        `;
      }
    }

    // -----------------------------
    // REVIT CONNECTION
    // -----------------------------
    
    let revitConnector = null;
    let revitConnectionTimer = null;

    async function initRevitConnection() {
      try {
        const { RevitConnector } = await import('./revit-connector.js');
        revitConnector = new RevitConnector({
          onStatusChange: updateRevitStatusUI
        });
        
        // Try to connect
        await revitConnector.connect();
      } catch (error) {
        console.log('Revit connector not available:', error.message);
      }
    }

    function updateRevitStatusUI(connected, data) {
      const indicator = document.getElementById('revit-status');
      if (!indicator) return;
      
      const dot = indicator.querySelector('.status-dot');
      const text = indicator.querySelector('.status-text');
      
      if (connected) {
        dot.className = 'status-dot connected';
        text.textContent = data.project ? `Revit: ${data.project}` : 'Revit Connected';
        indicator.title = `Connected to Revit - ${data.project || 'Unknown Project'}`;
      } else {
        dot.className = 'status-dot disconnected';
        text.textContent = 'Revit';
        indicator.title = 'Revit not connected. Start Live Sync in pyRevit.';
      }
    }

    // Toggle Revit connection when clicking the indicator
    document.getElementById('revit-status')?.addEventListener('click', async () => {
      if (!revitConnector) {
        await initRevitConnection();
        return;
      }
      
      const indicator = document.getElementById('revit-status');
      const dot = indicator.querySelector('.status-dot');
      
      if (revitConnector.connected) {
        revitConnector.disconnect();
      } else {
        dot.className = 'status-dot connecting';
        await revitConnector.connect();
      }
    });

    // Initialize Revit connection on page load
    setTimeout(initRevitConnection, 1000);

    // Compare project with Revit model
    async function compareWithRevit() {
      if (!revitConnector || !revitConnector.connected) {
        alert('Not connected to Revit. Please start Live Sync in the pyRevit extension first.');
        return;
      }
      
      if (!currentProject || !currentProject.departments) {
        alert('Please open a project first.');
        return;
      }
      
      try {
        // Show loading
        const statusDiv = document.createElement('div');
        statusDiv.className = 'toast loading';
        statusDiv.innerHTML = 'üîÑ Comparing with Revit model...';
        document.body.appendChild(statusDiv);
        
        const comparison = await revitConnector.compareWithArrangeProject(currentProject);
        
        // Remove loading toast
        statusDiv.remove();
        
        // Show results modal
        showRevitComparisonModal(comparison);
      } catch (error) {
        alert('Error comparing with Revit: ' + error.message);
      }
    }

    function showRevitComparisonModal(comparison) {
      // Create or update modal
      let modal = document.getElementById('revit-comparison-modal');
      if (!modal) {
        modal = document.createElement('div');
        modal.id = 'revit-comparison-modal';
        modal.className = 'modal';
        document.body.appendChild(modal);
      }
      
      const matchedCount = comparison.matched.length;
      const mismatchCount = comparison.mismatches.length;
      const revitOnlyCount = comparison.inRevitOnly.length;
      const arrangeOnlyCount = comparison.inArrangeOnly.length;
      
      modal.innerHTML = `
        <div class="modal-content" style="max-width: 900px; max-height: 80vh; overflow: auto;">
          <div class="modal-header">
            <h2>üîç Revit Model Comparison</h2>
            <button class="close-btn" onclick="document.getElementById('revit-comparison-modal').classList.remove('active')">√ó</button>
          </div>
          <div class="modal-body">
            <div class="comparison-summary" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; margin-bottom: 1.5rem;">
              <div style="background: #51cf66; color: white; padding: 1rem; border-radius: 8px; text-align: center;">
                <div style="font-size: 2rem; font-weight: bold;">${matchedCount}</div>
                <div>Matched</div>
              </div>
              <div style="background: ${mismatchCount > 0 ? '#ffd93d' : '#ccc'}; color: ${mismatchCount > 0 ? '#333' : '#666'}; padding: 1rem; border-radius: 8px; text-align: center;">
                <div style="font-size: 2rem; font-weight: bold;">${mismatchCount}</div>
                <div>Mismatches</div>
              </div>
              <div style="background: ${revitOnlyCount > 0 ? '#74b9ff' : '#ccc'}; color: white; padding: 1rem; border-radius: 8px; text-align: center;">
                <div style="font-size: 2rem; font-weight: bold;">${revitOnlyCount}</div>
                <div>Revit Only</div>
              </div>
              <div style="background: ${arrangeOnlyCount > 0 ? '#ff6b6b' : '#ccc'}; color: white; padding: 1rem; border-radius: 8px; text-align: center;">
                <div style="font-size: 2rem; font-weight: bold;">${arrangeOnlyCount}</div>
                <div>Arrange Only</div>
              </div>
            </div>
            
            ${mismatchCount > 0 ? `
            <div class="comparison-section" style="margin-bottom: 1rem;">
              <h3 style="color: #ffd93d; border-bottom: 2px solid #ffd93d; padding-bottom: 0.5rem;">‚ö†Ô∏è Mismatches (${mismatchCount})</h3>
              <table style="width: 100%; border-collapse: collapse; font-size: 0.9rem;">
                <thead>
                  <tr style="background: rgba(255,217,61,0.2);">
                    <th style="padding: 8px; text-align: left; border-bottom: 1px solid #444;">Room</th>
                    <th style="padding: 8px; text-align: left; border-bottom: 1px solid #444;">Code</th>
                    <th style="padding: 8px; text-align: left; border-bottom: 1px solid #444;">Issues</th>
                    <th style="padding: 8px; text-align: center; border-bottom: 1px solid #444;">Action</th>
                  </tr>
                </thead>
                <tbody>
                  ${comparison.mismatches.map(m => `
                    <tr>
                      <td style="padding: 8px; border-bottom: 1px solid #333;">${m.revit.number}</td>
                      <td style="padding: 8px; border-bottom: 1px solid #333;">${m.arrange.code || '-'}</td>
                      <td style="padding: 8px; border-bottom: 1px solid #333;">${m.issues.join('<br>')}</td>
                      <td style="padding: 8px; border-bottom: 1px solid #333; text-align: center;">
                        <button onclick="revitConnector.selectElements([${m.revit.id}])" style="padding: 4px 8px; cursor: pointer;">Select</button>
                      </td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            </div>
            ` : ''}
            
            ${arrangeOnlyCount > 0 ? `
            <div class="comparison-section" style="margin-bottom: 1rem;">
              <h3 style="color: #ff6b6b; border-bottom: 2px solid #ff6b6b; padding-bottom: 0.5rem;">üî¥ In Arrange Only (${arrangeOnlyCount})</h3>
              <p style="font-size: 0.85rem; color: var(--muted); margin-bottom: 0.5rem;">These rooms exist in your Arrange project but were not found in Revit:</p>
              <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                ${comparison.inArrangeOnly.slice(0, 20).map(r => `
                  <span style="background: rgba(255,107,107,0.2); padding: 4px 8px; border-radius: 4px; font-size: 0.85rem;">
                    ${r.code || r.roomNumber || 'Unknown'} - ${(r.name || '').substring(0, 25)}
                  </span>
                `).join('')}
                ${arrangeOnlyCount > 20 ? `<span style="color: var(--muted);">...and ${arrangeOnlyCount - 20} more</span>` : ''}
              </div>
            </div>
            ` : ''}
            
            ${revitOnlyCount > 0 ? `
            <div class="comparison-section" style="margin-bottom: 1rem;">
              <h3 style="color: #74b9ff; border-bottom: 2px solid #74b9ff; padding-bottom: 0.5rem;">üîµ In Revit Only (${revitOnlyCount})</h3>
              <p style="font-size: 0.85rem; color: var(--muted); margin-bottom: 0.5rem;">These rooms exist in Revit but not in your Arrange project:</p>
              <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                ${comparison.inRevitOnly.slice(0, 20).map(r => `
                  <span onclick="revitConnector.selectElements([${r.id}])" style="background: rgba(116,185,255,0.2); padding: 4px 8px; border-radius: 4px; font-size: 0.85rem; cursor: pointer;">
                    ${r.number} - ${(r.name || '').substring(0, 25)}
                  </span>
                `).join('')}
                ${revitOnlyCount > 20 ? `<span style="color: var(--muted);">...and ${revitOnlyCount - 20} more</span>` : ''}
              </div>
            </div>
            ` : ''}
            
            ${matchedCount > 0 && mismatchCount === 0 && arrangeOnlyCount === 0 ? `
            <div style="text-align: center; padding: 2rem; background: rgba(81,207,102,0.1); border-radius: 8px;">
              <span style="font-size: 3rem;">‚úÖ</span>
              <h3 style="color: #51cf66; margin-top: 1rem;">All rooms matched!</h3>
              <p style="color: var(--muted);">Your Arrange project is in sync with the Revit model.</p>
            </div>
            ` : ''}
          </div>
        </div>
      `;
      
      modal.classList.add('active');
    }

    // Add click handler to Revit status for context menu
    document.getElementById('revit-status')?.addEventListener('contextmenu', async (e) => {
      e.preventDefault();
      if (revitConnector && revitConnector.connected) {
        // Show options menu
        const menu = document.createElement('div');
        menu.className = 'context-menu';
        menu.style.cssText = 'position: fixed; background: var(--card-bg); border: 1px solid var(--border); border-radius: 8px; padding: 0.5rem; z-index: 10000; box-shadow: 0 4px 12px rgba(0,0,0,0.3);';
        menu.style.left = e.clientX + 'px';
        menu.style.top = e.clientY + 'px';
        menu.innerHTML = `
          <button style="display: block; width: 100%; padding: 8px 12px; border: none; background: none; color: var(--text); cursor: pointer; text-align: left;" onclick="compareWithRevit(); this.parentElement.remove();">üîç Compare with Revit</button>
          <button style="display: block; width: 100%; padding: 8px 12px; border: none; background: none; color: var(--text); cursor: pointer; text-align: left;" onclick="validateRevitRooms(); this.parentElement.remove();">‚úÖ Validate Revit Rooms</button>
          <button style="display: block; width: 100%; padding: 8px 12px; border: none; background: none; color: var(--text); cursor: pointer; text-align: left;" onclick="revitConnector.disconnect(); this.parentElement.remove();">‚ùå Disconnect</button>
        `;
        document.body.appendChild(menu);
        
        // Remove on click outside
        setTimeout(() => {
          document.addEventListener('click', function removeMenu() {
            menu.remove();
            document.removeEventListener('click', removeMenu);
          });
        }, 100);
      }
    });

    // Validate Revit rooms
    async function validateRevitRooms() {
      if (!revitConnector || !revitConnector.connected) {
        alert('Not connected to Revit.');
        return;
      }
      
      try {
        const result = await revitConnector.validateRooms();
        
        let html = `
          <div class="modal-content" style="max-width: 800px; max-height: 80vh; overflow: auto;">
            <div class="modal-header">
              <h2>‚úÖ Revit Room Validation</h2>
              <button class="close-btn" onclick="document.getElementById('revit-validation-modal').classList.remove('active')">√ó</button>
            </div>
            <div class="modal-body">
              <p>Validated <strong>${result.total_rooms}</strong> rooms: <span style="color: #ff6b6b;">${result.total_issues} issues</span>, <span style="color: #ffd93d;">${result.total_warnings} warnings</span></p>
              
              ${result.results.filter(r => r.issues.length > 0 || r.warnings.length > 0).map(r => `
                <div style="border: 1px solid var(--border); border-radius: 8px; padding: 1rem; margin-bottom: 1rem;">
                  <h4 style="margin-bottom: 0.5rem;">Room ${r.number} - ${r.name} ${r.code ? `(${r.code})` : ''}</h4>
                  ${r.issues.map(i => `<div style="color: #ff6b6b;">‚ùå ${i}</div>`).join('')}
                  ${r.warnings.map(w => `<div style="color: #ffd93d;">‚ö†Ô∏è ${w}</div>`).join('')}
                  <button onclick="revitConnector.selectElements([${r.id}])" style="margin-top: 0.5rem; padding: 4px 8px; cursor: pointer;">Select in Revit</button>
                </div>
              `).join('')}
              
              ${result.total_issues === 0 && result.total_warnings === 0 ? `
                <div style="text-align: center; padding: 2rem;">
                  <span style="font-size: 3rem;">üéâ</span>
                  <h3 style="color: #51cf66;">All rooms pass validation!</h3>
                </div>
              ` : ''}
            </div>
          </div>
        `;
        
        let modal = document.getElementById('revit-validation-modal');
        if (!modal) {
          modal = document.createElement('div');
          modal.id = 'revit-validation-modal';
          modal.className = 'modal';
          document.body.appendChild(modal);
        }
        modal.innerHTML = html;
        modal.classList.add('active');
      } catch (error) {
        alert('Error validating rooms: ' + error.message);
      }
    }

    // -----------------------------
    // INITIALIZE
    // -----------------------------


    // Initialize application
    // Data loading happens above via fetch, so we just need to wait for it
    
    // Start in project list view
    viewState = 'project-list';
    
    // Note: renderAll() is called after data enrichment completes in the fetch above
  </script>
</body>
</html>