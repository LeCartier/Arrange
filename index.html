<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Hospital Programming Workbench</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  
  <!-- Room Logic System -->
  <script type="module" src="room-logic/index.js"></script>
  <script type="module" src="room-logic/engine.js"></script>
  <script type="module">
    // Import room logic functions and make them globally available
    import { getChapter, getAllChapters, searchChapters } from './room-logic/index.js';
    import { evaluateChapter, formatForDisplay, exportResults, importResults } from './room-logic/engine.js';
    
    // Make available globally for onclick handlers
    window.RoomLogic = {
      getChapter,
      getAllChapters,
      searchChapters,
      evaluateChapter,
      formatForDisplay,
      exportResults,
      importResults
    };
    
    console.log('Room Logic System loaded');
    console.log('Available chapters:', getAllChapters());
  </script>
  
  <style>
    :root {
      --bg: #060606;
      --bg-card: #111;
      --border: #444;
      --text: #f5f5f5;
      --muted: #aaaaaa;
      --accent: #00b894;
      --pill-inactive: #333;
      --input-bg: #111;
      --input-border: #555;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      padding: 24px;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background-color: var(--bg);
      color: var(--text);
    }

    h1, h2, h3, h4 {
      margin: 0;
    }

    p {
      margin: 0;
    }

    header {
      margin-bottom: 24px;
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 20px;
    }

    header .header-content {
      flex: 1;
    }

    header .header-actions {
      display: flex;
      gap: 12px;
      padding-top: 4px;
    }

    header .icon-btn {
      width: 40px;
      height: 40px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    header .icon-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }

    header .icon-btn.portal {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    header .icon-btn.sync {
      background: linear-gradient(135deg, #00b894 0%, #00cec9 100%);
      color: white;
    }

    header .icon-btn.workbench {
      background: linear-gradient(135deg, #ff6b6b 0%, #feca57 100%);
      color: white;
    }

    header .icon-btn.workbench.active {
      background: linear-gradient(135deg, #feca57 0%, #ff6b6b 100%);
      box-shadow: 0 0 20px rgba(254, 202, 87, 0.5);
    }

    header p {
      margin-top: 8px;
      color: var(--muted);
      max-width: 800px;
      font-size: 0.95rem;
    }

    .layout {
      display: grid;
      grid-template-columns: minmax(320px, 400px) minmax(0, 1fr);
      gap: 24px;
      align-items: flex-start;
    }

    .layout.compare-mode {
      grid-template-columns: minmax(320px, 400px) minmax(0, 1fr) minmax(0, 1fr);
    }

    #left-column {
      display: block;
    }

    #right-column {
      display: block;
    }

    #compare-column {
      display: none;
    }

    .layout.compare-mode #compare-column {
      display: block;
    }

    .compare-column {
      background: var(--bg-card);
      border-radius: 12px;
      padding: 20px;
      border: 2px dashed var(--border);
      min-height: 400px;
      transition: border-color 0.2s;
    }

    .compare-column.drag-over {
      border-color: var(--accent);
      background: rgba(0, 184, 148, 0.05);
    }

    .compare-column h3 {
      margin-bottom: 12px;
      color: var(--muted);
      font-size: 1rem;
    }

    .compare-search {
      width: 100%;
      padding: 8px 12px;
      background: var(--input-bg);
      border: 1px solid var(--input-border);
      border-radius: 6px;
      color: var(--text);
      font-size: 0.9rem;
      margin-bottom: 16px;
    }

    .compare-room-display {
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 16px;
    }

    .compare-room-display h4 {
      margin-bottom: 12px;
      color: var(--accent);
    }

    .compare-room-display .detail-row {
      display: flex;
      justify-content: space-between;
      padding: 6px 0;
      border-bottom: 1px solid var(--border);
    }

    .compare-room-display .detail-row:last-child {
      border-bottom: none;
    }

    @media (max-width: 900px) {
      .layout {
        grid-template-columns: 1fr;
      }
      
      .layout.compare-mode {
        grid-template-columns: 1fr;
      }
      
      .layout.compare-mode #left-column {
        order: 1;
      }
      
      .layout.compare-mode #right-column {
        order: 2;
      }
      
      .layout.compare-mode #compare-column {
        order: 3;
      }
    }

    /* Tree View Styles */
    .tree-container {
      background-color: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 16px;
      max-height: calc(100vh - 200px);
      overflow-y: auto;
    }

    .tree-header {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-bottom: 16px;
    }

    .tree-header-top {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .tree-header-title {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .back-to-projects-btn {
      padding: 4px 10px;
      font-size: 0.85rem;
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      color: var(--text);
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .back-to-projects-btn:hover {
      background: var(--bg-hover);
    }

    .mode-toggle {
      display: flex;
      gap: 8px;
    }

    .mode-btn {
      padding: 6px 12px;
      border-radius: 6px;
      border: 1px solid var(--border);
      background-color: var(--pill-inactive);
      color: var(--text);
      font-size: 0.75rem;
      cursor: pointer;
      transition: all 0.15s ease;
    }

    .mode-btn.active {
      background-color: var(--accent);
      border-color: var(--accent);
    }

    .mode-btn:hover {
      transform: translateY(-1px);
    }

    .tree-node {
      margin-left: 0;
    }

    .tree-item {
      position: relative;
      display: flex;
      align-items: center;
      padding: 6px 8px 6px 28px;
      cursor: pointer;
      border-radius: 4px;
      transition: background-color 0.15s ease;
      user-select: none;
    }

    /* Hide spinner arrows on number inputs */
    input[type="number"]::-webkit-inner-spin-button,
    input[type="number"]::-webkit-outer-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }
    
    input[type="number"] {
      -moz-appearance: textfield;
      appearance: textfield;
    }

    .tree-item:hover {
      background-color: rgba(255, 255, 255, 0.05);
    }

    .tree-item.selected {
      background-color: rgba(0, 184, 148, 0.2);
      border-left: 3px solid var(--accent);
    }

    .tree-item.draggable-item {
      user-select: none;
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
    }

    .tree-item.draggable-item:active {
      cursor: grabbing !important;
    }

    .tree-drag-handle {
      position: absolute;
      left: 0;
      top: 0;
      bottom: 0;
      width: 20px;
      cursor: grab;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      transition: opacity 0.2s;
      z-index: 10;
    }

    .tree-drag-handle::before {
      content: '‚ãÆ';
      font-size: 14px;
      color: var(--muted);
    }

    .tree-item:hover .tree-drag-handle {
      opacity: 1;
    }

    .tree-drag-handle:active {
      cursor: grabbing;
    }

    .tree-item {
      position: relative;
      padding-left: 24px;
    }

    .tree-item.drag-over {
      border-top: 2px solid var(--accent);
      background-color: rgba(0, 184, 148, 0.1);
    }

    .tree-item[draggable="true"] {
      -webkit-user-drag: element;
    }

    .tree-toggle {
      width: 16px;
      height: 16px;
      margin-right: 4px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 0.7rem;
      color: var(--muted);
    }

    .tree-toggle.collapsed::before {
      content: '‚ñ∂';
    }

    .tree-toggle.expanded::before {
      content: '‚ñº';
    }

    .tree-toggle.leaf {
      visibility: hidden;
    }

    .tree-icon {
      margin-right: 6px;
      font-size: 0.85rem;
    }

    .tree-label {
      font-size: 0.85rem;
      flex: 1;
    }

    .tree-count {
      font-size: 0.75rem;
      color: var(--muted);
      margin-left: 8px;
    }

    .tree-children {
      margin-left: 20px;
      display: none;
    }

    .tree-children.expanded {
      display: block;
    }

    .detail-panel {
      background-color: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 10px;
    }

    .detail-panel h3 {
      margin: 0 0 8px 0;
      font-size: 1rem;
      color: var(--accent);
    }

    .detail-row {
      display: grid;
      grid-template-columns: 110px 1fr;
      gap: 8px;
      padding: 4px 0;
      border-bottom: 1px solid #222;
      font-size: 0.8rem;
    }

    .detail-row:last-child {
      border-bottom: none;
    }

    .detail-label {
      font-weight: 600;
      min-width: 120px;
      color: var(--muted);
    }

    .detail-value {
      flex: 1;
    }

    .equipment-list {
      max-height: 400px;
      overflow-y: auto;
    }

    .equipment-item {
      padding: 8px;
      margin: 4px 0;
      background-color: rgba(255, 255, 255, 0.02);
      border-radius: 4px;
      font-size: 0.8rem;
      overflow: hidden; /* Prevent horizontal scroll */
    }

    .equipment-item-header {
      display: flex;
      justify-content: space-between;
      gap: 12px;
      font-weight: 600;
      margin-bottom: 4px;
      min-width: 0; /* Allow flex items to shrink below content size */
    }
    
    .equipment-item-header > span:first-child {
      flex: 1;
      min-width: 0; /* Allow text to wrap/truncate */
      overflow: hidden;
    }
    
    .equipment-item-header > span:last-child {
      flex-shrink: 0; /* Don't shrink the quantity/acq info */
      white-space: nowrap;
    }

    .equipment-item-desc {
      color: var(--muted);
      font-size: 0.75rem;
      line-height: 1.4;
      display: block;
      word-wrap: break-word;
      overflow-wrap: break-word;
    }

    .equipment-item-desc.truncated {
      display: -webkit-box;
      -webkit-line-clamp: 2;
      line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .equipment-item-desc.expanded {
      display: block;
      white-space: normal;
    }

    .equipment-desc-toggle {
      color: var(--primary);
      cursor: pointer;
      font-size: 0.75rem;
      margin-left: 4px;
      text-decoration: underline;
      display: inline;
    }

    .equipment-desc-toggle:hover {
      color: var(--primary-hover);
    }

    /* Logic Portal Styles */
    .logic-card {
      background: var(--bg-card);
      border: 2px solid var(--border);
      border-radius: 8px;
      padding: 20px;
      transition: all 0.2s;
    }

    .logic-card:hover {
      border-color: var(--accent);
      box-shadow: 0 4px 12px rgba(0, 184, 148, 0.2);
    }

    .logic-card-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 15px;
      padding-bottom: 15px;
      border-bottom: 2px solid var(--border);
    }

    .logic-card-title {
      flex: 1;
    }

    .logic-card-code {
      font-weight: bold;
      color: var(--accent);
      font-size: 16px;
      margin-bottom: 5px;
    }

    .logic-card-name {
      color: var(--muted);
      font-size: 14px;
    }

    .logic-fields {
      display: grid;
      gap: 15px;
    }

    .logic-field {
      display: grid;
      grid-template-columns: 150px 1fr;
      gap: 10px;
      align-items: start;
    }

    .logic-field-label {
      font-weight: 600;
      color: var(--text);
      padding-top: 8px;
      font-size: 13px;
    }

    .logic-field-input, .logic-field-textarea {
      padding: 8px 12px;
      border: 2px solid var(--input-border);
      border-radius: 4px;
      font-size: 14px;
      font-family: 'Courier New', monospace;
      background: var(--input-bg);
      color: var(--text);
    }

    .logic-field-input:focus, .logic-field-textarea:focus {
      outline: none;
      border-color: var(--accent);
    }

    .logic-field-textarea {
      min-height: 60px;
      resize: vertical;
    }

    .logic-help-text {
      grid-column: 2;
      font-size: 12px;
      color: var(--muted);
      font-style: italic;
      margin-top: -10px;
    }

    .logic-status {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
    }

    .logic-status.complete {
      background: rgba(0, 184, 148, 0.2);
      color: #00b894;
    }

    .logic-status.partial {
      background: rgba(255, 193, 7, 0.2);
      color: #ffc107;
    }

    .logic-status.empty {
      background: rgba(255, 255, 255, 0.1);
      color: var(--muted);
    }

    .card {
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 16px;
      background-color: var(--bg-card);
      box-shadow: 0 0 12px rgba(0, 0, 0, 0.35);
    }

    .card h2 {
      margin-bottom: 8px;
      font-size: 1.1rem;
    }

    .pill {
      border-radius: 999px;
      padding: 6px 12px;
      margin-right: 8px;
      margin-bottom: 8px;
      border: none;
      cursor: pointer;
      background-color: var(--pill-inactive);
      color: var(--text);
      font-size: 0.75rem;
      transition: background-color 0.15s ease, transform 0.12s ease;
    }

    .pill.active {
      background-color: var(--accent);
    }

    .pill:hover {
      transform: translateY(-1px);
    }

    .pill-group {
      display: flex;
      flex-wrap: wrap;
    }

    .ids-list {
      max-height: 420px;
      overflow-y: auto;
      padding-right: 4px;
    }

    .ids-item {
      margin-bottom: 12px;
      padding-bottom: 12px;
      border-bottom: 1px solid #333;
      font-size: 0.8rem;
    }

    .ids-question {
      font-weight: 600;
      margin-bottom: 4px;
    }

    .ids-input {
      width: 100%;
      padding: 6px;
      border-radius: 4px;
      border: 1px solid var(--input-border);
      background-color: var(--input-bg);
      color: var(--text);
      font-size: 0.8rem;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.8rem;
    }

    th, td {
      padding: 4px 0;
    }

    th {
      text-align: left;
      border-bottom: 1px solid #555;
      padding-bottom: 4px;
      font-weight: 600;
    }

    th.right,
    td.right {
      text-align: right;
    }

    .muted {
      color: var(--muted);
      font-size: 0.9rem;
    }

    code {
      font-family: Menlo, Monaco, Consolas, "Courier New", monospace;
      font-size: 0.8rem;
      background-color: #222;
      padding: 1px 4px;
      border-radius: 3px;
    }

    ul {
      padding-left: 18px;
    }

    li {
      margin-bottom: 4px;
    }

    /* Modal Styles */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.8);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }

    .modal-overlay.active {
      display: flex;
    }

    .modal-content {
      background-color: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 24px;
      max-width: 900px;
      max-height: 80vh;
      overflow-y: auto;
      width: 90%;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      border-bottom: 1px solid var(--border);
      padding-bottom: 12px;
    }

    .modal-close {
      background: none;
      border: none;
      color: var(--text);
      font-size: 1.5rem;
      cursor: pointer;
      padding: 0;
      width: 30px;
      height: 30px;
    }

    .modal-close:hover {
      color: var(--accent);
    }

    .import-options {
      display: flex;
      gap: 12px;
      margin-bottom: 20px;
    }

    .import-option-btn {
      padding: 8px 16px;
      border-radius: 6px;
      border: 1px solid var(--border);
      background-color: var(--pill-inactive);
      color: var(--text);
      cursor: pointer;
      font-size: 0.85rem;
      transition: all 0.15s ease;
    }

    .import-option-btn.active {
      background-color: var(--accent);
      border-color: var(--accent);
    }

    .import-tree {
      max-height: 400px;
      overflow-y: auto;
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 12px;
      background-color: var(--bg);
    }

    .import-tree-item {
      padding: 6px 0;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .import-tree-item input[type="checkbox"] {
      cursor: pointer;
    }

    .import-tree-item label {
      cursor: pointer;
      flex: 1;
    }

    .import-tree-children {
      margin-left: 24px;
    }

    .merge-option {
      margin-top: 16px;
      padding: 12px;
      background-color: var(--bg);
      border: 1px solid var(--border);
      border-radius: 6px;
    }

    .merge-option label {
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      font-size: 0.9rem;
    }

    .btn-primary {
      background-color: var(--accent);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.9rem;
      transition: all 0.15s ease;
    }

    .btn-primary:hover {
      opacity: 0.9;
    }

    .btn-secondary {
      background-color: var(--pill-inactive);
      color: var(--text);
      border: 1px solid var(--border);
      padding: 10px 20px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.9rem;
      transition: all 0.15s ease;
    }

    .btn-secondary:hover {
      background-color: #444;
    }

    .modal-footer {
      margin-top: 20px;
      display: flex;
      justify-content: flex-end;
      gap: 12px;
      padding-top: 12px;
      border-top: 1px solid var(--border);
    }

    .project-name-input {
      width: 100%;
      padding: 8px;
      border-radius: 4px;
      border: 1px solid var(--input-border);
      background-color: var(--input-bg);
      color: var(--text);
      font-size: 0.9rem;
      margin-bottom: 16px;
    }

    .add-to-project-btn {
      margin-top: 12px;
      width: 100%;
      background-color: var(--accent);
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.85rem;
      transition: all 0.15s ease;
    }

    .add-to-project-btn:hover {
      opacity: 0.9;
    }

    .tree-search-box {
      width: 100%;
      padding: 8px 12px;
      background: var(--input-bg);
      border: 1px solid var(--input-border);
      border-radius: 6px;
      color: var(--text);
      font-size: 0.9rem;
      margin-top: 12px;
      margin-bottom: 0;
    }

    .tree-search-box:focus {
      outline: none;
      border-color: var(--accent);
    }

    .tree-item.search-match {
      background-color: rgba(0, 184, 148, 0.1);
    }

    .tree-item.search-highlight {
      background-color: rgba(0, 184, 148, 0.3);
    }

    /* Room Logic Indicators */
    .logic-badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      font-size: 0.7rem;
      padding: 2px 8px;
      border-radius: 12px;
      font-weight: 600;
      margin-left: 8px;
      vertical-align: middle;
    }

    .logic-badge.enabled {
      background: linear-gradient(135deg, #00b894 0%, #00cec9 100%);
      color: white;
      box-shadow: 0 2px 4px rgba(0, 184, 148, 0.3);
    }

    .logic-badge.disabled {
      background: var(--pill-inactive);
      color: var(--muted);
      border: 1px solid var(--border);
    }

    .logic-badge::before {
      content: "";
      width: 6px;
      height: 6px;
      border-radius: 50%;
      display: inline-block;
    }

    .logic-badge.enabled::before {
      background: white;
      box-shadow: 0 0 4px rgba(255, 255, 255, 0.8);
    }

    .logic-badge.disabled::before {
      background: var(--muted);
    }

    .import-tree-item.has-logic {
      border-left: 3px solid #00b894;
      padding-left: 12px;
    }

    .import-tree-item.no-logic {
      opacity: 0.7;
    }

    /* Logic Toggle Switch */
    .logic-toggle-switch {
      position: relative;
      display: inline-block !important;
      width: 24px !important;
      height: 14px !important;
      margin-left: 4px !important;
      margin-right: 4px !important;
      vertical-align: middle;
      flex-shrink: 0;
      min-width: 24px !important;
      max-width: 24px !important;
    }

    .logic-toggle-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .logic-toggle-slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: var(--pill-inactive);
      border: 1px solid var(--border);
      transition: .3s;
      border-radius: 14px;
    }

    .logic-toggle-slider:before {
      position: absolute;
      content: "";
      height: 10px;
      width: 10px;
      left: 2px;
      bottom: 1px;
      background-color: white;
      transition: .3s;
      border-radius: 50%;
    }

    .logic-toggle-switch input:checked + .logic-toggle-slider {
      background: linear-gradient(135deg, #00b894 0%, #00cec9 100%);
      border-color: #00b894;
    }

    .logic-toggle-switch input:checked + .logic-toggle-slider:before {
      transform: translateX(10px);
    }

    .logic-toggle-switch:hover .logic-toggle-slider {
      box-shadow: 0 0 8px rgba(0, 184, 148, 0.4);
    }

    /* Department Input Modal */
    .input-modal {
      background: var(--bg-card);
      padding: 20px;
      border-radius: 8px;
      margin-top: 16px;
      border: 1px solid var(--border);
    }

    .input-field {
      margin-bottom: 16px;
    }

    .input-field label {
      display: block;
      margin-bottom: 6px;
      font-weight: 500;
      color: var(--text);
    }

    .input-field input[type="number"],
    .input-field input[type="text"] {
      width: 100%;
      padding: 10px;
      background: var(--input-bg);
      border: 1px solid var(--input-border);
      border-radius: 6px;
      color: var(--text);
      font-size: 0.95rem;
    }

    .input-field .help-text {
      font-size: 0.85rem;
      color: var(--muted);
      margin-top: 4px;
    }

    .calculation-result {
      background: rgba(0, 184, 148, 0.1);
      border-left: 3px solid var(--accent);
      padding: 12px;
      border-radius: 4px;
      margin-top: 16px;
    }

    .calculation-result h4 {
      color: var(--accent);
      margin-bottom: 8px;
      font-size: 0.9rem;
    }

    .calculation-summary {
      font-size: 0.85rem;
      color: var(--muted);
    }

    /* Workbench Mode */
    #workbench-container {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: #1a1a2e;
      z-index: 9999;
      display: none;
      flex-direction: column;
    }

    #workbench-container.active {
      display: flex;
    }

    #workbench-header {
      background: rgba(26, 26, 46, 0.95);
      border-bottom: 2px solid #64c8ff;
      padding: 16px 24px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    #workbench-header h2 {
      color: #64c8ff;
      font-family: 'Courier New', monospace;
      font-size: 1.5rem;
      margin: 0;
      text-shadow: 0 0 10px rgba(100, 200, 255, 0.5);
    }

    #workbench-controls {
      display: flex;
      gap: 12px;
    }

    .workbench-btn {
      background: rgba(100, 200, 255, 0.2);
      border: 2px solid #64c8ff;
      color: #64c8ff;
      padding: 8px 16px;
      border-radius: 4px;
      cursor: pointer;
      font-family: 'Courier New', monospace;
      font-size: 0.9rem;
      transition: all 0.2s;
    }

    .workbench-btn:hover {
      background: rgba(100, 200, 255, 0.4);
      box-shadow: 0 0 15px rgba(100, 200, 255, 0.5);
    }

    .workbench-btn.danger {
      border-color: #ff6b6b;
      color: #ff6b6b;
      background: rgba(255, 107, 107, 0.2);
    }

    .workbench-btn.danger:hover {
      background: rgba(255, 107, 107, 0.4);
      box-shadow: 0 0 15px rgba(255, 107, 107, 0.5);
    }

    #workbench-canvas-container {
      flex: 1;
      position: relative;
      overflow: hidden;
    }

    #workbench-canvas {
      display: block;
      width: 100%;
      height: 100%;
      image-rendering: pixelated;
    }

    #workbench-legend {
      position: absolute;
      bottom: 20px;
      right: 20px;
      background: rgba(26, 26, 46, 0.95);
      border: 2px solid #64c8ff;
      border-radius: 8px;
      padding: 16px;
      font-family: 'Courier New', monospace;
      color: #64c8ff;
      font-size: 0.85rem;
      max-width: 300px;
    }

    #workbench-legend h4 {
      margin: 0 0 12px 0;
      color: #feca57;
      text-shadow: 0 0 10px rgba(254, 202, 87, 0.5);
    }

    .legend-section {
      margin-bottom: 16px;
    }

    .legend-section:last-child {
      margin-bottom: 0;
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 12px;
      margin: 8px 0;
    }

    .legend-color-box {
      width: 32px;
      height: 32px;
      border: 1px solid #64c8ff;
      border-radius: 4px;
      flex-shrink: 0;
    }

    .legend-pattern-box {
      width: 32px;
      height: 32px;
      border: 1px solid #64c8ff;
      border-radius: 4px;
      flex-shrink: 0;
      background: #fff;
      position: relative;
    }

    .pattern-dots {
      background-image: radial-gradient(circle, #000 2px, transparent 2px);
      background-size: 8px 8px;
    }

    .pattern-diagonal {
      background: repeating-linear-gradient(45deg, transparent, transparent 4px, #000 4px, #000 5px);
    }

    .pattern-crosshatch {
      background: 
        repeating-linear-gradient(45deg, transparent, transparent 4px, rgba(0,0,0,0.5) 4px, rgba(0,0,0,0.5) 5px),
        repeating-linear-gradient(-45deg, transparent, transparent 4px, rgba(0,0,0,0.5) 4px, rgba(0,0,0,0.5) 5px);
    }

    .pattern-horizontal {
      background: repeating-linear-gradient(0deg, transparent, transparent 4px, #000 4px, #000 5px);
    }

    .pattern-vertical {
      background: repeating-linear-gradient(90deg, transparent, transparent 4px, #000 4px, #000 5px);
    }
  </style>
</head>
<body>
  <header>
    <div class="header-content">
      <h1>Hospital Programming Workbench</h1>
      <p>
        A web-based tool for building hospital project programs from equipment guide data.
        Import departments, functional areas, and rooms with equipment to create your project.
      </p>
    </div>
    <div class="header-actions">
      <button class="icon-btn portal" onclick="openLogicPortal()" title="Logic Portal">‚öôÔ∏è</button>
      <button class="icon-btn sync" onclick="openDataSyncModal()" title="Sync Data">üîÑ</button>
      <button class="icon-btn workbench" id="workbench-toggle" onclick="toggleWorkbench()" title="3D Workbench">üßä</button>
    </div>
  </header>

  <!-- Workbench Mode Overlay -->
  <div id="workbench-container">
    <div id="workbench-header">
      <h2>‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê WORKBENCH v1.0 ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó</h2>
      <div id="workbench-controls">
        <button class="workbench-btn" onclick="workbenchToggleView()" id="view-toggle-btn">üìê 45¬∞/45¬∞ View</button>
        <button class="workbench-btn" onclick="workbenchAutoArrange()">üéØ Auto-Arrange</button>
        <button class="workbench-btn" onclick="workbenchReload()">üîÑ Reload</button>
        <button class="workbench-btn" onclick="workbenchSetBackground('pixel-art')">üé® Pixel Art</button>
        <button class="workbench-btn" onclick="workbenchSetBackground('terminal')">üíª Terminal</button>
        <button class="workbench-btn" onclick="workbenchSetBackground('minimal')">‚ö™ Minimal</button>
        <button class="workbench-btn danger" onclick="toggleWorkbench()">‚úï Close</button>
      </div>
    </div>
    <div id="workbench-canvas-container">
      <canvas id="workbench-canvas" width="1600" height="900"></canvas>
      <div id="workbench-legend">
        <h4>‚ïê‚ïê‚ïê LEGEND ‚ïê‚ïê‚ïê</h4>
        
        <div class="legend-section">
          <strong>Department Colors:</strong>
          <div class="legend-item">
            <div class="legend-color-box" style="background: #FFB3BA;"></div>
            <span>Inpatient</span>
          </div>
          <div class="legend-item">
            <div class="legend-color-box" style="background: #BAFFC9;"></div>
            <span>Clinical</span>
          </div>
          <div class="legend-item">
            <div class="legend-color-box" style="background: #BAE1FF;"></div>
            <span>Support</span>
          </div>
          <div class="legend-item">
            <div class="legend-color-box" style="background: #FFFFBA;"></div>
            <span>Admin</span>
          </div>
        </div>

        <div class="legend-section">
          <strong>Functional Area Patterns:</strong>
          <div class="legend-item">
            <div class="legend-pattern-box pattern-dots"></div>
            <span>Reception</span>
          </div>
          <div class="legend-item">
            <div class="legend-pattern-box pattern-diagonal"></div>
            <span>Patient Area</span>
          </div>
          <div class="legend-item">
            <div class="legend-pattern-box pattern-crosshatch"></div>
            <span>Treatment</span>
          </div>
          <div class="legend-item">
            <div class="legend-pattern-box pattern-horizontal"></div>
            <span>Staff/Admin</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <main class="layout">
    <!-- LEFT COLUMN: Tree Navigation -->
    <section id="left-column">
      <div class="tree-container">
        <div class="tree-header" id="tree-header">
          <div class="tree-header-top">
            <div class="tree-header-title">
              <button class="back-to-projects-btn" id="return-to-projects-btn" onclick="returnToProjectList()" style="display: none;">‚Üê Projects</button>
              <h2 style="font-size: 1.1rem; margin: 0;" id="nav-title">Navigator</h2>
            </div>
          </div>
          <div class="mode-toggle" id="mode-toggle">
            <button class="mode-btn active" data-mode="program" onclick="switchMode('program')">Program Mode</button>
            <button class="mode-btn" data-mode="reference" onclick="switchMode('reference')">Reference Mode</button>
            <button class="mode-btn" data-mode="compare" onclick="switchMode('compare')">Compare Mode</button>
          </div>
          <input type="text" id="tree-search-box" class="tree-search-box" placeholder="üîç Search rooms, departments..." oninput="filterTreeDebounced()" style="display: none;" />
        </div>
        <button class="add-to-project-btn" id="add-to-project-btn" onclick="openImportModal()" style="display: none;">+ Add to Project</button>
        <div id="tree-view"></div>
      </div>
    </section>

    <!-- RIGHT COLUMN: Detail View -->
    <section id="right-column">
      <div id="detail-view"></div>
    </section>

    <!-- COMPARE MODE: Second Column -->
    <section id="compare-column">
      <div id="compare-view"></div>
    </section>
  </main>

  <!-- Password Modal -->
  <div id="password-modal" class="modal-overlay">
    <div class="modal-content" style="max-width: 400px;">
      <div class="modal-header">
        <h2>üîê Logic Portal Access</h2>
        <button class="modal-close" onclick="closePasswordModal()">&times;</button>
      </div>
      <div style="padding: 20px;">
        <p style="margin-bottom: 20px; color: var(--muted);">Enter password to access the Room Logic Management Portal</p>
        <input type="password" id="portal-password" placeholder="Enter password" 
               style="width: 100%; padding: 12px; font-size: 16px; border: 2px solid var(--border); border-radius: 6px; background: var(--input-bg); color: var(--text);"
               onkeypress="if(event.key === 'Enter') checkPassword()">
        <div id="password-error" style="color: #e74c3c; margin-top: 10px; display: none;">‚ùå Incorrect password</div>
      </div>
      <div class="modal-footer">
        <button class="btn-secondary" onclick="closePasswordModal()">Cancel</button>
        <button class="btn-primary" onclick="checkPassword()">Enter Portal</button>
      </div>
    </div>
  </div>

  <!-- Logic Portal Modal -->
  <div id="logic-portal-modal" class="modal-overlay">
    <div class="modal-content" style="max-width: 1400px; max-height: 90vh;">
      <div class="modal-header">
        <h2>‚öôÔ∏è Room Logic Management Portal</h2>
        <button class="modal-close" onclick="closeLogicPortal()">&times;</button>
      </div>
      <div style="padding: 20px; overflow-y: auto; max-height: calc(90vh - 160px);">
        <div style="display: flex; gap: 20px; margin-bottom: 20px; align-items: center;">
          <input type="text" id="logic-search-box" placeholder="üîç Search rooms by code or name..."
                 style="flex: 1; padding: 12px; font-size: 14px; border: 2px solid var(--border); border-radius: 6px; background: var(--input-bg); color: var(--text);"
                 oninput="filterLogicRooms()">
          <button onclick="saveAllLogic()" class="btn-primary" style="white-space: nowrap;">üíæ Save All Changes</button>
          <button onclick="exportLogic()" class="btn-secondary" style="white-space: nowrap;">üì• Export</button>
        </div>
        
        <div id="logic-rooms-list" style="display: grid; gap: 15px;">
          <!-- Room logic cards will be inserted here -->
        </div>
      </div>
    </div>
  </div>

  <!-- Import Modal -->
  <div id="import-modal" class="modal-overlay">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Add to Project</h2>
        <button class="modal-close" onclick="closeImportModal()">&times;</button>
      </div>
      <div id="import-modal-body">
        <p class="muted">Expand the tree and check items to add to your project. Departments with <span class="logic-badge enabled" style="display: inline-flex; font-size: 0.7rem;">‚ö° LOGIC</span> have automated room calculation available.</p>
        <div style="margin-bottom: 12px;">
          <input type="text" id="import-search" placeholder="Search departments, functional areas, or rooms..." style="width: 100%; padding: 8px; border: 1px solid var(--border); border-radius: 4px; font-size: 0.95rem;" oninput="filterImportTree()" />
        </div>
        <div id="import-tree-container" class="import-tree"></div>
        <div class="merge-option">
          <label>
            <input type="checkbox" id="merge-on-import" checked />
            <span>Merge with existing items at same level (uncheck to create duplicates)</span>
          </label>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn-secondary" onclick="closeImportModal()">Cancel</button>
        <button class="btn-primary" onclick="confirmImport()">Add Selected</button>
      </div>
    </div>
  </div>

  <!-- Department Logic Modal -->
  <div id="department-logic-modal" class="modal-overlay">
    <div class="modal-content" style="max-width: 700px;">
      <div class="modal-header">
        <h2 id="logic-modal-title">Add Department with Room Logic</h2>
        <button class="modal-close" onclick="closeDepartmentLogicModal()">&times;</button>
      </div>
      <div style="padding: 20px;">
        <div id="logic-modal-content">
          <!-- Dynamic content will be inserted here -->
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn-secondary" onclick="closeDepartmentLogicModal()">Cancel</button>
        <button class="btn-primary" id="calculate-rooms-btn" onclick="calculateAndAddDepartment()" style="display: none;">Calculate & Add to Project</button>
      </div>
    </div>
  </div>

  <!-- Equipment Selection Modal -->
  <div id="equipment-modal" class="modal-overlay">
    <div class="modal-content" style="max-width: 700px;">
      <div class="modal-header">
        <h2>Add Equipment to Room</h2>
        <button class="modal-close" onclick="closeEquipmentModal()">&times;</button>
      </div>
      <div style="padding: 20px;">
        <div style="margin-bottom: 16px;">
          <input type="text" id="equipment-search" placeholder="Search by JSN, name, or description..." style="width: 100%; padding: 8px; border: 1px solid var(--border); border-radius: 4px; font-size: 0.95rem;" oninput="filterEquipmentList()" />
        </div>
        <div id="equipment-list" style="max-height: 400px; overflow-y: auto; border: 1px solid var(--border); border-radius: 4px;">
          <!-- Equipment items will be populated here -->
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn-secondary" onclick="closeEquipmentModal()">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Equipment Selection Modal -->
  <div id="equipment-modal" class="modal-overlay">
    <div class="modal-content" style="max-width: 700px;">
      <div class="modal-header">
        <h2>Add Equipment to Room</h2>
        <button class="modal-close" onclick="closeEquipmentModal()">&times;</button>
      </div>
      <div style="padding: 20px;">
        <div style="margin-bottom: 16px;">
          <input type="text" id="equipment-search" placeholder="Search by JSN, name, or description..." style="width: 100%; padding: 8px; border: 1px solid var(--border); border-radius: 4px; font-size: 0.95rem;" oninput="filterEquipmentList()" />
        </div>
        <div id="equipment-list" style="max-height: 400px; overflow-y: auto; border: 1px solid var(--border); border-radius: 4px;">
          <!-- Equipment items will be populated here -->
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn-secondary" onclick="closeEquipmentModal()">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Report Generation Modal -->
  <div id="report-modal" class="modal-overlay">
    <div class="modal-content" style="max-width: 500px;">
      <div class="modal-header">
        <h2>üìÑ Generate Project Report</h2>
        <button class="modal-close" onclick="closeReportModal()">&times;</button>
      </div>
      <div style="padding: 20px;">
        <p style="margin-bottom: 20px; color: var(--muted);">Select the report focus for your PDF export:</p>
        
        <div style="margin-bottom: 24px;">
          <label style="display: block; margin-bottom: 12px; cursor: pointer; padding: 12px; border: 2px solid var(--accent); border-radius: 6px; transition: all 0.2s;" onmouseover="this.style.borderColor='var(--accent)'" onmouseout="if(!this.querySelector('input').checked) this.style.borderColor='var(--border)'">
            <input type="radio" name="report-type" value="equipment" checked onchange="document.querySelectorAll('[name=report-type]').forEach(r => r.parentElement.style.borderColor = 'var(--border)'); this.parentElement.style.borderColor = 'var(--accent)';" style="margin-right: 8px;">
            <strong>Equipment Focus</strong>
            <div style="font-size: 0.85rem; color: var(--muted); margin-top: 4px; margin-left: 24px;">Lists all equipment for each room with JSN codes, quantities, and descriptions</div>
          </label>
          
          <label style="display: block; cursor: pointer; padding: 12px; border: 2px solid var(--border); border-radius: 6px; transition: all 0.2s;" onmouseover="this.style.borderColor='var(--accent)'" onmouseout="if(!this.querySelector('input').checked) this.style.borderColor='var(--border)'">
            <input type="radio" name="report-type" value="attributes" onchange="document.querySelectorAll('[name=report-type]').forEach(r => r.parentElement.style.borderColor = 'var(--border)'); this.parentElement.style.borderColor = 'var(--accent)';" style="margin-right: 8px;">
            <strong>Room Attributes Focus</strong>
            <div style="font-size: 0.85rem; color: var(--muted); margin-top: 4px; margin-left: 24px;">Shows detailed room specifications including HVAC, materials, utilities, and environmental requirements</div>
          </label>
        </div>

        <div style="margin-bottom: 16px;">
          <label style="display: flex; align-items: center; cursor: pointer;">
            <input type="checkbox" id="include-summary" checked style="margin-right: 8px;">
            <span>Include project summary page</span>
          </label>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn-secondary" onclick="closeReportModal()">Cancel</button>
        <button class="btn-primary" onclick="generatePDFReport()">üì• Generate PDF</button>
      </div>
    </div>
  </div>

  <!-- Data Sync Modal -->
  <div id="data-sync-modal" class="modal-overlay">
    <div class="modal-content" style="max-width: 600px;">
      <div class="modal-header">
        <h2>üîÑ Sync Data from GitHub</h2>
        <button class="modal-close" onclick="closeDataSyncModal()">&times;</button>
      </div>
      <div style="padding: 20px;">
        <p style="margin-bottom: 20px; color: var(--muted);">Update room and equipment data from the latest source files in your GitHub repository.</p>
        
        <div style="background: var(--bg); border: 1px solid var(--border); border-radius: 6px; padding: 16px; margin-bottom: 20px;">
          <h4 style="margin-bottom: 12px;">Repository Configuration</h4>
          <div style="margin-bottom: 12px;">
            <label style="display: block; margin-bottom: 4px; font-size: 0.9rem;">GitHub Repository (owner/repo)</label>
            <input type="text" id="github-repo" placeholder="LeCartier/Arrange" value="LeCartier/Arrange"
                   style="width: 100%; padding: 8px; background: var(--input-bg); border: 1px solid var(--input-border); color: var(--text); border-radius: 4px;">
          </div>
          <div style="margin-bottom: 12px;">
            <label style="display: block; margin-bottom: 4px; font-size: 0.9rem;">Branch</label>
            <input type="text" id="github-branch" placeholder="main" value="main"
                   style="width: 100%; padding: 8px; background: var(--input-bg); border: 1px solid var(--input-border); color: var(--text); border-radius: 4px;">
          </div>
        </div>

        <div style="background: #1a3a1a; border: 1px solid #2a5a2a; border-radius: 6px; padding: 12px; margin-bottom: 16px;">
          <div style="font-size: 0.85rem; color: #90ee90;">
            <strong>üìã Files to Sync:</strong>
            <ul style="margin: 8px 0 0 20px; line-height: 1.8;">
              <li>src/room_criteria.tsv ‚Üí Updates room specifications</li>
              <li>src/Equipment_Guide_parsed_v2.txt ‚Üí Updates equipment catalog</li>
            </ul>
          </div>
        </div>

        <div id="sync-status" style="min-height: 60px; padding: 12px; background: var(--bg); border: 1px solid var(--border); border-radius: 4px; font-size: 0.85rem; font-family: monospace; overflow-y: auto; max-height: 200px;">
          <div style="color: var(--muted);">Ready to sync...</div>
        </div>

        <div style="margin-top: 16px;">
          <label style="display: flex; align-items: center; cursor: pointer; padding: 8px; background: var(--bg); border-radius: 4px;">
            <input type="checkbox" id="backup-before-sync" checked style="margin-right: 8px;">
            <span style="font-size: 0.9rem;">Create backup of current data before syncing</span>
          </label>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn-secondary" onclick="closeDataSyncModal()">Cancel</button>
        <button class="btn-primary" onclick="syncDataFromGitHub()" style="background: linear-gradient(135deg, #00b894 0%, #00cec9 100%);">üîÑ Sync Now</button>
      </div>
    </div>
  </div>

  <script src="equipment-data-part1.js"></script>
  <script src="equipment-data-part2.js"></script>
  <script src="room-sizes.js"></script>
  <script src="workbench.js"></script>
  <script>
    // Build room code to department/FA mapping from equipment guide
    console.log('Building room metadata...');
    
    // Create a map of roomCode -> {department, functionalArea, roomName}
    const roomMetadata = new Map();
    
    // Parse the Equipment_Guide_parsed_v2.txt data to extract room metadata
    // The equipment mappings were generated from that file, so we need to reconstruct the metadata
    // For now, we'll use a simpler approach: create metadata from the existing data
    
    // Enrich ROOM_EQUIPMENT_MAPPINGS with department, functional area, and room names
    if (ROOM_EQUIPMENT_MAPPINGS && ROOM_SIZES && EQUIPMENT_LIST) {
      console.log(`Starting with ${ROOM_EQUIPMENT_MAPPINGS.length} equipment mappings`);
      console.log(`Have ${ROOM_SIZES.length} rooms and ${EQUIPMENT_LIST.length} equipment items`);
      
      // Since ROOM_EQUIPMENT_MAPPINGS only has roomCode, jsn, qty, we need to add the missing fields
      // We'll fetch the source file to get department and functional area data
      fetch('src/Equipment_Guide_parsed_v2.txt')
        .then(response => response.text())
        .then(text => {
          const lines = text.split('\n');
          const deptFaMap = new Map();
          
          // Skip header line
          // Build map of ALL room instances (not just first occurrence)
          // This allows rooms like SB191 to appear in multiple departments
          const allRoomInstances = [];
          
          for (let i = 1; i < lines.length; i++) {
            const line = lines[i].trim();
            if (!line) continue;
            
            const parts = line.split('\t');
            if (parts.length < 3) continue;
            
            // Clean up department and FA names
            let dept = parts[0] ? parts[0].replace(/"/g, '').trim() : '';
            let fa = parts[1] ? parts[1].replace(/"/g, '').trim() : '';
            const roomNameField = parts[2] ? parts[2].replace(/"/g, '').trim() : '';
            
            // Skip if essential fields are missing
            if (!dept || !fa || !roomNameField) continue;
            
            // Extract room code from "Order - CODE - Name" format
            const match = roomNameField.match(/- ([A-Z0-9]+) -/);
            if (match) {
              const roomCode = match[1];
              const roomName = roomNameField.split(' - ').slice(2).join(' - ').trim();
              
              // Store ALL instances, not just first occurrence
              allRoomInstances.push({
                roomCode: roomCode,
                department: dept,
                functionalArea: fa,
                roomName: roomName
              });
              
              // Also keep first occurrence map for backward compatibility
              if (!deptFaMap.has(roomCode)) {
                deptFaMap.set(roomCode, {
                  department: dept,
                  functionalArea: fa,
                  roomName: roomName
                });
              }
            }
          }
          
          console.log(`Built metadata for ${deptFaMap.size} unique room codes`);
          console.log(`Found ${allRoomInstances.length} total room instances (including duplicates across departments)`);
          console.log('Sample metadata:', Array.from(deptFaMap.entries()).slice(0, 3));
          
          // Store globally for compare mode
          window.ROOM_METADATA = deptFaMap;
          window.ALL_ROOM_INSTANCES = allRoomInstances;
          
          // Build indexed lookup for performance - O(1) instead of O(n) filter
          const roomInstancesByCode = new Map();
          allRoomInstances.forEach(instance => {
            if (!roomInstancesByCode.has(instance.roomCode)) {
              roomInstancesByCode.set(instance.roomCode, []);
            }
            roomInstancesByCode.get(instance.roomCode).push(instance);
          });
          
          console.log(`Starting enrichment of ${ROOM_EQUIPMENT_MAPPINGS.length} base equipment mappings...`);
          
          // First deduplicate the base mappings - same equipment appears multiple times per room
          const uniqueEquipment = new Map();
          ROOM_EQUIPMENT_MAPPINGS.forEach(mapping => {
            const key = `${mapping.roomCode}|${mapping.jsn}`;
            if (!uniqueEquipment.has(key)) {
              uniqueEquipment.set(key, mapping);
            }
          });
          console.log(`Deduplicated base equipment from ${ROOM_EQUIPMENT_MAPPINGS.length} to ${uniqueEquipment.size} unique room+equipment combinations`);
          
          // Simply add metadata to each unique mapping
          // Tree building will use ALL_ROOM_INSTANCES to show rooms in multiple depts
          const enrichedMappings = Array.from(uniqueEquipment.values()).map(mapping => {
            const metadata = deptFaMap.get(mapping.roomCode);
            return {
              ...mapping,
              department: metadata?.department || 'Unknown',
              functionalArea: metadata?.functionalArea || 'Unknown',
              roomName: metadata?.roomName || mapping.roomCode,
              equipmentJsn: mapping.jsn,
              quantity: mapping.qty || 1
            };
          });
          
          console.log(`Enriched ${enrichedMappings.length} mappings with metadata (deduplicated)`);
          
          // Update window property
          window.ROOM_EQUIPMENT_MAPPINGS = enrichedMappings;
          
          // Reset cached dept map so import tree rebuilds with enriched data
          cachedDeptMap = null;
          
          // No deduplication needed since we already deduplicated during enrichment
          // Invalidate cached reference tree since data changed
          cachedReferenceTree = null;
          lastMappingsLength = 0;
          
          // Build ROOM_EQUIPMENT lookup object for easy access by room code
          // Pre-build equipment items lookup for O(1) access
          const equipLookup = new Map();
          EQUIPMENT_LIST.forEach(eq => equipLookup.set(eq.jsn, eq));
          
          window.ROOM_EQUIPMENT = {};
          enrichedMappings.forEach(mapping => {
            if (!window.ROOM_EQUIPMENT[mapping.roomCode]) {
              window.ROOM_EQUIPMENT[mapping.roomCode] = [];
            }
            const equipItem = equipLookup.get(mapping.equipmentJsn);
            if (equipItem) {
              window.ROOM_EQUIPMENT[mapping.roomCode].push({
                JSN: equipItem.jsn,
                'Equipment Name': equipItem.name,
                'Qty per Room': mapping.quantity || 1,
                'Acq/Ins': mapping.acqIns || equipItem.acqIns || '',
                Description: equipItem.description || ''
              });
            }
          });
          console.log('Built ROOM_EQUIPMENT lookup for', Object.keys(window.ROOM_EQUIPMENT).length, 'room codes');
          
          // Now trigger initial render with enriched data
          viewState = 'project-list';
          renderAll();
        })
        .catch(error => {
          console.error('Error loading equipment guide:', error);
          // Fall back to using original data without enrichment
          console.warn('Using original mappings without department/FA metadata');
          window.ROOM_EQUIPMENT_MAPPINGS = ROOM_EQUIPMENT_MAPPINGS;
          viewState = 'project-list';
          renderAll();
        });
    } else {
      // If data isn't available, just render with what we have
      console.warn('Equipment or room data not loaded');
      window.ROOM_EQUIPMENT_MAPPINGS = ROOM_EQUIPMENT_MAPPINGS || [];
      viewState = 'project-list';
      renderAll();
    }
    
    // -----------------------------
    // DATA MODELS & SAMPLE DATA
    // -----------------------------

    // For clarity, using plain JS objects; no TypeScript syntax.
    
    // Helper to get enriched equipment mappings
    function getEquipmentMappings() {
      return window.ROOM_EQUIPMENT_MAPPINGS || ROOM_EQUIPMENT_MAPPINGS || [];
    }

    // PROJECT MANAGEMENT DATA
    // Project structure: departments -> functional areas -> rooms -> equipment
    let USER_PROJECTS = JSON.parse(localStorage.getItem('va-user-projects') || '[]');
    let CURRENT_PROJECT_ID = localStorage.getItem('va-current-project-id') || null;

    // Migrate existing projects to add cost fields
    USER_PROJECTS.forEach(project => {
      // Add cost factors if missing
      if (project.costPerNSF === undefined) project.costPerNSF = 0;
      if (project.costPerGSF === undefined) project.costPerGSF = 0;
      
      // Add cost to equipment if missing
      if (project.departments) {
        project.departments.forEach(dept => {
          if (dept.functionalAreas) {
            dept.functionalAreas.forEach(fa => {
              if (fa.rooms) {
                fa.rooms.forEach(room => {
                  if (room.equipment) {
                    room.equipment.forEach(eq => {
                      if (eq.cost === undefined) eq.cost = 0;
                    });
                  }
                });
              }
            });
          }
        });
      }
    });

    // Initialize default project if none exist
    if (USER_PROJECTS.length === 0) {
      const defaultProject = {
        id: generateId(),
        name: "New Project",
        siteName: "",
        description: "",
        departments: [],
        costPerNSF: 0,
        costPerGSF: 0,
        createdAt: new Date().toISOString(),
        modifiedAt: new Date().toISOString()
      };
      USER_PROJECTS.push(defaultProject);
      CURRENT_PROJECT_ID = defaultProject.id;
      saveProjects();
    } else if (!CURRENT_PROJECT_ID || !USER_PROJECTS.find(p => p.id === CURRENT_PROJECT_ID)) {
      CURRENT_PROJECT_ID = USER_PROJECTS[0].id;
      localStorage.setItem('va-current-project-id', CURRENT_PROJECT_ID);
    }

    function getCurrentProject() {
      return USER_PROJECTS.find(p => p.id === CURRENT_PROJECT_ID) || USER_PROJECTS[0];
    }

    function saveProjects() {
      localStorage.setItem('va-user-projects', JSON.stringify(USER_PROJECTS));
      getCurrentProject().modifiedAt = new Date().toISOString();
    }

    function generateId() {
      return 'id-' + Math.random().toString(36).substr(2, 9) + '-' + Date.now();
    }

    const PROJECT = {
      id: "proj-1",
      name: "Sample VA Hospital Project",
      siteName: "Sample VAMC",
      description: "Baseline demo program using PG-18-9 logic."
    };

    const SAMPLE_CHAPTERS = [
      { id: "100", title: "MEDICAL / SURGICAL PATIENT CARE UNIT (MS PCU)", category: "clinical" },
      { id: "102", title: "INTENSIVE CARE PATIENT CARE UNIT (IC PCU)", category: "clinical" },
      { id: "112", title: "MATERNITY CARE (MAT)", category: "clinical" },
      { id: "122", title: "PEDIATRIC PATIENT CARE UNIT (PED PCU)", category: "clinical" },
      { id: "124", title: "NEONATAL INTENSIVE CARE UNIT (NICU)", category: "clinical" },
      { id: "126", title: "PSYCHIATRIC PATIENT CARE UNIT (PSY PCU)", category: "clinical" },
      { id: "130", title: "SPINAL CORD INJURY PATIENT CARE UNIT (SCI PCU)", category: "clinical" },
      { id: "132", title: "BLIND REHABILITATION PATIENT CARE UNIT (BR PCU)", category: "clinical" },
      { id: "202", title: "AMBULATORY CARE / PRIMARY CARE", category: "clinical" },
      { id: "210", title: "SURGERY", category: "clinical" },
      { id: "214", title: "ANESTHESIA", category: "clinical" },
      { id: "218", title: "POST ANESTHESIA CARE UNIT (PACU)", category: "clinical" },
      { id: "224", title: "PAIN MANAGEMENT", category: "clinical" },
      { id: "230", title: "ENDOSCOPY / BRONCHOSCOPY", category: "clinical" },
      { id: "256", title: "EMERGENCY DEPARTMENT (ED)", category: "clinical" },
      { id: "258", title: "URGENT CARE CENTER", category: "clinical" },
      { id: "260", title: "IMAGING", category: "clinical" },
      { id: "262", title: "CARDIOLOGY", category: "clinical" },
      { id: "264", title: "NUCLEAR MEDICINE", category: "clinical" },
      { id: "266", title: "RADIATION ONCOLOGY", category: "clinical" },
      { id: "268", title: "PHARMACY SERVICE", category: "clinical" },
      { id: "270", title: "PATHOLOGY & LABORATORY MEDICINE", category: "clinical" },
      { id: "272", title: "BLOOD BANK", category: "clinical" },
      { id: "280", title: "PROSTHETICS & ORTHOTICS", category: "clinical" },
      { id: "282", title: "PHYSICAL MEDICINE & REHABILITATION", category: "clinical" },
      { id: "284", title: "AUDIOLOGY / SPEECH", category: "clinical" },
      { id: "286", title: "NUTRITION & FOOD SERVICE", category: "support" },
      { id: "290", title: "MENTAL HEALTH / SUBSTANCE ABUSE", category: "clinical" },
      { id: "292", title: "SOCIAL WORK SERVICE", category: "clinical" },
      { id: "294", title: "CHAPLAIN SERVICE", category: "support" },
      { id: "298", title: "EDUCATION / TRAINING", category: "support" },
      { id: "300", title: "ADMINISTRATION", category: "support" },
      { id: "310", title: "MEDICAL RECORDS", category: "support" },
      { id: "330", title: "VOLUNTARY SERVICE", category: "support" },
      { id: "340", title: "ENVIRONMENTAL MANAGEMENT SERVICE", category: "support" },
      { id: "350", title: "STERILE PROCESSING & DISTRIBUTION", category: "support" },
      { id: "360", title: "LINEN SERVICE", category: "support" },
      { id: "370", title: "ENGINEERING / MAINTENANCE", category: "support" },
      { id: "380", title: "POLICE SERVICE", category: "support" },
      { id: "390", title: "TELECOMMUNICATIONS", category: "support" },
      { id: "420", title: "GENERAL STORAGE / RECEIVING", category: "support" }
    ];

    const SAMPLE_IDS = [
      // CHAPTER 100: MEDICAL/SURGICAL PCU
      { id: "CH100_A", chapterId: "100", label: "A", text: "How many Acute Inpatient Medical / Surgical patient beds are projected? (W) (17-267)", type: "W", inputKind: "number", minValue: 17, maxValue: 267, defaultValue: 32 },
      { id: "CH100_B", chapterId: "100", label: "B", text: "Is Behavioral Health Care for Inpatients authorized? (M)", type: "M", inputKind: "boolean", defaultValue: false },
      
      // CHAPTER 102: INTENSIVE CARE PCU
      { id: "CH102_A", chapterId: "102", label: "A", text: "How many ICU beds are projected? (W) (8-45)", type: "W", inputKind: "number", minValue: 8, maxValue: 45, defaultValue: 12 },
      { id: "CH102_B", chapterId: "102", label: "B", text: "Is a Coronary Care Unit authorized? (M)", type: "M", inputKind: "boolean", defaultValue: false },
      { id: "CH102_C", chapterId: "102", label: "C", text: "Is a Cardiac Catheterization Lab authorized? (M)", type: "M", inputKind: "boolean", defaultValue: false },
      
      // CHAPTER 112: MATERNITY CARE
      { id: "CH112_A", chapterId: "112", label: "A", text: "How many annual deliveries are projected? (W)", type: "W", inputKind: "number", defaultValue: 0 },
      { id: "CH112_B", chapterId: "112", label: "B", text: "Is Labor, Delivery, Recovery (LDR) authorized? (M)", type: "M", inputKind: "boolean", defaultValue: false },
      { id: "CH112_C", chapterId: "112", label: "C", text: "Is Labor, Delivery, Recovery, Postpartum (LDRP) authorized? (M)", type: "M", inputKind: "boolean", defaultValue: false },
      
      // CHAPTER 122: PEDIATRIC PCU
      { id: "CH122_A", chapterId: "122", label: "A", text: "How many Pediatric inpatient beds are projected? (W)", type: "W", inputKind: "number", defaultValue: 0 },
      
      // CHAPTER 124: NEONATAL ICU
      { id: "CH124_A", chapterId: "124", label: "A", text: "How many NICU beds are projected? (W)", type: "W", inputKind: "number", defaultValue: 0 },
      { id: "CH124_B", chapterId: "124", label: "B", text: "Is Level II (Intermediate) care authorized? (M)", type: "M", inputKind: "boolean", defaultValue: false },
      { id: "CH124_C", chapterId: "124", label: "C", text: "Is Level III (Intensive) care authorized? (M)", type: "M", inputKind: "boolean", defaultValue: false },
      
      // CHAPTER 126: PSYCHIATRIC PCU
      { id: "CH126_A", chapterId: "126", label: "A", text: "How many Psychiatric inpatient beds are projected? (W) (16-120)", type: "W", inputKind: "number", minValue: 16, maxValue: 120, defaultValue: 0 },
      { id: "CH126_B", chapterId: "126", label: "B", text: "Is Intensive Psychiatric care authorized? (M)", type: "M", inputKind: "boolean", defaultValue: false },
      
      // CHAPTER 130: SPINAL CORD INJURY PCU
      { id: "CH130_A", chapterId: "130", label: "A", text: "How many SCI beds are projected? (W)", type: "W", inputKind: "number", defaultValue: 0 },
      
      // CHAPTER 132: BLIND REHABILITATION PCU
      { id: "CH132_A", chapterId: "132", label: "A", text: "How many Blind Rehabilitation beds are projected? (W)", type: "W", inputKind: "number", defaultValue: 0 },
      
      // CHAPTER 202: AMBULATORY CARE
      { id: "CH202_A", chapterId: "202", label: "A", text: "How many annual Primary Care clinic stops are projected? (W)", type: "W", inputKind: "number", defaultValue: 0 },
      { id: "CH202_B", chapterId: "202", label: "B", text: "How many Primary Care Provider FTE positions are authorized? (S)", type: "S", inputKind: "number", defaultValue: 0 },
      { id: "CH202_C", chapterId: "202", label: "C", text: "How many Specialty Care Provider FTE positions are authorized? (S)", type: "S", inputKind: "number", defaultValue: 0 },
      
      // CHAPTER 210: SURGERY
      { id: "CH210_A", chapterId: "210", label: "A", text: "How many annual surgical operations are projected? (W)", type: "W", inputKind: "number", defaultValue: 0 },
      { id: "CH210_B", chapterId: "210", label: "B", text: "How many Operating Rooms are authorized? (M)", type: "M", inputKind: "number", defaultValue: 0 },
      { id: "CH210_C", chapterId: "210", label: "C", text: "Is Ambulatory Surgery authorized? (M)", type: "M", inputKind: "boolean", defaultValue: false },
      { id: "CH210_D", chapterId: "210", label: "D", text: "Is Cystoscopy authorized? (M)", type: "M", inputKind: "boolean", defaultValue: false },
      
      // CHAPTER 214: ANESTHESIA
      { id: "CH214_A", chapterId: "214", label: "A", text: "How many annual anesthesia procedures are projected? (W)", type: "W", inputKind: "number", defaultValue: 0 },
      { id: "CH214_B", chapterId: "214", label: "B", text: "How many Anesthesiologist FTE positions are authorized? (S)", type: "S", inputKind: "number", defaultValue: 0 },
      
      // CHAPTER 218: PACU
      { id: "CH218_A", chapterId: "218", label: "A", text: "How many PACU beds are projected? (W)", type: "W", inputKind: "number", defaultValue: 0 },
      
      // CHAPTER 224: PAIN MANAGEMENT
      { id: "CH224_A", chapterId: "224", label: "A", text: "How many annual Pain Management clinic stops are projected? (W)", type: "W", inputKind: "number", defaultValue: 0 },
      
      // CHAPTER 230: ENDOSCOPY
      { id: "CH230_A", chapterId: "230", label: "A", text: "How many annual endoscopy procedures are projected? (W)", type: "W", inputKind: "number", defaultValue: 0 },
      { id: "CH230_B", chapterId: "230", label: "B", text: "How many Endoscopy Procedure Rooms are authorized? (M)", type: "M", inputKind: "number", defaultValue: 0 },
      
      // CHAPTER 256: EMERGENCY DEPARTMENT
      { id: "CH256_A", chapterId: "256", label: "A", text: "How many annual ED visits (Stop Code 130) are projected? (W)", type: "W", inputKind: "number", defaultValue: 0 },
      { id: "CH256_B", chapterId: "256", label: "B", text: "How many Emergency Treatment Rooms are authorized? (M)", type: "M", inputKind: "number", defaultValue: 0 },
      { id: "CH256_C", chapterId: "256", label: "C", text: "Is a Trauma Bay authorized? (M)", type: "M", inputKind: "boolean", defaultValue: false },
      
      // CHAPTER 258: URGENT CARE
      { id: "CH258_A", chapterId: "258", label: "A", text: "How many annual Urgent Care visits are projected? (W)", type: "W", inputKind: "number", defaultValue: 0 },
      
      // CHAPTER 260: IMAGING
      { id: "CH260_A", chapterId: "260", label: "A", text: "How many annual Diagnostic Radiology procedures are projected? (W)", type: "W", inputKind: "number", defaultValue: 0 },
      { id: "CH260_B", chapterId: "260", label: "B", text: "How many Radiographic/Fluoroscopic Rooms are authorized? (M)", type: "M", inputKind: "number", defaultValue: 0 },
      { id: "CH260_C", chapterId: "260", label: "C", text: "How many CT Scanners are authorized? (M)", type: "M", inputKind: "number", defaultValue: 0 },
      { id: "CH260_D", chapterId: "260", label: "D", text: "How many MRI units are authorized? (M)", type: "M", inputKind: "number", defaultValue: 0 },
      { id: "CH260_E", chapterId: "260", label: "E", text: "How many Ultrasound Rooms are authorized? (M)", type: "M", inputKind: "number", defaultValue: 0 },
      
      // CHAPTER 262: CARDIOLOGY
      { id: "CH262_A", chapterId: "262", label: "A", text: "How many annual Cardiology clinic stops are projected? (W)", type: "W", inputKind: "number", defaultValue: 0 },
      { id: "CH262_B", chapterId: "262", label: "B", text: "Is Echocardiography authorized? (M)", type: "M", inputKind: "boolean", defaultValue: false },
      { id: "CH262_C", chapterId: "262", label: "C", text: "Is Cardiac Stress Testing authorized? (M)", type: "M", inputKind: "boolean", defaultValue: false },
      
      // CHAPTER 264: NUCLEAR MEDICINE
      { id: "CH264_A", chapterId: "264", label: "A", text: "How many annual Nuclear Medicine procedures are projected? (W)", type: "W", inputKind: "number", defaultValue: 0 },
      { id: "CH264_B", chapterId: "264", label: "B", text: "How many Gamma Cameras are authorized? (M)", type: "M", inputKind: "number", defaultValue: 0 },
      
      // CHAPTER 266: RADIATION ONCOLOGY
      { id: "CH266_A", chapterId: "266", label: "A", text: "How many annual Radiation Oncology treatments are projected? (W)", type: "W", inputKind: "number", defaultValue: 0 },
      { id: "CH266_B", chapterId: "266", label: "B", text: "How many Linear Accelerators are authorized? (M)", type: "M", inputKind: "number", defaultValue: 0 },
      
      // CHAPTER 268: PHARMACY
      { id: "CH268_A", chapterId: "268", label: "A", text: "How many Clinical Pharmacist FTE positions are authorized? (S)", type: "S", inputKind: "number", defaultValue: 0 },
      { id: "CH268_B", chapterId: "268", label: "B", text: "How many annual outpatient prescriptions are projected? (W)", type: "W", inputKind: "number", defaultValue: 0 },
      { id: "CH268_C", chapterId: "268", label: "C", text: "Is IV Admixture authorized? (M)", type: "M", inputKind: "boolean", defaultValue: false },
      { id: "CH268_D", chapterId: "268", label: "D", text: "Is Investigational Drug Service authorized? (M)", type: "M", inputKind: "boolean", defaultValue: false },
      
      // CHAPTER 270: PATHOLOGY & LAB
      { id: "CH270_A", chapterId: "270", label: "A", text: "How many annual Laboratory tests are projected? (W)", type: "W", inputKind: "number", defaultValue: 0 },
      { id: "CH270_B", chapterId: "270", label: "B", text: "How many Pathologist FTE positions are authorized? (S)", type: "S", inputKind: "number", defaultValue: 0 },
      { id: "CH270_C", chapterId: "270", label: "C", text: "Is Anatomical Pathology authorized? (M)", type: "M", inputKind: "boolean", defaultValue: false },
      { id: "CH270_D", chapterId: "270", label: "D", text: "Is Microbiology authorized? (M)", type: "M", inputKind: "boolean", defaultValue: false },
      
      // CHAPTER 272: BLOOD BANK
      { id: "CH272_A", chapterId: "272", label: "A", text: "How many annual blood units are projected? (W)", type: "W", inputKind: "number", defaultValue: 0 },
      { id: "CH272_B", chapterId: "272", label: "B", text: "Is Apheresis authorized? (M)", type: "M", inputKind: "boolean", defaultValue: false },
      
      // CHAPTER 280: PROSTHETICS
      { id: "CH280_A", chapterId: "280", label: "A", text: "How many Prosthetics FTE positions are authorized? (S)", type: "S", inputKind: "number", defaultValue: 0 },
      { id: "CH280_B", chapterId: "280", label: "B", text: "Is Orthotics/Prosthetics Fabrication authorized? (M)", type: "M", inputKind: "boolean", defaultValue: false },
      
      // CHAPTER 282: PHYSICAL MEDICINE & REHAB
      { id: "CH282_A", chapterId: "282", label: "A", text: "How many annual Physical Therapy visits are projected? (W)", type: "W", inputKind: "number", defaultValue: 0 },
      { id: "CH282_B", chapterId: "282", label: "B", text: "How many annual Occupational Therapy visits are projected? (W)", type: "W", inputKind: "number", defaultValue: 0 },
      { id: "CH282_C", chapterId: "282", label: "C", text: "How many Physical Therapist FTE positions are authorized? (S)", type: "S", inputKind: "number", defaultValue: 0 },
      { id: "CH282_D", chapterId: "282", label: "D", text: "How many Occupational Therapist FTE positions are authorized? (S)", type: "S", inputKind: "number", defaultValue: 0 },
      
      // CHAPTER 284: AUDIOLOGY/SPEECH
      { id: "CH284_A", chapterId: "284", label: "A", text: "How many annual Audiology clinic stops are projected? (W)", type: "W", inputKind: "number", defaultValue: 0 },
      { id: "CH284_B", chapterId: "284", label: "B", text: "How many annual Speech Pathology visits are projected? (W)", type: "W", inputKind: "number", defaultValue: 0 },
      { id: "CH284_C", chapterId: "284", label: "C", text: "How many Audiologist FTE positions are authorized? (S)", type: "S", inputKind: "number", defaultValue: 0 },
      
      // CHAPTER 286: NUTRITION & FOOD
      { id: "CH286_A", chapterId: "286", label: "A", text: "How many total meals per day are projected? (W)", type: "W", inputKind: "number", defaultValue: 0 },
      { id: "CH286_B", chapterId: "286", label: "B", text: "How many Dietitian FTE positions are authorized? (S)", type: "S", inputKind: "number", defaultValue: 0 },
      { id: "CH286_C", chapterId: "286", label: "C", text: "Is a Dining Room for patients authorized? (M)", type: "M", inputKind: "boolean", defaultValue: false },
      
      // CHAPTER 290: MENTAL HEALTH
      { id: "CH290_A", chapterId: "290", label: "A", text: "How many annual Mental Health clinic stops are projected? (W)", type: "W", inputKind: "number", defaultValue: 0 },
      { id: "CH290_B", chapterId: "290", label: "B", text: "How many Psychiatrist FTE positions are authorized? (S)", type: "S", inputKind: "number", defaultValue: 0 },
      { id: "CH290_C", chapterId: "290", label: "C", text: "How many Psychologist FTE positions are authorized? (S)", type: "S", inputKind: "number", defaultValue: 0 },
      { id: "CH290_D", chapterId: "290", label: "D", text: "Is Substance Abuse Treatment authorized? (M)", type: "M", inputKind: "boolean", defaultValue: false },
      
      // CHAPTER 292: SOCIAL WORK
      { id: "CH292_A", chapterId: "292", label: "A", text: "How many Social Worker FTE positions are authorized? (S)", type: "S", inputKind: "number", defaultValue: 0 },
      
      // CHAPTER 294: CHAPLAIN
      { id: "CH294_A", chapterId: "294", label: "A", text: "How many Chaplain FTE positions are authorized? (S)", type: "S", inputKind: "number", defaultValue: 0 },
      { id: "CH294_B", chapterId: "294", label: "B", text: "Is a Chapel authorized? (M)", type: "M", inputKind: "boolean", defaultValue: false },
      
      // CHAPTER 298: EDUCATION
      { id: "CH298_A", chapterId: "298", label: "A", text: "How many Educator FTE positions are authorized? (S)", type: "S", inputKind: "number", defaultValue: 0 },
      { id: "CH298_B", chapterId: "298", label: "B", text: "How many total staff requiring training? (W)", type: "W", inputKind: "number", defaultValue: 0 },
      
      // CHAPTER 300: ADMINISTRATION
      { id: "CH300_A", chapterId: "300", label: "A", text: "How many Administrative FTE positions are authorized? (S)", type: "S", inputKind: "number", defaultValue: 0 },
      { id: "CH300_B", chapterId: "300", label: "B", text: "How many total facility FTE positions? (W)", type: "W", inputKind: "number", defaultValue: 0 },
      
      // CHAPTER 310: MEDICAL RECORDS
      { id: "CH310_A", chapterId: "310", label: "A", text: "How many annual patient registrations are projected? (W)", type: "W", inputKind: "number", defaultValue: 0 },
      { id: "CH310_B", chapterId: "310", label: "B", text: "How many Medical Records FTE positions are authorized? (S)", type: "S", inputKind: "number", defaultValue: 0 },
      
      // CHAPTER 330: VOLUNTARY SERVICE
      { id: "CH330_A", chapterId: "330", label: "A", text: "How many Voluntary Service FTE positions are authorized? (S)", type: "S", inputKind: "number", defaultValue: 0 },
      
      // CHAPTER 340: ENVIRONMENTAL MANAGEMENT
      { id: "CH340_A", chapterId: "340", label: "A", text: "How many Environmental Management FTE positions are authorized? (S)", type: "S", inputKind: "number", defaultValue: 0 },
      { id: "CH340_B", chapterId: "340", label: "B", text: "What is the total building gross square feet? (W)", type: "W", inputKind: "number", defaultValue: 0 },
      
      // CHAPTER 350: STERILE PROCESSING
      { id: "CH350_A", chapterId: "350", label: "A", text: "How many annual surgical instrument sets are projected? (W)", type: "W", inputKind: "number", defaultValue: 0 },
      { id: "CH350_B", chapterId: "350", label: "B", text: "How many Sterile Processing FTE positions are authorized? (S)", type: "S", inputKind: "number", defaultValue: 0 },
      
      // CHAPTER 360: LINEN SERVICE
      { id: "CH360_A", chapterId: "360", label: "A", text: "How many pounds of linen per day are projected? (W)", type: "W", inputKind: "number", defaultValue: 0 },
      { id: "CH360_B", chapterId: "360", label: "B", text: "Is on-site laundry authorized? (M)", type: "M", inputKind: "boolean", defaultValue: false },
      
      // CHAPTER 370: ENGINEERING
      { id: "CH370_A", chapterId: "370", label: "A", text: "How many Engineering FTE positions are authorized? (S)", type: "S", inputKind: "number", defaultValue: 0 },
      { id: "CH370_B", chapterId: "370", label: "B", text: "What is the total building gross square feet? (W)", type: "W", inputKind: "number", defaultValue: 0 },
      
      // CHAPTER 380: POLICE SERVICE
      { id: "CH380_A", chapterId: "380", label: "A", text: "How many Police Officer FTE positions are authorized? (S)", type: "S", inputKind: "number", defaultValue: 0 },
      
      // CHAPTER 390: TELECOMMUNICATIONS
      { id: "CH390_A", chapterId: "390", label: "A", text: "How many Telecommunications FTE positions are authorized? (S)", type: "S", inputKind: "number", defaultValue: 0 },
      
      // CHAPTER 420: GENERAL STORAGE
      { id: "CH420_A", chapterId: "420", label: "A", text: "What is the total building gross square feet? (W)", type: "W", inputKind: "number", defaultValue: 0 }
    ];

    const SAMPLE_FUNCTIONAL_AREAS = [
      {
        id: "100-FA1",
        chapterId: "100",
        code: "FA 1",
        name: "Inpatient Unit Patient Area"
      },
      {
        id: "100-FA2",
        chapterId: "100",
        code: "FA 2",
        name: "Support Area"
      },
      {
        id: "268-FA13",
        chapterId: "268",
        code: "FA 13",
        name: "Medication Consultation Services"
      }
    ];

    // SAMPLE_ROOMS now loaded from room-sizes.js as ROOM_SIZES
    const SAMPLE_ROOMS = ROOM_SIZES || [
      // Fallback data if room-sizes.js fails to load
      { id: "IMS21", chapterId: "100", name: "Single Universal Bedroom, MS PCU", nsf: 140 },
      { id: "IMS23", chapterId: "100", name: "Airborne Infection Isolation (AII) Bedroom", nsf: 160 },
      { id: "IMS24", chapterId: "100", name: "Airborne Infection Isolation (AII) Anteroom", nsf: 65 },
      { id: "IMS25", chapterId: "100", name: "Protective Environment Isolation Bedroom", nsf: 160 },
      { id: "IMS26", chapterId: "100", name: "Protective Environment Isolation Anteroom", nsf: 65 },
      { id: "IMS27", chapterId: "100", name: "Bariatric / Physical Disabilities Bedroom", nsf: 200 },
      { id: "NTOIL", chapterId: "100", name: "Patient Toilet", nsf: 60 },
      { id: "NTOI1", chapterId: "100", name: "Patient Toilet, Bariatric", nsf: 80 },
      { id: "NTOI2", chapterId: "100", name: "Patient Toilet, Isolation", nsf: 65 },
      { id: "NSHWR", chapterId: "100", name: "Patient Shower", nsf: 40 },
      { id: "NBATH", chapterId: "100", name: "Patient Bathing Room", nsf: 80 },
      { id: "NWCRM", chapterId: "100", name: "Wheelchair Storage", nsf: 30 },
      { id: "OFA01", chapterId: "100", name: "Office, Nurse Manager", nsf: 120 },
      { id: "OFA02", chapterId: "100", name: "Office, Assistant Nurse Manager", nsf: 100 },
      { id: "OFA03", chapterId: "100", name: "Office, Clinical Nurse Specialist", nsf: 100 },
      { id: "WRML1", chapterId: "100", name: "Workroom, Clinical", nsf: 150 },
      { id: "MEDST", chapterId: "100", name: "Medication Room", nsf: 120 },
      { id: "UTLCL", chapterId: "100", name: "Utility Room, Clean", nsf: 80 },
      { id: "UTLSO", chapterId: "100", name: "Utility Room, Soiled", nsf: 80 },
      { id: "NUTRI", chapterId: "100", name: "Nourishment Station", nsf: 100 },
      { id: "EQPSS", chapterId: "100", name: "Equipment Storage", nsf: 60 },
      { id: "LNST1", chapterId: "100", name: "Linen Storage, Clean", nsf: 60 },
      { id: "JANIT", chapterId: "100", name: "Janitor's Closet", nsf: 40 },
      
      // CHAPTER 102: ICU
      { id: "ICU01", chapterId: "102", name: "ICU Patient Room", nsf: 250 },
      { id: "ICU02", chapterId: "102", name: "ICU Patient Room, Isolation", nsf: 270 },
      { id: "ICUTO", chapterId: "102", name: "ICU Patient Toilet", nsf: 60 },
      { id: "ICUFA", chapterId: "102", name: "ICU Family Consult Room", nsf: 120 },
      { id: "ICUWR", chapterId: "102", name: "ICU Workroom", nsf: 150 },
      { id: "ICUMD", chapterId: "102", name: "ICU Medication Room", nsf: 120 },
      { id: "ICUUC", chapterId: "102", name: "ICU Utility Clean", nsf: 80 },
      { id: "ICUUS", chapterId: "102", name: "ICU Utility Soiled", nsf: 80 },
      { id: "ICUEQ", chapterId: "102", name: "ICU Equipment Storage", nsf: 80 },
      
      // CHAPTER 112: MATERNITY
      { id: "LDR01", chapterId: "112", name: "Labor, Delivery, Recovery Room (LDR)", nsf: 350 },
      { id: "LDRP1", chapterId: "112", name: "Labor, Delivery, Recovery, Postpartum (LDRP)", nsf: 400 },
      { id: "LABOR", chapterId: "112", name: "Labor Room", nsf: 200 },
      { id: "DELIV", chapterId: "112", name: "Delivery Room", nsf: 400 },
      { id: "RECOV", chapterId: "112", name: "Recovery Room", nsf: 140 },
      { id: "NURSY", chapterId: "112", name: "Nursery", nsf: 120 },
      { id: "MATWR", chapterId: "112", name: "Maternity Workroom", nsf: 150 },
      
      // CHAPTER 122: PEDIATRICS
      { id: "PEDBR", chapterId: "122", name: "Pediatric Patient Bedroom", nsf: 140 },
      { id: "PEDPT", chapterId: "122", name: "Pediatric Play Room", nsf: 200 },
      { id: "PEDWR", chapterId: "122", name: "Pediatric Workroom", nsf: 150 },
      
      // CHAPTER 124: NICU
      { id: "NICU1", chapterId: "124", name: "NICU Patient Space, Level II", nsf: 120 },
      { id: "NICU2", chapterId: "124", name: "NICU Patient Space, Level III", nsf: 150 },
      { id: "NICUW", chapterId: "124", name: "NICU Workroom", nsf: 150 },
      
      // CHAPTER 126: PSYCHIATRY
      { id: "PSYBR", chapterId: "126", name: "Psychiatric Patient Bedroom", nsf: 140 },
      { id: "PSYTO", chapterId: "126", name: "Psychiatric Patient Toilet", nsf: 60 },
      { id: "PSYDA", chapterId: "126", name: "Psychiatric Day Room", nsf: 400 },
      { id: "PSYDI", chapterId: "126", name: "Psychiatric Dining Room", nsf: 300 },
      { id: "PSYOC", chapterId: "126", name: "Psychiatric Occupational Therapy", nsf: 400 },
      { id: "PSYEX", chapterId: "126", name: "Psychiatric Exercise Room", nsf: 300 },
      { id: "PSYQU", chapterId: "126", name: "Psychiatric Quiet Room", nsf: 100 },
      { id: "PSYSE", chapterId: "126", name: "Psychiatric Seclusion Room", nsf: 100 },
      
      // CHAPTER 130: SCI
      { id: "SCIBR", chapterId: "130", name: "SCI Patient Bedroom", nsf: 200 },
      { id: "SCITO", chapterId: "130", name: "SCI Patient Toilet", nsf: 80 },
      { id: "SCISH", chapterId: "130", name: "SCI Patient Shower", nsf: 60 },
      { id: "SCITR", chapterId: "130", name: "SCI Therapy Room", nsf: 400 },
      
      // CHAPTER 132: BLIND REHAB
      { id: "BRBR1", chapterId: "132", name: "Blind Rehab Patient Bedroom", nsf: 140 },
      { id: "BRTR1", chapterId: "132", name: "Blind Rehab Training Room", nsf: 300 },
      
      // CHAPTER 202: AMBULATORY CARE
      { id: "EXCL1", chapterId: "202", name: "Exam/Consult Room, Primary Care", nsf: 120 },
      { id: "EXCL2", chapterId: "202", name: "Exam/Consult Room, Specialty", nsf: 120 },
      { id: "PROC1", chapterId: "202", name: "Procedure Room, Minor", nsf: 150 },
      { id: "OFCL1", chapterId: "202", name: "Office, Provider", nsf: 120 },
      { id: "WRMCL", chapterId: "202", name: "Workroom, Clinical", nsf: 120 },
      
      // CHAPTER 210: SURGERY
      { id: "OPROM", chapterId: "210", name: "Operating Room", nsf: 600 },
      { id: "ORCYS", chapterId: "210", name: "Cystoscopy Room", nsf: 400 },
      { id: "SCRUB", chapterId: "210", name: "Scrub/Gown Area", nsf: 80 },
      { id: "SUBST", chapterId: "210", name: "Sub-Sterile Room", nsf: 80 },
      { id: "ANSUP", chapterId: "210", name: "Anesthesia Supply Room", nsf: 150 },
      { id: "ORSTR", chapterId: "210", name: "OR Supply/Storage", nsf: 200 },
      { id: "ORSTC", chapterId: "210", name: "OR Sterile Supply", nsf: 150 },
      
      // CHAPTER 214: ANESTHESIA
      { id: "OFAN1", chapterId: "214", name: "Office, Anesthesiologist", nsf: 120 },
      { id: "ANWRK", chapterId: "214", name: "Anesthesia Workroom", nsf: 150 },
      
      // CHAPTER 218: PACU
      { id: "PACUB", chapterId: "218", name: "PACU Patient Bay", nsf: 120 },
      { id: "PACUW", chapterId: "218", name: "PACU Workstation", nsf: 150 },
      
      // CHAPTER 224: PAIN MANAGEMENT
      { id: "PAINC", chapterId: "224", name: "Pain Management Consult Room", nsf: 120 },
      { id: "PAINP", chapterId: "224", name: "Pain Management Procedure Room", nsf: 150 },
      
      // CHAPTER 230: ENDOSCOPY
      { id: "ENDPR", chapterId: "230", name: "Endoscopy Procedure Room", nsf: 350 },
      { id: "ENDREC", chapterId: "230", name: "Endoscopy Recovery Bay", nsf: 80 },
      { id: "ENDCL", chapterId: "230", name: "Endoscope Cleaning Room", nsf: 120 },
      
      // CHAPTER 256: EMERGENCY
      { id: "EDTRT", chapterId: "256", name: "ED Treatment Room", nsf: 140 },
      { id: "EDTRA", chapterId: "256", name: "ED Trauma Bay", nsf: 400 },
      { id: "EDCAR", chapterId: "256", name: "ED Cardiac Room", nsf: 200 },
      { id: "EDTRI", chapterId: "256", name: "ED Triage Room", nsf: 100 },
      { id: "EDWAI", chapterId: "256", name: "ED Waiting Room", nsf: 300 },
      { id: "EDWRK", chapterId: "256", name: "ED Workroom", nsf: 150 },
      
      // CHAPTER 258: URGENT CARE
      { id: "UCTRT", chapterId: "258", name: "Urgent Care Treatment Room", nsf: 120 },
      { id: "UCWAI", chapterId: "258", name: "Urgent Care Waiting", nsf: 200 },
      
      // CHAPTER 260: IMAGING
      { id: "XRAY1", chapterId: "260", name: "Radiographic/Fluoroscopic Room", nsf: 350 },
      { id: "XRCT1", chapterId: "260", name: "CT Scanner Room", nsf: 500 },
      { id: "XRMRI", chapterId: "260", name: "MRI Room", nsf: 600 },
      { id: "XRUS1", chapterId: "260", name: "Ultrasound Room", nsf: 200 },
      { id: "XRCON", chapterId: "260", name: "Radiologist Control/Reading Room", nsf: 150 },
      { id: "XRCHG", chapterId: "260", name: "Patient Changing Room", nsf: 40 },
      { id: "XRWAI", chapterId: "260", name: "Imaging Waiting Area", nsf: 200 },
      
      // CHAPTER 262: CARDIOLOGY
      { id: "CARDC", chapterId: "262", name: "Cardiology Consult Room", nsf: 120 },
      { id: "CECHO", chapterId: "262", name: "Echocardiography Room", nsf: 200 },
      { id: "CSTRS", chapterId: "262", name: "Cardiac Stress Test Room", nsf: 250 },
      { id: "CCATH", chapterId: "262", name: "Cardiac Catheterization Lab", nsf: 800 },
      
      // CHAPTER 264: NUCLEAR MEDICINE
      { id: "NMGAM", chapterId: "264", name: "Gamma Camera Room", nsf: 350 },
      { id: "NMPTS", chapterId: "264", name: "Nuclear Med Patient Waiting", nsf: 80 },
      { id: "NMHOT", chapterId: "264", name: "Hot Lab", nsf: 120 },
      
      // CHAPTER 266: RADIATION ONCOLOGY
      { id: "ROLAC", chapterId: "266", name: "Linear Accelerator Room", nsf: 600 },
      { id: "ROSIM", chapterId: "266", name: "Simulation Room", nsf: 400 },
      { id: "ROCON", chapterId: "266", name: "Radiation Oncology Consult", nsf: 120 },
      { id: "ROWAI", chapterId: "266", name: "Radiation Oncology Waiting", nsf: 200 },
      
      // CHAPTER 268: PHARMACY
      { id: "PHCON", chapterId: "268", name: "Pharmacy Consult Room", nsf: 100 },
      { id: "PHDIS", chapterId: "268", name: "Outpatient Dispensing", nsf: 300 },
      { id: "PHIVA", chapterId: "268", name: "IV Admixture Room", nsf: 200 },
      { id: "PHINV", chapterId: "268", name: "Investigational Drug Room", nsf: 120 },
      { id: "PHSTO", chapterId: "268", name: "Pharmacy Storage", nsf: 400 },
      { id: "PHOFF", chapterId: "268", name: "Pharmacist Office", nsf: 100 },
      
      // CHAPTER 270: LAB
      { id: "LABCH", chapterId: "270", name: "Chemistry Lab", nsf: 600 },
      { id: "LABHE", chapterId: "270", name: "Hematology Lab", nsf: 400 },
      { id: "LABMI", chapterId: "270", name: "Microbiology Lab", nsf: 500 },
      { id: "LABPA", chapterId: "270", name: "Pathology Lab", nsf: 400 },
      { id: "LABGR", chapterId: "270", name: "Gross Anatomy Room", nsf: 300 },
      { id: "LABPC", chapterId: "270", name: "Phlebotomy Collection", nsf: 80 },
      { id: "LABOF", chapterId: "270", name: "Pathologist Office", nsf: 120 },
      
      // CHAPTER 272: BLOOD BANK
      { id: "BBSTO", chapterId: "272", name: "Blood Bank Storage", nsf: 200 },
      { id: "BBAPH", chapterId: "272", name: "Apheresis Room", nsf: 150 },
      { id: "BBWRK", chapterId: "272", name: "Blood Bank Workroom", nsf: 200 },
      
      // CHAPTER 280: PROSTHETICS
      { id: "PROEX", chapterId: "280", name: "Prosthetics Exam Room", nsf: 120 },
      { id: "PROFB", chapterId: "280", name: "Prosthetics Fabrication", nsf: 500 },
      { id: "PROFF", chapterId: "280", name: "Prosthetist Office", nsf: 100 },
      
      // CHAPTER 282: PM&R
      { id: "PTGYM", chapterId: "282", name: "Physical Therapy Gymnasium", nsf: 800 },
      { id: "PTTRT", chapterId: "282", name: "PT Treatment Cubicle", nsf: 80 },
      { id: "OTTRM", chapterId: "282", name: "Occupational Therapy Room", nsf: 200 },
      { id: "OTADL", chapterId: "282", name: "OT Activities of Daily Living", nsf: 300 },
      { id: "PMOFF", chapterId: "282", name: "Therapist Office", nsf: 100 },
      
      // CHAPTER 284: AUDIOLOGY
      { id: "AUDBO", chapterId: "284", name: "Audiology Booth", nsf: 80 },
      { id: "SPCON", chapterId: "284", name: "Speech Pathology Room", nsf: 120 },
      { id: "AUDOF", chapterId: "284", name: "Audiologist Office", nsf: 100 },
      
      // CHAPTER 286: NUTRITION
      { id: "KITCN", chapterId: "286", name: "Main Kitchen", nsf: 2000 },
      { id: "DININ", chapterId: "286", name: "Dining Room", nsf: 600 },
      { id: "CAFET", chapterId: "286", name: "Cafeteria", nsf: 1200 },
      { id: "NUTOF", chapterId: "286", name: "Dietitian Office", nsf: 100 },
      { id: "NUTCO", chapterId: "286", name: "Nutrition Consult Room", nsf: 100 },
      
      // CHAPTER 290: MENTAL HEALTH
      { id: "MHCON", chapterId: "290", name: "Mental Health Consult Room", nsf: 120 },
      { id: "MHGRP", chapterId: "290", name: "Group Therapy Room", nsf: 300 },
      { id: "MHOFF", chapterId: "290", name: "Psychiatrist/Psychologist Office", nsf: 120 },
      { id: "MHSUB", chapterId: "290", name: "Substance Abuse Treatment Room", nsf: 150 },
      
      // CHAPTER 292: SOCIAL WORK
      { id: "SWCON", chapterId: "292", name: "Social Work Consult Room", nsf: 100 },
      { id: "SWOFF", chapterId: "292", name: "Social Worker Office", nsf: 100 },
      
      // CHAPTER 294: CHAPLAIN
      { id: "CHOFF", chapterId: "294", name: "Chaplain Office", nsf: 100 },
      { id: "CHAPE", chapterId: "294", name: "Chapel", nsf: 800 },
      { id: "CHMED", chapterId: "294", name: "Meditation Room", nsf: 120 },
      
      // CHAPTER 298: EDUCATION
      { id: "EDCLR", chapterId: "298", name: "Classroom", nsf: 600 },
      { id: "EDCON", chapterId: "298", name: "Conference Room", nsf: 400 },
      { id: "EDOFF", chapterId: "298", name: "Educator Office", nsf: 100 },
      { id: "EDLIB", chapterId: "298", name: "Library", nsf: 800 },
      
      // CHAPTER 300: ADMINISTRATION
      { id: "ADDIR", chapterId: "300", name: "Director Office", nsf: 200 },
      { id: "ADOFF", chapterId: "300", name: "Administrative Office", nsf: 100 },
      { id: "ADCON", chapterId: "300", name: "Conference Room", nsf: 300 },
      { id: "ADWRK", chapterId: "300", name: "Workroom/Copy", nsf: 150 },
      
      // CHAPTER 310: MEDICAL RECORDS
      { id: "MRREG", chapterId: "310", name: "Registration/Admitting", nsf: 80 },
      { id: "MRFIL", chapterId: "310", name: "File Room", nsf: 800 },
      { id: "MRWRK", chapterId: "310", name: "Medical Records Work Area", nsf: 200 },
      { id: "MROFF", chapterId: "310", name: "Medical Records Office", nsf: 100 },
      
      // CHAPTER 330: VOLUNTARY SERVICE
      { id: "VSOFF", chapterId: "330", name: "Voluntary Service Office", nsf: 100 },
      { id: "VSWRK", chapterId: "330", name: "Volunteer Work Area", nsf: 200 },
      
      // CHAPTER 340: ENVIRONMENTAL MGMT
      { id: "EMOFF", chapterId: "340", name: "EMS Office", nsf: 100 },
      { id: "EMSTO", chapterId: "340", name: "Housekeeping Storage", nsf: 200 },
      { id: "EMJAN", chapterId: "340", name: "Janitor Closet", nsf: 40 },
      
      // CHAPTER 350: STERILE PROCESSING
      { id: "SPDEC", chapterId: "350", name: "Decontamination Area", nsf: 400 },
      { id: "SPPRE", chapterId: "350", name: "Prep & Pack Area", nsf: 400 },
      { id: "SPSTR", chapterId: "350", name: "Sterilization Room", nsf: 300 },
      { id: "SPSTO", chapterId: "350", name: "Sterile Storage", nsf: 300 },
      
      // CHAPTER 360: LINEN
      { id: "LNCLN", chapterId: "360", name: "Clean Linen Storage", nsf: 400 },
      { id: "LNSOL", chapterId: "360", name: "Soiled Linen Holding", nsf: 200 },
      { id: "LNLAU", chapterId: "360", name: "Laundry Processing", nsf: 800 },
      
      // CHAPTER 370: ENGINEERING
      { id: "ENGOF", chapterId: "370", name: "Engineering Office", nsf: 100 },
      { id: "ENGSH", chapterId: "370", name: "Engineering Shop", nsf: 400 },
      { id: "ENGST", chapterId: "370", name: "Engineering Storage", nsf: 300 },
      
      // CHAPTER 380: POLICE
      { id: "POLOF", chapterId: "380", name: "Police Office", nsf: 100 },
      { id: "POLDI", chapterId: "380", name: "Police Dispatch", nsf: 150 },
      
      // CHAPTER 390: TELECOM
      { id: "TELOF", chapterId: "390", name: "Telecommunications Office", nsf: 100 },
      { id: "TELMDF", chapterId: "390", name: "MDF/IDF Room", nsf: 200 },
      
      // CHAPTER 420: STORAGE
      { id: "STRGE", chapterId: "420", name: "General Storage", nsf: 1000 },
      { id: "RECEI", chapterId: "420", name: "Receiving Dock", nsf: 600 }
    ];

    const SAMPLE_EQUIPMENT = [];  // Will be loaded from Equipment_Guide_parsed_v2.txt

    const SAMPLE_ROOM_EQUIPMENT = [];  // Will be loaded from Equipment_Guide_parsed_v2.txt

    // -----------------------------
    // STATE
    // -----------------------------

    let activeChapters = ["100", "102", "210", "256", "268"];
    let driverValues = [
      { projectId: PROJECT.id, driverId: "CH100_A", value: 32 },
      { projectId: PROJECT.id, driverId: "CH100_B", value: false },
      { projectId: PROJECT.id, driverId: "CH102_A", value: 12 },
      { projectId: PROJECT.id, driverId: "CH102_B", value: false },
      { projectId: PROJECT.id, driverId: "CH102_C", value: false },
      { projectId: PROJECT.id, driverId: "CH210_A", value: 0 },
      { projectId: PROJECT.id, driverId: "CH210_B", value: 4 },
      { projectId: PROJECT.id, driverId: "CH210_C", value: false },
      { projectId: PROJECT.id, driverId: "CH210_D", value: false },
      { projectId: PROJECT.id, driverId: "CH256_A", value: 0 },
      { projectId: PROJECT.id, driverId: "CH256_B", value: 8 },
      { projectId: PROJECT.id, driverId: "CH256_C", value: false },
      { projectId: PROJECT.id, driverId: "CH268_A", value: 3 },
      { projectId: PROJECT.id, driverId: "CH268_B", value: 50000 },
      { projectId: PROJECT.id, driverId: "CH268_C", value: true },
      { projectId: PROJECT.id, driverId: "CH268_D", value: false }
    ];

    let currentMode = 'program';
    let compareLeftRoom = null;
    let compareRightRoom = null; // 'program' or 'reference'
    let selectedNode = null;
    let expandedNodes = new Set(['project']);
    let viewState = 'project-list'; // 'project-list' or 'project-detail'
    let selectedProjectInList = null; // Project selected in list view (not opened)

    let globalIdCounter = 1;
    function makeId() {
      return "id-" + (globalIdCounter++);
    }

    // -----------------------------
    // RULE ENGINE
    // -----------------------------

    function buildProgram(project, driverValues, activeChapterIds) {
      const driverMap = new Map();
      driverValues.forEach(d => driverMap.set(d.driverId, d));

      // Helper function to get driver value
      const getVal = (driverId) => {
        const driver = driverMap.get(driverId);
        if (!driver) return 0;
        if (typeof driver.value === "boolean") return driver.value ? 1 : 0;
        return typeof driver.value === "number" ? driver.value : Number(driver.value || 0);
      };

      const getBool = (driverId) => {
        const driver = driverMap.get(driverId);
        if (!driver) return false;
        return driver.value === true || driver.value === "true";
      };

      const roomRequirements = [];

      // Helper to add room requirement
      const addRoom = (chapterId, roomId, count) => {
        if (count > 0) {
          roomRequirements.push({
            id: makeId(),
            projectId: project.id,
            chapterId: chapterId,
            roomTemplateId: roomId,
            requiredCount: Math.ceil(count)
          });
        }
      };

      // ===== CHAPTER 100: MED/SURG PCU =====
      if (activeChapterIds.includes("100")) {
        const beds = getVal("CH100_A");
        const hasBehavioral = getBool("CH100_B");
        
        if (beds > 0) {
          // Patient Bedrooms - 1 per bed
          addRoom("100", "IMS21", beds);
          
          // Isolation rooms - 1 per 16 beds
          addRoom("100", "IMS23", Math.ceil(beds / 16));
          addRoom("100", "IMS24", Math.ceil(beds / 16)); // Anteroom for isolation
          
          // Bariatric rooms - minimum 1 per 32 beds
          addRoom("100", "IMS27", Math.max(1, Math.ceil(beds / 32)));
        }
      }

      // ===== CHAPTER 102: ICU =====
      if (activeChapterIds.includes("102")) {
        const icuBeds = getVal("CH102_A");
        const hasCCU = getBool("CH102_B");
        const hasCath = getBool("CH102_C");
        
        if (icuBeds > 0) {
          // ICU patient rooms - 1 per bed
          addRoom("102", "ICU01", icuBeds);
          
          // Isolation rooms - minimum 1, or 10% of beds
          addRoom("102", "ICU02", Math.max(1, Math.ceil(icuBeds * 0.1)));
          
          // Patient toilets - 1 per 2 beds
          addRoom("102", "ICUTO", Math.ceil(icuBeds / 2));
          
          // Family consult - 1 per unit (12 beds)
          addRoom("102", "ICUFA", Math.ceil(icuBeds / 12));
          
          // Workroom - 1 per unit
          addRoom("102", "ICUWR", Math.ceil(icuBeds / 12));
          
          // Medication room - 1 per unit
          addRoom("102", "ICUMD", Math.ceil(icuBeds / 12));
          
          // Utility clean - 1 per unit
          addRoom("102", "ICUUC", Math.ceil(icuBeds / 12));
          
          // Utility soiled - 1 per unit
          addRoom("102", "ICUUS", Math.ceil(icuBeds / 12));
          
          // Equipment storage - 1 per unit
          addRoom("102", "ICUEQ", Math.ceil(icuBeds / 12));
          
          // If Cardiac Cath Lab authorized
          if (hasCath) {
            addRoom("102", "CCATH", 1);
          }
        }
      }

      // ===== CHAPTER 112: MATERNITY =====
      if (activeChapterIds.includes("112")) {
        const deliveries = getVal("CH112_A");
        const hasLDR = getBool("CH112_B");
        const hasLDRP = getBool("CH112_C");
        
        if (deliveries > 0) {
          if (hasLDRP) {
            // LDRP rooms - 1 per 300 deliveries
            addRoom("112", "LDRP1", Math.max(1, Math.ceil(deliveries / 300)));
          } else if (hasLDR) {
            // LDR rooms - 1 per 400 deliveries
            addRoom("112", "LDR01", Math.max(1, Math.ceil(deliveries / 400)));
          } else {
            // Traditional Labor & Delivery
            addRoom("112", "LABOR", Math.max(1, Math.ceil(deliveries / 500)));
            addRoom("112", "DELIV", Math.max(1, Math.ceil(deliveries / 600)));
          }
          
          // Recovery rooms
          addRoom("112", "RECOV", Math.max(2, Math.ceil(deliveries / 400)));
          
          // Nursery
          addRoom("112", "NURSY", Math.max(1, Math.ceil(deliveries / 500)));
          
          // Workroom
          addRoom("112", "MATWR", 1);
        }
      }

      // ===== CHAPTER 122: PEDIATRICS =====
      if (activeChapterIds.includes("122")) {
        const pedBeds = getVal("CH122_A");
        
        if (pedBeds > 0) {
          addRoom("122", "PEDBR", pedBeds);
          addRoom("122", "PEDPT", Math.ceil(pedBeds / 16));
          addRoom("122", "PEDWR", Math.ceil(pedBeds / 16));
        }
      }

      // ===== CHAPTER 124: NICU =====
      if (activeChapterIds.includes("124")) {
        const nicuBeds = getVal("CH124_A");
        const hasLevel2 = getBool("CH124_B");
        const hasLevel3 = getBool("CH124_C");
        
        if (nicuBeds > 0) {
          if (hasLevel3) {
            addRoom("124", "NICU2", nicuBeds);
          } else if (hasLevel2) {
            addRoom("124", "NICU1", nicuBeds);
          }
          addRoom("124", "NICUW", Math.ceil(nicuBeds / 12));
        }
      }

      // ===== CHAPTER 126: PSYCHIATRY =====
      if (activeChapterIds.includes("126")) {
        const psyBeds = getVal("CH126_A");
        const hasIntensive = getBool("CH126_B");
        
        if (psyBeds > 0) {
          // Bedrooms - 1 per bed
          addRoom("126", "PSYBR", psyBeds);
          
          // Toilets - 1 per bedroom
          addRoom("126", "PSYTO", psyBeds);
          
          // Day room - 1 per 16 beds
          addRoom("126", "PSYDA", Math.ceil(psyBeds / 16));
          
          // Dining - 1 per 16 beds
          addRoom("126", "PSYDI", Math.ceil(psyBeds / 16));
          
          // OT space - 1 per 16 beds
          addRoom("126", "PSYOC", Math.ceil(psyBeds / 16));
          
          // Exercise room - 1 per 32 beds
          addRoom("126", "PSYEX", Math.ceil(psyBeds / 32));
          
          // Quiet room - 1 per 16 beds
          addRoom("126", "PSYQU", Math.ceil(psyBeds / 16));
          
          // Seclusion room - minimum 2
          addRoom("126", "PSYSE", Math.max(2, Math.ceil(psyBeds / 16)));
        }
      }

      // ===== CHAPTER 130: SCI =====
      if (activeChapterIds.includes("130")) {
        const sciBeds = getVal("CH130_A");
        
        if (sciBeds > 0) {
          addRoom("130", "SCIBR", sciBeds);
          addRoom("130", "SCITO", sciBeds);
          addRoom("130", "SCISH", Math.ceil(sciBeds / 4));
          addRoom("130", "SCITR", Math.ceil(sciBeds / 8));
        }
      }

      // ===== CHAPTER 132: BLIND REHAB =====
      if (activeChapterIds.includes("132")) {
        const brBeds = getVal("CH132_A");
        
        if (brBeds > 0) {
          addRoom("132", "BRBR1", brBeds);
          addRoom("132", "BRTR1", Math.ceil(brBeds / 8));
        }
      }

      // ===== CHAPTER 202: AMBULATORY CARE =====
      if (activeChapterIds.includes("202")) {
        const primaryStops = getVal("CH202_A");
        const primaryFTE = getVal("CH202_B");
        const specialtyFTE = getVal("CH202_C");
        
        // Primary care exam rooms - 1.5 per FTE
        if (primaryFTE > 0) {
          addRoom("202", "EXCL1", Math.ceil(primaryFTE * 1.5));
          addRoom("202", "OFCL1", primaryFTE);
        }
        
        // Specialty exam rooms - 1.5 per FTE
        if (specialtyFTE > 0) {
          addRoom("202", "EXCL2", Math.ceil(specialtyFTE * 1.5));
        }
        
        // Procedure rooms - 1 per 10,000 stops
        if (primaryStops > 0) {
          addRoom("202", "PROC1", Math.max(1, Math.ceil(primaryStops / 10000)));
          addRoom("202", "WRMCL", Math.max(1, Math.ceil((primaryFTE + specialtyFTE) / 5)));
        }
      }

      // ===== CHAPTER 210: SURGERY =====
      if (activeChapterIds.includes("210")) {
        const surgeries = getVal("CH210_A");
        const orRooms = getVal("CH210_B");
        const hasAmb = getBool("CH210_C");
        const hasCysto = getBool("CH210_D");
        
        if (orRooms > 0) {
          addRoom("210", "OPROM", orRooms);
          addRoom("210", "SCRUB", orRooms);
          addRoom("210", "SUBST", orRooms);
          addRoom("210", "ANSUP", Math.max(1, Math.ceil(orRooms / 4)));
          addRoom("210", "ORSTR", Math.max(1, Math.ceil(orRooms / 4)));
          addRoom("210", "ORSTC", Math.max(1, Math.ceil(orRooms / 4)));
          
          if (hasCysto) {
            addRoom("210", "ORCYS", 1);
          }
        }
      }

      // ===== CHAPTER 214: ANESTHESIA =====
      if (activeChapterIds.includes("214")) {
        const anesthFTE = getVal("CH214_B");
        
        if (anesthFTE > 0) {
          addRoom("214", "OFAN1", anesthFTE);
          addRoom("214", "ANWRK", Math.ceil(anesthFTE / 4));
        }
      }

      // ===== CHAPTER 218: PACU =====
      if (activeChapterIds.includes("218")) {
        const pacuBeds = getVal("CH218_A");
        
        if (pacuBeds > 0) {
          addRoom("218", "PACUB", pacuBeds);
          addRoom("218", "PACUW", Math.ceil(pacuBeds / 8));
        }
      }

      // ===== CHAPTER 224: PAIN MANAGEMENT =====
      if (activeChapterIds.includes("224")) {
        const painStops = getVal("CH224_A");
        
        if (painStops > 0) {
          addRoom("224", "PAINC", Math.max(1, Math.ceil(painStops / 2500)));
          addRoom("224", "PAINP", Math.max(1, Math.ceil(painStops / 3000)));
        }
      }

      // ===== CHAPTER 230: ENDOSCOPY =====
      if (activeChapterIds.includes("230")) {
        const endoProc = getVal("CH230_A");
        const endoRooms = getVal("CH230_B");
        
        if (endoRooms > 0) {
          addRoom("230", "ENDPR", endoRooms);
          addRoom("230", "ENDREC", endoRooms * 2);
          addRoom("230", "ENDCL", Math.max(1, Math.ceil(endoRooms / 2)));
        }
      }

      // ===== CHAPTER 256: EMERGENCY DEPARTMENT =====
      if (activeChapterIds.includes("256")) {
        const edVisits = getVal("CH256_A");
        const edRooms = getVal("CH256_B");
        const hasTrauma = getBool("CH256_C");
        
        if (edVisits > 0 || edRooms > 0) {
          const rooms = edRooms > 0 ? edRooms : Math.max(4, Math.ceil(edVisits / 3000));
          
          addRoom("256", "EDTRT", rooms);
          addRoom("256", "EDTRI", Math.max(1, Math.ceil(rooms / 8)));
          addRoom("256", "EDCAR", Math.max(1, Math.ceil(rooms / 10)));
          addRoom("256", "EDWAI", Math.max(1, Math.ceil(rooms / 10)));
          addRoom("256", "EDWRK", Math.max(1, Math.ceil(rooms / 8)));
          
          if (hasTrauma) {
            addRoom("256", "EDTRA", 1);
          }
        }
      }

      // ===== CHAPTER 258: URGENT CARE =====
      if (activeChapterIds.includes("258")) {
        const ucVisits = getVal("CH258_A");
        
        if (ucVisits > 0) {
          addRoom("258", "UCTRT", Math.max(2, Math.ceil(ucVisits / 5000)));
          addRoom("258", "UCWAI", 1);
        }
      }

      // ===== CHAPTER 260: IMAGING =====
      if (activeChapterIds.includes("260")) {
        const xrayRooms = getVal("CH260_B");
        const ctScanners = getVal("CH260_C");
        const mriUnits = getVal("CH260_D");
        const usRooms = getVal("CH260_E");
        
        if (xrayRooms > 0) {
          addRoom("260", "XRAY1", xrayRooms);
          addRoom("260", "XRCON", Math.max(1, Math.ceil(xrayRooms / 3)));
        }
        
        if (ctScanners > 0) {
          addRoom("260", "XRCT1", ctScanners);
        }
        
        if (mriUnits > 0) {
          addRoom("260", "XRMRI", mriUnits);
        }
        
        if (usRooms > 0) {
          addRoom("260", "XRUS1", usRooms);
        }
        
        const totalRooms = xrayRooms + ctScanners + mriUnits + usRooms;
        if (totalRooms > 0) {
          addRoom("260", "XRCHG", Math.max(2, Math.ceil(totalRooms / 2)));
          addRoom("260", "XRWAI", Math.max(1, Math.ceil(totalRooms / 5)));
        }
      }

      // ===== CHAPTER 262: CARDIOLOGY =====
      if (activeChapterIds.includes("262")) {
        const cardStops = getVal("CH262_A");
        const hasEcho = getBool("CH262_B");
        const hasStress = getBool("CH262_C");
        
        if (cardStops > 0) {
          addRoom("262", "CARDC", Math.max(1, Math.ceil(cardStops / 2000)));
          
          if (hasEcho) {
            addRoom("262", "CECHO", Math.max(1, Math.ceil(cardStops / 3000)));
          }
          
          if (hasStress) {
            addRoom("262", "CSTRS", Math.max(1, Math.ceil(cardStops / 2500)));
          }
        }
      }

      // ===== CHAPTER 264: NUCLEAR MEDICINE =====
      if (activeChapterIds.includes("264")) {
        const nmProc = getVal("CH264_A");
        const gammaCams = getVal("CH264_B");
        
        if (gammaCams > 0) {
          addRoom("264", "NMGAM", gammaCams);
          addRoom("264", "NMPTS", gammaCams * 2);
          addRoom("264", "NMHOT", Math.max(1, Math.ceil(gammaCams / 2)));
        }
      }

      // ===== CHAPTER 266: RADIATION ONCOLOGY =====
      if (activeChapterIds.includes("266")) {
        const roTreatments = getVal("CH266_A");
        const linacs = getVal("CH266_B");
        
        if (linacs > 0) {
          addRoom("266", "ROLAC", linacs);
          addRoom("266", "ROSIM", Math.max(1, Math.ceil(linacs / 2)));
          addRoom("266", "ROCON", Math.max(2, linacs));
          addRoom("266", "ROWAI", Math.max(1, Math.ceil(linacs / 2)));
        }
      }

      // ===== CHAPTER 268: PHARMACY =====
      if (activeChapterIds.includes("268")) {
        const pharmFTE = getVal("CH268_A");
        const rxVolume = getVal("CH268_B");
        const hasIV = getBool("CH268_C");
        const hasInv = getBool("CH268_D");
        
        if (pharmFTE > 0) {
          addRoom("268", "PHCON", Math.max(1, Math.ceil(pharmFTE / 2)));
          addRoom("268", "PHOFF", Math.ceil(pharmFTE / 3));
        }
        
        if (rxVolume > 0) {
          addRoom("268", "PHDIS", Math.max(1, Math.ceil(rxVolume / 100000)));
          addRoom("268", "PHSTO", Math.max(1, Math.ceil(rxVolume / 80000)));
        }
        
        if (hasIV) {
          addRoom("268", "PHIVA", 1);
        }
        
        if (hasInv) {
          addRoom("268", "PHINV", 1);
        }
      }

      // ===== CHAPTER 270: PATHOLOGY & LAB =====
      if (activeChapterIds.includes("270")) {
        const labTests = getVal("CH270_A");
        const pathFTE = getVal("CH270_B");
        const hasAnatPath = getBool("CH270_C");
        const hasMicro = getBool("CH270_D");
        
        if (labTests > 0) {
          addRoom("270", "LABCH", Math.max(1, Math.ceil(labTests / 200000)));
          addRoom("270", "LABHE", Math.max(1, Math.ceil(labTests / 250000)));
          addRoom("270", "LABPC", Math.max(2, Math.ceil(labTests / 100000)));
          
          if (hasMicro) {
            addRoom("270", "LABMI", Math.max(1, Math.ceil(labTests / 300000)));
          }
          
          if (hasAnatPath) {
            addRoom("270", "LABPA", 1);
            addRoom("270", "LABGR", 1);
          }
        }
        
        if (pathFTE > 0) {
          addRoom("270", "LABOF", pathFTE);
        }
      }

      // ===== CHAPTER 272: BLOOD BANK =====
      if (activeChapterIds.includes("272")) {
        const bloodUnits = getVal("CH272_A");
        const hasApheresis = getBool("CH272_B");
        
        if (bloodUnits > 0) {
          addRoom("272", "BBSTO", Math.max(1, Math.ceil(bloodUnits / 5000)));
          addRoom("272", "BBWRK", 1);
          
          if (hasApheresis) {
            addRoom("272", "BBAPH", 1);
          }
        }
      }

      // ===== CHAPTER 280: PROSTHETICS =====
      if (activeChapterIds.includes("280")) {
        const prosFTE = getVal("CH280_A");
        const hasFab = getBool("CH280_B");
        
        if (prosFTE > 0) {
          addRoom("280", "PROEX", Math.max(1, Math.ceil(prosFTE * 1.5)));
          addRoom("280", "PROFF", prosFTE);
          
          if (hasFab) {
            addRoom("280", "PROFB", 1);
          }
        }
      }

      // ===== CHAPTER 282: PHYSICAL MEDICINE & REHAB =====
      if (activeChapterIds.includes("282")) {
        const ptVisits = getVal("CH282_A");
        const otVisits = getVal("CH282_B");
        const ptFTE = getVal("CH282_C");
        const otFTE = getVal("CH282_D");
        
        if (ptVisits > 0 || ptFTE > 0) {
          addRoom("282", "PTGYM", Math.max(1, Math.ceil(ptFTE / 8)));
          addRoom("282", "PTTRT", Math.max(2, Math.ceil(ptVisits / 3000)));
        }
        
        if (otVisits > 0 || otFTE > 0) {
          addRoom("282", "OTTRM", Math.max(2, Math.ceil(otVisits / 2500)));
          addRoom("282", "OTADL", Math.max(1, Math.ceil(otFTE / 5)));
        }
        
        if (ptFTE + otFTE > 0) {
          addRoom("282", "PMOFF", ptFTE + otFTE);
        }
      }

      // ===== CHAPTER 284: AUDIOLOGY/SPEECH =====
      if (activeChapterIds.includes("284")) {
        const audioStops = getVal("CH284_A");
        const speechVisits = getVal("CH284_B");
        const audioFTE = getVal("CH284_C");
        
        if (audioStops > 0 || audioFTE > 0) {
          addRoom("284", "AUDBO", Math.max(1, Math.ceil(audioFTE * 1.5)));
          addRoom("284", "AUDOF", audioFTE);
        }
        
        if (speechVisits > 0) {
          addRoom("284", "SPCON", Math.max(1, Math.ceil(speechVisits / 2000)));
        }
      }

      // ===== CHAPTER 286: NUTRITION & FOOD =====
      if (activeChapterIds.includes("286")) {
        const mealsPerDay = getVal("CH286_A");
        const dietFTE = getVal("CH286_B");
        const hasDining = getBool("CH286_C");
        
        if (mealsPerDay > 0) {
          addRoom("286", "KITCN", Math.max(1, Math.ceil(mealsPerDay / 500)));
          
          if (hasDining) {
            addRoom("286", "DININ", Math.max(1, Math.ceil(mealsPerDay / 200)));
          }
          
          addRoom("286", "CAFET", Math.max(1, Math.ceil(mealsPerDay / 300)));
        }
        
        if (dietFTE > 0) {
          addRoom("286", "NUTOF", dietFTE);
          addRoom("286", "NUTCO", Math.max(1, Math.ceil(dietFTE / 2)));
        }
      }

      // ===== CHAPTER 290: MENTAL HEALTH =====
      if (activeChapterIds.includes("290")) {
        const mhStops = getVal("CH290_A");
        const psychFTE = getVal("CH290_B");
        const psycholFTE = getVal("CH290_C");
        const hasSub = getBool("CH290_D");
        
        if (mhStops > 0) {
          addRoom("290", "MHCON", Math.max(2, Math.ceil(mhStops / 2000)));
          addRoom("290", "MHGRP", Math.max(1, Math.ceil(mhStops / 5000)));
          
          if (hasSub) {
            addRoom("290", "MHSUB", Math.max(1, Math.ceil(mhStops / 4000)));
          }
        }
        
        if (psychFTE + psycholFTE > 0) {
          addRoom("290", "MHOFF", psychFTE + psycholFTE);
        }
      }

      // ===== CHAPTER 292: SOCIAL WORK =====
      if (activeChapterIds.includes("292")) {
        const swFTE = getVal("CH292_A");
        
        if (swFTE > 0) {
          addRoom("292", "SWCON", Math.max(1, Math.ceil(swFTE * 1.2)));
          addRoom("292", "SWOFF", swFTE);
        }
      }

      // ===== CHAPTER 294: CHAPLAIN =====
      if (activeChapterIds.includes("294")) {
        const chapFTE = getVal("CH294_A");
        const hasChapel = getBool("CH294_B");
        
        if (chapFTE > 0) {
          addRoom("294", "CHOFF", chapFTE);
        }
        
        if (hasChapel) {
          addRoom("294", "CHAPE", 1);
          addRoom("294", "CHMED", 1);
        }
      }

      // ===== CHAPTER 298: EDUCATION =====
      if (activeChapterIds.includes("298")) {
        const edFTE = getVal("CH298_A");
        const totalStaff = getVal("CH298_B");
        
        if (totalStaff > 0) {
          addRoom("298", "EDCLR", Math.max(1, Math.ceil(totalStaff / 200)));
          addRoom("298", "EDCON", Math.max(1, Math.ceil(totalStaff / 150)));
          addRoom("298", "EDLIB", Math.max(1, Math.ceil(totalStaff / 300)));
        }
        
        if (edFTE > 0) {
          addRoom("298", "EDOFF", edFTE);
        }
      }

      // ===== CHAPTER 300: ADMINISTRATION =====
      if (activeChapterIds.includes("300")) {
        const adminFTE = getVal("CH300_A");
        const totalFTE = getVal("CH300_B");
        
        if (adminFTE > 0) {
          addRoom("300", "ADDIR", Math.max(1, Math.ceil(adminFTE / 50)));
          addRoom("300", "ADOFF", adminFTE);
          addRoom("300", "ADCON", Math.max(1, Math.ceil(adminFTE / 20)));
          addRoom("300", "ADWRK", Math.max(1, Math.ceil(adminFTE / 15)));
        }
      }

      // ===== CHAPTER 310: MEDICAL RECORDS =====
      if (activeChapterIds.includes("310")) {
        const registrations = getVal("CH310_A");
        const mrFTE = getVal("CH310_B");
        
        if (registrations > 0) {
          addRoom("310", "MRREG", Math.max(2, Math.ceil(registrations / 25000)));
          addRoom("310", "MRFIL", Math.max(1, Math.ceil(registrations / 30000)));
          addRoom("310", "MRWRK", Math.max(1, Math.ceil(registrations / 40000)));
        }
        
        if (mrFTE > 0) {
          addRoom("310", "MROFF", Math.max(1, Math.ceil(mrFTE / 3)));
        }
      }

      // ===== CHAPTER 330: VOLUNTARY SERVICE =====
      if (activeChapterIds.includes("330")) {
        const vsFTE = getVal("CH330_A");
        
        if (vsFTE > 0) {
          addRoom("330", "VSOFF", vsFTE);
          addRoom("330", "VSWRK", Math.max(1, Math.ceil(vsFTE / 2)));
        }
      }

      // ===== CHAPTER 340: ENVIRONMENTAL MANAGEMENT =====
      if (activeChapterIds.includes("340")) {
        const emFTE = getVal("CH340_A");
        const buildingGSF = getVal("CH340_B");
        
        if (emFTE > 0) {
          addRoom("340", "EMOFF", Math.max(1, Math.ceil(emFTE / 10)));
          addRoom("340", "EMSTO", Math.max(2, Math.ceil(buildingGSF / 100000)));
          addRoom("340", "EMJAN", Math.max(4, Math.ceil(buildingGSF / 30000)));
        }
      }

      // ===== CHAPTER 350: STERILE PROCESSING =====
      if (activeChapterIds.includes("350")) {
        const instrSets = getVal("CH350_A");
        const spFTE = getVal("CH350_B");
        
        if (instrSets > 0 || spFTE > 0) {
          addRoom("350", "SPDEC", Math.max(1, Math.ceil(instrSets / 5000)));
          addRoom("350", "SPPRE", Math.max(1, Math.ceil(instrSets / 5000)));
          addRoom("350", "SPSTR", Math.max(1, Math.ceil(instrSets / 6000)));
          addRoom("350", "SPSTO", Math.max(1, Math.ceil(instrSets / 4000)));
        }
      }

      // ===== CHAPTER 360: LINEN SERVICE =====
      if (activeChapterIds.includes("360")) {
        const linenLbs = getVal("CH360_A");
        const hasLaundry = getBool("CH360_B");
        
        if (linenLbs > 0) {
          addRoom("360", "LNCLN", Math.max(1, Math.ceil(linenLbs / 1000)));
          addRoom("360", "LNSOL", Math.max(1, Math.ceil(linenLbs / 2000)));
          
          if (hasLaundry) {
            addRoom("360", "LNLAU", Math.max(1, Math.ceil(linenLbs / 800)));
          }
        }
      }

      // ===== CHAPTER 370: ENGINEERING =====
      if (activeChapterIds.includes("370")) {
        const engFTE = getVal("CH370_A");
        const buildingGSF = getVal("CH370_B");
        
        if (engFTE > 0) {
          addRoom("370", "ENGOF", engFTE);
          addRoom("370", "ENGSH", Math.max(1, Math.ceil(engFTE / 8)));
          addRoom("370", "ENGST", Math.max(1, Math.ceil(buildingGSF / 150000)));
        }
      }

      // ===== CHAPTER 380: POLICE SERVICE =====
      if (activeChapterIds.includes("380")) {
        const policeFTE = getVal("CH380_A");
        
        if (policeFTE > 0) {
          addRoom("380", "POLOF", Math.max(1, Math.ceil(policeFTE / 5)));
          addRoom("380", "POLDI", 1);
        }
      }

      // ===== CHAPTER 390: TELECOMMUNICATIONS =====
      if (activeChapterIds.includes("390")) {
        const telFTE = getVal("CH390_A");
        
        if (telFTE > 0) {
          addRoom("390", "TELOF", telFTE);
          addRoom("390", "TELMDF", Math.max(2, Math.ceil(telFTE / 3)));
        }
      }

      // ===== CHAPTER 420: GENERAL STORAGE =====
      if (activeChapterIds.includes("420")) {
        const buildingGSF = getVal("CH420_A");
        
        if (buildingGSF > 0) {
          addRoom("420", "STRGE", Math.max(1, Math.ceil(buildingGSF / 50000)));
          addRoom("420", "RECEI", Math.max(1, Math.ceil(buildingGSF / 100000)));
        }
      }

      // Equipment requirements from room requirements + mappings
      const equipmentRequirements = [];
      for (const rr of roomRequirements) {
        const mappings = ROOM_EQUIPMENT_MAPPINGS.filter(
          re => re.roomCode === rr.roomTemplateId
        );
        for (const mapRow of mappings) {
          equipmentRequirements.push({
            id: makeId(),
            projectId: project.id,
            roomRequirementId: rr.id,
            equipmentJsn: mapRow.jsn,
            requiredQtyPerRoom: mapRow.qty
          });
        }
      }

      return { roomRequirements, equipmentRequirements };
    }

    // -----------------------------
    // TREE VIEW FUNCTIONS
    // -----------------------------

    function switchMode(mode) {
      currentMode = mode;
      document.querySelectorAll('.mode-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.mode === mode);
      });
      
      // Show Add button only in program mode
      const addBtn = document.getElementById('add-to-project-btn');
      if (addBtn) {
        addBtn.style.display = mode === 'program' ? 'block' : 'none';
      }
      
      // Show/hide search box based on mode
      const searchBox = document.getElementById('tree-search-box');
      if (searchBox) {
        // Show search in reference and compare modes
        searchBox.style.display = (mode === 'reference' || mode === 'compare') ? 'block' : 'none';
        searchBox.value = ''; // Clear search when switching modes
      }
      
      const layout = document.querySelector('.layout');
      if (mode === 'compare') {
        layout.classList.add('compare-mode');
      } else {
        layout.classList.remove('compare-mode');
      }
      
      // Update navigator title
      const navTitle = document.getElementById('nav-title');
      if (navTitle) {
        navTitle.textContent = 'Navigator';
      }
      
      renderAll();
    }

    // Debounce filterTree for better performance during typing
    let filterTreeTimeout = null;
    function filterTreeDebounced() {
      if (filterTreeTimeout) {
        clearTimeout(filterTreeTimeout);
      }
      filterTreeTimeout = setTimeout(filterTree, 150);
    }

    function filterTree() {
      const searchBox = document.getElementById('tree-search-box');
      const searchText = searchBox ? searchBox.value.toLowerCase().trim() : '';
      
      // Clear all search-related classes
      document.querySelectorAll('.tree-item').forEach(item => {
        item.classList.remove('search-match', 'search-highlight');
      });
      
      if (!searchText) {
        // If search is empty, show everything and collapse auto-expanded nodes
        document.querySelectorAll('.tree-item').forEach(item => {
          item.style.display = '';
        });
        renderTree();
        return;
      }
      
      // Find all matching items
      const allItems = document.querySelectorAll('.tree-item');
      const matchingItems = new Set();
      const parentItems = new Set();
      const nodesToExpand = new Set();
      
      allItems.forEach(item => {
        const text = item.textContent.toLowerCase();
        const nodeId = item.dataset.nodeId;
        
        if (text.includes(searchText)) {
          matchingItems.add(item);
          item.classList.add('search-match');
          
          // Find and highlight the exact match within the text
          if (nodeId && nodeId.startsWith('room-')) {
            item.classList.add('search-highlight');
          }
          
          // Add all parent nodes to ensure they're visible
          let parentId = item.dataset.parentId;
          while (parentId) {
            const parentItem = document.querySelector(`[data-node-id="${parentId}"]`);
            if (parentItem) {
              parentItems.add(parentItem);
              matchingItems.add(parentItem);
              
              // Track nodes that should be expanded
              nodesToExpand.add(parentId);
              
              parentId = parentItem.dataset.parentId;
            } else {
              break;
            }
          }
        }
      });
      
      // Expand parent nodes
      nodesToExpand.forEach(nodeId => {
        if (!expandedNodes.has(nodeId)) {
          expandedNodes.add(nodeId);
        }
      });
      
      // Re-render tree to show expanded state, then apply filters
      renderTree();
      
      // Re-apply search highlighting and visibility after render (async for better performance)
      requestAnimationFrame(() => {
        const updatedItems = document.querySelectorAll('.tree-item');
        const updatedMatching = new Set();
        
        updatedItems.forEach(item => {
          const text = item.textContent.toLowerCase();
          const nodeId = item.dataset.nodeId;
          
          if (text.includes(searchText)) {
            updatedMatching.add(item);
            item.classList.add('search-match');
            
            if (nodeId && nodeId.startsWith('room-')) {
              item.classList.add('search-highlight');
            }
            
            // Add parent chain
            let parentId = item.dataset.parentId;
            while (parentId) {
              const parentItem = document.querySelector(`[data-node-id="${parentId}"]`);
              if (parentItem) {
                updatedMatching.add(parentItem);
                parentId = parentItem.dataset.parentId;
              } else {
                break;
              }
            }
          }
        });
        
        // Hide non-matching items
        updatedItems.forEach(item => {
          if (updatedMatching.has(item)) {
            item.style.display = '';
          } else {
            item.style.display = 'none';
          }
        });
      }, 0);
    }    function selectProjectInList(projectId) {
      selectedProjectInList = projectId;
      renderDetail();
    }

    function openProject(projectId) {
      CURRENT_PROJECT_ID = projectId;
      localStorage.setItem('va-current-project-id', projectId);
      viewState = 'project-detail';
      selectedProjectInList = null;
      expandedNodes.clear();
      selectedNode = null;
      renderAll();
    }

    function returnToProjectList() {
      viewState = 'project-list';
      selectedProjectInList = null;
      expandedNodes.clear();
      selectedNode = null;
      renderAll();
    }

    function createNewProject() {
      const newProject = {
        id: generateId(),
        name: `Project ${USER_PROJECTS.length + 1}`,
        siteName: "",
        description: "",
        departments: [],
        createdAt: new Date().toISOString(),
        modifiedAt: new Date().toISOString()
      };
      USER_PROJECTS.push(newProject);
      saveProjects();
      openProject(newProject.id);
    }

    function deleteProject(projectId, event) {
      event.stopPropagation();
      if (USER_PROJECTS.length === 1) {
        alert('Cannot delete the last project');
        return;
      }
      if (!confirm('Are you sure you want to delete this project? This cannot be undone.')) {
        return;
      }
      USER_PROJECTS = USER_PROJECTS.filter(p => p.id !== projectId);
      if (CURRENT_PROJECT_ID === projectId) {
        CURRENT_PROJECT_ID = USER_PROJECTS[0].id;
        localStorage.setItem('va-current-project-id', CURRENT_PROJECT_ID);
      }
      saveProjects();
      renderAll();
    }

    function buildTreeData() {
      // Reference/Compare mode - always show reference tree regardless of view state
      if (currentMode === 'reference' || currentMode === 'compare') {
        const mappings = window.ROOM_EQUIPMENT_MAPPINGS || [];
        
        // Return cached tree if data hasn't changed (and we have data)
        if (cachedReferenceTree && mappings.length > 0 && lastMappingsLength === mappings.length) {
          return cachedReferenceTree;
        }
        
        console.log('Building reference tree from', mappings.length, 'mappings');
        
        const tree = {
          id: 'reference-root',
          type: 'reference-root',
          label: 'Guide',
          icon: 'üìö',
          children: []
        };

        if (mappings.length === 0) {
          console.warn('No equipment mappings available for reference tree');
          return tree;
        }

        const deptMap = new Map();
        
        // Build tree structure efficiently from ALL_ROOM_INSTANCES instead of mappings
        // This is much faster than iterating through millions of mapping entries
        const allInstances = window.ALL_ROOM_INSTANCES || [];
        if (allInstances.length > 0) {
          console.log('Building tree from', allInstances.length, 'room instances (optimized)');
          allInstances.forEach(instance => {
            if (!deptMap.has(instance.department)) {
              deptMap.set(instance.department, {
                name: instance.department,
                functionalAreas: new Map()
              });
            }
            
            const dept = deptMap.get(instance.department);
            if (!dept.functionalAreas.has(instance.functionalArea)) {
              dept.functionalAreas.set(instance.functionalArea, {
                name: instance.functionalArea,
                rooms: new Map()
              });
            }
            
            const fa = dept.functionalAreas.get(instance.functionalArea);
            if (!fa.rooms.has(instance.roomCode)) {
              fa.rooms.set(instance.roomCode, {
                code: instance.roomCode,
                name: instance.roomName
              });
            }
          });
        } else {
          // Fallback to mappings if ALL_ROOM_INSTANCES not available
          console.log('Building tree from', mappings.length, 'mappings (fallback)');
          mappings.forEach(mapping => {
            if (!deptMap.has(mapping.department)) {
              deptMap.set(mapping.department, {
                name: mapping.department,
                functionalAreas: new Map()
              });
            }
            
            const dept = deptMap.get(mapping.department);
            if (!dept.functionalAreas.has(mapping.functionalArea)) {
              dept.functionalAreas.set(mapping.functionalArea, {
                name: mapping.functionalArea,
                rooms: new Map()
              });
            }
            
            const fa = dept.functionalAreas.get(mapping.functionalArea);
            if (!fa.rooms.has(mapping.roomCode)) {
              fa.rooms.set(mapping.roomCode, {
                code: mapping.roomCode,
                name: mapping.roomName
              });
            }
          });
        }

        Array.from(deptMap.keys()).sort().forEach(deptName => {
          const dept = deptMap.get(deptName);
          const deptNode = {
            id: `dept-ref-${deptName}`,
            type: 'department-reference',
            label: deptName,
            icon: 'üè¢',
            children: []
          };

          Array.from(dept.functionalAreas.keys()).sort().forEach(faName => {
            const fa = dept.functionalAreas.get(faName);
            const faNode = {
              id: `fa-ref-${deptName}-${faName}`,
              type: 'functional-area-reference',
              label: faName,
              icon: 'üìÇ',
              department: deptName,
              children: []
            };

            Array.from(fa.rooms.keys()).sort().forEach(roomCode => {
              const room = fa.rooms.get(roomCode);
              faNode.children.push({
                id: `room-ref-${deptName}-${faName}-${roomCode}`,
                type: 'room-reference',
                label: `${room.code} - ${room.name}`,
                icon: 'üö™',
                department: deptName,
                functionalArea: faName,
                roomCode: room.code,
                roomName: room.name
              });
            });

            deptNode.children.push(faNode);
          });

          tree.children.push(deptNode);
        });

        // Cache the tree for next time
        cachedReferenceTree = tree;
        lastMappingsLength = mappings.length;
        console.log('Reference tree cached with', tree.children.length, 'departments');

        return tree;
      }

      // Project list view
      if (viewState === 'project-list') {
        const tree = {
          id: 'project-list',
          type: 'project-list',
          label: 'Projects',
          icon: 'üìã',
          children: []
        };
        return tree;
      }

      // Program mode - Individual project view
      const project = getCurrentProject();
      const tree = {
        id: 'project',
        type: 'project',
        project: project,
        label: project.name,
        icon: 'üè•',
        children: []
      };

      if (currentMode === 'program') {
        // Program mode: show user's project structure (departments > functional areas > rooms > equipment)
        if (!project.departments || project.departments.length === 0) {
          // No departments yet - show empty state
          return tree;
        }

        project.departments.forEach(dept => {
          const deptNode = {
            id: `dept-${dept.id}`,
            type: 'department',
            department: dept,
            label: dept.name,
            icon: 'üè¢',
            children: []
          };

          if (dept.functionalAreas && dept.functionalAreas.length > 0) {
            dept.functionalAreas.forEach(fa => {
              const faNode = {
                id: `fa-${fa.id}`,
                type: 'functional-area',
                functionalArea: fa,
                department: dept,
                label: fa.name,
                icon: 'üìÇ',
                children: []
              };

              if (fa.rooms && fa.rooms.length > 0) {
                fa.rooms.forEach(room => {
                  faNode.children.push({
                    id: `room-${room.id}`,
                    type: 'room',
                    room: room,
                    functionalArea: fa,
                    department: dept,
                    label: `${room.code} - ${room.name}`,
                    icon: 'üö™'
                  });
                });
              }

              deptNode.children.push(faNode);
            });
          }

          tree.children.push(deptNode);
        });
      }

      return tree;
    }

    function renderTreeNode(node, level = 0, parentId = null) {
      const isExpanded = expandedNodes.has(node.id);
      const hasChildren = node.children && node.children.length > 0;
      const isSelected = selectedNode?.id === node.id;
      
      // Escape the node ID for use in onclick handlers
      const escapedNodeId = node.id.replace(/'/g, "\\'").replace(/"/g, '&quot;');
      
      // Make items draggable
      const isDraggableCompare = currentMode === 'compare' && (node.room || node.roomCode);
      const isDraggableProgram = currentMode === 'program' && viewState === 'project-open';
      const isDraggable = isDraggableCompare || isDraggableProgram;
      
      // Build draggable/drop attributes
      let compareAttrs = '';
      if (isDraggableCompare) {
        compareAttrs = `draggable="true" ondragstart="handleRoomDragStart(event, '${escapedNodeId}')"`;
      }
      
      let dropAttrs = '';
      if (isDraggableProgram) {
        dropAttrs = `ondragover="handleTreeDragOver(event)" ondrop="handleTreeDrop(event, '${escapedNodeId}')" ondragleave="handleTreeDragLeave(event)"`;
      }

      let html = `
        <div class="tree-node" data-level="${level}" ${dropAttrs}>
          <div class="tree-item ${isSelected ? 'selected' : ''}" ${compareAttrs} onclick="handleNodeClick('${escapedNodeId}')" data-node-id="${escapedNodeId}" ${parentId ? `data-parent-id="${parentId}"` : ''}>
            ${isDraggableProgram ? `<span class="tree-drag-handle" draggable="true" ondragstart="handleTreeDragStart(event, '${escapedNodeId}')" ondragend="handleTreeDragEnd(event)" title="Drag to reorder"></span>` : ''}
            <span class="tree-toggle ${hasChildren ? (isExpanded ? 'expanded' : 'collapsed') : 'leaf'}" 
                  onclick="event.stopPropagation(); toggleNode('${escapedNodeId}')"></span>
            <span class="tree-icon">${node.icon}</span>
            <span class="tree-label">${node.label}</span>
            ${node.count ? `<span class="tree-count">√ó${node.count}</span>` : ''}
          </div>
      `;

      if (hasChildren) {
        html += `<div class="tree-children ${isExpanded ? 'expanded' : ''}" id="children-${escapedNodeId}">`;
        node.children.forEach(child => {
          html += renderTreeNode(child, level + 1, escapedNodeId);
        });
        html += `</div>`;
      }

      html += `</div>`;
      return html;
    }

    // Drag and Drop for Program Mode Tree
    let draggedNode = null;
    let draggedNodeData = null;
    let isDragging = false;
    let dragStartTime = 0;

    function handleTreeDragStart(event, nodeId) {
      isDragging = true;
      dragStartTime = Date.now();
      draggedNode = event.target.closest('.tree-item');
      if (draggedNode) {
        draggedNode.style.opacity = '0.5';
      }
      event.dataTransfer.effectAllowed = 'move';
      event.dataTransfer.setData('text/plain', nodeId);
      
      // Store the node data for later
      const treeData = buildTreeData();
      draggedNodeData = findNodeById(treeData, nodeId);
      
      // Stop propagation to prevent triggering click
      event.stopPropagation();
    }

    function handleTreeDragOver(event) {
      if (event.preventDefault) {
        event.preventDefault();
      }
      event.dataTransfer.dropEffect = 'move';
      
      // Add visual feedback to the tree-item
      const target = event.target.closest('.tree-node');
      if (target) {
        const item = target.querySelector('.tree-item');
        if (item && item !== draggedNode) {
          item.classList.add('drag-over');
        }
      }
      return false;
    }

    function handleTreeDragLeave(event) {
      const target = event.target.closest('.tree-node');
      if (target) {
        const item = target.querySelector('.tree-item');
        if (item) {
          item.classList.remove('drag-over');
        }
      }
    }

    function handleTreeDrop(event, targetNodeId) {
      if (event.stopPropagation) {
        event.stopPropagation();
      }
      event.preventDefault();
      
      const target = event.target.closest('.tree-node');
      if (target) {
        const item = target.querySelector('.tree-item');
        if (item) {
          item.classList.remove('drag-over');
        }
      }
      
      if (!draggedNodeData || !targetNodeId || draggedNodeData.id === targetNodeId) {
        return false;
      }
      
      const project = getCurrentProject();
      
      // Extract type and ID from node IDs (format: "dept-xxx", "fa-xxx", "room-xxx")
      const draggedType = draggedNodeData.type;
      const targetType = findNodeById(buildTreeData(), targetNodeId)?.type;
      
      if (!draggedType || !targetType || draggedType !== targetType) {
        return false; // Only allow reordering within same type
      }
      
      // Departments can be reordered
      if (draggedType === 'department' && targetType === 'department') {
        const draggedDept = draggedNodeData.department;
        const targetDept = findNodeById(buildTreeData(), targetNodeId)?.department;
        
        const draggedIndex = project.departments.findIndex(d => d.id === draggedDept.id);
        const targetIndex = project.departments.findIndex(d => d.id === targetDept.id);
        
        if (draggedIndex !== -1 && targetIndex !== -1) {
          const [removed] = project.departments.splice(draggedIndex, 1);
          project.departments.splice(targetIndex, 0, removed);
          saveProjects();
          renderAll();
        }
      }
      // FAs can be reordered within same department
      else if (draggedType === 'functional-area' && targetType === 'functional-area') {
        const draggedFA = draggedNodeData.functionalArea;
        const draggedDept = draggedNodeData.department;
        const targetNode = findNodeById(buildTreeData(), targetNodeId);
        const targetFA = targetNode?.functionalArea;
        const targetDept = targetNode?.department;
        
        // Only allow if same department
        if (draggedDept.id === targetDept.id) {
          const dept = project.departments.find(d => d.id === draggedDept.id);
          if (dept) {
            const draggedIndex = dept.functionalAreas.findIndex(f => f.id === draggedFA.id);
            const targetIndex = dept.functionalAreas.findIndex(f => f.id === targetFA.id);
            
            if (draggedIndex !== -1 && targetIndex !== -1) {
              const [removed] = dept.functionalAreas.splice(draggedIndex, 1);
              dept.functionalAreas.splice(targetIndex, 0, removed);
              saveProjects();
              renderAll();
            }
          }
        }
      }
      // Rooms can be reordered within same FA
      else if (draggedType === 'room' && targetType === 'room') {
        const draggedRoom = draggedNodeData.room;
        const draggedFA = draggedNodeData.functionalArea;
        const draggedDept = draggedNodeData.department;
        const targetNode = findNodeById(buildTreeData(), targetNodeId);
        const targetRoom = targetNode?.room;
        const targetFA = targetNode?.functionalArea;
        const targetDept = targetNode?.department;
        
        // Only allow if same FA and department
        if (draggedDept.id === targetDept.id && draggedFA.id === targetFA.id) {
          const dept = project.departments.find(d => d.id === draggedDept.id);
          if (dept) {
            const fa = dept.functionalAreas.find(f => f.id === draggedFA.id);
            if (fa) {
              const draggedIndex = fa.rooms.findIndex(r => r.id === draggedRoom.id);
              const targetIndex = fa.rooms.findIndex(r => r.id === targetRoom.id);
              
              if (draggedIndex !== -1 && targetIndex !== -1) {
                const [removed] = fa.rooms.splice(draggedIndex, 1);
                fa.rooms.splice(targetIndex, 0, removed);
                saveProjects();
                renderAll();
              }
            }
          }
        }
      }
      
      return false;
    }

    function handleTreeDragEnd(event) {
      if (draggedNode) {
        draggedNode.style.opacity = '';
      }
      
      // Remove all visual feedback
      document.querySelectorAll('.tree-item').forEach(item => {
        item.classList.remove('drag-over');
      });
      
      draggedNode = null;
      draggedNodeData = null;
      
      // Clear dragging flag after a short delay to prevent click from firing
      setTimeout(() => {
        isDragging = false;
      }, 100);
    }

    function renderTree() {
      const container = document.getElementById('tree-view');
      const modeToggle = document.getElementById('mode-toggle');
      const addBtn = document.getElementById('add-to-project-btn');
      const returnBtn = document.getElementById('return-to-projects-btn');
      const searchBox = document.getElementById('tree-search-box');

      if (viewState === 'project-list') {
        // Show mode toggle, hide add button and return button in project list view
        if (modeToggle) modeToggle.style.display = 'flex';
        if (addBtn) addBtn.style.display = 'none';
        if (returnBtn) returnBtn.style.display = 'none';
        // Show search box in reference mode even in project list (when tree is shown)
        if (searchBox) searchBox.style.display = currentMode === 'reference' ? 'block' : 'none';
        
        // Render project list in program mode, tree in reference/compare mode
        if (currentMode === 'program') {
          let html = `
            <div style="margin-bottom: 16px;">
              <button class="btn-primary" onclick="createNewProject()" style="width: 100%;">+ New Project</button>
            </div>
          `;
        
        USER_PROJECTS.forEach(project => {
          const deptCount = project.departments ? project.departments.length : 0;
          let roomCount = 0;
          if (project.departments) {
            project.departments.forEach(dept => {
              if (dept.functionalAreas) {
                dept.functionalAreas.forEach(fa => {
                  if (fa.rooms) roomCount += fa.rooms.length;
                });
              }
            });
          }
          
          const isSelected = selectedProjectInList === project.id;
          
          html += `
            <div class="tree-item" style="padding: 12px; margin-bottom: 8px; background: ${isSelected ? 'var(--input-bg)' : 'var(--bg)'}; border: 1px solid ${isSelected ? 'var(--accent)' : 'var(--border)'}; border-radius: 6px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; gap: 12px;" onclick="selectProjectInList('${project.id}')">
              <div style="flex: 1; min-width: 0;">
                <div style="font-weight: 600; margin-bottom: 4px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">üè• ${project.name}</div>
                <div style="font-size: 0.75rem; color: var(--muted);">${deptCount} departments ‚Ä¢ ${roomCount} rooms</div>
              </div>
              <div style="display: flex; gap: 6px; flex-shrink: 0;">
                <button class="btn-secondary" onclick="openProject('${project.id}'); event.stopPropagation();" style="padding: 6px 10px; font-size: 0.75rem;" title="Open project">üìÇ Open</button>
                <button class="btn-secondary" onclick="deleteProject('${project.id}', event)" style="padding: 6px 10px; font-size: 0.75rem;" title="Delete project">üóëÔ∏è</button>
              </div>
            </div>
          `;
        });
        
        container.innerHTML = html;
        } else {
          // Reference/Compare mode in project list - show reference tree
          console.log('Rendering reference tree in project-list view, mode:', currentMode);
          const treeData = buildTreeData();
          console.log('Tree data:', treeData ? `${treeData.children?.length || 0} children` : 'null');
          const treeHTML = renderTreeNode(treeData);
          console.log('Tree HTML length:', treeHTML?.length || 0);
          container.innerHTML = treeHTML;
        }
      } else {
        // Show mode toggle and conditionally show add/return buttons and search box
        if (modeToggle) modeToggle.style.display = 'flex';
        if (returnBtn) returnBtn.style.display = currentMode === 'compare' ? 'none' : 'block';
        if (addBtn) addBtn.style.display = currentMode === 'program' ? 'block' : 'none';
        if (searchBox) searchBox.style.display = currentMode === 'reference' ? 'block' : 'none';
        
        // Render project tree (program mode) or reference tree (reference/compare mode)
        const treeData = buildTreeData();
        container.innerHTML = renderTreeNode(treeData);
      }
    }

    function toggleNode(nodeId) {
      if (expandedNodes.has(nodeId)) {
        expandedNodes.delete(nodeId);
      } else {
        expandedNodes.add(nodeId);
      }
      // Only re-render tree, not detail (performance optimization)
      renderTree();
    }

    function findNodeById(tree, nodeId) {
      if (tree.id === nodeId) return tree;
      if (tree.children) {
        for (const child of tree.children) {
          const found = findNodeById(child, nodeId);
          if (found) return found;
        }
      }
      return null;
    }

    function handleNodeClick(nodeId) {
      // Ignore clicks during or immediately after drag operations
      if (isDragging || (Date.now() - dragStartTime < 200)) {
        return;
      }
      
      // In compare mode, clicking doesn't select - only drag/drop or search
      if (currentMode === 'compare') {
        return;
      }
      
      const treeData = buildTreeData();
      selectedNode = findNodeById(treeData, nodeId);
      console.log('Node clicked:', nodeId, 'Found:', selectedNode);
      
      // If there's an active search, collapse all and only expand the path to this node
      const searchBox = document.getElementById('tree-search-box');
      const hasActiveSearch = searchBox && searchBox.value.trim() !== '';
      
      if (hasActiveSearch) {
        // Clear expanded nodes
        expandedNodes.clear();
        
        // Expand only the parent path for this node
        const nodeElement = document.querySelector(`[data-node-id="${nodeId.replace(/'/g, "\\'")}"]`);
        if (nodeElement) {
          let parentId = nodeElement.dataset.parentId;
          while (parentId) {
            expandedNodes.add(parentId);
            const parentElement = document.querySelector(`[data-node-id="${parentId}"]`);
            if (parentElement) {
              parentId = parentElement.dataset.parentId;
            } else {
              break;
            }
          }
        }
      }
      
      renderTree();
      renderDetail();
    }

    // -----------------------------
    // DETAIL VIEW FUNCTIONS
    // -----------------------------

    // Helper function to check if two rooms are identical
    function areRoomsIdentical(room1, room2) {
      // Compare basic properties (code, name, and NSF must match)
      if (room1.code !== room2.code || room1.name !== room2.name || room1.nsf !== room2.nsf) {
        return false;
      }
      
      // Compare equipment (same items and quantities)
      const eq1 = room1.equipment || [];
      const eq2 = room2.equipment || [];
      if (eq1.length !== eq2.length) return false;
      
      // Sort and compare equipment by JSN
      const eq1Sorted = [...eq1].sort((a, b) => a.jsn.localeCompare(b.jsn));
      const eq2Sorted = [...eq2].sort((a, b) => a.jsn.localeCompare(b.jsn));
      
      for (let i = 0; i < eq1Sorted.length; i++) {
        if (eq1Sorted[i].jsn !== eq2Sorted[i].jsn || eq1Sorted[i].quantity !== eq2Sorted[i].quantity) {
          return false;
        }
      }
      
      // Compare attributes (excluding 'Room Name' which can have copy suffix)
      const attr1 = room1.attributes || {};
      const attr2 = room2.attributes || {};
      
      const keys1 = Object.keys(attr1).filter(k => k !== 'Room Name').sort();
      const keys2 = Object.keys(attr2).filter(k => k !== 'Room Name').sort();
      
      if (keys1.length !== keys2.length) return false;
      if (keys1.join(',') !== keys2.join(',')) return false;
      
      for (const key of keys1) {
        if (attr1[key] !== attr2[key]) return false;
      }
      
      return true;
    }
    
    // Helper function to group rooms by identity
    function groupRoomsByIdentity(rooms) {
      const groups = [];
      const processed = new Set();
      
      rooms.forEach((room, index) => {
        if (processed.has(index)) return;
        
        const group = {
          room: room,
          roomIds: [room.id],
          quantity: 1
        };
        
        // Find other identical rooms
        for (let i = index + 1; i < rooms.length; i++) {
          if (processed.has(i)) continue;
          if (areRoomsIdentical(room, rooms[i])) {
            group.roomIds.push(rooms[i].id);
            group.quantity++;
            processed.add(i);
          }
        }
        
        processed.add(index);
        groups.push(group);
      });
      
      return groups;
    }

    // Toggle detail section expansion
    function toggleDetailSection(sectionId) {
      const content = document.getElementById(`content-${sectionId}`);
      const toggle = document.getElementById(`toggle-${sectionId}`);
      
      if (content && toggle) {
        if (content.style.display === 'none') {
          content.style.display = 'block';
          toggle.textContent = '‚ñº';
        } else {
          content.style.display = 'none';
          toggle.textContent = '‚ñ∂';
        }
      }
    }

    function renderDetail() {
      const container = document.getElementById('detail-view');
      
      // In compare mode, renderCompareMode handles the detail view
      if (currentMode === 'compare') {
        renderCompareMode();
        return;
      }
      
      if (viewState === 'project-list') {
        // In reference mode, skip project list logic if we have a selected node
        if (currentMode === 'reference' && selectedNode) {
          // Fall through to the selectedNode handling below
        } else if (selectedProjectInList) {
          const project = USER_PROJECTS.find(p => p.id === selectedProjectInList);
          if (project) {
            let totalDepts = project.departments ? project.departments.length : 0;
            let totalFAs = 0;
            let totalRooms = 0;
            let totalEquip = 0;

            if (project.departments) {
              project.departments.forEach(dept => {
                if (dept.functionalAreas) {
                  totalFAs += dept.functionalAreas.length;
                  dept.functionalAreas.forEach(fa => {
                    if (fa.rooms) {
                      totalRooms += fa.rooms.length;
                      fa.rooms.forEach(room => {
                        if (room.equipment) totalEquip += room.equipment.length;
                      });
                    }
                  });
                }
              });
            }

            container.innerHTML = `
              <div class="detail-panel">
                <h3>üìä Project Information</h3>
                <div class="detail-row">
                  <div class="detail-label">Project Name:</div>
                  <div class="detail-value">${project.name}</div>
                </div>
                <div class="detail-row">
                  <div class="detail-label">Created:</div>
                  <div class="detail-value">${new Date(project.createdAt).toLocaleDateString()}</div>
                </div>
                <div class="detail-row">
                  <div class="detail-label">Last Modified:</div>
                  <div class="detail-value">${new Date(project.modifiedAt).toLocaleString()}</div>
                </div>
              </div>
              <div class="detail-panel">
                <h3>üìà Project Statistics</h3>
                <div class="detail-row">
                  <div class="detail-label">Departments:</div>
                  <div class="detail-value">${totalDepts}</div>
                </div>
                <div class="detail-row">
                  <div class="detail-label">Functional Areas:</div>
                  <div class="detail-value">${totalFAs}</div>
                </div>
                <div class="detail-row">
                  <div class="detail-label">Rooms:</div>
                  <div class="detail-value">${totalRooms}</div>
                </div>
                <div class="detail-row">
                  <div class="detail-label">Equipment Items:</div>
                  <div class="detail-value">${totalEquip}</div>
                </div>
              </div>
              <div class="detail-panel">
                <button class="btn-primary" onclick="openProject('${project.id}')" style="width: 100%; margin-bottom: 8px;">üìÇ Open Project</button>
                <button class="btn-primary" onclick="generateReportForProject('${project.id}')" style="width: 100%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">üìÑ Generate Report</button>
              </div>
            `;
            return;
          }
        } else {
          // Only show welcome if not in reference mode with a selection
          if (!(currentMode === 'reference' && selectedNode)) {
            container.innerHTML = `
              <div class="detail-panel">
                <h3>Welcome to Hospital Programming Workbench</h3>
                <p class="muted" style="margin-bottom: 16px;">Manage your hospital programming projects.</p>
                <h4 style="margin-top: 24px; margin-bottom: 12px;">Getting Started</h4>
                <ul class="muted" style="line-height: 1.6;">
                  <li>Click a project to view its details</li>
                  <li>Click <strong>üìÇ Open</strong> to work on a project</li>
                  <li><strong>Program Mode:</strong> Build your project by importing departments, functional areas, and rooms</li>
                  <li><strong>Reference Mode:</strong> Browse all available rooms and equipment from the equipment guide</li>
                  <li>Projects are saved locally in your browser</li>
                </ul>
                <div style="margin-top: 24px; padding: 16px; background: var(--bg); border: 1px solid var(--border); border-radius: 6px;">
                  <h4 style="margin-bottom: 8px;">All Projects</h4>
                  <div style="font-size: 0.9rem; color: var(--muted);">
                    Total Projects: ${USER_PROJECTS.length}
                  </div>
                </div>
              </div>
            `;
            return;
          }
        }
      }
      
      if (!selectedNode) {
        console.log('No selected node');
        container.innerHTML = `
          <div class="detail-panel">
            <h3>Welcome to Hospital Programming Workbench</h3>
            <p class="muted">Select an item from the tree on the left to view details.</p>
            <ul class="muted" style="margin-top: 16px; line-height: 1.6;">
              <li><strong>Program Mode:</strong> Build your project by importing departments, functional areas, and rooms</li>
              <li><strong>Reference Mode:</strong> Browse all available rooms and equipment from the equipment guide</li>
            </ul>
          </div>
        `;
        return;
      }

      console.log('Selected node type:', selectedNode.type, selectedNode);

      let html = '';

      if (selectedNode.type === 'project') {
        html += renderProjectDetail();
      } else if (selectedNode.type === 'department') {
        html += renderDepartmentDetail();
      } else if (selectedNode.type === 'functional-area') {
        html += renderFunctionalAreaDetail();
      } else if (selectedNode.type === 'room') {
        html += renderRoomDetail();
      } else if (selectedNode.type === 'reference-root') {
        html += renderGuideRootDetail();
      } else if (selectedNode.type === 'department-reference') {
        html += renderDepartmentReferenceDetail();
      } else if (selectedNode.type === 'functional-area-reference') {
        html += renderFunctionalAreaReferenceDetail();
      } else if (selectedNode.type === 'room-reference') {
        console.log('Calling renderRoomReferenceDetail');
        html += renderRoomReferenceDetail();
      } else if (selectedNode.type === 'chapter') {
        html += renderChapterDetail();
      }

      console.log('Rendering HTML length:', html.length);
      container.innerHTML = html;
    }

    function renderDepartmentDetail() {
      const dept = selectedNode.department;
      const faCount = dept.functionalAreas ? dept.functionalAreas.length : 0;
      let roomCount = 0;
      let equipCount = 0;
      const totalNSF = calculateDeptNSF(dept);
      const allRooms = [];
      const project = getCurrentProject();
      const totalCost = calculateDeptCost(dept, project);

      if (dept.functionalAreas) {
        dept.functionalAreas.forEach(fa => {
          if (fa.rooms) {
            roomCount += fa.rooms.length;
            fa.rooms.forEach(room => {
              if (room.equipment) equipCount += room.equipment.length;
              allRooms.push({ room, fa });
            });
          }
        });
      }

      let html = `
        <div class="detail-panel">
          <h3>üè¢ ${dept.name}</h3>
          <div class="detail-row">
            <div class="detail-label">Department:</div>
            <div class="detail-value">${dept.name}</div>
          </div>
          <div class="detail-row">
            <div class="detail-label">Functional Areas:</div>
            <div class="detail-value">${faCount}</div>
          </div>
          <div class="detail-row">
            <div class="detail-label">Total Rooms:</div>
            <div class="detail-value">${roomCount}</div>
          </div>
          <div class="detail-row">
            <div class="detail-label">Total Equipment:</div>
            <div class="detail-value">${equipCount}</div>
          </div>
          <div class="detail-row">
            <div class="detail-label">Total NSF:</div>
            <div class="detail-value">${totalNSF.toLocaleString()} SF</div>
          </div>
          <div class="detail-row">
            <div class="detail-label">Total Cost:</div>
            <div class="detail-value" style="font-weight: 600; color: var(--accent);">$${totalCost.toLocaleString()}</div>
          </div>
        </div>
        <div class="detail-panel" style="padding: 8px 12px;">
          <button class="btn-secondary" onclick="deleteDepartment('${dept.id}')" style="width: 100%; font-size: 0.85rem; padding: 6px 12px; background: var(--error); color: white; border-color: var(--error);" onmouseover="this.style.opacity='0.8'" onmouseout="this.style.opacity='1'">üóëÔ∏è Delete Department</button>
        </div>
      `;

      if (allRooms.length > 0) {
        const displayRooms = allRooms.slice(0, 100);
        const hasMoreRooms = allRooms.length > 100;
        
        html += `
        <div class="detail-panel">
          <h3>üè¢ Department Structure</h3>
        `;
        
        // Group by functional areas
        dept.functionalAreas.forEach((fa, faIndex) => {
          if (!fa.rooms || fa.rooms.length === 0) return;
          
          const faNSF = calculateFANSF(fa);
          
          html += `
            <div style="margin-bottom: 12px; padding: 10px; background: var(--bg); border-left: 3px solid var(--primary); border-radius: 4px;">
              <div style="display: flex; align-items: center; gap: 8px; cursor: pointer; user-select: none;" onclick="toggleDetailSection('fa-${faIndex}')">
                <span id="toggle-fa-${faIndex}" style="font-size: 0.9rem;">‚ñ∂</span>
                <div style="flex: 1;">
                  <div style="font-weight: 600; font-size: 0.95rem;">üìÇ ${fa.name}</div>
                  <div style="font-size: 0.85rem; color: var(--muted); margin-top: 2px;">${fa.rooms.length} rooms ‚Ä¢ ${faNSF.toLocaleString()} SF</div>
                </div>
              </div>
              <div id="content-fa-${faIndex}" style="display: none; margin-top: 8px; margin-left: 8px;">
          `;
          
          // Show rooms in this FA (grouped by identity)
          const roomGroups = groupRoomsByIdentity(fa.rooms);
          roomGroups.forEach(group => {
            const room = group.room;
            const equipCount = room.equipment ? room.equipment.length : 0;
            html += `
              <div style="padding: 6px 8px; margin-bottom: 4px; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 4px; display: flex; align-items: center; gap: 8px; font-size: 0.85rem;">
                <div style="min-width: 30px; text-align: center;">
                  <input type="number" value="${group.quantity}" min="0" 
                    onchange="updateRoomGroupQuantity('${group.roomIds.join(',')}', this.value, ${group.quantity})"
                    style="width: 45px; padding: 2px 4px; background: var(--input-bg); border: 1px solid var(--input-border); color: var(--text); border-radius: 3px; text-align: center; font-size: 0.85rem;"
                    title="Quantity (0 to delete all, adjust to add/remove copies)">
                </div>
                <div style="flex: 1; min-width: 0;">
                  <strong>${room.code}</strong> - ${room.name}
                </div>
                <div style="white-space: nowrap;">
                  <input type="number" value="${room.nsf || 0}" 
                    onchange="updateRoomGroupNSF('${group.roomIds.join(',')}', this.value)"
                    style="width: 55px; padding: 2px 4px; background: var(--input-bg); border: 1px solid var(--input-border); color: var(--text); border-radius: 3px; text-align: right; font-size: 0.85rem;">
                  <span style="font-size: 0.75rem; margin-left: 2px;">SF</span>
                </div>
                <div style="font-size: 0.75rem; color: var(--muted); white-space: nowrap;">${equipCount} eq</div>
              </div>
            `;
          });
          
          html += `
              </div>
            </div>
          `;
        });
        
        html += `
        </div>
        `;
      }

      return html;
    }

    function renderFunctionalAreaDetail() {
      const fa = selectedNode.functionalArea;
      const dept = selectedNode.department;
      const roomCount = fa.rooms ? fa.rooms.length : 0;
      let equipCount = 0;
      const totalNSF = calculateFANSF(fa);
      const project = getCurrentProject();
      const totalCost = calculateFACost(fa, project);

      if (fa.rooms) {
        fa.rooms.forEach(room => {
          if (room.equipment) equipCount += room.equipment.length;
        });
      }

      let html = `
        <div class="detail-panel">
          <h3>üìÇ ${fa.name}</h3>
          <div class="detail-row">
            <div class="detail-label">Department:</div>
            <div class="detail-value">${dept.name}</div>
          </div>
          <div class="detail-row">
            <div class="detail-label">Functional Area:</div>
            <div class="detail-value">${fa.name}</div>
          </div>
          <div class="detail-row">
            <div class="detail-label">Rooms:</div>
            <div class="detail-value">${roomCount}</div>
          </div>
          <div class="detail-row">
            <div class="detail-label">Total Equipment:</div>
            <div class="detail-value">${equipCount}</div>
          </div>
          <div class="detail-row">
            <div class="detail-label">Total NSF:</div>
            <div class="detail-value">${totalNSF.toLocaleString()} SF</div>
          </div>
          <div class="detail-row">
            <div class="detail-label">Total Cost:</div>
            <div class="detail-value" style="font-weight: 600; color: var(--accent);">$${totalCost.toLocaleString()}</div>
          </div>
        </div>
        <div class="detail-panel" style="padding: 8px 12px;">
          <button class="btn-secondary" onclick="deleteFunctionalArea('${fa.id}', '${dept.id}')" style="width: 100%; font-size: 0.85rem; padding: 6px 12px; background: var(--error); color: white; border-color: var(--error);" onmouseover="this.style.opacity='0.8'" onmouseout="this.style.opacity='1'">üóëÔ∏è Delete Functional Area</button>
        </div>
      `;

      if (fa.rooms && fa.rooms.length > 0) {
        const displayRooms = fa.rooms.slice(0, 100);
        const hasMoreRooms = fa.rooms.length > 100;
        
        html += `
        <div class="detail-panel">
          <h3>üö™ Rooms (${fa.rooms.length}${hasMoreRooms ? ' - showing first 100' : ''})</h3>
          <div style="max-height: 400px; overflow-y: auto;">
        `;
        const roomGroups = groupRoomsByIdentity(displayRooms);
        roomGroups.forEach(group => {
          const room = group.room;
          const equipCount = room.equipment ? room.equipment.length : 0;
          html += `
            <div style="padding: 6px 8px; margin-bottom: 4px; background: var(--bg); border: 1px solid var(--border); border-radius: 4px; display: flex; align-items: center; gap: 8px; font-size: 0.85rem;">
              <div style="min-width: 30px; text-align: center;">
                <input type="number" value="${group.quantity}" min="0" 
                  onchange="updateRoomGroupQuantity('${group.roomIds.join(',')}', this.value, ${group.quantity})"
                  style="width: 45px; padding: 2px 4px; background: var(--input-bg); border: 1px solid var(--input-border); color: var(--text); border-radius: 3px; text-align: center; font-size: 0.85rem;"
                  title="Quantity (0 to delete all, adjust to add/remove copies)">
              </div>
              <div style="flex: 1; min-width: 0;">
                <strong>${room.code}</strong> - ${room.name}
              </div>
              <div style="white-space: nowrap;">
                <input type="number" value="${room.nsf || 0}" 
                  onchange="updateRoomGroupNSF('${group.roomIds.join(',')}', this.value)"
                  style="width: 55px; padding: 2px 4px; background: var(--input-bg); border: 1px solid var(--input-border); color: var(--text); border-radius: 3px; text-align: right; font-size: 0.85rem;">
                <span style="font-size: 0.75rem; margin-left: 2px;">SF</span>
              </div>
              <div style="font-size: 0.75rem; color: var(--muted); white-space: nowrap;">${equipCount} eq</div>
            </div>
          `;
        });
        if (hasMoreRooms) {
          html += `
            <div style="padding: 12px; text-align: center; color: var(--muted); font-size: 0.85rem;">
              Showing first 100 of ${fa.rooms.length} rooms. Use tree navigation for specific rooms.
            </div>
          `;
        }
        html += `
          </div>
        </div>
        `;
      }

      return html;
    }

    function renderGuideRootDetail() {
      const allInstances = window.ALL_ROOM_INSTANCES || [];
      
      // Group by department and functional area
      const deptMap = new Map();
      allInstances.forEach(instance => {
        if (!deptMap.has(instance.department)) {
          deptMap.set(instance.department, {
            name: instance.department,
            fas: new Set(),
            rooms: 0,
            nsf: 0
          });
        }
        const dept = deptMap.get(instance.department);
        dept.fas.add(instance.functionalArea);
        dept.rooms++;
        const roomData = getRoomAttributes(instance.roomCode);
        if (roomData && roomData.nsf) {
          dept.nsf += roomData.nsf;
        }
      });
      
      const totalDepts = deptMap.size;
      let totalFAs = 0;
      let totalRooms = 0;
      let totalNSF = 0;
      
      deptMap.forEach(dept => {
        totalFAs += dept.fas.size;
        totalRooms += dept.rooms;
        totalNSF += dept.nsf;
      });
      
      let html = `
        <div class="detail-panel">
          <h3>üìö Equipment Guide</h3>
          <div class="detail-row">
            <div class="detail-label">Departments:</div>
            <div class="detail-value">${totalDepts}</div>
          </div>
          <div class="detail-row">
            <div class="detail-label">Functional Areas:</div>
            <div class="detail-value">${totalFAs}</div>
          </div>
          <div class="detail-row">
            <div class="detail-label">Total Rooms:</div>
            <div class="detail-value">${totalRooms}</div>
          </div>
          <div class="detail-row">
            <div class="detail-label">Total NSF:</div>
            <div class="detail-value">${totalNSF.toLocaleString()} SF</div>
          </div>
        </div>
        <div class="detail-panel">
          <h3>üè¢ Departments</h3>
          <div style="max-height: 500px; overflow-y: auto;">
      `;
      
      // Sort departments and render them with collapsible FAs
      const sortedDepts = Array.from(deptMap.entries()).sort((a, b) => a[0].localeCompare(b[0]));
      sortedDepts.forEach(([deptName, dept], index) => {
        const deptId = `guide-dept-${index}`;
        html += `
          <div style="margin-bottom: 8px; padding: 8px; background: var(--bg); border: 1px solid var(--border); border-radius: 4px;">
            <div style="display: flex; align-items: center; gap: 8px; cursor: pointer; user-select: none;" onclick="toggleDetailSection('${deptId}')">
              <span id="toggle-${deptId}" style="font-size: 0.9rem;">‚ñ∂</span>
              <div style="flex: 1;">
                <div style="font-weight: 600; font-size: 0.95rem;">üè¢ ${deptName}</div>
                <div style="font-size: 0.85rem; color: var(--muted); margin-top: 2px;">
                  ${dept.fas.size} FAs ‚Ä¢ ${dept.rooms} rooms ‚Ä¢ ${dept.nsf.toLocaleString()} SF
                </div>
              </div>
            </div>
            <div id="content-${deptId}" style="display: none; margin-top: 8px; margin-left: 16px; font-size: 0.85rem; color: var(--muted);">
              Click department in tree to view functional areas
            </div>
          </div>
        `;
      });
      
      html += `
          </div>
        </div>
        <div class="detail-panel">
          <p style="color: var(--muted); font-size: 0.9rem;">
            Reference mode - viewing equipment guide data. Switch to Program Mode to work with your project.
          </p>
        </div>
      `;
      
      return html;
    }

    function renderDepartmentReferenceDetail() {
      const deptName = selectedNode.label;

      // Count all room instances and calculate total NSF
      const allInstances = window.ALL_ROOM_INSTANCES || [];
      const deptInstances = allInstances.filter(instance => instance.department === deptName);
      const roomCount = deptInstances.length;
      
      // Group by functional areas
      const faMap = new Map();
      deptInstances.forEach(instance => {
        if (!faMap.has(instance.functionalArea)) {
          faMap.set(instance.functionalArea, {
            name: instance.functionalArea,
            rooms: 0,
            nsf: 0
          });
        }
        const fa = faMap.get(instance.functionalArea);
        fa.rooms++;
        const roomData = getRoomAttributes(instance.roomCode);
        if (roomData && roomData.nsf) {
          fa.nsf += roomData.nsf;
        }
      });
      
      const faCount = faMap.size;
      let totalNSF = 0;
      faMap.forEach(fa => {
        totalNSF += fa.nsf;
      });

      let html = `
        <div class="detail-panel">
          <h3>üè¢ ${deptName}</h3>
          <div class="detail-row">
            <div class="detail-label">Department:</div>
            <div class="detail-value">${deptName}</div>
          </div>
          <div class="detail-row">
            <div class="detail-label">Functional Areas:</div>
            <div class="detail-value">${faCount}</div>
          </div>
          <div class="detail-row">
            <div class="detail-label">Total Rooms:</div>
            <div class="detail-value">${roomCount}</div>
          </div>
          <div class="detail-row">
            <div class="detail-label">Total NSF:</div>
            <div class="detail-value">${totalNSF.toLocaleString()} SF</div>
          </div>
        </div>
        <div class="detail-panel">
          <h3>üìÇ Functional Areas</h3>
          <div style="max-height: 400px; overflow-y: auto;">
      `;
      
      // Sort FAs and render them with collapsible rooms list
      const sortedFAs = Array.from(faMap.entries()).sort((a, b) => a[0].localeCompare(b[0]));
      sortedFAs.forEach(([faName, fa], index) => {
        const faId = `dept-fa-${index}`;
        html += `
          <div style="margin-bottom: 8px; padding: 8px; background: var(--bg); border: 1px solid var(--border); border-radius: 4px;">
            <div style="display: flex; align-items: center; gap: 8px; cursor: pointer; user-select: none;" onclick="toggleDetailSection('${faId}')">
              <span id="toggle-${faId}" style="font-size: 0.9rem;">‚ñ∂</span>
              <div style="flex: 1;">
                <div style="font-weight: 600; font-size: 0.95rem;">üìÇ ${faName}</div>
                <div style="font-size: 0.85rem; color: var(--muted); margin-top: 2px;">
                  ${fa.rooms} rooms ‚Ä¢ ${fa.nsf.toLocaleString()} SF
                </div>
              </div>
            </div>
            <div id="content-${faId}" style="display: none; margin-top: 8px; margin-left: 16px; font-size: 0.85rem; color: var(--muted);">
              Click functional area in tree to view rooms
            </div>
          </div>
        `;
      });
      
      html += `
          </div>
        </div>
        <div class="detail-panel">
          <p style="color: var(--muted); font-size: 0.9rem;">
            Reference mode - viewing equipment guide data. Switch to Program Mode to work with your project.
          </p>
        </div>
      `;
      
      return html;
    }

    function renderFunctionalAreaReferenceDetail() {
      const deptName = selectedNode.department;
      const faName = selectedNode.label;

      // Count all room instances and calculate total NSF
      const allInstances = window.ALL_ROOM_INSTANCES || [];
      const faInstances = allInstances.filter(instance => 
        instance.department === deptName && instance.functionalArea === faName
      );
      const roomCount = faInstances.length;
      
      // Group rooms by code
      const roomMap = new Map();
      faInstances.forEach(instance => {
        if (!roomMap.has(instance.roomCode)) {
          const roomData = getRoomAttributes(instance.roomCode);
          roomMap.set(instance.roomCode, {
            code: instance.roomCode,
            name: instance.roomName,
            nsf: roomData?.nsf || 0,
            count: 0
          });
        }
        roomMap.get(instance.roomCode).count++;
      });
      
      let totalNSF = 0;
      roomMap.forEach(room => {
        totalNSF += room.nsf * room.count;
      });

      let html = `
        <div class="detail-panel">
          <h3>üìÇ ${faName}</h3>
          <div class="detail-row">
            <div class="detail-label">Department:</div>
            <div class="detail-value">${deptName}</div>
          </div>
          <div class="detail-row">
            <div class="detail-label">Functional Area:</div>
            <div class="detail-value">${faName}</div>
          </div>
          <div class="detail-row">
            <div class="detail-label">Rooms:</div>
            <div class="detail-value">${roomCount}</div>
          </div>
          <div class="detail-row">
            <div class="detail-label">Total NSF:</div>
            <div class="detail-value">${totalNSF.toLocaleString()} SF</div>
          </div>
        </div>
        <div class="detail-panel">
          <h3>üö™ Rooms (${roomMap.size} unique)</h3>
          <div style="max-height: 400px; overflow-y: auto;">
      `;
      
      // Sort rooms by code and display them
      const sortedRooms = Array.from(roomMap.values()).sort((a, b) => a.code.localeCompare(b.code));
      sortedRooms.forEach(room => {
        html += `
          <div style="padding: 6px 8px; margin-bottom: 4px; background: var(--bg); border: 1px solid var(--border); border-radius: 4px; font-size: 0.85rem;">
            <div style="display: flex; align-items: center; gap: 8px;">
              <div style="min-width: 30px; text-align: center; font-weight: 600; color: var(--primary);">
                ${room.count}
              </div>
              <div style="flex: 1; min-width: 0;">
                <strong>${room.code}</strong> - ${room.name}
              </div>
              <div style="white-space: nowrap; color: var(--muted);">
                ${room.nsf.toLocaleString()} SF
              </div>
            </div>
          </div>
        `;
      });
      
      html += `
          </div>
        </div>
        <div class="detail-panel">
          <p style="color: var(--muted); font-size: 0.9rem;">
            Reference mode - viewing equipment guide data. Switch to Program Mode to work with your project.
          </p>
        </div>
      `;
      
      return html;
    }

    function renderProjectDetail() {
      const project = getCurrentProject();
      const totalDepts = project.departments ? project.departments.length : 0;
      let totalFAs = 0;
      let totalRooms = 0;
      let totalEquip = 0;
      const totalNSF = calculateProjectNSF(project);
      const allRooms = [];

      if (project.departments) {
        project.departments.forEach(dept => {
          if (dept.functionalAreas) {
            totalFAs += dept.functionalAreas.length;
            dept.functionalAreas.forEach(fa => {
              if (fa.rooms) {
                totalRooms += fa.rooms.length;
                fa.rooms.forEach(room => {
                  if (room.equipment) {
                    totalEquip += room.equipment.length;
                  }
                  allRooms.push({ room, fa, dept });
                });
              }
            });
          }
        });
      }

      let html = `
        <div class="detail-panel">
          <h3>üìä Project Overview</h3>
          <div class="detail-row">
            <div class="detail-label">Project Name:</div>
            <div class="detail-value">
              <input type="text" 
                     class="project-name-input" 
                     value="${project.name}" 
                     onchange="updateProjectName(this.value)"
                     style="padding: 4px 8px;">
            </div>
          </div>
          <div class="detail-row">
            <div class="detail-label">Departments:</div>
            <div class="detail-value">${totalDepts}</div>
          </div>
          <div class="detail-row">
            <div class="detail-label">Functional Areas:</div>
            <div class="detail-value">${totalFAs}</div>
          </div>
          <div class="detail-row">
            <div class="detail-label">Rooms:</div>
            <div class="detail-value">${totalRooms}</div>
          </div>
          <div class="detail-row">
            <div class="detail-label">Equipment Items:</div>
            <div class="detail-value">${totalEquip}</div>
          </div>
          <div class="detail-row">
            <div class="detail-label">Total NSF:</div>
            <div class="detail-value">${totalNSF.toLocaleString()} SF</div>
          </div>
          <div class="detail-row">
            <div class="detail-label">Last Modified:</div>
            <div class="detail-value">${new Date(project.modifiedAt).toLocaleString()}</div>
          </div>
        </div>
        <div class="detail-panel">
          <h3>üí∞ Cost Settings & Summary</h3>
          <div class="detail-row">
            <div class="detail-label">Cost per NSF:</div>
            <div class="detail-value">
              $<input type="number" 
                     value="${project.costPerNSF || 0}" 
                     min="0"
                     step="10"
                     onchange="updateProjectCostFactor('costPerNSF', this.value)"
                     style="width: 100px; padding: 4px 8px; background: var(--input-bg); border: 1px solid var(--input-border); color: var(--text); border-radius: 4px;">
            </div>
          </div>
          <div class="detail-row">
            <div class="detail-label">Cost per GSF:</div>
            <div class="detail-value">
              $<input type="number" 
                     value="${project.costPerGSF || 0}" 
                     min="0"
                     step="10"
                     onchange="updateProjectCostFactor('costPerGSF', this.value)"
                     style="width: 100px; padding: 4px 8px; background: var(--input-bg); border: 1px solid var(--input-border); color: var(--text); border-radius: 4px;">
            </div>
          </div>
          <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border);">
            <div class="detail-row">
              <div class="detail-label">Equipment Cost:</div>
              <div class="detail-value" style="font-weight: 600; color: var(--accent);">$${calculateProjectCost(project).toLocaleString()}</div>
            </div>
          </div>
          <div style="margin-top: 8px; padding: 8px; background: var(--bg); border-radius: 4px; font-size: 0.85rem; color: var(--muted);">
            Set construction cost per NSF or GSF to calculate total project costs including construction.
          </div>
        </div>
        <div class="detail-panel">
          <div style="margin-top: 0px;">
            <button onclick="openReportModal()" class="btn-primary" style="width: 100%; display: flex; align-items: center; justify-content: center; gap: 8px;">
              üìÑ Generate Report
            </button>
          </div>
        </div>
        <div class="detail-panel">
          <p style="margin-bottom: 12px; color: var(--muted); font-size: 0.9rem;">
            Click <strong>+ Add to Project</strong> to import departments, functional areas, or rooms from the reference library.
          </p>
        </div>
      `;

      if (allRooms.length > 0) {
        html += `
        <div class="detail-panel">
          <h3>üè• Project Structure</h3>
        `;
        
        // Group by departments
        project.departments.forEach((dept, deptIndex) => {
          if (!dept.functionalAreas || dept.functionalAreas.length === 0) return;
          
          const deptRoomCount = dept.functionalAreas.reduce((sum, fa) => sum + (fa.rooms?.length || 0), 0);
          const deptNSF = calculateDeptNSF(dept);
          
          html += `
            <div style="margin-bottom: 16px; padding: 12px; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 6px;">
              <div style="display: flex; align-items: center; gap: 8px; cursor: pointer; user-select: none;" onclick="toggleDetailSection('dept-${deptIndex}')">
                <span id="toggle-dept-${deptIndex}" style="font-size: 0.9rem;">‚ñ∂</span>
                <div style="flex: 1;">
                  <div style="font-weight: 600; font-size: 1rem;">üè¢ ${dept.name}</div>
                  <div style="font-size: 0.85rem; color: var(--muted); margin-top: 2px;">${deptRoomCount} rooms ‚Ä¢ ${deptNSF.toLocaleString()} SF</div>
                </div>
              </div>
              <div id="content-dept-${deptIndex}" style="display: none; margin-top: 12px;">
          `;
          
          // Group by functional areas within department
          dept.functionalAreas.forEach((fa, faIndex) => {
            if (!fa.rooms || fa.rooms.length === 0) return;
            
            const faNSF = calculateFANSF(fa);
            
            html += `
              <div style="margin-left: 12px; margin-bottom: 12px; padding: 8px; background: var(--bg); border-left: 3px solid var(--primary); border-radius: 4px;">
                <div style="display: flex; align-items: center; gap: 8px; cursor: pointer; user-select: none;" onclick="toggleDetailSection('dept-${deptIndex}-fa-${faIndex}')">
                  <span id="toggle-dept-${deptIndex}-fa-${faIndex}" style="font-size: 0.8rem;">‚ñ∂</span>
                  <div style="flex: 1;">
                    <div style="font-weight: 600; font-size: 0.95rem;">üìÇ ${fa.name}</div>
                    <div style="font-size: 0.85rem; color: var(--muted); margin-top: 2px;">${fa.rooms.length} rooms ‚Ä¢ ${faNSF.toLocaleString()} SF</div>
                  </div>
                </div>
                <div id="content-dept-${deptIndex}-fa-${faIndex}" style="display: none; margin-top: 8px; margin-left: 8px;">
            `;
            
            // Show rooms in this FA (grouped by identity)
            const roomGroups = groupRoomsByIdentity(fa.rooms);
            roomGroups.forEach(group => {
              const room = group.room;
              const equipCount = room.equipment ? room.equipment.length : 0;
              html += `
                <div style="padding: 6px 8px; margin-bottom: 4px; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 4px; display: flex; align-items: center; gap: 8px; font-size: 0.85rem;">
                  <div style="min-width: 30px; text-align: center;">
                    <input type="number" value="${group.quantity}" min="0" 
                      onchange="updateRoomGroupQuantity('${group.roomIds.join(',')}', this.value, ${group.quantity})"
                      style="width: 45px; padding: 2px 4px; background: var(--input-bg); border: 1px solid var(--input-border); color: var(--text); border-radius: 3px; text-align: center; font-size: 0.85rem;"
                      title="Quantity (0 to delete all, adjust to add/remove copies)">
                  </div>
                  <div style="flex: 1; min-width: 0;">
                    <strong>${room.code}</strong> - ${room.name}
                  </div>
                  <div style="white-space: nowrap;">
                    <input type="number" value="${room.nsf || 0}" 
                      onchange="updateRoomGroupNSF('${group.roomIds.join(',')}', this.value)"
                      style="width: 55px; padding: 2px 4px; background: var(--input-bg); border: 1px solid var(--input-border); color: var(--text); border-radius: 3px; text-align: right; font-size: 0.85rem;">
                    <span style="font-size: 0.75rem; margin-left: 2px;">SF</span>
                  </div>
                  <div style="font-size: 0.75rem; color: var(--muted); white-space: nowrap;">${equipCount} eq</div>
                </div>
              `;
            });
            
            html += `
                </div>
              </div>
            `;
          });
          
          html += `
              </div>
            </div>
          `;
        });
        
        html += `
        </div>
        `;
      }

      return html;
    }

    function updateProjectName(newName) {
      const project = getCurrentProject();
      project.name = newName;
      saveProjects();
      renderAll();
    }

    function renderIDSPanel() {
      const activeIds = SAMPLE_IDS.filter(d => activeChapters.includes(d.chapterId));
      
      if (activeIds.length === 0) return '';

      let html = `
        <div class="detail-panel">
          <h3>üìù Input Data Statements (IDS)</h3>
          <p class="muted" style="margin-bottom: 12px; font-size: 0.85rem;">
            Adjust these values to recalculate the program.
          </p>
      `;

      activeIds.forEach(driver => {
        const current = driverValues.find(
          v => v.projectId === PROJECT.id && v.driverId === driver.id
        );
        const val = current ? current.value : (driver.defaultValue ?? "");

        html += `
          <div class="detail-row">
            <div class="detail-label" style="min-width: 200px; font-weight: normal;">
              ${driver.chapterId} ${driver.label}
            </div>
            <div class="detail-value">
        `;

        if (driver.inputKind === "number") {
          html += `
            <input type="number" 
                   value="${val}" 
                   ${driver.minValue != null ? `min="${driver.minValue}"` : ''}
                   ${driver.maxValue != null ? `max="${driver.maxValue}"` : ''}
                   onchange="handleDriverChange('${driver.id}', this.value, 'number')"
                   style="width: 100px; padding: 4px 8px; background: var(--input-bg); border: 1px solid var(--input-border); color: var(--text); border-radius: 4px;">
          `;
        } else if (driver.inputKind === "boolean") {
          html += `
            <select onchange="handleDriverChange('${driver.id}', this.value, 'boolean')"
                    style="padding: 4px 8px; background: var(--input-bg); border: 1px solid var(--input-border); color: var(--text); border-radius: 4px;">
              <option value="false" ${!val ? 'selected' : ''}>No</option>
              <option value="true" ${val ? 'selected' : ''}>Yes</option>
            </select>
          `;
        }

        html += `
            </div>
          </div>
          <div style="font-size: 0.75rem; color: var(--muted); margin: 4px 0 8px 0; padding-left: 200px;">
            ${driver.text}
          </div>
        `;
      });

      html += `</div>`;
      return html;
    }

    function renderChapterDetail() {
      const chapter = SAMPLE_CHAPTERS.find(c => c.id === selectedNode.chapterId);
      const program = buildProgram(PROJECT, driverValues, activeChapters);
      const chapterRooms = program.roomRequirements.filter(rr => rr.chapterId === selectedNode.chapterId);
      const totalRooms = chapterRooms.reduce((sum, rr) => sum + rr.requiredCount, 0);
      const totalNSF = chapterRooms.reduce((sum, rr) => {
        const room = SAMPLE_ROOMS.find(r => r.id === rr.roomTemplateId);
        return sum + (room ? room.nsf * rr.requiredCount : 0);
      }, 0);

      return `
        <div class="detail-panel">
          <h3>üìÅ ${chapter.title}</h3>
          <div class="detail-row">
            <div class="detail-label">Chapter ID:</div>
            <div class="detail-value">${chapter.id}</div>
          </div>
          <div class="detail-row">
            <div class="detail-label">Category:</div>
            <div class="detail-value">${chapter.category}</div>
          </div>
          <div class="detail-row">
            <div class="detail-label">Room Types:</div>
            <div class="detail-value">${chapterRooms.length}</div>
          </div>
          <div class="detail-row">
            <div class="detail-label">Total Rooms:</div>
            <div class="detail-value">${totalRooms}</div>
          </div>
          <div class="detail-row">
            <div class="detail-label">Total NSF:</div>
            <div class="detail-value">${totalNSF.toLocaleString()} SF</div>
          </div>
        </div>
      `;
    }

    // Helper function to get room attributes from ROOM_SIZES
    function getRoomAttributes(roomCode) {
      if (typeof ROOM_SIZES !== 'undefined' && ROOM_SIZES) {
        return ROOM_SIZES.find(r => r.id === roomCode);
      }
      return null;
    }

    // Helper to render editable attribute field
    function renderEditableAttribute(label, value, onChange) {
      const displayValue = value !== null && value !== undefined && value !== '' ? value : '';
      return `
        <div class="detail-row">
          <div class="detail-label">${label}:</div>
          <div class="detail-value">
            <input type="text" value="${displayValue}" 
              onchange="${onChange}"
              placeholder="Not specified"
              style="width: 100%; padding: 4px 8px; background: var(--input-bg); border: 1px solid var(--input-border); color: var(--text); border-radius: 4px;">
          </div>
        </div>
      `;
    }

    // Helper to render read-only attribute field
    function renderReadOnlyAttribute(label, value) {
      const displayValue = value !== null && value !== undefined && value !== '' ? value : 'Not specified';
      return `
        <div class="detail-row">
          <div class="detail-label">${label}:</div>
          <div class="detail-value">${displayValue}</div>
        </div>
      `;
    }

    function renderRoomDetail() {
      // Handle imported rooms (from reference mode)
      if (selectedNode.room && !selectedNode.roomTemplate) {
        const room = selectedNode.room;
        const equipCount = room.equipment ? room.equipment.length : 0;
        const nsf = room.nsf || 0;
        const project = getCurrentProject();
        const roomCost = calculateRoomCost(room, project);
        const equipmentCost = calculateEquipmentCost(room.equipment);
        
        // Get room attributes from ROOM_SIZES
        const roomAttrs = getRoomAttributes(room.code);

        let html = `
          <div class="detail-panel">
            <h3>üö™ ${room.code} - ${room.name}</h3>
            <div class="detail-row">
              <div class="detail-label">Room Code:</div>
              <div class="detail-value">${room.code}</div>
            </div>
            <div class="detail-row">
              <div class="detail-label">Room Name:</div>
              <div class="detail-value">
                <input type="text" value="${room.name}" 
                  onchange="updateRoomName('${room.id}', this.value)"
                  style="width: 100%; padding: 4px 8px; background: var(--input-bg); border: 1px solid var(--input-border); color: var(--text); border-radius: 4px;">
              </div>
            </div>
            <div class="detail-row">
              <div class="detail-label">NSF:</div>
              <div class="detail-value">
                <input type="number" value="${nsf}" 
                  onchange="updateRoomNSF('${room.id}', this.value)"
                  style="width: 80px; padding: 4px 8px; background: var(--input-bg); border: 1px solid var(--input-border); color: var(--text); border-radius: 4px;">
                SF
              </div>
            </div>
            <div class="detail-row">
              <div class="detail-label">Equipment Items:</div>
              <div class="detail-value">${equipCount}</div>
            </div>
            <div class="detail-row">
              <div class="detail-label">Equipment Cost:</div>
              <div class="detail-value" style="font-weight: 600; color: var(--accent);">$${equipmentCost.toLocaleString()}</div>
            </div>
            <div class="detail-row">
              <div class="detail-label">Total Cost:</div>
              <div class="detail-value" style="font-weight: 600; color: var(--accent);">$${roomCost.toLocaleString()}</div>
            </div>
          </div>
          <div class="detail-panel" style="padding: 8px 12px; display: flex; gap: 8px;">
            <button class="btn-secondary" onclick="duplicateRoom('${room.id}')" style="flex: 1; font-size: 0.85rem; padding: 6px 12px;">üìã Duplicate Room</button>
            <button class="btn-secondary" onclick="resetRoomToDefault('${room.id}')" style="flex: 1; font-size: 0.85rem; padding: 6px 12px; background: #f39c12; color: white; border-color: #e67e22;" onmouseover="this.style.background='#e67e22'" onmouseout="this.style.background='#f39c12'">üîÑ Reset to Default</button>
          </div>
        `;

        // Room Attributes - editable if available from ROOM_SIZES
        if (roomAttrs) {
          // Helper to get attribute value (room.attributes overrides ROOM_SIZES)
          const getAttr = (attrName) => room.attributes?.[attrName] ?? roomAttrs[attrName];
          
          // Consolidated Attributes Panel with ALL available attributes in multi-column layout
          html += `
            <div class="detail-panel">
              <h3>üìã Room Attributes</h3>
              <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 16px;">
                
                <!-- Column 1: Materials & Finishes -->
                <div>
                  <h4 style="margin: 0 0 8px 0; font-size: 0.9rem; color: var(--muted);">üèóÔ∏è Materials & Finishes</h4>
                  ${renderEditableAttribute('Ceiling Material', getAttr('ceilingMaterial'), `updateRoomAttribute('${room.id}', 'ceilingMaterial', this.value)`)}
                  ${renderEditableAttribute('Ceiling Alt', getAttr('ceilingMaterialAlternate'), `updateRoomAttribute('${room.id}', 'ceilingMaterialAlternate', this.value)`)}
                  ${renderEditableAttribute('Ceiling Finish', getAttr('ceilingFinish'), `updateRoomAttribute('${room.id}', 'ceilingFinish', this.value)`)}
                  ${renderEditableAttribute('Wall Material', getAttr('wallMaterial'), `updateRoomAttribute('${room.id}', 'wallMaterial', this.value)`)}
                  ${renderEditableAttribute('Wall Alt', getAttr('wallMaterialAlternate'), `updateRoomAttribute('${room.id}', 'wallMaterialAlternate', this.value)`)}
                  ${renderEditableAttribute('Wall Finish', getAttr('wallFinish'), `updateRoomAttribute('${room.id}', 'wallFinish', this.value)`)}
                  ${renderEditableAttribute('Floor Material', getAttr('floorMaterial'), `updateRoomAttribute('${room.id}', 'floorMaterial', this.value)`)}
                  ${renderEditableAttribute('Floor Alt', getAttr('floorMaterialAlternate'), `updateRoomAttribute('${room.id}', 'floorMaterialAlternate', this.value)`)}
                  ${renderEditableAttribute('Floor Base', getAttr('floorBaseMaterial'), `updateRoomAttribute('${room.id}', 'floorBaseMaterial', this.value)`)}
                </div>
                
                <!-- Column 2: Door & Environmental -->
                <div>
                  <h4 style="margin: 0 0 8px 0; font-size: 0.9rem; color: var(--muted);">üö™ Door</h4>
                  ${renderEditableAttribute('Door Material', getAttr('doorMaterial'), `updateRoomAttribute('${room.id}', 'doorMaterial', this.value)`)}
                  ${renderEditableAttribute('Door Height', getAttr('doorHeight'), `updateRoomAttribute('${room.id}', 'doorHeight', this.value)`)}
                  ${renderEditableAttribute('Door Width', getAttr('doorWidth'), `updateRoomAttribute('${room.id}', 'doorWidth', this.value)`)}
                  ${renderEditableAttribute('Door Type', getAttr('doorType'), `updateRoomAttribute('${room.id}', 'doorType', this.value)`)}
                  ${renderEditableAttribute('Door Rating', getAttr('doorRating'), `updateRoomAttribute('${room.id}', 'doorRating', this.value)`)}
                  
                  <h4 style="margin: 12px 0 8px 0; font-size: 0.9rem; color: var(--muted);">üí° Lighting & Acoustics</h4>
                  ${renderEditableAttribute('Lighting Level', getAttr('lightingLevel'), `updateRoomAttribute('${room.id}', 'lightingLevel', this.value)`)}
                  ${renderEditableAttribute('Acoustical Criteria', getAttr('acousticalCriteria'), `updateRoomAttribute('${room.id}', 'acousticalCriteria', this.value)`)}
                  ${renderEditableAttribute('Max Noise (NC)', getAttr('maxNoiseLevelNc'), `updateRoomAttribute('${room.id}', 'maxNoiseLevelNc', this.value)`)}
                  ${renderEditableAttribute('Floor Live Load', getAttr('floorLiveLoad'), `updateRoomAttribute('${room.id}', 'floorLiveLoad', this.value)`)}
                </div>
                
                <!-- Column 3: HVAC -->
                <div>
                  <h4 style="margin: 0 0 8px 0; font-size: 0.9rem; color: var(--muted);">‚ùÑÔ∏è HVAC</h4>
                  ${renderEditableAttribute('Min Total ACH', getAttr('minTotalAch'), `updateRoomAttribute('${room.id}', 'minTotalAch', this.value)`)}
                  ${renderEditableAttribute('Min OA ACH', getAttr('minOaAch'), `updateRoomAttribute('${room.id}', 'minOaAch', this.value)`)}
                  ${renderEditableAttribute('Unoccupied ACH', getAttr('unoccupiedAch'), `updateRoomAttribute('${room.id}', 'unoccupiedAch', this.value)`)}
                  ${renderEditableAttribute('Air Balance', getAttr('roomAirBalance'), `updateRoomAttribute('${room.id}', 'roomAirBalance', this.value)`)}
                  ${renderEditableAttribute('HEPA Filtration', getAttr('airHasHepaFiltration'), `updateRoomAttribute('${room.id}', 'airHasHepaFiltration', this.value)`)}
                  ${renderEditableAttribute('100% Exhaust', getAttr('exhaustIs100Outside'), `updateRoomAttribute('${room.id}', 'exhaustIs100Outside', this.value)`)}
                  ${renderEditableAttribute('Temp Cooling (¬∞C)', getAttr('indoorTempCoolingC'), `updateRoomAttribute('${room.id}', 'indoorTempCoolingC', this.value)`)}
                  ${renderEditableAttribute('Temp Heating (¬∞C)', getAttr('indoorTempHeatingC'), `updateRoomAttribute('${room.id}', 'indoorTempHeatingC', this.value)`)}
                  ${renderEditableAttribute('RH Max (%)', getAttr('indoorRelativeHumidityRhMax'), `updateRoomAttribute('${room.id}', 'indoorRelativeHumidityRhMax', this.value)`)}
                  ${renderEditableAttribute('RH Min (%)', getAttr('indoorRelativeHumidityRhMin'), `updateRoomAttribute('${room.id}', 'indoorRelativeHumidityRhMin', this.value)`)}
                </div>
                
                <!-- Column 4: Medical Gases & Plumbing -->
                <div>
                  <h4 style="margin: 0 0 8px 0; font-size: 0.9rem; color: var(--muted);">üîß Medical Gases</h4>
                  ${renderEditableAttribute('Medical Air', getAttr('medAir'), `updateRoomAttribute('${room.id}', 'medAir', this.value)`)}
                  ${renderEditableAttribute('Medical Vacuum', getAttr('medVac'), `updateRoomAttribute('${room.id}', 'medVac', this.value)`)}
                  ${renderEditableAttribute('Oxygen', getAttr('oxygen'), `updateRoomAttribute('${room.id}', 'oxygen', this.value)`)}
                  ${renderEditableAttribute('Nitrogen', getAttr('nitrogen'), `updateRoomAttribute('${room.id}', 'nitrogen', this.value)`)}
                  ${renderEditableAttribute('Nitrous Oxide', getAttr('nitrousOxide'), `updateRoomAttribute('${room.id}', 'nitrousOxide', this.value)`)}
                  ${renderEditableAttribute('WAGD', getAttr('wagd'), `updateRoomAttribute('${room.id}', 'wagd', this.value)`)}
                  ${renderEditableAttribute('CO2', getAttr('co2'), `updateRoomAttribute('${room.id}', 'co2', this.value)`)}
                  ${renderEditableAttribute('Inst Air', getAttr('instAir'), `updateRoomAttribute('${room.id}', 'instAir', this.value)`)}
                  ${renderEditableAttribute('Lab Air', getAttr('labAir'), `updateRoomAttribute('${room.id}', 'labAir', this.value)`)}
                  ${renderEditableAttribute('Lab Vacuum', getAttr('labVac'), `updateRoomAttribute('${room.id}', 'labVac', this.value)`)}
                  ${renderEditableAttribute('Dental Air', getAttr('dentalAir'), `updateRoomAttribute('${room.id}', 'dentalAir', this.value)`)}
                  ${renderEditableAttribute('Dental Vacuum', getAttr('dentalVac'), `updateRoomAttribute('${room.id}', 'dentalVac', this.value)`)}
                  ${renderEditableAttribute('Oral Evac', getAttr('oralEvac'), `updateRoomAttribute('${room.id}', 'oralEvac', this.value)`)}
                  
                  <h4 style="margin: 12px 0 8px 0; font-size: 0.9rem; color: var(--muted);">üíß Plumbing</h4>
                  ${renderEditableAttribute('Cold Water', getAttr('domesticColdWater'), `updateRoomAttribute('${room.id}', 'domesticColdWater', this.value)`)}
                  ${renderEditableAttribute('Hot Water', getAttr('domesticHotWater'), `updateRoomAttribute('${room.id}', 'domesticHotWater', this.value)`)}
                  ${renderEditableAttribute('Floor Drain', getAttr('floorDrain'), `updateRoomAttribute('${room.id}', 'floorDrain', this.value)`)}
                  ${renderEditableAttribute('Natural Gas', getAttr('naturalGas'), `updateRoomAttribute('${room.id}', 'naturalGas', this.value)`)}
                  ${renderEditableAttribute('Lab Natural Gas', getAttr('labNaturalGas'), `updateRoomAttribute('${room.id}', 'labNaturalGas', this.value)`)}
                </div>
              </div>
            </div>
          `;
        }

        if (room.equipment && room.equipment.length > 0) {
          html += `
            <div class="detail-panel">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                <h3 style="margin: 0;">üîß Equipment (${room.equipment.length} items)</h3>
                <button class="btn-secondary" onclick="addEquipmentToRoom('${room.id}')" style="padding: 6px 12px; font-size: 0.85rem;">‚ûï Add Equipment</button>
              </div>
              <div class="equipment-list">
          `;

          room.equipment.forEach(eq => {
            const eqCost = (eq.cost || 0) * (eq.quantity || 1);
            html += `
              <div class="equipment-item">
                <div class="equipment-item-header">
                  <span>${eq.jsn} - ${eq.name} - <span class="equipment-item-desc${eq.description && eq.description.length > 100 ? ' truncated' : ''}">${eq.description || ''}</span>${eq.description && eq.description.length > 100 ? ' <span class="equipment-desc-toggle" onclick="toggleEquipmentDesc(this)">more</span>' : ''}</span>
                  <span style="display: flex; align-items: center; gap: 8px;">
                    <span>Qty:</span>
                    <input type="number" value="${eq.quantity}" min="1"
                      onchange="updateEquipmentQuantity('${room.id}', '${eq.id}', this.value)"
                      style="width: 60px; padding: 2px 6px; background: var(--input-bg); border: 1px solid var(--input-border); color: var(--text); border-radius: 4px;">
                    <span>| $</span>
                    <input type="number" value="${eq.cost || 0}" min="0" step="100"
                      onchange="updateEquipmentCost('${room.id}', '${eq.id}', this.value)"
                      style="width: 80px; padding: 2px 6px; background: var(--input-bg); border: 1px solid var(--input-border); color: var(--text); border-radius: 4px;"
                      title="Unit cost">
                    <span>= $${eqCost.toLocaleString()}</span>
                    <span>| ${eq.acqIns}</span>
                    <button onclick="removeEquipment('${room.id}', '${eq.id}')" 
                      style="padding: 2px 8px; background: var(--error); color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.75rem;"
                      title="Remove equipment">üóëÔ∏è</button>
                  </span>
                </div>
              </div>
            `;
          });

          html += `
              </div>
            </div>
          `;
        } else {
          // Show Add Equipment button even when no equipment exists
          html += `
            <div class="detail-panel">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                <h3 style="margin: 0;">üîß Equipment (0 items)</h3>
                <button class="btn-secondary" onclick="addEquipmentToRoom('${room.id}')" style="padding: 6px 12px; font-size: 0.85rem;">‚ûï Add Equipment</button>
              </div>
              <p style="color: var(--muted); font-size: 0.9rem;">No equipment in this room yet.</p>
            </div>
          `;
        }

        return html;
      }

      // Handle program mode rooms (rule-based)
      const room = selectedNode.roomTemplate;
      const rr = selectedNode.roomRequirement;
      const program = buildProgram(PROJECT, driverValues, activeChapters);
      
      // Get equipment for this room
      const roomEquipment = program.equipmentRequirements.filter(
        er => er.roomRequirementId === rr.id
      );

      let html = `
        <div class="detail-panel">
          <h3>üö™ ${room.id} - ${room.name}</h3>
          <div class="detail-row">
            <div class="detail-label">Room Code:</div>
            <div class="detail-value">${room.id}</div>
          </div>
          <div class="detail-row">
            <div class="detail-label">Quantity:</div>
            <div class="detail-value">${rr.requiredCount}</div>
          </div>
          <div class="detail-row">
            <div class="detail-label">NSF per Room:</div>
            <div class="detail-value">${room.nsf} SF</div>
          </div>
          <div class="detail-row">
            <div class="detail-label">Total NSF:</div>
            <div class="detail-value">${(room.nsf * rr.requiredCount).toLocaleString()} SF</div>
          </div>
        </div>
      `;

      if (roomEquipment.length > 0) {
        html += `
          <div class="detail-panel">
            <h3>üîß Equipment (${roomEquipment.length} items)</h3>
            <div class="equipment-list">
        `;

        const equipmentMap = new Map();
        EQUIPMENT_LIST.forEach(e => equipmentMap.set(e.jsn, e));

        roomEquipment.forEach(er => {
          const eq = equipmentMap.get(er.equipmentJsn);
          if (eq) {
            html += `
              <div class="equipment-item">
                <div class="equipment-item-header">
                  <span>${eq.jsn} - ${eq.name} - <span class="equipment-item-desc${eq.description && eq.description.length > 100 ? ' truncated' : ''}">${eq.description || ''}</span>${eq.description && eq.description.length > 100 ? '<span class="equipment-desc-toggle" onclick="toggleEquipmentDesc(this)">more</span>' : ''}</span>
                  <span>Qty: ${er.requiredQtyPerRoom} | ${eq.acqIns}</span>
                </div>
              </div>
            `;
          }
        });

        html += `
            </div>
          </div>
        `;
      }

      return html;
    }

    function renderRoomReferenceDetail() {
      // Get room info from selected node
      const roomCode = selectedNode.roomCode;
      const roomName = selectedNode.roomName;
      const department = selectedNode.department;
      const functionalArea = selectedNode.functionalArea;
      
      console.log('Rendering room reference:', roomCode, roomName, department, functionalArea);
      console.log('ROOM_SIZES available:', typeof ROOM_SIZES !== 'undefined', ROOM_SIZES ? ROOM_SIZES.length : 0);
      console.log('ROOM_EQUIPMENT_MAPPINGS available:', typeof ROOM_EQUIPMENT_MAPPINGS !== 'undefined', ROOM_EQUIPMENT_MAPPINGS ? ROOM_EQUIPMENT_MAPPINGS.length : 0);
      
      // Defensive check for ROOM_SIZES
      if (typeof ROOM_SIZES === 'undefined') {
        return `
          <div class="detail-panel">
            <h3>‚ö†Ô∏è Data Loading Error</h3>
            <p style="color: var(--muted);">Room size data not loaded. Please refresh the page.</p>
          </div>
        `;
      }
      
      // Get room attributes from ROOM_SIZES
      const roomData = getRoomAttributes(roomCode);
      console.log('Found roomData:', roomData ? 'Yes' : 'No', roomData ? roomData.id : 'null');
      
      // Get all equipment for this room code (don't filter by dept/FA since equipment is same across instances)
      const allMappings = getEquipmentMappings();
      console.log('Total equipment mappings available:', allMappings.length);
      const roomEquipment = allMappings.filter(re => re.roomCode === roomCode);
      console.log('Found equipment mappings for', roomCode, ':', roomEquipment.length);
      if (roomEquipment.length > 0) {
        console.log('Sample equipment mapping:', roomEquipment[0]);
        console.log('First 5 JSNs:', roomEquipment.slice(0, 5).map(re => re.jsn));
      }

      let html = `
        <div class="detail-panel">
          <h3>üö™ ${roomCode} - ${roomName}</h3>
          ${renderReadOnlyAttribute('Room Code', roomCode)}
          ${renderReadOnlyAttribute('Department', department)}
          ${renderReadOnlyAttribute('Functional Area', functionalArea)}
          ${renderReadOnlyAttribute('NSF', roomData?.nsf ? roomData.nsf + ' SF' : 'Not specified')}
          ${renderReadOnlyAttribute('Equipment Items', roomEquipment.length)}
        </div>
        <div class="detail-panel">
          <p style="color: var(--muted); font-size: 0.9rem; margin-bottom: 12px;">
            üìö Reference mode - read-only view. Switch to Program Mode and import this room to edit.
          </p>
        </div>
      `;

      // Room Attributes - show in compact multi-column layout with ALL available attributes
      if (roomData) {
        html += `
          <div class="detail-panel">
            <h3>üìã Attributes</h3>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; font-size: 0.75rem;">
              
              <!-- Column 1: Materials & Finishes -->
              <div>
                <h4 style="margin: 0 0 4px 0; font-size: 0.75rem; color: var(--muted); font-weight: 600;">üèóÔ∏è Materials & Finishes</h4>
                ${renderReadOnlyAttribute('Ceiling Mat', roomData.ceilingMaterial)}
                ${renderReadOnlyAttribute('Ceiling Alt', roomData.ceilingMaterialAlternate)}
                ${renderReadOnlyAttribute('Ceiling Finish', roomData.ceilingFinish)}
                ${renderReadOnlyAttribute('Ceiling Cat', roomData.ceilingCategory)}
                ${renderReadOnlyAttribute('Wall Mat', roomData.wallMaterial)}
                ${renderReadOnlyAttribute('Wall Alt', roomData.wallMaterialAlternate)}
                ${renderReadOnlyAttribute('Wall Finish', roomData.wallFinish)}
                ${renderReadOnlyAttribute('Wall Finish Alt', roomData.wallFinishAlternate)}
                ${renderReadOnlyAttribute('Floor Mat', roomData.floorMaterial)}
                ${renderReadOnlyAttribute('Floor Alt', roomData.floorMaterialAlternate)}
                ${renderReadOnlyAttribute('Floor Base', roomData.floorBaseMaterial)}
                ${renderReadOnlyAttribute('Floor Base Alt', roomData.floorBaseMaterialAlternate)}
                ${renderReadOnlyAttribute('Wain', roomData.wain)}
              </div>
              
              <!-- Column 2: Door & Environmental -->
              <div>
                <h4 style="margin: 0 0 4px 0; font-size: 0.75rem; color: var(--muted); font-weight: 600;">üö™ Door</h4>
                ${renderReadOnlyAttribute('Door Mat', roomData.doorMaterial)}
                ${renderReadOnlyAttribute('Door Height', roomData.doorHeight)}
                ${renderReadOnlyAttribute('Door Width', roomData.doorWidth)}
                ${renderReadOnlyAttribute('Door Function', roomData.doorFunction)}
                ${renderReadOnlyAttribute('Door Hardware', roomData.doorHardware)}
                ${renderReadOnlyAttribute('Door Type', roomData.doorType)}
                ${renderReadOnlyAttribute('Door Rating', roomData.doorRating)}
                ${renderReadOnlyAttribute('Door Notes', roomData.doorNotes)}
                
                <h4 style="margin: 8px 0 4px 0; font-size: 0.75rem; color: var(--muted); font-weight: 600;">üí° Light/Sound</h4>
                ${renderReadOnlyAttribute('Lighting Lvl', roomData.lightingLevel)}
                ${renderReadOnlyAttribute('Acoustical', roomData.acousticalCriteria)}
                ${renderReadOnlyAttribute('Max NC', roomData.maxNoiseLevelNc)}
                ${renderReadOnlyAttribute('Floor Load', roomData.floorLiveLoad)}
              </div>
              
              <!-- Column 3: HVAC -->
              <div>
                <h4 style="margin: 0 0 4px 0; font-size: 0.75rem; color: var(--muted); font-weight: 600;">‚ùÑÔ∏è HVAC</h4>
                ${renderReadOnlyAttribute('Total ACH', roomData.minTotalAch)}
                ${renderReadOnlyAttribute('OA ACH', roomData.minOaAch)}
                ${renderReadOnlyAttribute('Unocc ACH', roomData.unoccupiedAch)}
                ${renderReadOnlyAttribute('Air Balance', roomData.roomAirBalance)}
                ${renderReadOnlyAttribute('Room Air', roomData.roomAir)}
                ${renderReadOnlyAttribute('HEPA Filter', roomData.airHasHepaFiltration)}
                ${renderReadOnlyAttribute('100% Exhaust', roomData.exhaustIs100Outside)}
                ${renderReadOnlyAttribute('Cool Temp', roomData.indoorTempCoolingC ? roomData.indoorTempCoolingC + '¬∞C' : null)}
                ${renderReadOnlyAttribute('Heat Temp', roomData.indoorTempHeatingC ? roomData.indoorTempHeatingC + '¬∞C' : null)}
                ${renderReadOnlyAttribute('RH Max', roomData.indoorRelativeHumidityRhMax ? roomData.indoorRelativeHumidityRhMax + '%' : null)}
                ${renderReadOnlyAttribute('RH Min', roomData.indoorRelativeHumidityRhMin ? roomData.indoorRelativeHumidityRhMin + '%' : null)}
                ${renderReadOnlyAttribute('Temp Ctrl', roomData.individualRoomControlTemp)}
                ${renderReadOnlyAttribute('Flow Ctrl', roomData.individualRoomControlFlow)}
              </div>
              
              <!-- Column 4: Medical Gases & Services -->
              <div>
                <h4 style="margin: 0 0 4px 0; font-size: 0.75rem; color: var(--muted); font-weight: 600;">üîß Medical Gases</h4>
                ${renderReadOnlyAttribute('Med Air', roomData.medAir)}
                ${renderReadOnlyAttribute('Med Vac', roomData.medVac)}
                ${renderReadOnlyAttribute('O‚ÇÇ', roomData.oxygen)}
                ${renderReadOnlyAttribute('N‚ÇÇ', roomData.nitrogen)}
                ${renderReadOnlyAttribute('N‚ÇÇO', roomData.nitrousOxide)}
                ${renderReadOnlyAttribute('WAGD', roomData.wagd)}
                ${renderReadOnlyAttribute('CO‚ÇÇ', roomData.co2)}
                ${renderReadOnlyAttribute('Inst Air', roomData.instAir)}
                ${renderReadOnlyAttribute('Lab Air', roomData.labAir)}
                ${renderReadOnlyAttribute('Lab Vac', roomData.labVac)}
                ${renderReadOnlyAttribute('Lab Gas', roomData.labNaturalGas)}
                ${renderReadOnlyAttribute('Dental Air', roomData.dentalAir)}
                ${renderReadOnlyAttribute('Dental Vac', roomData.dentalVac)}
                ${renderReadOnlyAttribute('Oral Evac', roomData.oralEvac)}
                
                <h4 style="margin: 8px 0 4px 0; font-size: 0.75rem; color: var(--muted); font-weight: 600;">üíß Plumbing</h4>
                ${renderReadOnlyAttribute('Cold Water', roomData.domesticColdWater)}
                ${renderReadOnlyAttribute('Hot Water', roomData.domesticHotWater)}
                ${renderReadOnlyAttribute('Floor Drain', roomData.floorDrain)}
                ${renderReadOnlyAttribute('Nat Gas', roomData.naturalGas)}
              </div>
            </div>
          </div>
        `;
      }

      // Equipment List
      if (roomEquipment.length > 0) {
        html += `
          <div class="detail-panel">
            <h3>üîß Equipment (${roomEquipment.length} items)</h3>
            <div class="equipment-list">
        `;

        const equipmentMap = new Map();
        EQUIPMENT_LIST.forEach(e => equipmentMap.set(e.jsn, e));

        roomEquipment.forEach(re => {
          const eq = equipmentMap.get(re.jsn);
          if (eq) {
            html += `
              <div class="equipment-item">
                <div class="equipment-item-header">
                  <span>${eq.jsn} - ${eq.name} - <span class="equipment-item-desc${eq.description && eq.description.length > 100 ? ' truncated' : ''}">${eq.description || ''}</span>${eq.description && eq.description.length > 100 ? '<span class="equipment-desc-toggle" onclick="toggleEquipmentDesc(this)">more</span>' : ''}</span>
                  <span>Qty: ${re.quantity} | ${eq.acqIns}</span>
                </div>
              </div>
            `;
          }
        });

        html += `
            </div>
          </div>
        `;
      }

      return html;
    }

    function handleDriverChange(driverId, value, type) {
      const existingIndex = driverValues.findIndex(
        d => d.projectId === PROJECT.id && d.driverId === driverId
      );

      let finalValue = value;
      if (type === "number") {
        finalValue = value === "" ? "" : Number(value);
      } else if (type === "boolean") {
        finalValue = value === "true";
      }

      const newEntry = {
        projectId: PROJECT.id,
        driverId: driverId,
        value: finalValue
      };

      if (existingIndex === -1) {
        driverValues = driverValues.concat(newEntry);
      } else {
        const copy = driverValues.slice();
        copy[existingIndex] = newEntry;
        driverValues = copy;
      }

      renderAll();
    }

    // -----------------------------
    // RENDER FUNCTIONS
    // -----------------------------

    // Debounce utility to prevent excessive re-renders
    function debounce(func, wait) {
      let timeout;
      return function executedFunction(...args) {
        const later = () => {
          clearTimeout(timeout);
          func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
      };
    }

    function renderAll() {
      renderTree();
      renderDetail();
      
      // Render compare mode panels if in compare mode
      if (currentMode === 'compare') {
        renderCompareMode();
      }
    }

    function renderCompareMode() {
      const detailView = document.getElementById('detail-view');
      const compareView = document.getElementById('compare-view');
      
      console.log('renderCompareMode called');
      console.log('compareLeftRoom:', compareLeftRoom);
      console.log('compareRightRoom:', compareRightRoom);
      
      // Left column in detail-view
      let leftHtml = `
        <div class="compare-column" id="compare-left-col" ondrop="handleCompareDrop(event, 'left')" ondragover="handleCompareDragOver(event)" ondragleave="handleCompareDragLeave(event)">
          <h3>Room Comparison - Left Side</h3>
          <input type="text" class="compare-search" id="compare-left-search" placeholder="Search room code or name..." oninput="searchCompareRoom('left')">
          <div id="compare-left-results"></div>
          <div id="compare-left-display">
      `;
      
      if (compareLeftRoom) {
        console.log('Rendering left room:', compareLeftRoom.room.code);
        leftHtml += renderRoomComparison(compareLeftRoom);
      } else {
        leftHtml += `<p style="color: var(--muted); text-align: center; padding: 40px 0;">Drag a room here or search to compare</p>`;
      }
      
      leftHtml += `
          </div>
        </div>
      `;
      
      detailView.innerHTML = leftHtml;
      
      // Right column in compare-view
      let rightHtml = `
        <div class="compare-column" id="compare-right-col" ondrop="handleCompareDrop(event, 'right')" ondragover="handleCompareDragOver(event)" ondragleave="handleCompareDragLeave(event)">
          <h3>Room Comparison - Right Side</h3>
          <input type="text" class="compare-search" id="compare-right-search" placeholder="Search room code or name..." oninput="searchCompareRoom('right')">
          <div id="compare-right-results"></div>
          <div id="compare-right-display">
      `;
      
      if (compareRightRoom) {
        console.log('Rendering right room:', compareRightRoom.room.code);
        rightHtml += renderRoomComparison(compareRightRoom);
      } else {
        rightHtml += `<p style="color: var(--muted); text-align: center; padding: 40px 0;">Drag a room here or search to compare</p>`;
      }
      
      rightHtml += `
          </div>
        </div>
      `;
      
      console.log('Setting compareView innerHTML');
      compareView.innerHTML = rightHtml;
    }

    function renderRoomComparison(roomData) {
      const { room, fa, dept } = roomData;
      const equipCount = room.equipment ? room.equipment.length : 0;
      const totalNSF = room.nsf || 0;
      
      let html = `
        <div class="compare-room-display">
          <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 16px;">
            <h4>${room.code} - ${room.name}</h4>
            <button onclick="clearCompareRoom('${roomData.side}')" style="background: var(--pill-inactive); border: none; color: var(--text); padding: 4px 8px; border-radius: 4px; cursor: pointer;">‚úï</button>
          </div>
          <div class="detail-row">
            <div class="detail-label">Department:</div>
            <div class="detail-value">${dept.name}</div>
          </div>
          <div class="detail-row">
            <div class="detail-label">Functional Area:</div>
            <div class="detail-value">${fa.name}</div>
          </div>
          <div class="detail-row">
            <div class="detail-label">NSF:</div>
            <div class="detail-value">${totalNSF.toLocaleString()} SF</div>
          </div>
          <div class="detail-row">
            <div class="detail-label">Equipment Items:</div>
            <div class="detail-value">${equipCount}</div>
          </div>
      `;
      
      // Attributes
      if (room.attributes && Object.keys(room.attributes).length > 0) {
        html += `<h4 style="margin-top: 20px; margin-bottom: 12px; font-size: 0.95rem;">Attributes</h4>`;
        Object.entries(room.attributes).forEach(([key, value]) => {
          html += `
            <div class="detail-row">
              <div class="detail-label">${key}:</div>
              <div class="detail-value">${value}</div>
            </div>
          `;
        });
      }
      
      // Equipment
      if (room.equipment && room.equipment.length > 0) {
        html += `<h4 style="margin-top: 20px; margin-bottom: 12px; font-size: 0.95rem;">Equipment (${room.equipment.length})</h4>`;
        room.equipment.forEach(eq => {
          const hasLongDesc = eq.description && eq.description.length > 100;
          html += `
            <div style="padding: 8px; margin-bottom: 8px; background: var(--bg-secondary); border-radius: 4px;">
              <div style="font-weight: 600; margin-bottom: 4px;">${eq.jsn} - ${eq.name} - <span class="equipment-item-desc${hasLongDesc ? ' truncated' : ''}" style="font-size: 0.8rem; color: var(--muted);">${eq.description || ''}</span>${hasLongDesc ? '<span class="equipment-desc-toggle" onclick="toggleEquipmentDesc(this)">more</span>' : ''}</div>
              <div style="font-size: 0.85rem; color: var(--muted);">Qty: ${eq.quantity} | ${eq.acqIns}</div>
            </div>
          `;
        });
      }
      
      html += `
        </div>
      `;
      
      return html;
    }

    function handleRoomDragStart(event, nodeId) {
      // Store the room code for the drop event (use reference data in compare mode)
      const treeData = buildTreeData();
      const node = findNodeById(treeData, nodeId);
      if (node) {
        // In compare mode, use roomCode; in program mode, use room.id
        if (currentMode === 'compare' && node.roomCode) {
          event.dataTransfer.setData('text/plain', node.roomCode);
        } else if (node.room) {
          event.dataTransfer.setData('text/plain', node.room.id);
        }
        event.dataTransfer.effectAllowed = 'copy';
      }
    }

    function handleCompareDragOver(event) {
      event.preventDefault();
      event.currentTarget.classList.add('drag-over');
    }

    function handleCompareDragLeave(event) {
      event.currentTarget.classList.remove('drag-over');
    }

    function handleCompareDrop(event, side) {
      event.preventDefault();
      event.currentTarget.classList.remove('drag-over');
      
      // Get room code from drag event
      const roomCode = event.dataTransfer.getData('text/plain');
      if (!roomCode) return;
      
      console.log('Drop received for room code:', roomCode);
      
      // Get metadata for this room code
      const metadata = window.ROOM_METADATA ? window.ROOM_METADATA.get(roomCode) : null;
      if (!metadata) {
        console.error('No metadata found for room code:', roomCode);
        return;
      }
      
      console.log('Found metadata:', metadata);
      
      const roomSize = ROOM_SIZES.find(r => r.id === roomCode);
      if (!roomSize) {
        console.error('No room size found for room code:', roomCode);
        return;
      }
      
      // Build room object from reference data
      const room = {
        code: roomCode,
        name: roomSize.name || metadata.roomName || roomCode,
        nsf: roomSize.nsf || 0,
        attributes: {},
        equipment: []
      };
      
      // Add attributes from ROOM_SIZES (all properties except id, name, nsf)
      Object.keys(roomSize).forEach(key => {
        if (key !== 'id' && key !== 'name' && key !== 'nsf' && roomSize[key] !== null) {
          room.attributes[key] = roomSize[key];
        }
      });
      
      // Add equipment
      const equipForRoom = ROOM_EQUIPMENT_MAPPINGS.filter(m => m.roomCode === roomCode);
      equipForRoom.forEach(eq => {
        const equipDetail = EQUIPMENT_LIST.find(e => e.jsn === eq.jsn);
        if (equipDetail) {
          room.equipment.push({
            jsn: eq.jsn,
            name: equipDetail.name,
            quantity: eq.qty || eq.quantity || 1,
            acqIns: equipDetail.acqIns,
            description: equipDetail.description
          });
        }
      });
      
      const dept = { name: metadata.department };
      const fa = { name: metadata.functionalArea };
      
      console.log('Built room data:', { room, fa, dept });
      
      if (side === 'left') {
        compareLeftRoom = { room, fa, dept, side: 'left' };
      } else if (side === 'right') {
        compareRightRoom = { room, fa, dept, side: 'right' };
      }
      
      console.log('Rendering compare mode after drop');
      renderCompareMode();
    }

    function clearCompareRoom(side) {
      if (side === 'left') {
        compareLeftRoom = null;
      } else if (side === 'right') {
        compareRightRoom = null;
      }
      renderCompareMode();
    }

    function searchCompareRoom(side) {
      const searchInput = document.getElementById(`compare-${side}-search`);
      const resultsDiv = document.getElementById(`compare-${side}-results`);
      const query = searchInput.value.toLowerCase().trim();
      
      if (!query) {
        resultsDiv.innerHTML = '';
        return;
      }
      
      const matches = [];
      const seenRooms = new Set();
      
      // Search reference data
      ROOM_EQUIPMENT_MAPPINGS.forEach(mapping => {
        if (seenRooms.has(mapping.roomCode)) return;
        
        const roomSize = ROOM_SIZES[mapping.roomCode];
        if (!roomSize) return;
        
        const roomName = roomSize['Room Name'] || mapping.roomCode;
        
        if (mapping.roomCode.toLowerCase().includes(query) || roomName.toLowerCase().includes(query)) {
          seenRooms.add(mapping.roomCode);
          matches.push({
            roomCode: mapping.roomCode,
            roomName: roomName,
            deptName: mapping.department,
            faName: mapping.functionalArea
          });
        }
      });
      
      let html = '';
      if (matches.length > 0) {
        html = '<div style="background: var(--bg); border: 1px solid var(--border); border-radius: 4px; margin-bottom: 12px; max-height: 200px; overflow-y: auto;">';
        matches.forEach(match => {
          html += `
            <div onclick="selectCompareRoom('${match.roomCode}', '${side}')" style="padding: 8px; cursor: pointer; border-bottom: 1px solid var(--border); transition: background 0.2s;" onmouseover="this.style.background='var(--bg-secondary)'" onmouseout="this.style.background='transparent'">
              <div style="font-weight: 600;">${match.roomCode} - ${match.roomName}</div>
              <div style="font-size: 0.85rem; color: var(--muted);">${match.deptName} ‚Üí ${match.faName}</div>
            </div>
          `;
        });
        html += '</div>';
      } else {
        html = '<p style="color: var(--muted); font-size: 0.85rem; margin-bottom: 12px;">No matching rooms found</p>';
      }
      
      resultsDiv.innerHTML = html;
    }

    function selectCompareRoom(roomCode, side) {
      // Get metadata for this room code
      const metadata = window.ROOM_METADATA ? window.ROOM_METADATA.get(roomCode) : null;
      if (!metadata) return;
      
      const roomSize = ROOM_SIZES.find(r => r.id === roomCode);
      if (!roomSize) return;
      
      // Build room object from reference data
      const room = {
        code: roomCode,
        name: roomSize.name || metadata.roomName || roomCode,
        nsf: roomSize.nsf || 0,
        attributes: {},
        equipment: []
      };
      
      // Add attributes from ROOM_SIZES (all properties except id, name, nsf)
      Object.keys(roomSize).forEach(key => {
        if (key !== 'id' && key !== 'name' && key !== 'nsf' && roomSize[key] !== null) {
          room.attributes[key] = roomSize[key];
        }
      });
      
      // Add equipment
      const equipForRoom = ROOM_EQUIPMENT_MAPPINGS.filter(m => m.roomCode === roomCode);
      equipForRoom.forEach(eq => {
        const equipDetail = EQUIPMENT_LIST.find(e => e.jsn === eq.jsn);
        if (equipDetail) {
          room.equipment.push({
            jsn: eq.jsn,
            name: equipDetail.name,
            quantity: eq.qty || eq.quantity || 1,
            acqIns: equipDetail.acqIns,
            description: equipDetail.description
          });
        }
      });
      
      const dept = { name: metadata.department };
      const fa = { name: metadata.functionalArea };
      
      if (side === 'left') {
        compareLeftRoom = { room, fa, dept, side: 'left' };
      } else if (side === 'right') {
        compareRightRoom = { room, fa, dept, side: 'right' };
      }
      
      // Clear search
      document.getElementById(`compare-${side}-search`).value = '';
      document.getElementById(`compare-${side}-results`).innerHTML = '';
      renderCompareMode();
    }

    // Debounced version for input handlers
    const debouncedRenderAll = debounce(renderAll, 150);

    // -----------------------------
    // EVENT HANDLERS
    // -----------------------------

    // -----------------------------
    // IMPORT MODAL FUNCTIONS
    // -----------------------------

    let selectedImportItems = new Set();
    let expandedImportNodes = new Set();

    // Cache the department/FA structure to avoid rebuilding on every render
    let cachedDeptMap = null;
    function getDeptMap() {
      if (!cachedDeptMap) {
        cachedDeptMap = new Map();
        const mappings = window.ROOM_EQUIPMENT_MAPPINGS || [];
        mappings.forEach(mapping => {
          if (!cachedDeptMap.has(mapping.department)) {
            cachedDeptMap.set(mapping.department, new Map());
          }
          const faMap = cachedDeptMap.get(mapping.department);
          if (!faMap.has(mapping.functionalArea)) {
            faMap.set(mapping.functionalArea, new Set());
          }
          faMap.get(mapping.functionalArea).add(mapping.roomCode);
        });
      }
      return cachedDeptMap;
    }

    function openImportModal() {
      document.getElementById('import-modal').classList.add('active');
      document.getElementById('import-search').value = '';
      renderImportTree();
      setTimeout(() => document.getElementById('import-search').focus(), 100);
    }

    function closeImportModal() {
      document.getElementById('import-modal').classList.remove('active');
      selectedImportItems.clear();
    }

    // Room Logic Functions
    let currentLogicDepartment = null;
    let currentLogicInputs = {};
    let departmentLogicToggles = new Map(); // Track which departments have logic enabled

    function checkDepartmentHasLogic(departmentName) {
      if (!window.RoomLogic) return false;
      
      // Map department names to chapter IDs
      // Department names come from Equipment_Guide_parsed_v2.txt format: "100 (NAME)"
      const deptToChapter = {
        '100 (MEDICAL / SURGICAL PATIENT CARE UNIT (M/S PCU))': '100',
        '102 (INTENSIVE CARE PATIENT CARE UNIT (IC PCU))': '102',
        '104 (SPINAL CORD INJURY / DISORDERS CENTER (SCI/D))': '104',
        '106 (SMALL HOUSE (SH) MODEL)': '106',
        '208 (CHAPLAIN SERVICE)': '208',
        '210 (CARDIOLOGY SERVICE)': '210',
        '212 (PULMONARY MEDICINE SERVICE)': '212',
        '214 (CLINICAL SERVICES ADMINISTRATION)': '214',
        '218 (VETERANS ASSISTANCE UNIT)': '218',
        '220 (CREDIT UNION)': '220',
        '222 (DENTAL SERVICE)': '222',
        '226 (ELECTROENCEPHALOGRAPHY (EEG) LABORATORY)': '226',
        '234 (FISCAL SERVICE)': '234',
        '238 (MEDICAL CENTER DIRECTOR\'S SUITE)': '238',
        '244 (LOBBY)': '244',
        '254 (NURSING SERVICE ADMINISTRATION)': '254',
        '274 (QUARTERS, ON-CALL)': '274',
        '279 (POLICE SERVICE)': '279',
        '280 (SERVICE ORGANIZATIONS)': '280',
        '282 (SOCIAL WORK SERVICE)': '282',
        '290 (VOLUNTARY SERVICE)': '290'
      };
      
      const chapterId = deptToChapter[departmentName];
      if (!chapterId) return false;
      
      const chapter = window.RoomLogic.getChapter(chapterId);
      return chapter !== null;
    }

    function getDepartmentChapterId(departmentName) {
      const deptToChapter = {
        '100 (MEDICAL / SURGICAL PATIENT CARE UNIT (M/S PCU))': '100',
        '102 (INTENSIVE CARE PATIENT CARE UNIT (IC PCU))': '102',
        '104 (SPINAL CORD INJURY / DISORDERS CENTER (SCI/D))': '104',
        '106 (SMALL HOUSE (SH) MODEL)': '106',
        '208 (CHAPLAIN SERVICE)': '208',
        '210 (CARDIOLOGY SERVICE)': '210',
        '212 (PULMONARY MEDICINE SERVICE)': '212',
        '214 (CLINICAL SERVICES ADMINISTRATION)': '214',
        '218 (VETERANS ASSISTANCE UNIT)': '218',
        '220 (CREDIT UNION)': '220',
        '222 (DENTAL SERVICE)': '222',
        '226 (ELECTROENCEPHALOGRAPHY (EEG) LABORATORY)': '226',
        '234 (FISCAL SERVICE)': '234',
        '238 (MEDICAL CENTER DIRECTOR\'S SUITE)': '238',
        '244 (LOBBY)': '244',
        '254 (NURSING SERVICE ADMINISTRATION)': '254',
        '274 (QUARTERS, ON-CALL)': '274',
        '279 (POLICE SERVICE)': '279',
        '280 (SERVICE ORGANIZATIONS)': '280',
        '282 (SOCIAL WORK SERVICE)': '282',
        '290 (VOLUNTARY SERVICE)': '290'
      };
      return deptToChapter[departmentName];
    }

    function showAvailableLogicDepartments() {
      if (!window.RoomLogic) {
        alert('Room logic system not loaded!');
        return;
      }
      
      const chapters = window.RoomLogic.getAllChapters();
      
      let html = `
        <div style="margin-bottom: 16px;">
          <h3 style="margin-bottom: 12px;">Departments with Automated Logic</h3>
          <p class="muted" style="margin-bottom: 16px;">These departments have automated room calculation based on your inputs.</p>
        </div>
      `;
      
      chapters.forEach(chapter => {
        html += `
          <div style="background: var(--bg-card); border: 1px solid var(--border); border-radius: 8px; padding: 16px; margin-bottom: 12px; cursor: pointer; transition: all 0.2s;" 
               onmouseover="this.style.borderColor='var(--accent)'" 
               onmouseout="this.style.borderColor='var(--border)'"
               onclick="openDepartmentLogicWorkflowById('${chapter.id}')">
            <div style="display: flex; align-items: center; gap: 12px;">
              <span class="logic-badge enabled">‚ö° LOGIC</span>
              <div style="flex: 1;">
                <h4 style="margin-bottom: 4px;">Chapter ${chapter.id}: ${chapter.name}</h4>
                <p class="muted" style="font-size: 0.85rem;">${chapter.description}</p>
                ${chapter.status ? `<p style="font-size: 0.8rem; margin-top: 6px; color: #856404; background: #fff3cd; padding: 6px 10px; border-radius: 4px; display: inline-block;">${chapter.status}</p>` : ''}
                <p class="muted" style="font-size: 0.75rem; margin-top: 4px;">${chapter.inputCount} inputs required ‚Ä¢ ${chapter.functionalAreaCount} functional areas</p>
              </div>
              <button class="btn-primary" style="padding: 6px 12px; font-size: 0.85rem;">Configure ‚Üí</button>
            </div>
          </div>
        `;
      });
      
      document.getElementById('logic-modal-content').innerHTML = html;
      document.getElementById('logic-modal-title').textContent = 'Add Department with Room Logic';
      document.getElementById('calculate-rooms-btn').style.display = 'none';
      document.getElementById('department-logic-modal').classList.add('active');
      closeImportModal();
    }

    function toggleDepartmentLogic(departmentName, enabled) {
      departmentLogicToggles.set(departmentName, enabled);
      renderImportTree(); // Re-render to update badge
    }

    function openDepartmentLogicWorkflow(departmentName) {
      const chapterId = getDepartmentChapterId(departmentName);
      if (chapterId) {
        openDepartmentLogicWorkflowById(chapterId);
      }
    }

    function openDepartmentLogicWorkflowById(chapterId) {
      if (!window.RoomLogic) {
        alert('Room logic system not loaded!');
        return;
      }
      
      const chapter = window.RoomLogic.getChapter(chapterId);
      if (!chapter) {
        alert(`Chapter ${chapterId} not found!`);
        return;
      }
      
      currentLogicDepartment = chapter;
      currentLogicInputs = {};
      
      // Initialize default values
      chapter.inputs.forEach(input => {
        currentLogicInputs[input.id] = input.defaultValue || (input.min || 0);
      });
      
      let html = `
        <div style="margin-bottom: 20px;">
          <h3 style="margin-bottom: 8px;">Chapter ${chapter.chapter}: ${chapter.name}</h3>
          <p class="muted">${chapter.description}</p>
          ${chapter.status ? `<div style="margin-top: 12px; padding: 12px; background: #fff3cd; border-left: 4px solid #ffc107; border-radius: 4px; font-size: 0.9rem;">${chapter.status}</div>` : ''}
        </div>
        
        <div class="input-modal">
          <h4 style="margin-bottom: 16px; color: var(--accent);">Project Inputs</h4>
      `;
      
      chapter.inputs.forEach(input => {
        html += `
          <div class="input-field">
            <label for="input-${input.id}">${input.label}</label>
            <input type="${input.type}" 
                   id="input-${input.id}" 
                   ${input.min !== undefined ? `min="${input.min}"` : ''}
                   ${input.max !== undefined ? `max="${input.max}"` : ''}
                   value="${currentLogicInputs[input.id]}"
                   onchange="updateLogicInput('${input.id}', this.value)"
                   style="width: 100%;">
            ${input.helpText ? `<div class="help-text">${input.helpText}</div>` : ''}
          </div>
        `;
      });
      
      html += `
        </div>
        
        <div id="preview-results" style="margin-top: 20px; display: none;">
          <div class="calculation-result">
            <h4>üìä Calculation Preview</h4>
            <div id="preview-content" class="calculation-summary"></div>
          </div>
        </div>
      `;
      
      document.getElementById('logic-modal-content').innerHTML = html;
      document.getElementById('logic-modal-title').textContent = `Add ${chapter.name}`;
      document.getElementById('calculate-rooms-btn').style.display = 'block';
      document.getElementById('department-logic-modal').classList.add('active');
      closeImportModal();
      
      // Show initial preview
      updateCalculationPreview();
    }

    function updateLogicInput(inputId, value) {
      currentLogicInputs[inputId] = parseFloat(value) || 0;
      updateCalculationPreview();
    }

    function updateCalculationPreview() {
      if (!currentLogicDepartment) return;
      
      // Validate inputs against min/max
      let validationError = null;
      for (const input of currentLogicDepartment.inputs) {
        const value = currentLogicInputs[input.id];
        if (input.min !== undefined && value < input.min) {
          validationError = `${input.label}: Value must be at least ${input.min} (you entered ${value})`;
          break;
        }
        if (input.max !== undefined && value > input.max) {
          validationError = `${input.label}: Value must be at most ${input.max} (you entered ${value})`;
          break;
        }
      }
      
      if (validationError) {
        document.getElementById('preview-content').innerHTML = 
          `<p style="color: #ff6b6b;"><strong>‚ö†Ô∏è Validation Error:</strong> ${validationError}</p>`;
        document.getElementById('preview-results').style.display = 'block';
        document.getElementById('calculate-rooms-btn').disabled = true;
        return;
      }
      
      try {
        const results = window.RoomLogic.evaluateChapter(currentLogicDepartment, currentLogicInputs);
        
        let html = '';
        
        if (results.totalRooms === 0) {
          html = `<p style="color: #ff6b6b;"><strong>‚ö†Ô∏è No rooms calculated:</strong> Your input values may be outside the valid range or don't match any calculation rules.</p>`;
          document.getElementById('calculate-rooms-btn').disabled = true;
        } else {
          html = `
            <p><strong>Total Rooms:</strong> ${results.totalRooms}</p>
            <p><strong>Total NSF:</strong> ${results.totalNSF.toLocaleString()} sq ft</p>
            <p><strong>Functional Areas:</strong> ${results.functionalAreas.length}</p>
          `;
          document.getElementById('calculate-rooms-btn').disabled = false;
        }
        
        if (results.errors.length > 0) {
          html += `<p style="color: #ff6b6b; margin-top: 8px;"><strong>‚ö†Ô∏è Errors:</strong> ${results.errors[0].message}</p>`;
          document.getElementById('calculate-rooms-btn').disabled = true;
        }
        
        document.getElementById('preview-content').innerHTML = html;
        document.getElementById('preview-results').style.display = 'block';
      } catch (error) {
        console.error('Preview error:', error);
        document.getElementById('preview-content').innerHTML = 
          `<p style="color: #ff6b6b;"><strong>‚ö†Ô∏è Calculation Error:</strong> ${error.message}</p>`;
        document.getElementById('preview-results').style.display = 'block';
        document.getElementById('calculate-rooms-btn').disabled = true;
      }
    }

    function calculateAndAddDepartment() {
      if (!currentLogicDepartment) return;
      
      try {
        const results = window.RoomLogic.evaluateChapter(currentLogicDepartment, currentLogicInputs);
        
        if (results.errors.length > 0) {
          alert(`Calculation errors:\n${results.errors.map(e => e.message).join('\n')}`);
          return;
        }
        
        // Helper function to get equipment for a room code
        function getEquipmentForRoomCode(roomCode) {
          const equipment = [];
          const mappings = window.ROOM_EQUIPMENT_MAPPINGS || ROOM_EQUIPMENT_MAPPINGS || [];
          const equipList = window.EQUIPMENT_LIST || EQUIPMENT_LIST || [];
          
          const equipForRoom = mappings.filter(m => m.roomCode === roomCode);
          equipForRoom.forEach(eq => {
            const equipDetail = equipList.find(e => e.jsn === eq.jsn);
            if (equipDetail) {
              equipment.push({
                jsn: eq.jsn,
                name: equipDetail.name,
                quantity: eq.qty || eq.quantity || 1,
                acqIns: equipDetail.acqIns,
                description: equipDetail.description
              });
            }
          });
          
          return equipment;
        }
        
        // Convert results to department structure
        const project = getCurrentProject();
        const newDept = {
          id: generateId(),
          name: currentLogicDepartment.name,
          chapterId: currentLogicDepartment.chapter,
          logicInputs: {...currentLogicInputs},
          functionalAreas: results.functionalAreas.map(fa => ({
            id: generateId(),
            name: fa.name,
            description: fa.description,
            rooms: fa.rooms.filter(r => r.type !== 'calculation').map(room => ({
              id: generateId(),
              code: room.code,
              name: room.name,
              quantity: room.quantity,
              nsf: room.nsfPerRoom,
              totalNSF: room.totalNSF,
              notes: room.notes || '',
              equipment: getEquipmentForRoomCode(room.code),
              logicGenerated: true
            }))
          }))
        };
        
        project.departments.push(newDept);
        saveProjects();
        renderAll();
        closeDepartmentLogicModal();
        
        alert(`‚úÖ Added ${currentLogicDepartment.name}\n\n${results.totalRooms} rooms ‚Ä¢ ${results.totalNSF.toLocaleString()} NSF`);
      } catch (error) {
        console.error('Calculation error:', error);
        alert('Error calculating rooms: ' + error.message);
      }
    }

    function closeDepartmentLogicModal() {
      document.getElementById('department-logic-modal').classList.remove('active');
      currentLogicDepartment = null;
      currentLogicInputs = {};
    }

    function filterImportTree() {
      const searchTerm = document.getElementById('import-search').value.toLowerCase();
      
      if (searchTerm) {
        // Auto-expand all nodes when searching to show matches
        const deptMap = getDeptMap();
        deptMap.forEach((faMap, dept) => {
          const deptMatches = dept.toLowerCase().includes(searchTerm);
          
          faMap.forEach((rooms, fa) => {
            const faMatches = fa.toLowerCase().includes(searchTerm);
            
            rooms.forEach(roomCode => {
              const enrichedMappings = window.ROOM_EQUIPMENT_MAPPINGS || ROOM_EQUIPMENT_MAPPINGS;
              const roomMapping = enrichedMappings.find(
                m => m.department === dept && m.functionalArea === fa && m.roomCode === roomCode
              );
              const roomName = roomMapping ? roomMapping.roomName : roomCode;
              const roomMatches = roomCode.toLowerCase().includes(searchTerm) || 
                                  (roomName && roomName.toLowerCase().includes(searchTerm));
              
              // Expand parent nodes if any child matches
              if (deptMatches || faMatches || roomMatches) {
                expandedImportNodes.add(dept);
                expandedImportNodes.add(`${dept}::${fa}`);
              }
            });
          });
        });
      }
      
      renderImportTree();
    }

    function toggleImportNode(nodeId) {
      if (expandedImportNodes.has(nodeId)) {
        expandedImportNodes.delete(nodeId);
      } else {
        expandedImportNodes.add(nodeId);
      }
      renderImportTree();
    }

    function renderImportTree() {
      const container = document.getElementById('import-tree-container');
      let html = '';

      // Use cached department map
      const deptMap = getDeptMap();
      
      // Get search term
      const searchTerm = document.getElementById('import-search')?.value.toLowerCase() || '';

      // Helper function to check if department should be shown
      function shouldShowDept(dept, faMap) {
        if (!searchTerm) return true;
        if (dept.toLowerCase().includes(searchTerm)) return true;
        
        // Check if any FA or room matches
        for (const [fa, rooms] of faMap.entries()) {
          if (fa.toLowerCase().includes(searchTerm)) return true;
          
          for (const roomCode of rooms) {
            const enrichedMappings = window.ROOM_EQUIPMENT_MAPPINGS || ROOM_EQUIPMENT_MAPPINGS;
            const roomMapping = enrichedMappings.find(
              m => m.department === dept && m.functionalArea === fa && m.roomCode === roomCode
            );
            const roomName = roomMapping ? roomMapping.roomName : roomCode;
            if (roomCode.toLowerCase().includes(searchTerm) || 
                (roomName && roomName.toLowerCase().includes(searchTerm))) {
              return true;
            }
          }
        }
        return false;
      }
      
      // Helper function to check if FA should be shown
      function shouldShowFA(dept, fa, rooms) {
        if (!searchTerm) return true;
        if (fa.toLowerCase().includes(searchTerm)) return true;
        
        for (const roomCode of rooms) {
          const enrichedMappings = window.ROOM_EQUIPMENT_MAPPINGS || ROOM_EQUIPMENT_MAPPINGS;
          const roomMapping = enrichedMappings.find(
            m => m.department === dept && m.functionalArea === fa && m.roomCode === roomCode
          );
          const roomName = roomMapping ? roomMapping.roomName : roomCode;
          if (roomCode.toLowerCase().includes(searchTerm) || 
              (roomName && roomName.toLowerCase().includes(searchTerm))) {
            return true;
          }
        }
        return false;
      }
      
      // Helper function to check if room should be shown
      function shouldShowRoom(dept, fa, roomCode) {
        if (!searchTerm) return true;
        const enrichedMappings = window.ROOM_EQUIPMENT_MAPPINGS || ROOM_EQUIPMENT_MAPPINGS;
        const roomMapping = enrichedMappings.find(
          m => m.department === dept && m.functionalArea === fa && m.roomCode === roomCode
        );
        const roomName = roomMapping ? roomMapping.roomName : roomCode;
        return roomCode.toLowerCase().includes(searchTerm) || 
               (roomName && roomName.toLowerCase().includes(searchTerm));
      }

      // Render unified tree with checkboxes at all levels
      Array.from(deptMap.keys()).sort().forEach(dept => {
        const faMap = deptMap.get(dept);
        
        // Skip if doesn't match search
        if (!shouldShowDept(dept, faMap)) return;
        
        const faCount = faMap.size;
        let totalRooms = 0;
        deptMap.get(dept).forEach(rooms => totalRooms += rooms.size);
        const deptId = `dept-${dept.replace(/[^a-zA-Z0-9]/g, '_')}`;
        const isDeptExpanded = expandedImportNodes.has(deptId);
        
        // Calculate department checkbox state
        const deptState = getCheckboxState(dept, deptMap);
        
        // Check if department has room logic available
        const hasLogic = checkDepartmentHasLogic(dept);
        const logicEnabled = departmentLogicToggles.get(dept) || false;
        const logicBadge = hasLogic 
          ? `<span class="logic-badge ${logicEnabled ? 'enabled' : 'disabled'}">${logicEnabled ? '‚ö° LOGIC' : 'MANUAL'}</span>` 
          : '<span class="logic-badge disabled">MANUAL</span>';
        
        html += `
          <div style="margin-bottom: 8px;">
            <div class="import-tree-item ${hasLogic ? 'has-logic' : 'no-logic'}">
              <span onclick="toggleImportNode('${deptId}')" style="cursor: pointer; margin-right: 4px;">${isDeptExpanded ? '‚ñº' : '‚ñ∂'}</span>
              <input type="checkbox" id="import-${dept}" value="${dept}" 
                ${deptState.checked ? 'checked' : ''}
                ${deptState.indeterminate ? 'data-indeterminate="true"' : ''}
                onchange="toggleImportItem('${dept}', this.checked)">
              <label for="import-${dept}" style="font-weight: 600;">${dept}</label>
              ${logicBadge}
              ${hasLogic ? `<label class="logic-toggle-switch" onclick="event.stopPropagation();">
                <input type="checkbox" ${logicEnabled ? 'checked' : ''} 
                  onchange="toggleDepartmentLogic('${dept.replace(/'/g, "\\'")}', this.checked)">
                <span class="logic-toggle-slider"></span>
              </label>` : ''}
              <span style="font-size: 0.75rem; color: var(--muted); margin-left: 8px;">(${faCount} FAs, ${totalRooms} rooms)</span>
            </div>
            ${isDeptExpanded ? `
              <div style="margin-left: 24px; margin-top: 4px;">
                ${Array.from(deptMap.get(dept).keys()).sort().filter(fa => {
                  return shouldShowFA(dept, fa, deptMap.get(dept).get(fa));
                }).map(fa => {
                  const roomCount = deptMap.get(dept).get(fa).size;
                  const faItemKey = `${dept}::${fa}`;
                  const faId = `fa-${dept.replace(/[^a-zA-Z0-9]/g, '_')}-${fa.replace(/[^a-zA-Z0-9]/g, '_')}`;
                  const isFaExpanded = expandedImportNodes.has(faId);
                  
                  // Calculate FA checkbox state
                  const faState = getFACheckboxState(dept, fa, deptMap);
                  
                  return `
                    <div style="margin-bottom: 4px;">
                      <div class="import-tree-item">
                        <span onclick="toggleImportNode('${faId}')" style="cursor: pointer; margin-right: 4px;">${isFaExpanded ? '‚ñº' : '‚ñ∂'}</span>
                        <input type="checkbox" id="import-${faItemKey.replace(/[^a-zA-Z0-9]/g, '_')}" 
                          value="${faItemKey}" 
                          ${faState.checked ? 'checked' : ''}
                          ${faState.indeterminate ? 'data-indeterminate="true"' : ''}
                          onchange="toggleImportItem('${faItemKey}', this.checked)">
                        <label for="import-${faItemKey.replace(/[^a-zA-Z0-9]/g, '_')}">${fa}</label>
                        <span style="font-size: 0.75rem; color: var(--muted); margin-left: 8px;">(${roomCount} rooms)</span>
                      </div>
                      ${isFaExpanded ? `
                        <div style="margin-left: 24px; margin-top: 2px;">
                          ${Array.from(deptMap.get(dept).get(fa)).sort().filter(roomCode => {
                            return shouldShowRoom(dept, fa, roomCode);
                          }).map(roomCode => {
                            const mappings = window.ROOM_EQUIPMENT_MAPPINGS || [];
                            const roomMapping = mappings.find(m => 
                              m.department === dept && 
                              m.functionalArea === fa && 
                              m.roomCode === roomCode
                            );
                            const roomName = roomMapping ? roomMapping.roomName : roomCode;
                            const roomItemKey = `${dept}::${fa}::${roomCode}`;
                            
                            return `
                              <div class="import-tree-item" style="padding-left: 16px;">
                                <input type="checkbox" id="import-${roomItemKey.replace(/[^a-zA-Z0-9]/g, '_')}" 
                                  value="${roomItemKey}" 
                                  ${selectedImportItems.has(roomItemKey) ? 'checked' : ''}
                                  onchange="toggleImportItem('${roomItemKey}', this.checked)">
                                <label for="import-${roomItemKey.replace(/[^a-zA-Z0-9]/g, '_')}" style="font-size: 0.85rem;">${roomCode} - ${roomName}</label>
                              </div>
                            `;
                          }).join('')}
                        </div>
                      ` : ''}
                    </div>
                  `;
                }).join('')}
              </div>
            ` : ''}
          </div>
        `;
      });

      container.innerHTML = html || `<p class="muted" style="text-align: center; padding: 40px;">${searchTerm ? 'No matching items found' : 'No items available'}</p>`;
      
      // Set indeterminate states after rendering
      document.querySelectorAll('input[data-indeterminate="true"]').forEach(checkbox => {
        checkbox.indeterminate = true;
      });
    }
    
    function getCheckboxState(dept, deptMap) {
      // Check if department itself is selected
      if (selectedImportItems.has(dept)) {
        return { checked: true, indeterminate: false };
      }
      
      // Count selected FAs and rooms under this department
      let totalFAs = 0;
      let selectedFAs = 0;
      let hasSelectedRooms = false;
      
      deptMap.get(dept).forEach((rooms, fa) => {
        totalFAs++;
        const faKey = `${dept}::${fa}`;
        if (selectedImportItems.has(faKey)) {
          selectedFAs++;
        } else {
          // Check if any individual rooms are selected
          rooms.forEach(roomCode => {
            if (selectedImportItems.has(`${dept}::${fa}::${roomCode}`)) {
              hasSelectedRooms = true;
            }
          });
        }
      });
      
      if (selectedFAs === totalFAs) {
        return { checked: true, indeterminate: false };
      } else if (selectedFAs > 0 || hasSelectedRooms) {
        return { checked: false, indeterminate: true };
      }
      return { checked: false, indeterminate: false };
    }
    
    function getFACheckboxState(dept, fa, deptMap) {
      const faKey = `${dept}::${fa}`;
      
      // Check if FA itself is selected
      if (selectedImportItems.has(faKey)) {
        return { checked: true, indeterminate: false };
      }
      
      // Count selected rooms under this FA
      const rooms = deptMap.get(dept).get(fa);
      let selectedRooms = 0;
      
      rooms.forEach(roomCode => {
        if (selectedImportItems.has(`${dept}::${fa}::${roomCode}`)) {
          selectedRooms++;
        }
      });
      
      if (selectedRooms === rooms.size) {
        return { checked: true, indeterminate: false };
      } else if (selectedRooms > 0) {
        return { checked: false, indeterminate: true };
      }
      return { checked: false, indeterminate: false };
    }

    function toggleImportNode(nodeId) {
      if (expandedImportNodes.has(nodeId)) {
        expandedImportNodes.delete(nodeId);
      } else {
        expandedImportNodes.add(nodeId);
      }
      renderImportTree();
    }

    function toggleImportItem(itemKey, checked) {
      const parts = itemKey.split('::');
      const deptMap = getDeptMap();
      
      if (parts.length === 1) {
        // Department level
        const dept = itemKey;
        if (checked) {
          selectedImportItems.add(dept);
          // Add all FAs and rooms under this department
          deptMap.get(dept).forEach((rooms, fa) => {
            selectedImportItems.add(`${dept}::${fa}`);
            rooms.forEach(roomCode => {
              selectedImportItems.add(`${dept}::${fa}::${roomCode}`);
            });
          });
        } else {
          selectedImportItems.delete(dept);
          // Remove all FAs and rooms under this department
          deptMap.get(dept).forEach((rooms, fa) => {
            selectedImportItems.delete(`${dept}::${fa}`);
            rooms.forEach(roomCode => {
              selectedImportItems.delete(`${dept}::${fa}::${roomCode}`);
            });
          });
        }
      } else if (parts.length === 2) {
        // Functional Area level
        const [dept, fa] = parts;
        if (checked) {
          selectedImportItems.add(itemKey);
          // Add all rooms under this FA
          deptMap.get(dept).get(fa).forEach(roomCode => {
            selectedImportItems.add(`${dept}::${fa}::${roomCode}`);
          });
          // Check if all FAs in this dept are now selected
          let allFAsSelected = true;
          deptMap.get(dept).forEach((rooms, faName) => {
            if (!selectedImportItems.has(`${dept}::${faName}`)) {
              allFAsSelected = false;
            }
          });
          if (allFAsSelected) {
            selectedImportItems.add(dept);
          }
        } else {
          selectedImportItems.delete(itemKey);
          selectedImportItems.delete(dept); // Uncheck parent dept
          // Remove all rooms under this FA
          deptMap.get(dept).get(fa).forEach(roomCode => {
            selectedImportItems.delete(`${dept}::${fa}::${roomCode}`);
          });
        }
      } else if (parts.length === 3) {
        // Room level
        const [dept, fa, roomCode] = parts;
        if (checked) {
          selectedImportItems.add(itemKey);
          // Check if all rooms in this FA are now selected
          const rooms = deptMap.get(dept).get(fa);
          let allRoomsSelected = true;
          rooms.forEach(rc => {
            if (!selectedImportItems.has(`${dept}::${fa}::${rc}`)) {
              allRoomsSelected = false;
            }
          });
          if (allRoomsSelected) {
            selectedImportItems.add(`${dept}::${fa}`);
            // Check if all FAs in dept are now selected
            let allFAsSelected = true;
            deptMap.get(dept).forEach((rooms, faName) => {
              if (!selectedImportItems.has(`${dept}::${faName}`)) {
                allFAsSelected = false;
              }
            });
            if (allFAsSelected) {
              selectedImportItems.add(dept);
            }
          }
        } else {
          selectedImportItems.delete(itemKey);
          selectedImportItems.delete(`${dept}::${fa}`); // Uncheck parent FA
          selectedImportItems.delete(dept); // Uncheck parent dept
        }
      }
      
      renderImportTree();
    }

    function confirmImport() {
      if (selectedImportItems.size === 0) {
        alert('Please select at least one item to import');
        return;
      }

      // Collect departments with logic enabled from selected items
      const logicDepartments = [];
      const manualDepartments = [];
      
      selectedImportItems.forEach(itemKey => {
        const parts = itemKey.split('::');
        if (parts.length === 1) {
          const deptName = itemKey;
          if (departmentLogicToggles.get(deptName)) {
            logicDepartments.push(deptName);
          } else {
            manualDepartments.push({ type: 'department', data: itemKey });
          }
        } else if (!departmentLogicToggles.get(parts[0])) {
          // Only add if parent department doesn't have logic enabled
          if (parts.length === 2) {
            manualDepartments.push({ type: 'fa', data: itemKey });
          } else if (parts.length === 3) {
            manualDepartments.push({ type: 'room', data: itemKey });
          }
        }
      });

      // If there are logic departments, collect all inputs first
      if (logicDepartments.length > 0) {
        showCombinedLogicInputDialog(logicDepartments, manualDepartments);
      } else {
        // No logic departments, proceed with normal import
        executeImport([], manualDepartments);
      }
    }

    function showCombinedLogicInputDialog(logicDepartments, manualDepartments) {
      if (!window.RoomLogic) {
        alert('Room logic system not loaded!');
        return;
      }

      // Collect all inputs from all logic departments
      const allInputs = [];
      const chapterMap = new Map();
      
      logicDepartments.forEach(deptName => {
        const chapterId = getDepartmentChapterId(deptName);
        if (chapterId) {
          const chapter = window.RoomLogic.getChapter(chapterId);
          if (chapter) {
            chapterMap.set(deptName, chapter);
            chapter.inputs.forEach(input => {
              allInputs.push({
                deptName,
                chapterId,
                chapterName: chapter.name,
                input
              });
            });
          }
        }
      });

      if (allInputs.length === 0) {
        alert('No logic inputs found for selected departments');
        return;
      }

      // Build combined input dialog
      let html = `
        <div style="margin-bottom: 20px;">
          <h3 style="margin-bottom: 8px;">Room Logic Inputs</h3>
          <p class="muted">Provide inputs for ${logicDepartments.length} department(s) with logic enabled:</p>
        </div>
      `;

      // Group inputs by department
      logicDepartments.forEach(deptName => {
        const chapter = chapterMap.get(deptName);
        if (!chapter) return;

        html += `
          <div class="input-modal" style="margin-bottom: 20px; padding: 16px; background: rgba(255,255,255,0.03); border-radius: 8px;">
            <h4 style="margin-bottom: 12px; color: var(--accent);">‚ö° ${chapter.name}</h4>
        `;

        chapter.inputs.forEach(input => {
          const inputId = `logic-input-${deptName}-${input.id}`.replace(/[^a-zA-Z0-9-]/g, '_');
          const defaultValue = input.defaultValue || input.min || 0;
          
          html += `
            <div class="input-field" style="margin-bottom: 12px;">
              <label for="${inputId}">${input.label}</label>
              <input type="${input.type}" 
                     id="${inputId}" 
                     ${input.min !== undefined ? `min="${input.min}"` : ''}
                     ${input.max !== undefined ? `max="${input.max}"` : ''}
                     value="${defaultValue}"
                     data-dept="${deptName}"
                     data-input-id="${input.id}"
                     style="width: 100%;">
              ${input.helpText ? `<div class="help-text">${input.helpText}</div>` : ''}
            </div>
          `;
        });

        html += `</div>`;
      });

      document.getElementById('logic-modal-content').innerHTML = html;
      document.getElementById('logic-modal-title').textContent = 'Configure Logic Departments';
      document.getElementById('calculate-rooms-btn').style.display = 'block';
      document.getElementById('calculate-rooms-btn').textContent = 'Calculate & Add to Project';
      document.getElementById('calculate-rooms-btn').onclick = () => {
        executeCombinedLogicImport(chapterMap, manualDepartments);
      };
      document.getElementById('department-logic-modal').classList.add('active');
    }

    function executeCombinedLogicImport(chapterMap, manualDepartments) {
      const project = getCurrentProject();
      const mergeMode = document.getElementById('merge-on-import').checked;
      const logicResults = [];

      // Collect inputs and calculate for each logic department
      chapterMap.forEach((chapter, deptName) => {
        const inputs = {};
        
        // Gather input values for this department
        chapter.inputs.forEach(input => {
          const inputId = `logic-input-${deptName}-${input.id}`.replace(/[^a-zA-Z0-9-]/g, '_');
          const element = document.getElementById(inputId);
          if (element) {
            inputs[input.id] = parseFloat(element.value) || 0;
          }
        });

        // Validate inputs
        for (const input of chapter.inputs) {
          const value = inputs[input.id];
          if (input.min !== undefined && value < input.min) {
            alert(`${chapter.name} - ${input.label}: Value must be at least ${input.min} (you entered ${value})`);
            return;
          }
          if (input.max !== undefined && value > input.max) {
            alert(`${chapter.name} - ${input.label}: Value must be at most ${input.max} (you entered ${value})`);
            return;
          }
        }

        try {
          const results = window.RoomLogic.evaluateChapter(chapter, inputs);
          
          if (results.errors.length > 0) {
            alert(`${chapter.name} calculation errors:\n${results.errors.map(e => e.message).join('\n')}`);
            return;
          }

          logicResults.push({
            deptName,
            chapter,
            inputs,
            results
          });
        } catch (error) {
          console.error(`Error calculating ${deptName}:`, error);
          alert(`Error calculating ${chapter.name}: ${error.message}`);
          return;
        }
      });

      // Add all logic departments to project
      logicResults.forEach(({ deptName, chapter, inputs, results }) => {
        const newDept = {
          id: generateId(),
          name: chapter.name,
          chapterId: chapter.chapter,
          logicInputs: {...inputs},
          functionalAreas: results.functionalAreas.map(fa => ({
            id: generateId(),
            name: fa.name,
            description: fa.description,
            rooms: fa.rooms.filter(r => r.type !== 'calculation').map(room => ({
              id: generateId(),
              code: room.code,
              name: room.name,
              quantity: room.quantity,
              nsf: room.nsfPerRoom,
              totalNSF: room.totalNSF,
              notes: room.notes || '',
              equipment: [],
              logicGenerated: true
            }))
          }))
        };
        project.departments.push(newDept);
      });

      // Execute manual imports
      executeImport([], manualDepartments);

      saveProjects();
      closeDepartmentLogicModal();
      closeImportModal();
      renderAll();

      const totalLogicRooms = logicResults.reduce((sum, r) => sum + r.results.totalRooms, 0);
      const totalLogicNSF = logicResults.reduce((sum, r) => sum + r.results.totalNSF, 0);
      
      alert(`‚úÖ Import Complete\n\nLogic Departments: ${logicResults.length}\nRooms: ${totalLogicRooms}\nNSF: ${totalLogicNSF.toLocaleString()}\n\nManual Items: ${manualDepartments.length}`);
    }

    function executeImport(logicDepartments, manualDepartments) {
      const mergeMode = document.getElementById('merge-on-import').checked;
      const project = getCurrentProject();

      manualDepartments.forEach(item => {
        if (item.type === 'department') {
          importDepartment(project, item.data, mergeMode);
        } else if (item.type === 'fa') {
          const [dept, fa] = item.data.split('::');
          importFunctionalArea(project, dept, fa, mergeMode);
        } else if (item.type === 'room') {
          const [dept, fa, roomCode] = item.data.split('::');
          importRoom(project, dept, fa, roomCode, mergeMode);
        }
      });

      saveProjects();
      closeImportModal();
      renderAll();
    }

    function importDepartment(project, deptName, mergeMode) {
      let dept = project.departments.find(d => d.name === deptName);
      
      if (!dept || !mergeMode) {
        dept = {
          id: generateId(),
          name: deptName,
          functionalAreas: []
        };
        project.departments.push(dept);
      }

      // Use ALL_ROOM_INSTANCES to find functional areas and rooms for this department
      const faMap = new Map();
      const allInstances = window.ALL_ROOM_INSTANCES || [];
      allInstances.forEach(instance => {
        if (instance.department === deptName) {
          if (!faMap.has(instance.functionalArea)) {
            faMap.set(instance.functionalArea, new Set());
          }
          faMap.get(instance.functionalArea).add(instance.roomCode);
        }
      });

      faMap.forEach((rooms, faName) => {
        let fa = dept.functionalAreas.find(f => f.name === faName);
        if (!fa || !mergeMode) {
          fa = {
            id: generateId(),
            name: faName,
            rooms: []
          };
          dept.functionalAreas.push(fa);
        }

        // Import all rooms in this functional area
        rooms.forEach(roomCode => {
          importRoomToFA(fa, deptName, faName, roomCode, mergeMode);
        });
      });
    }

    function importFunctionalArea(project, deptName, faName, mergeMode) {
      let dept = project.departments.find(d => d.name === deptName);
      
      if (!dept) {
        dept = {
          id: generateId(),
          name: deptName,
          functionalAreas: []
        };
        project.departments.push(dept);
      }

      let fa = dept.functionalAreas.find(f => f.name === faName);
      if (!fa || !mergeMode) {
        fa = {
          id: generateId(),
          name: faName,
          rooms: []
        };
        dept.functionalAreas.push(fa);
      }

      // Use ALL_ROOM_INSTANCES to find rooms for this dept/FA combination
      const rooms = new Set();
      const allInstances = window.ALL_ROOM_INSTANCES || [];
      allInstances.forEach(instance => {
        if (instance.department === deptName && instance.functionalArea === faName) {
          rooms.add(instance.roomCode);
        }
      });

      rooms.forEach(roomCode => {
        importRoomToFA(fa, deptName, faName, roomCode, mergeMode);
      });
    }

    function importRoom(project, deptName, faName, roomCode, mergeMode) {
      let dept = project.departments.find(d => d.name === deptName);
      
      if (!dept) {
        dept = {
          id: generateId(),
          name: deptName,
          functionalAreas: []
        };
        project.departments.push(dept);
      }

      let fa = dept.functionalAreas.find(f => f.name === faName);
      if (!fa) {
        fa = {
          id: generateId(),
          name: faName,
          rooms: []
        };
        dept.functionalAreas.push(fa);
      }

      importRoomToFA(fa, deptName, faName, roomCode, mergeMode);
    }

    function importRoomToFA(fa, deptName, faName, roomCode, mergeMode) {
      let room = fa.rooms.find(r => r.code === roomCode);
      
      if (!room || !mergeMode) {
        // Look up room name and NSF from ROOM_SIZES
        const roomTemplate = ROOM_SIZES.find(r => r['Room Code'] === roomCode);
        const nsf = roomTemplate ? roomTemplate['NSF'] : 100; // Default 100 NSF if not found
        const roomName = roomTemplate ? roomTemplate['Room Name'] : roomCode;

        room = {
          id: generateId(),
          code: roomCode,
          name: roomName,
          nsf: nsf,
          equipment: []
        };
        fa.rooms.push(room);
      }

      // Import equipment for this room using ROOM_EQUIPMENT lookup (already deduplicated)
      const baseEquipment = window.ROOM_EQUIPMENT ? window.ROOM_EQUIPMENT[roomCode] : [];
      if (baseEquipment && baseEquipment.length > 0) {
        baseEquipment.forEach(eq => {
          const equipExists = room.equipment.some(e => e.jsn === eq.JSN);
          if (!equipExists || !mergeMode) {
            room.equipment.push({
              id: generateId(),
              jsn: eq.JSN,
              name: eq['Equipment Name'],
              quantity: eq['Qty per Room'] || 1,
              acqIns: eq['Acq/Ins'] || '',
              description: eq.Description || ''
            });
          }
        });
      }
    }

    // -----------------------------
    // REPORT GENERATION FUNCTIONS
    // -----------------------------

    function openReportModal() {
      document.getElementById('report-modal').classList.add('active');
    }

    function closeReportModal() {
      document.getElementById('report-modal').classList.remove('active');
    }

    function generateReportForProject(projectId) {
      // Temporarily set this project as the context for report generation
      const originalProject = currentProjectId;
      currentProjectId = projectId;
      openReportModal();
      // Reset after modal opens
      setTimeout(() => {
        currentProjectId = originalProject;
      }, 100);
    }

    function generatePDFReport() {
      const reportType = document.querySelector('input[name="report-type"]:checked').value;
      const includeSummary = document.getElementById('include-summary').checked;
      const project = getCurrentProject();
      
      if (!project) {
        alert('No project selected');
        return;
      }

      // Initialize jsPDF
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      
      let yPos = 20;
      const lineHeight = 7;
      const pageHeight = 280;
      const marginLeft = 15;
      const marginRight = 195;

      // Helper function to check if we need a new page
      function checkPageBreak(spaceNeeded = 20) {
        if (yPos + spaceNeeded > pageHeight) {
          doc.addPage();
          yPos = 20;
          return true;
        }
        return false;
      }

      // Helper function to add wrapped text
      function addText(text, x, y, maxWidth, options = {}) {
        const lines = doc.splitTextToSize(text, maxWidth);
        lines.forEach((line, i) => {
          if (i > 0) {
            checkPageBreak();
          }
          doc.text(line, x, y + (i * lineHeight));
        });
        return lines.length * lineHeight;
      }

      // Title Page
      doc.setFontSize(24);
      doc.setFont(undefined, 'bold');
      doc.text('Hospital Programming Report', marginLeft, yPos);
      yPos += 15;
      
      doc.setFontSize(16);
      doc.text(project.name, marginLeft, yPos);
      yPos += 10;
      
      doc.setFontSize(10);
      doc.setFont(undefined, 'normal');
      doc.text(`Generated: ${new Date().toLocaleString()}`, marginLeft, yPos);
      yPos += 10;
      doc.text(`Report Type: ${reportType === 'equipment' ? 'Equipment Focus' : 'Room Attributes Focus'}`, marginLeft, yPos);
      yPos += 15;

      // Summary Page (if selected)
      if (includeSummary) {
        const totalDepts = project.departments ? project.departments.length : 0;
        let totalFAs = 0;
        let totalRooms = 0;
        let totalEquip = 0;
        const totalNSF = calculateProjectNSF(project);

        if (project.departments) {
          project.departments.forEach(dept => {
            if (dept.functionalAreas) {
              totalFAs += dept.functionalAreas.length;
              dept.functionalAreas.forEach(fa => {
                if (fa.rooms) {
                  totalRooms += fa.rooms.length;
                  fa.rooms.forEach(room => {
                    if (room.equipment) {
                      totalEquip += room.equipment.length;
                    }
                  });
                }
              });
            }
          });
        }

        doc.setFontSize(14);
        doc.setFont(undefined, 'bold');
        doc.text('Project Summary', marginLeft, yPos);
        yPos += 10;

        doc.setFontSize(10);
        doc.setFont(undefined, 'normal');
        doc.text(`Departments: ${totalDepts}`, marginLeft, yPos);
        yPos += lineHeight;
        doc.text(`Functional Areas: ${totalFAs}`, marginLeft, yPos);
        yPos += lineHeight;
        doc.text(`Rooms: ${totalRooms}`, marginLeft, yPos);
        yPos += lineHeight;
        doc.text(`Equipment Items: ${totalEquip}`, marginLeft, yPos);
        yPos += lineHeight;
        doc.text(`Total NSF: ${totalNSF.toLocaleString()} SF`, marginLeft, yPos);
        yPos += 15;
      }

      // Iterate through departments, functional areas, and rooms
      if (project.departments) {
        project.departments.forEach((dept, deptIdx) => {
          checkPageBreak(30);
          
          // Department Header
          doc.setFontSize(14);
          doc.setFont(undefined, 'bold');
          doc.text(`Department: ${dept.name}`, marginLeft, yPos);
          yPos += 10;

          if (dept.functionalAreas) {
            dept.functionalAreas.forEach((fa, faIdx) => {
              checkPageBreak(25);
              
              // Functional Area Header
              doc.setFontSize(12);
              doc.setFont(undefined, 'bold');
              doc.text(`  Functional Area: ${fa.name}`, marginLeft, yPos);
              yPos += 8;

              if (fa.rooms) {
                fa.rooms.forEach((room, roomIdx) => {
                  checkPageBreak(40);
                  
                  // Room Header
                  doc.setFontSize(10);
                  doc.setFont(undefined, 'bold');
                  doc.text(`    ${room.code} - ${room.name}`, marginLeft, yPos);
                  yPos += lineHeight;
                  
                  doc.setFont(undefined, 'normal');
                  doc.text(`    NSF: ${room.nsf || 0} SF`, marginLeft, yPos);
                  yPos += lineHeight;

                  if (reportType === 'equipment') {
                    // Equipment Focus
                    if (room.equipment && room.equipment.length > 0) {
                      doc.setFont(undefined, 'italic');
                      doc.text(`    Equipment (${room.equipment.length} items):`, marginLeft, yPos);
                      yPos += lineHeight;
                      
                      doc.setFont(undefined, 'normal');
                      room.equipment.forEach(equip => {
                        checkPageBreak();
                        doc.setFontSize(9);
                        const equipText = `      ‚Ä¢ ${equip.jsn} - ${equip.name} (Qty: ${equip.quantity})`;
                        yPos += addText(equipText, marginLeft, yPos, marginRight - marginLeft);
                        
                        if (equip.description) {
                          doc.setTextColor(100);
                          const descText = `        ${equip.description}`;
                          yPos += addText(descText, marginLeft, yPos, marginRight - marginLeft);
                          doc.setTextColor(0);
                        }
                      });
                      doc.setFontSize(10);
                    } else {
                      doc.setFontSize(9);
                      doc.setTextColor(150);
                      doc.text('      No equipment specified', marginLeft, yPos);
                      doc.setTextColor(0);
                      doc.setFontSize(10);
                      yPos += lineHeight;
                    }
                  } else {
                    // Room Attributes Focus
                    const roomData = ROOM_SIZES.find(r => r.roomCode === room.code);
                    if (roomData) {
                      doc.setFontSize(9);
                      
                      // HVAC & Environmental
                      if (roomData.airChangesPerHour || roomData.indoorTemperatureF) {
                        checkPageBreak(15);
                        doc.setFont(undefined, 'italic');
                        doc.text('    HVAC & Environmental:', marginLeft, yPos);
                        yPos += lineHeight;
                        doc.setFont(undefined, 'normal');
                        
                        if (roomData.airChangesPerHour) {
                          doc.text(`      Air Changes/Hour: ${roomData.airChangesPerHour}`, marginLeft, yPos);
                          yPos += lineHeight;
                        }
                        if (roomData.indoorTemperatureF) {
                          doc.text(`      Temperature: ${roomData.indoorTemperatureF}¬∞F`, marginLeft, yPos);
                          yPos += lineHeight;
                        }
                        if (roomData.indoorRelativeHumidityRhMax || roomData.indoorRelativeHumidityRhMin) {
                          const humidityText = `      Humidity: ${roomData.indoorRelativeHumidityRhMin || ''}${roomData.indoorRelativeHumidityRhMin && roomData.indoorRelativeHumidityRhMax ? '-' : ''}${roomData.indoorRelativeHumidityRhMax || ''}%`;
                          doc.text(humidityText, marginLeft, yPos);
                          yPos += lineHeight;
                        }
                      }

                      // Materials & Finishes
                      if (roomData.ceilingFinish || roomData.wallFinish || roomData.floorFinish) {
                        checkPageBreak(15);
                        doc.setFont(undefined, 'italic');
                        doc.text('    Materials & Finishes:', marginLeft, yPos);
                        yPos += lineHeight;
                        doc.setFont(undefined, 'normal');
                        
                        if (roomData.ceilingFinish) {
                          doc.text(`      Ceiling: ${roomData.ceilingFinish}`, marginLeft, yPos);
                          yPos += lineHeight;
                        }
                        if (roomData.wallFinish) {
                          doc.text(`      Wall: ${roomData.wallFinish}`, marginLeft, yPos);
                          yPos += lineHeight;
                        }
                        if (roomData.floorFinish) {
                          doc.text(`      Floor: ${roomData.floorFinish}`, marginLeft, yPos);
                          yPos += lineHeight;
                        }
                      }

                      // Medical Gases
                      const gases = [];
                      if (roomData.oxygenOutlets) gases.push(`O2: ${roomData.oxygenOutlets}`);
                      if (roomData.medicalAirOutlets) gases.push(`Med Air: ${roomData.medicalAirOutlets}`);
                      if (roomData.medicalVacuumOutlets) gases.push(`Vac: ${roomData.medicalVacuumOutlets}`);
                      
                      if (gases.length > 0) {
                        checkPageBreak(10);
                        doc.setFont(undefined, 'italic');
                        doc.text('    Medical Gases:', marginLeft, yPos);
                        yPos += lineHeight;
                        doc.setFont(undefined, 'normal');
                        doc.text(`      ${gases.join(', ')}`, marginLeft, yPos);
                        yPos += lineHeight;
                      }

                      // Equipment count
                      const equipCount = room.equipment ? room.equipment.length : 0;
                      if (equipCount > 0) {
                        doc.text(`    Equipment Items: ${equipCount}`, marginLeft, yPos);
                        yPos += lineHeight;
                      }

                      doc.setFontSize(10);
                    }
                  }

                  yPos += 3; // Space between rooms
                });
              }
              
              yPos += 5; // Space between functional areas
            });
          }
          
          yPos += 5; // Space between departments
        });
      }

      // Save the PDF
      const fileName = `${project.name.replace(/[^a-z0-9]/gi, '_')}_${reportType}_${new Date().toISOString().split('T')[0]}.pdf`;
      doc.save(fileName);
      
      closeReportModal();
    }

    // -----------------------------
    // ROOM MANAGEMENT FUNCTIONS
    // -----------------------------

    function updateRoomGroupQuantity(roomIdsStr, newQuantity, currentQuantity) {
      const qty = parseInt(newQuantity);
      const currentQty = parseInt(currentQuantity);
      
      if (isNaN(qty) || qty < 0) {
        alert('Please enter a valid quantity (0 or greater)');
        renderAll();
        return;
      }

      const roomIds = roomIdsStr.split(',');
      const project = getCurrentProject();
      if (!project.departments) return;

      // Find the first room to use as template
      let templateRoom = null;
      let targetFA = null;
      
      for (const dept of project.departments) {
        if (!dept.functionalAreas) continue;
        for (const fa of dept.functionalAreas) {
          if (!fa.rooms) continue;
          const room = fa.rooms.find(r => r.id === roomIds[0]);
          if (room) {
            templateRoom = room;
            targetFA = fa;
            break;
          }
        }
        if (templateRoom) break;
      }

      if (!templateRoom || !targetFA) return;

      if (qty === 0) {
        // Delete all rooms in the group
        if (confirm(`Delete all ${currentQty} "${templateRoom.name}" room(s)?`)) {
          roomIds.forEach(roomId => {
            const roomIndex = targetFA.rooms.findIndex(r => r.id === roomId);
            if (roomIndex !== -1) {
              targetFA.rooms.splice(roomIndex, 1);
              if (selectedNode && selectedNode.room && selectedNode.room.id === roomId) {
                selectedNode = null;
              }
            }
          });
          saveProjects();
          renderAll();
        } else {
          renderAll();
        }
        return;
      }

      const difference = qty - currentQty;
      
      if (difference > 0) {
        // Add more copies
        for (let i = 0; i < difference; i++) {
          const newName = templateRoom.name;
          const newRoom = {
            id: generateId(),
            code: templateRoom.code,
            name: newName,
            nsf: templateRoom.nsf,
            attributes: templateRoom.attributes ? { ...templateRoom.attributes } : undefined,
            equipment: templateRoom.equipment ? templateRoom.equipment.map(eq => ({
              id: generateId(),
              jsn: eq.jsn,
              name: eq.name,
              quantity: eq.quantity,
              acqIns: eq.acqIns,
              description: eq.description
            })) : []
          };
          targetFA.rooms.push(newRoom);
        }
        saveProjects();
        renderAll();
      } else if (difference < 0) {
        // Remove some copies (keep the first ones, remove the last)
        const toRemove = Math.abs(difference);
        const toRemoveIds = roomIds.slice(-toRemove);
        
        toRemoveIds.forEach(roomId => {
          const roomIndex = targetFA.rooms.findIndex(r => r.id === roomId);
          if (roomIndex !== -1) {
            targetFA.rooms.splice(roomIndex, 1);
            if (selectedNode && selectedNode.room && selectedNode.room.id === roomId) {
              selectedNode = null;
            }
          }
        });
        saveProjects();
        renderAll();
      }
      // If difference === 0, no change needed
    }

    function updateRoomGroupNSF(roomIdsStr, newNSF) {
      const nsf = parseInt(newNSF);
      if (isNaN(nsf) || nsf < 0) {
        alert('Please enter a valid NSF value');
        renderAll();
        return;
      }

      const roomIds = roomIdsStr.split(',');
      const project = getCurrentProject();
      if (!project.departments) return;

      // Update NSF for all rooms in the group
      for (const dept of project.departments) {
        if (!dept.functionalAreas) continue;
        for (const fa of dept.functionalAreas) {
          if (!fa.rooms) continue;
          roomIds.forEach(roomId => {
            const room = fa.rooms.find(r => r.id === roomId);
            if (room) {
              room.nsf = nsf;
            }
          });
        }
      }

      saveProjects();
      renderAll();
    }

    function toggleEquipmentDesc(element) {
      const descDiv = element.previousElementSibling;
      const isExpanded = descDiv.classList.contains('expanded');
      
      if (isExpanded) {
        descDiv.classList.remove('expanded');
        descDiv.classList.add('truncated');
        element.textContent = 'more';
      } else {
        descDiv.classList.add('expanded');
        descDiv.classList.remove('truncated');
        element.textContent = 'less';
      }
    }

    function updateRoomQuantity(roomId, newQuantity) {
      const qty = parseInt(newQuantity);
      if (isNaN(qty) || qty < 0) {
        alert('Please enter a valid quantity (0 or greater)');
        renderAll();
        return;
      }

      const project = getCurrentProject();
      if (!project.departments) return;

      // Find the room
      for (const dept of project.departments) {
        if (!dept.functionalAreas) continue;
        for (const fa of dept.functionalAreas) {
          if (!fa.rooms) continue;
          const roomIndex = fa.rooms.findIndex(r => r.id === roomId);
          if (roomIndex !== -1) {
            const room = fa.rooms[roomIndex];
            
            if (qty === 0) {
              // Delete the room
              if (confirm(`Delete "${room.name}"?`)) {
                fa.rooms.splice(roomIndex, 1);
                if (selectedNode && selectedNode.room && selectedNode.room.id === roomId) {
                  selectedNode = null;
                }
                saveProjects();
                renderAll();
              } else {
                renderAll(); // Reset the input
              }
              return;
            } else if (qty > 1) {
              // Duplicate the room (qty - 1) times
              const duplicateCount = qty - 1;
              for (let i = 0; i < duplicateCount; i++) {
                const newName = room.name + ' (Copy)';
                const newRoom = {
                  id: generateId(),
                  code: room.code,
                  name: newName,
                  nsf: room.nsf,
                  attributes: room.attributes ? {
                    ...room.attributes,
                    'Room Name': newName
                  } : { 'Room Name': newName },
                  equipment: room.equipment.map(eq => ({
                    id: generateId(),
                    jsn: eq.jsn,
                    name: eq.name,
                    quantity: eq.quantity,
                    acqIns: eq.acqIns,
                    description: eq.description
                  }))
                };
                fa.rooms.push(newRoom);
              }
              saveProjects();
              renderAll();
              return;
            }
            // qty === 1: do nothing, it's the current state
            return;
          }
        }
      }
    }

    function updateRoomNSF(roomId, newNSF) {
      const project = getCurrentProject();
      if (!project.departments) return;

      for (const dept of project.departments) {
        if (!dept.functionalAreas) continue;
        for (const fa of dept.functionalAreas) {
          if (!fa.rooms) continue;
          const room = fa.rooms.find(r => r.id === roomId);
          if (room) {
            room.nsf = parseFloat(newNSF) || 0;
            saveProjects();
            renderAll();
            return;
          }
        }
      }
    }

    function updateRoomName(roomId, newName) {
      const project = getCurrentProject();
      if (!project.departments) return;

      for (const dept of project.departments) {
        if (!dept.functionalAreas) continue;
        for (const fa of dept.functionalAreas) {
          if (!fa.rooms) continue;
          const room = fa.rooms.find(r => r.id === roomId);
          if (room) {
            room.name = newName;
            saveProjects();
            renderAll();
            return;
          }
        }
      }
    }

    function updateRoomAttribute(roomId, attributeName, newValue) {
      const project = getCurrentProject();
      if (!project.departments) return;

      for (const dept of project.departments) {
        if (!dept.functionalAreas) continue;
        for (const fa of dept.functionalAreas) {
          if (!fa.rooms) continue;
          const room = fa.rooms.find(r => r.id === roomId);
          if (room) {
            // Initialize attributes object if it doesn't exist
            if (!room.attributes) {
              room.attributes = {};
            }
            // Store the attribute value
            room.attributes[attributeName] = newValue;
            saveProjects();
            renderAll();
            return;
          }
        }
      }
    }

    function resetRoomToDefault(roomId) {
      if (!confirm('Reset this room to default attributes and equipment? This will remove any customizations you\'ve made.')) return;
      
      const project = getCurrentProject();
      if (!project.departments) return;

      for (const dept of project.departments) {
        if (!dept.functionalAreas) continue;
        for (const fa of dept.functionalAreas) {
          if (!fa.rooms) continue;
          const room = fa.rooms.find(r => r.id === roomId);
          if (room) {
            // Find the base room in ROOM_SIZES
            const baseRoom = ROOM_SIZES.find(r => r['Room Code'] === room.code);
            if (!baseRoom) {
              alert('Cannot find base room data for code: ' + room.code);
              return;
            }

            // Reset attributes to default (clear customizations)
            delete room.attributes;
            
            // Reset equipment to base room equipment
            const baseEquipment = ROOM_EQUIPMENT[room.code] || [];
            room.equipment = baseEquipment.map(eq => ({
              id: generateId(),
              jsn: eq.JSN,
              name: eq['Equipment Name'],
              quantity: eq['Qty per Room'] || 1,
              acqIns: eq['Acq/Ins'],
              description: eq.Description
            }));
            
            saveProjects();
            renderAll();
            return;
          }
        }
      }
    }

    function resetRoomToDefault(roomId) {
      if (!confirm('Reset this room to default attributes and equipment? This will remove any customizations you\'ve made.')) return;
      
      const project = getCurrentProject();
      if (!project.departments) return;

      for (const dept of project.departments) {
        if (!dept.functionalAreas) continue;
        for (const fa of dept.functionalAreas) {
          if (!fa.rooms) continue;
          const room = fa.rooms.find(r => r.id === roomId);
          if (room) {
            // Find the base room in ROOM_SIZES
            const baseRoom = ROOM_SIZES.find(r => r['Room Code'] === room.code);
            if (!baseRoom) {
              alert('Cannot find base room data for code: ' + room.code);
              return;
            }

            // Reset attributes to default (clear customizations)
            delete room.attributes;
            
            // Reset equipment to base room equipment
            const baseEquipment = ROOM_EQUIPMENT[room.code] || [];
            room.equipment = baseEquipment.map(eq => ({
              id: generateId(),
              jsn: eq.JSN,
              name: eq['Equipment Name'],
              quantity: eq['Qty per Room'] || 1,
              acqIns: eq['Acq/Ins'],
              description: eq.Description
            }));
            
            saveProjects();
            renderAll();
            return;
          }
        }
      }
    }

    function duplicateRoom(roomId) {
      const project = getCurrentProject();
      if (!project.departments) return;

      for (const dept of project.departments) {
        if (!dept.functionalAreas) continue;
        for (const fa of dept.functionalAreas) {
          if (!fa.rooms) continue;
          const room = fa.rooms.find(r => r.id === roomId);
          if (room) {
            const newName = room.name + ' (Copy)';
            const newRoom = {
              id: generateId(),
              code: room.code,
              name: newName,
              nsf: room.nsf,
              attributes: room.attributes ? {
                ...room.attributes,
                'Room Name': newName  // Update Room Name attribute to match new name
              } : { 'Room Name': newName },
              equipment: room.equipment.map(eq => ({
                id: generateId(),
                jsn: eq.jsn,
                name: eq.name,
                quantity: eq.quantity,
                acqIns: eq.acqIns,
                description: eq.description
              }))
            };
            fa.rooms.push(newRoom);
            saveProjects();
            renderAll();
            return;
          }
        }
      }
    }

    function deleteDepartment(deptId) {
      const project = getCurrentProject();
      const dept = project.departments?.find(d => d.id === deptId);
      
      if (!dept) return;
      
      const faCount = dept.functionalAreas?.length || 0;
      let roomCount = 0;
      dept.functionalAreas?.forEach(fa => {
        roomCount += fa.rooms?.length || 0;
      });
      
      const confirmMsg = `Are you sure you want to delete "${dept.name}"?\n\nThis will delete:\n- ${faCount} functional area(s)\n- ${roomCount} room(s)\n\nThis action cannot be undone.`;
      
      if (!confirm(confirmMsg)) return;
      
      if (!project.departments) return;
      
      const deptIndex = project.departments.findIndex(d => d.id === deptId);
      if (deptIndex !== -1) {
        project.departments.splice(deptIndex, 1);
        saveProjects();
        // Clear selection if the deleted department was selected
        if (selectedNode && selectedNode.department && selectedNode.department.id === deptId) {
          selectedNode = null;
        }
        renderAll();
      }
    }

    function deleteFunctionalArea(faId, deptId) {
      const project = getCurrentProject();
      const dept = project.departments?.find(d => d.id === deptId);
      const fa = dept?.functionalAreas?.find(f => f.id === faId);
      
      if (!fa) return;
      
      const roomCount = fa.rooms?.length || 0;
      const confirmMsg = `Are you sure you want to delete "${fa.name}"?\n\nThis will delete ${roomCount} room(s).\n\nThis action cannot be undone.`;
      
      if (!confirm(confirmMsg)) return;
      
      if (!dept || !dept.functionalAreas) return;
      
      const faIndex = dept.functionalAreas.findIndex(f => f.id === faId);
      if (faIndex !== -1) {
        dept.functionalAreas.splice(faIndex, 1);
        saveProjects();
        // Clear selection if the deleted functional area was selected
        if (selectedNode && selectedNode.functionalArea && selectedNode.functionalArea.id === faId) {
          selectedNode = null;
        }
        renderAll();
      }
    }

    function deleteRoom(roomId) {
      if (!confirm('Are you sure you want to delete this room?')) return;
      
      const project = getCurrentProject();
      if (!project.departments) return;

      for (const dept of project.departments) {
        if (!dept.functionalAreas) continue;
        for (const fa of dept.functionalAreas) {
          if (!fa.rooms) continue;
          const roomIndex = fa.rooms.findIndex(r => r.id === roomId);
          if (roomIndex !== -1) {
            fa.rooms.splice(roomIndex, 1);
            saveProjects();
            // Clear selection if the deleted room was selected
            if (selectedNode && selectedNode.room && selectedNode.room.id === roomId) {
              selectedNode = null;
            }
            renderAll();
            return;
          }
        }
      }
    }

    function updateEquipmentQuantity(roomId, equipmentId, newQuantity) {
      const project = getCurrentProject();
      if (!project.departments) return;

      const qty = parseInt(newQuantity);
      if (isNaN(qty) || qty < 1) {
        alert('Please enter a valid quantity (minimum 1)');
        renderAll();
        return;
      }

      for (const dept of project.departments) {
        if (!dept.functionalAreas) continue;
        for (const fa of dept.functionalAreas) {
          if (!fa.rooms) continue;
          const room = fa.rooms.find(r => r.id === roomId);
          if (room && room.equipment) {
            const equipment = room.equipment.find(e => e.id === equipmentId);
            if (equipment) {
              equipment.quantity = qty;
              saveProjects();
              renderAll();
              return;
            }
          }
        }
      }
    }

    function removeEquipment(roomId, equipmentId) {
      const project = getCurrentProject();
      if (!project.departments) return;

      for (const dept of project.departments) {
        if (!dept.functionalAreas) continue;
        for (const fa of dept.functionalAreas) {
          if (!fa.rooms) continue;
          const room = fa.rooms.find(r => r.id === roomId);
          if (room && room.equipment) {
            room.equipment = room.equipment.filter(e => e.id !== equipmentId);
            saveProjects();
            renderAll();
            return;
          }
        }
      }
    }

    function updateEquipmentCost(roomId, equipmentId, newCost) {
      const project = getCurrentProject();
      if (!project.departments) return;

      const cost = parseFloat(newCost);
      if (isNaN(cost) || cost < 0) {
        alert('Please enter a valid cost (minimum 0)');
        renderAll();
        return;
      }

      for (const dept of project.departments) {
        if (!dept.functionalAreas) continue;
        for (const fa of dept.functionalAreas) {
          if (!fa.rooms) continue;
          const room = fa.rooms.find(r => r.id === roomId);
          if (room && room.equipment) {
            const equipment = room.equipment.find(e => e.id === equipmentId);
            if (equipment) {
              equipment.cost = cost;
              saveProjects();
              renderAll();
              return;
            }
          }
        }
      }
    }

    function updateProjectCostFactor(factorType, newValue) {
      const project = getCurrentProject();
      const value = parseFloat(newValue);
      
      if (isNaN(value) || value < 0) {
        alert('Please enter a valid cost factor (minimum 0)');
        renderAll();
        return;
      }

      if (factorType === 'costPerNSF') {
        project.costPerNSF = value;
        // Clear GSF when NSF is set
        if (value > 0) project.costPerGSF = 0;
      } else if (factorType === 'costPerGSF') {
        project.costPerGSF = value;
        // Clear NSF when GSF is set
        if (value > 0) project.costPerNSF = 0;
      }

      saveProjects();
      renderAll();
    }

    let currentRoomIdForEquipment = null;

    function addEquipmentToRoom(roomId) {
      currentRoomIdForEquipment = roomId;
      renderEquipmentList();
      document.getElementById('equipment-modal').classList.add('active');
      document.getElementById('equipment-search').value = '';
      document.getElementById('equipment-search').focus();
    }

    function closeEquipmentModal() {
      document.getElementById('equipment-modal').classList.remove('active');
      currentRoomIdForEquipment = null;
    }

    function renderEquipmentList(searchTerm = '') {
      const container = document.getElementById('equipment-list');
      const lowerSearch = searchTerm.toLowerCase();
      
      let filteredEquipment = EQUIPMENT_LIST;
      if (searchTerm) {
        filteredEquipment = EQUIPMENT_LIST.filter(eq => 
          eq.jsn.toLowerCase().includes(lowerSearch) ||
          eq.name.toLowerCase().includes(lowerSearch) ||
          (eq.description && eq.description.toLowerCase().includes(lowerSearch))
        );
      }

      if (filteredEquipment.length === 0) {
        container.innerHTML = '<div style="padding: 40px; text-align: center; color: var(--muted);">No equipment found</div>';
        return;
      }

      let html = '<div style="display: flex; flex-direction: column;">';
      filteredEquipment.forEach(eq => {
        html += `
          <div style="padding: 12px 16px; border-bottom: 1px solid var(--border); cursor: pointer; transition: background 0.2s;" 
               onmouseover="this.style.background='var(--bg-hover)'" 
               onmouseout="this.style.background='transparent'"
               onclick="selectEquipment('${eq.jsn}')">
            <div style="font-weight: 600; margin-bottom: 4px;">${eq.jsn} - ${eq.name}</div>
            ${eq.acqIns ? `<div style="font-size: 0.85rem; color: var(--muted); margin-bottom: 2px;">Category: ${eq.acqIns}</div>` : ''}
            ${eq.description ? `<div style="font-size: 0.85rem; color: var(--muted);">${eq.description}</div>` : ''}
          </div>
        `;
      });
      html += '</div>';
      
      container.innerHTML = html;
    }

    function filterEquipmentList() {
      const searchTerm = document.getElementById('equipment-search').value;
      renderEquipmentList(searchTerm);
    }

    function selectEquipment(jsn) {
      const equipItem = EQUIPMENT_LIST.find(e => e.jsn === jsn);
      if (!equipItem) {
        alert('Equipment not found.');
        return;
      }

      const quantity = prompt('Enter quantity:', '1');
      if (!quantity) return;

      const project = getCurrentProject();
      if (!project.departments) return;

      for (const dept of project.departments) {
        if (!dept.functionalAreas) continue;
        for (const fa of dept.functionalAreas) {
          if (!fa.rooms) continue;
          const room = fa.rooms.find(r => r.id === currentRoomIdForEquipment);
          if (room) {
            if (!room.equipment) room.equipment = [];
            room.equipment.push({
              id: generateId(),
              jsn: equipItem.jsn,
              name: equipItem.name,
              quantity: parseInt(quantity) || 1,
              acqIns: equipItem.acqIns,
              description: equipItem.description,
              cost: 0
            });
            saveProjects();
            closeEquipmentModal();
            renderAll();
            return;
          }
        }
      }
    }

    function calculateTotalNSF(rooms) {
      if (!rooms) return 0;
      return rooms.reduce((sum, room) => sum + (room.nsf || 0), 0);
    }

    function calculateFANSF(fa) {
      return calculateTotalNSF(fa.rooms);
    }

    function calculateDeptNSF(dept) {
      if (!dept.functionalAreas) return 0;
      return dept.functionalAreas.reduce((sum, fa) => sum + calculateFANSF(fa), 0);
    }

    function calculateProjectNSF(project) {
      if (!project.departments) return 0;
      return project.departments.reduce((sum, dept) => sum + calculateDeptNSF(dept), 0);
    }

    // COST CALCULATION FUNCTIONS
    function calculateEquipmentCost(equipment) {
      if (!equipment) return 0;
      return equipment.reduce((sum, eq) => sum + ((eq.cost || 0) * (eq.quantity || 1)), 0);
    }

    function calculateRoomCost(room, project) {
      let cost = 0;
      // Equipment cost
      if (room.equipment) {
        cost += calculateEquipmentCost(room.equipment);
      }
      // Construction cost (NSF * costPerNSF or GSF * costPerGSF)
      const nsf = room.nsf || 0;
      const costPerNSF = project?.costPerNSF || 0;
      const costPerGSF = project?.costPerGSF || 0;
      if (costPerNSF > 0) {
        cost += nsf * costPerNSF;
      } else if (costPerGSF > 0 && nsf > 0) {
        // Assuming a default 1.35 grossing factor if using GSF
        const gsf = nsf * 1.35;
        cost += gsf * costPerGSF;
      }
      return cost;
    }

    function calculateFACost(fa, project) {
      if (!fa.rooms) return 0;
      return fa.rooms.reduce((sum, room) => sum + calculateRoomCost(room, project), 0);
    }

    function calculateDeptCost(dept, project) {
      if (!dept.functionalAreas) return 0;
      return dept.functionalAreas.reduce((sum, fa) => sum + calculateFACost(fa, project), 0);
    }

    function calculateProjectCost(project) {
      if (!project.departments) return 0;
      return project.departments.reduce((sum, dept) => sum + calculateDeptCost(dept, project), 0);
    }

    // -----------------------------
    // LOGIC PORTAL
    // -----------------------------

    let roomLogicData = {};
    let workbench = null;

    function toggleWorkbench() {
      const container = document.getElementById('workbench-container');
      const button = document.getElementById('workbench-toggle');
      
      if (container.classList.contains('active')) {
        // Close workbench
        container.classList.remove('active');
        button.classList.remove('active');
      } else {
        // Open workbench
        container.classList.add('active');
        button.classList.add('active');
        
        // Initialize or refresh workbench
        if (!workbench) {
          workbench = new IsometricWorkbench('workbench-canvas');
        }
        
        // Load current project data
        workbenchReload();
      }
    }

    function workbenchReload() {
      if (!workbench) return;
      
      // Get current project departments from the tree
      const departments = [];
      const project = getCurrentProject();
      
      Object.keys(project.departments || {}).forEach(deptName => {
        const dept = project.departments[deptName];
        const rooms = [];
        
        Object.keys(dept.functionalAreas || {}).forEach(faName => {
          const fa = dept.functionalAreas[faName];
          (fa.rooms || []).forEach(room => {
            const qty = room.quantity || 1;
            // Create one room entry per quantity so each gets a cube
            for (let i = 0; i < qty; i++) {
              rooms.push({
                room_code: room.roomCode,
                room_name: room.roomName + (qty > 1 ? ` #${i + 1}` : ''),
                functional_area: faName,
                nsf: room.nsf || 100,
                quantity: 1
              });
            }
          });
        });
        
        departments.push({
          name: deptName,
          rooms: rooms
        });
      });
      
      workbench.loadFromProject(departments);
    }

    function workbenchAutoArrange() {
      if (!workbench) return;
      workbench.autoArrange();
    }
    
    function workbenchSetBackground(style) {
      if (!workbench) return;
      workbench.setBackgroundStyle(style);
    }

    function workbenchToggleView() {
      if (!workbench) return;
      workbench.toggleViewMode();
      
      // Update button text
      const btn = document.getElementById('view-toggle-btn');
      if (workbench.viewMode === 'elevation') {
        btn.textContent = 'üìê 45¬∞/45¬∞ View';
      } else {
        btn.textContent = 'üìê Top-Down View';
      }
    }

    function openLogicPortal() {
      document.getElementById('password-modal').classList.add('active');
      document.getElementById('portal-password').value = '';
      document.getElementById('password-error').style.display = 'none';
      setTimeout(() => document.getElementById('portal-password').focus(), 100);
    }

    function closePasswordModal() {
      document.getElementById('password-modal').classList.remove('active');
    }

    function checkPassword() {
      const password = document.getElementById('portal-password').value;
      if (password === 'CARTER') {
        closePasswordModal();
        showLogicPortal();
      } else {
        document.getElementById('password-error').style.display = 'block';
        document.getElementById('portal-password').select();
      }
    }

    function showLogicPortal() {
      loadRoomLogic();
      renderLogicRoomsList();
      document.getElementById('logic-portal-modal').classList.add('active');
    }

    function closeLogicPortal() {
      document.getElementById('logic-portal-modal').classList.remove('active');
    }

    // -----------------------------
    // DATA SYNC FUNCTIONS
    // -----------------------------

    function openDataSyncModal() {
      document.getElementById('data-sync-modal').classList.add('active');
      // Load saved config
      const savedRepo = localStorage.getItem('github-repo') || 'LeCartier/Arrange';
      const savedBranch = localStorage.getItem('github-branch') || 'main';
      document.getElementById('github-repo').value = savedRepo;
      document.getElementById('github-branch').value = savedBranch;
      
      // Reset status
      document.getElementById('sync-status').innerHTML = '<div style="color: var(--muted);">Ready to sync...</div>';
    }

    function closeDataSyncModal() {
      document.getElementById('data-sync-modal').classList.remove('active');
    }

    function logSync(message, type = 'info') {
      const statusDiv = document.getElementById('sync-status');
      const color = type === 'error' ? '#ff6b6b' : type === 'success' ? '#51cf66' : type === 'warning' ? '#ffd93d' : 'var(--text)';
      const timestamp = new Date().toLocaleTimeString();
      statusDiv.innerHTML += `<div style="color: ${color}; margin-bottom: 4px;">[${timestamp}] ${message}</div>`;
      statusDiv.scrollTop = statusDiv.scrollHeight;
    }

    async function syncDataFromGitHub() {
      const repo = document.getElementById('github-repo').value.trim();
      const branch = document.getElementById('github-branch').value.trim();
      const createBackup = document.getElementById('backup-before-sync').checked;

      if (!repo) {
        alert('Please enter a GitHub repository');
        return;
      }

      // Save config
      localStorage.setItem('github-repo', repo);
      localStorage.setItem('github-branch', branch);

      // Clear status
      document.getElementById('sync-status').innerHTML = '';
      logSync('Starting data sync...', 'info');

      try {
        // Create backup if requested
        if (createBackup) {
          logSync('Creating backup of current data...', 'info');
          const backup = {
            timestamp: new Date().toISOString(),
            ROOM_SIZES: typeof ROOM_SIZES !== 'undefined' ? ROOM_SIZES : [],
            EQUIPMENT_LIST: typeof EQUIPMENT_LIST !== 'undefined' ? EQUIPMENT_LIST : [],
            ROOM_EQUIPMENT_MAPPINGS: typeof ROOM_EQUIPMENT_MAPPINGS !== 'undefined' ? ROOM_EQUIPMENT_MAPPINGS : []
          };
          localStorage.setItem('data-backup-' + Date.now(), JSON.stringify(backup));
          logSync('Backup created successfully', 'success');
        }

        // Fetch room criteria TSV
        logSync('Fetching room_criteria.tsv...', 'info');
        const roomCriteriaUrl = `https://raw.githubusercontent.com/${repo}/${branch}/src/room_criteria.tsv`;
        const roomResponse = await fetch(roomCriteriaUrl);
        
        if (!roomResponse.ok) {
          throw new Error(`Failed to fetch room_criteria.tsv: ${roomResponse.status}`);
        }
        
        const roomData = await roomResponse.text();
        logSync(`Downloaded room_criteria.tsv (${(roomData.length / 1024).toFixed(1)} KB)`, 'success');

        // Fetch equipment guide
        logSync('Fetching Equipment_Guide_parsed_v2.txt...', 'info');
        const equipUrl = `https://raw.githubusercontent.com/${repo}/${branch}/src/Equipment_Guide_parsed_v2.txt`;
        const equipResponse = await fetch(equipUrl);
        
        if (!equipResponse.ok) {
          throw new Error(`Failed to fetch Equipment_Guide_parsed_v2.txt: ${equipResponse.status}`);
        }
        
        const equipData = await equipResponse.text();
        logSync(`Downloaded Equipment_Guide_parsed_v2.txt (${(equipData.length / 1024).toFixed(1)} KB)`, 'success');

        // Parse TSV data
        logSync('Parsing room criteria data...', 'info');
        const newRoomSizes = parseTSVData(roomData);
        logSync(`Parsed ${newRoomSizes.length} rooms`, 'success');

        // Parse equipment data
        logSync('Parsing equipment data...', 'info');
        const { equipmentList, mappings } = parseEquipmentData(equipData);
        logSync(`Parsed ${equipmentList.length} equipment items and ${mappings.length} mappings`, 'success');

        // Update global variables
        if (newRoomSizes.length > 0) {
          window.ROOM_SIZES = newRoomSizes;
          logSync('Updated ROOM_SIZES', 'success');
        }
        
        if (equipmentList.length > 0) {
          window.EQUIPMENT_LIST = equipmentList;
          logSync('Updated EQUIPMENT_LIST', 'success');
        }
        
        if (mappings.length > 0) {
          window.ROOM_EQUIPMENT_MAPPINGS = mappings;
          logSync('Updated ROOM_EQUIPMENT_MAPPINGS', 'success');
        }

        // Store update timestamp
        localStorage.setItem('last-data-sync', new Date().toISOString());

        logSync('‚úì Data sync completed successfully!', 'success');
        logSync('Refreshing UI...', 'info');
        
        // Refresh the UI
        renderAll();
        
        setTimeout(() => {
          alert('Data sync completed! The application has been updated with the latest data.');
          closeDataSyncModal();
        }, 1000);

      } catch (error) {
        logSync(`‚úó Error: ${error.message}`, 'error');
        console.error('Sync error:', error);
      }
    }

    function parseTSVData(tsvText) {
      const lines = tsvText.trim().split('\n');
      if (lines.length < 2) return [];

      const headers = lines[0].split('\t');
      const rooms = [];

      for (let i = 1; i < lines.length; i++) {
        const values = lines[i].split('\t');
        const room = {};
        
        headers.forEach((header, index) => {
          let value = values[index] || '';
          
          // Remove surrounding quotes if present (common in TSV/CSV for fields with commas)
          if (value.startsWith('"') && value.endsWith('"')) {
            value = value.slice(1, -1);
          }
          
          // Convert to appropriate type
          if (value === '') {
            room[header] = null;
          } else if (!isNaN(value) && value !== '') {
            room[header] = parseFloat(value);
          } else {
            room[header] = value;
          }
        });

        if (room.roomCode) {
          rooms.push(room);
        }
      }

      return rooms;
    }

    function parseEquipmentData(equipText) {
      // This is a simplified parser - adjust based on your actual file format
      const lines = equipText.trim().split('\n');
      const equipmentList = [];
      const mappings = [];
      
      let currentSection = null;
      
      for (const line of lines) {
        if (line.startsWith('EQUIPMENT:')) {
          currentSection = 'equipment';
          continue;
        } else if (line.startsWith('MAPPINGS:')) {
          currentSection = 'mappings';
          continue;
        }

        if (currentSection === 'equipment' && line.trim()) {
          const parts = line.split('|');
          if (parts.length >= 3) {
            equipmentList.push({
              jsn: parts[0].trim(),
              name: parts[1].trim(),
              description: parts[2].trim()
            });
          }
        } else if (currentSection === 'mappings' && line.trim()) {
          const parts = line.split('|');
          if (parts.length >= 5) {
            mappings.push({
              roomCode: parts[0].trim(),
              department: parts[1].trim(),
              functionalArea: parts[2].trim(),
              equipmentJsn: parts[3].trim(),
              quantity: parseInt(parts[4]) || 1
            });
          }
        }
      }

      return { equipmentList, mappings };
    }

    function loadRoomLogic() {
      // Load existing logic from localStorage
      const saved = localStorage.getItem('roomLogicData');
      if (saved) {
        try {
          roomLogicData = JSON.parse(saved);
        } catch (e) {
          roomLogicData = {};
        }
      }

      // Initialize with all rooms from ROOM_SIZES
      if (typeof ROOM_SIZES !== 'undefined') {
        ROOM_SIZES.forEach(room => {
          if (!roomLogicData[room.id]) {
            roomLogicData[room.id] = {
              code: room.id,
              name: room.name,
              minQty: '',
              maxQty: '',
              qtyFormula: '',
              nsfFormula: room.nsf ? String(room.nsf) : '',
              variables: '',
              notes: ''
            };
          } else {
            // Update name if it changed
            roomLogicData[room.id].name = room.name;
            // Update NSF if not set
            if (!roomLogicData[room.id].nsfFormula && room.nsf) {
              roomLogicData[room.id].nsfFormula = String(room.nsf);
            }
          }
        });
      }
    }

    let currentLogicPage = 0;
    const LOGIC_PAGE_SIZE = 50; // Show 50 rooms at a time

    function renderLogicRoomsList(append = false) {
      const container = document.getElementById('logic-rooms-list');
      const searchTerm = (document.getElementById('logic-search-box')?.value || '').toLowerCase();
      
      const allRooms = Object.values(roomLogicData)
        .filter(room => {
          if (!searchTerm) return true;
          return room.code.toLowerCase().includes(searchTerm) ||
                 room.name.toLowerCase().includes(searchTerm);
        })
        .sort((a, b) => a.code.localeCompare(b.code));

      // Reset page on new search
      if (!append) {
        currentLogicPage = 0;
      }

      const start = currentLogicPage * LOGIC_PAGE_SIZE;
      const end = start + LOGIC_PAGE_SIZE;
      const rooms = allRooms.slice(start, end);
      const hasMore = end < allRooms.length;

      const html = rooms.map(room => {
        const hasLogic = room.qtyFormula || room.minQty || room.maxQty || room.notes;
        const status = hasLogic ? 
          (room.qtyFormula && room.minQty && room.maxQty ? 'complete' : 'partial') : 'empty';
        const statusText = status === 'complete' ? 'Complete' : 
                          status === 'partial' ? 'Partial' : 'No Logic';
        
        const escapedCode = escapeHtml(room.code).replace(/'/g, '&#39;');
        const displayCode = escapeHtml(room.code);
        const displayName = escapeHtml(room.name);
        const displayMinQty = escapeHtml(room.minQty || '');
        const displayMaxQty = escapeHtml(room.maxQty || '');
        const displayQtyFormula = escapeHtml(room.qtyFormula || '');
        const displayNsfFormula = escapeHtml(room.nsfFormula || '');
        const displayVariables = escapeHtml(room.variables || '');
        const displayNotes = escapeHtml(room.notes || '');

        return `
          <div class="logic-card">
            <div class="logic-card-header">
              <div class="logic-card-title">
                <div class="logic-card-code">${displayCode}</div>
                <div class="logic-card-name">${displayName}</div>
              </div>
              <span class="logic-status ${status}">${statusText}</span>
            </div>
            
            <div class="logic-fields">
              <div class="logic-field">
                <label class="logic-field-label">Minimum Qty:</label>
                <input type="text" class="logic-field-input" 
                       value="${displayMinQty}" 
                       data-room-code="${escapedCode}"
                       onchange="updateRoomLogic(this.dataset.roomCode, 'minQty', this.value)"
                       placeholder="e.g., 1 or 0">
              </div>
              
              <div class="logic-field">
                <label class="logic-field-label">Maximum Qty:</label>
                <input type="text" class="logic-field-input" 
                       value="${displayMaxQty}" 
                       data-room-code="${escapedCode}"
                       onchange="updateRoomLogic(this.dataset.roomCode, 'maxQty', this.value)"
                       placeholder="e.g., 20 or unlimited">
              </div>
              
              <div class="logic-field">
                <label class="logic-field-label">Quantity Formula:</label>
                <textarea class="logic-field-textarea" 
                          data-room-code="${escapedCode}"
                          onchange="updateRoomLogic(this.dataset.roomCode, 'qtyFormula', this.value)"
                          placeholder="e.g., annualVisits / 2000 or 1 per 10 beds">${displayQtyFormula}</textarea>
              </div>
              <div class="logic-help-text">Enter calculation formula or text description</div>
              
              <div class="logic-field">
                <label class="logic-field-label">NSF per Room:</label>
                <input type="text" class="logic-field-input" 
                       value="${displayNsfFormula}" 
                       data-room-code="${escapedCode}"
                       onchange="updateRoomLogic(this.dataset.roomCode, 'nsfFormula', this.value)"
                       placeholder="e.g., 120 or varies">
              </div>
              
              <div class="logic-field">
                <label class="logic-field-label">Variables Used:</label>
                <input type="text" class="logic-field-input" 
                       value="${displayVariables}" 
                       data-room-code="${escapedCode}"
                       onchange="updateRoomLogic(this.dataset.roomCode, 'variables', this.value)"
                       placeholder="e.g., numBeds, annualVisits">
              </div>
              <div class="logic-help-text">Comma-separated list of project variables</div>
              
              <div class="logic-field">
                <label class="logic-field-label">Notes:</label>
                <textarea class="logic-field-textarea" 
                          data-room-code="${escapedCode}"
                          onchange="updateRoomLogic(this.dataset.roomCode, 'notes', this.value)"
                          placeholder="Section 4 & 5 notes from PDF...">${displayNotes}</textarea>
              </div>
              <div class="logic-help-text">Reference to PDF sections or calculation notes</div>
            </div>
          </div>
        `;
      }).join('');
    }

    function updateRoomLogic(code, field, value) {
      if (!roomLogicData[code]) {
        roomLogicData[code] = { code };
      }
      roomLogicData[code][field] = value;
    }

    const filterLogicRooms = debounce(() => {
      renderLogicRoomsList();
    }, 300);

    function saveAllLogic() {
      try {
        localStorage.setItem('roomLogicData', JSON.stringify(roomLogicData));
        alert('‚úÖ Room logic saved successfully to browser storage!');
      } catch (e) {
        alert('‚ùå Error saving logic: ' + e.message);
      }
    }

    function exportLogic() {
      try {
        const dataStr = JSON.stringify(roomLogicData, null, 2);
        const dataBlob = new Blob([dataStr], { type: 'application/json' });
        const url = URL.createObjectURL(dataBlob);
        const link = document.createElement('a');
        link.href = url;
        link.download = `room-logic-${new Date().toISOString().split('T')[0]}.json`;
        link.click();
        URL.revokeObjectURL(url);
        alert('‚úÖ Room logic exported successfully!');
      } catch (e) {
        alert('‚ùå Error exporting logic: ' + e.message);
      }
    }

    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Close modals when clicking outside
    window.addEventListener('click', (e) => {
      if (e.target.id === 'password-modal') closePasswordModal();
      if (e.target.id === 'logic-portal-modal') closeLogicPortal();
      if (e.target.id === 'import-modal') closeImportModal();
      if (e.target.id === 'equipment-modal') closeEquipmentModal();
    });

    // -----------------------------
    // INITIALIZE
    // -----------------------------


    // Initialize application
    // Data loading happens above via fetch, so we just need to wait for it
    
    // Start in project list view
    viewState = 'project-list';
    
    // Note: renderAll() is called after data enrichment completes in the fetch above
  </script>
</body>
</html>